---
title: "Piru_enchancement-Models"
author: "Kit Swift"
date: "2022-12-15"
output: html_document

---

# Load libraries

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries-data, message=FALSE}
library(here) # similar to set working directory
library(tidyverse) # data wrangling
library(lubridate) # dates and times
library(ggthemes)
library(plotly)
library(dplyr)
library(olsrr)
#library(survival)
library(lme4)
library(lmerTest)
library(multcomp)
library(multcompView)
library(emmeans) # includes lsmeans
library(multcomp) # functions: multcompLetters2, multcompLetters3, multcompLetters4 using aov object
library(rgl)

#mafa_cover_all = MAFA % cover 2018 and 2019
#exotic_cover_all = exotic % cover 2018 and 2019

R.Version()
citation() 

```

# Load colors for graphs

```{r colors, include=TRUE}
devtools::install_github("an-bui/calecopal")

library(calecopal)
# all palettes
names(cal_palettes)

# Site colors: 1, 2 
cal_palette(name = "chaparral1", n = 5, type = "continuous") # [1] "#DCC27A" "#F19B34"
site1color <- "#DCC27A"
site2color <- "#F19B34"
sitecolors <- c(site1color, site2color)

# Treatment colors: Full, half, none 
cal_palette(name = "chaparral3", n = 5, type = "continuous") # [1] "#D3E3CA", "#92A587", "#2F3525"
cal_palette(name = "desert", n = 5, type = "continuous") # [1] "#F6EECF", "#B09175", "#291611"
treatment1color <- "#F6EECF"
treatment2color <- "#B09175"
treatment3color <- "#291611"
treatmentcolors <- c(treatment1color, treatment2color, treatment3color)

```

# Question 1: How do environmental conditions change with canopy cover? Considering (a) canopy treatment and (b) canopy cover.

Is canopy treatment or canopy cover a stronger predictor of the environmental conditions below the shrub canopy?

Notes: - **response variable**: The variable you want to test. (e.g.,. PAR, TDR, nncover) - **explanatory variables**: The variables that can explain the outcome. (e.g., treatment, mafacover, site) - **data frame**: Include all the data you'll be working with. (e.g., combine par and mafa_cover_all) - **formula**: a formula is a two-sided linear formula object describing both the *fixed-effects* and *random effects* part of the model, with the response on the left of a \~ operator and the terms, separated by + operators, on the right. - **random effects**: Random-effects terms are distinguished by vertical bars **(\|)** separating expressions for design matrices from grouping factors. Two vertical bars **(\|\|)** can be used to specify multiple uncorrelated random effects for the same grouping variable. + Because of the way it is implemented, the \|\|-syntax works only for design matrices containing numeric (continuous) predictors; to fit models with independent categorical effects, see dummy or the lmer_alt function from the afex package.)

### Load PAR, TDR, and non-native percent cover data.

### Saved as a csv in the "Processed" data folder.

```{r load data par tdr nncover csv, include=TRUE}
# variables as characters
# data as double numbers
mafa_cover_all_load <- read_csv("data/processed/mafa_cover_all.csv",
  col_types = cols(
    plot_number = col_character(),
    year = col_character(),
    cover_percent = col_double(),
    site = col_character()
    )
  )
mafa_cover_all <- mafa_cover_all_load %>% 
  dplyr::select(plot_number, year, cover_percent, site)

par_load <- read_csv("data/processed/par.csv",
  col_types = cols(
    date = col_character(),
    plot_number = col_character(),
    treatment = col_character(),
    year = col_character(),
    month = col_character(),
    site = col_character(),
    normalized_par = col_double()
    )
  )

par <- par_load %>% 
  dplyr::select(date, year, month, site, plot_number, treatment, normalized_par)

tdr_load <- read_csv("data/processed/tdr.csv",
  col_types = cols(
    plot_number = col_character(),
    treatment = col_character(),
    year = col_character(),
    month = col_character(),
    site = col_character(),
    soil_moisture = col_double()
    )
  )
tdr <- tdr_load %>% 
  dplyr::select(date, year, month, site, plot_number, treatment, soil_moisture)

exotic_cover_all_load <- read_csv("data/processed/exotic_cover_all.csv",
    col_types = cols(
    year = col_character(),
    plot_number = col_character(),
    MAFA_removal = col_character(),
    site = col_character(),
    cover_percent = col_double()
    )
)
exotic_cover_all <- exotic_cover_all_load %>% 
  dplyr::select(date, year, site, plot_number, MAFA_removal, cover_percent)

survmort_load <- read_csv("data/processed/survmort.csv",
                          col_types = cols(
                             year = col_character(),
                             month = col_character(), 
                             plot_number = col_character(),
                             treatment = col_character(), 
                             species = col_character(), 
                             alive = col_integer(), 
                             dead = col_integer(), 
                             site = col_character(), 
                             month_count = col_integer(), 
                             transplanted = col_character()
                          )
                          )
survmort <- survmort_load %>% 
  dplyr::select(year, month, plot_number, treatment, species, alive, dead, site, month_count, transplanted)
print(survmort)
summary(survmort)

nngrass2018_cover_height_laod <- read_csv("data/processed/nngrass2018_cover_height.csv",
                                          col_types = cols(
                             year = col_character(),
                             plot_number = col_character(),
                             quad_rep = col_character(),
                             nn_grassheight_cm = col_number(),
                             MAFA_removal = col_character(), 
                             exo_coverpercent = col_number(),
                             site = col_character(),
                             MAFA_coverpercent = col_number()
                          )
                          )
nngrass2018_cover_height <- nngrass2018_cover_height_laod %>% 
  dplyr::select(year, plot_number, quad_rep, nn_grassheight_cm, MAFA_removal, exo_coverpercent, site, MAFA_coverpercent) %>% 
  rename(treatment = MAFA_removal)


nngrass2018_cover_density_laod <- read_csv("data/processed/nngrass2018_cover_density.csv", 
                                                           col_types = cols(
                             year = col_character(),
                             plot_number = col_character(),
                             quad_rep = col_character(),
                             status_lifeform = col_character(),
                             MAFA_removal = col_character(), 
                             exo_coverpercent = col_number(),
                             site = col_character(),
                             MAFA_coverpercent = col_number(), 
                            total_density_200cm2 = col_integer()
                          )
                          )
nngrass2018_cover_density <- nngrass2018_cover_density_laod %>% 
  dplyr::select(year, plot_number, quad_rep, status_lifeform, total_density_200cm2, MAFA_removal, exo_coverpercent, site, MAFA_coverpercent) %>% 
  rename(treatment = MAFA_removal)

```

Create dfs for PAR, TDR, and NNcover models: parmod, tdrmod, nnmod
```{r create parmod tdrmod nnmod dfs, include=TRUE}
# PAR
parmod <- par %>%
  left_join(mafa_cover_all, by = c("year", "site", "plot_number")) %>% 
  rename(mafacover = cover_percent)
print(parmod)
parmod %>% 
  group_by(year, treatment) %>% 
  summarise(N = length(normalized_par))


# TDR
tdrmod <- tdr %>% 
  left_join(mafa_cover_all, by = c("year", "site", "plot_number")) %>% 
  rename(mafacover = cover_percent) %>% 
  filter(year <= 2019) 
  
#print(tdrmod)
tdrmod %>% #highlight and run
  group_by(year, treatment) %>% 
  summarise(N = length(soil_moisture))

# write.csv(tdrmod, "data/processed/tdr_model.csv")
# tdr1 <- filter(tdrmod, site == "1")
# tdr2 <- filter(tdrmod, site == "2")

# NN COVER
nnmod <- exotic_cover_all %>% 
   left_join(mafa_cover_all, by = c("year", "site", "plot_number")) %>% 
  rename(nncover = cover_percent.x,
         mafacover = cover_percent.y, 
         treatment = MAFA_removal)#%>% 
  # dplyr::select("date", "year", "site", "plot_number", "treatment", "nncover", "mafacover")
view(nnmod)
#write.csv(nnmod, "data/processed/nnmod.csv")
```

```{r combine model dfs}

nnmod %>%  # check number of data points
  group_by(year, treatment) %>% 
  summarise(N_mafacover = length(mafacover), 
            N_exocover = length(nncover))
# write.csv(nnmod, "data/processed/nn_model.csv")
# nnmod1 <- filter(nnmod, site == "1")
# nnmod2 <- filter(nnmod, site == "2")

nnmod_nodate <- nnmod %>% 
  dplyr::select(!date) %>% 
  mutate(treatment = case_when(treatment == "nonene" ~ "none", 
                               TRUE ~ treatment))

tdrmod_nodate <- tdrmod %>% 
   dplyr::select(!date) %>% 
    mutate(treatment = case_when(treatment == "nonene" ~ "none", 
                               TRUE ~ treatment))

parmod_nodate <- parmod %>% 
    dplyr::select(!date) %>% 
  mutate(treatment = case_when(treatment == "nonene" ~ "none", 
                               TRUE ~ treatment))

# join parmod + nncover + tdrmod
environ_mod <- full_join(parmod, nnmod_nodate, by = c("year", "site", "plot_number", "treatment", "mafacover")) %>% 
  full_join(tdrmod_nodate, by = c("year", "month", "site", "plot_number", "treatment", "mafacover"))

# join parmod + nncover
parmod_nncover <- parmod %>% 
   mutate(treatment = case_when(treatment == "nonene" ~ "none", 
                               TRUE ~ treatment)) %>% 
  left_join(nnmod_nodate, by = (c("year", "site", "plot_number", "treatment", "mafacover")))

# join tdrmod + nncover
tdrmod_nncover <- tdrmod %>% 
   mutate(treatment = case_when(treatment == "nonene" ~ "none", 
                               TRUE ~ treatment)) %>% 
  left_join(nnmod_nodate, by = (c("year", "site", "plot_number", "treatment", "mafacover")))

# join nnmod + tdrmod_nodate + parmod_nodate
tdr_prep <- tdrmod_nodate %>% 
  filter(month == 4 | month == 3) %>% 
  unite('year_month_tdr', year:month, remove = FALSE) %>% 
  dplyr::select(!month)

par_prep <- parmod_nodate %>% 
  filter(month == 4 | month == 5) %>% 
  unite('year_month_par', year:month, remove = FALSE) %>% 
   dplyr::select(!month)
    
nnmod_environ <- nnmod %>% 
  left_join(tdr_prep, by = (c("year", "site", "plot_number", "treatment", "mafacover"))) %>% 
  left_join(par_prep, by = (c("year", "site", "plot_number", "treatment", "mafacover")))

view(environ_mod)
environ_mod %>%  # check number of data points
  group_by(year, treatment) %>% 
  summarise(N_mafacover = length(mafacover), 
            N_exocover = length(nncover))
write.csv(environ_mod, "data/processed/full_environ_mod.csv")
```

------------------------------------------------------------------------

## PAR linear mixed-effects model

1.  lmer

2.  testing the residuals for normality

```{r parmod normality, include = TRUE}


# lmer model
#lme.parmod <- lmer(normalized_par ~ treatment + mafacover + site + month + (1|date) + (1|plot_number) + (1|year),
#                   data = parmod)
lme.parmod <- lmer(normalized_par ~ treatment + mafacover + site + month + nncover+ year + (1|plot_number) ,
                   data = environ_mod)
lme.parmod <- lmer(normalized_par ~  mafacover  + month + nncover+ (1|plot_number) ,
                   data = environ_mod)

MOD <- lme.parmod

# Calculate model's residual and fitted values
F1 <- fitted(MOD)
E1 <- residuals(MOD, "pearson")

# See residuals as a histogram, look for normal distribution
hist(E1)

# Graph residuals against a normal distribution, look for all points to be on 1:1 line
#need to call next two lines together
qqnorm(E1, xlab = "Theoretical Quantiles", ylab = "Pearson Residuals")
qqline(E1)

# Graph residuals vs fitted values to inspect homogeneity of variance, look for a random scattering of plots
# run together 2 lines
plot(x=F1, y=E1, xlab="Fitted Model Values", ylab="Pearson Residuals", main = "Variance")
abline(h = 0) # looking for random scatter

# Check for crazy outliers, look for lines MUCH taller than the rest of data
plot(cooks.distance(MOD))

# Plot a box plot for each factor, look for equal variance amount levels along the zero line
# Box plots need to be assessed for every fixed effect (categorical factor) for your model. 
# Random effects need the qqline just like normality. 
# So, only site and treatment get box plots. 
# MAFA cover is a covariate (continuous variable).
boxplot(E1 ~ treatment, data = parmod)
abline(h = 0)

boxplot(E1 ~ month, data = parmod)
abline(h = 0)

boxplot(E1 ~ site, data = parmod)
abline(h = 0)

boxplot(E1 ~ year, data = parmod)
abline(h = 0)

# Plot each random effect in the model - things in the (1|_), look for dots along 1:1 line
qqnorm(ranef(MOD)$plot_number[,1], main = "Plot Residuals")
qqline(ranef(MOD)$plot_number[,1]) # unique plots

```

3.  statistics

```{r parmod anova, include = TRUE}
# run together
print(lme.parmod) # print 
# fixed level effects, pvalues, etc.

anova(lme.parmod) 
# par is significant by mafa cover and month
#Type III Analysis of Variance Table with Satterthwaite's method
#           Sum Sq  Mean Sq NumDF   DenDF F value    Pr(>F)    
#treatment 0.02174 0.010868     2  33.426  0.6394 0.5339143    
#mafacover 0.25133 0.251334     1  80.455 14.7875 0.0002396 ***
#site      0.02927 0.029268     1  37.217  1.7220 0.1974680    
#month     1.77267 0.295445     6 242.617 17.3829 < 2.2e-16 ***
#nncover   0.31190 0.311903     1 115.757 18.3512 3.814e-05 ***
#year      0.00086 0.000865     1 272.537  0.0509 0.8217118    

summary(lme.parmod) # p-values
#Fixed effects:
#                Estimate Std. Error         df t value Pr(>|t|)    
#(Intercept)    4.540e-01  5.973e-02  1.407e+02   7.602 3.77e-12 ***
#treatmenthalf -4.422e-02  3.910e-02  3.388e+01  -1.131  0.26605    
#treatmentnone -2.722e-02  4.109e-02  3.610e+01  -0.663  0.51186    
#mafacover     -3.515e-03  9.140e-04  8.046e+01  -3.845  0.00024 ***
#site2          4.504e-02  3.432e-02  3.722e+01   1.312  0.19747    
#month3         2.274e-01  3.073e-02  2.426e+02   7.399 2.24e-12 ***
#month4         7.973e-02  4.346e-02  2.426e+02   1.835  0.06779 .  
#month5         1.981e-01  3.073e-02  2.426e+02   6.445 6.17e-10 ***
#month7         1.662e-01  3.073e-02  2.426e+02   5.409 1.52e-07 ***
#month9         2.115e-01  3.073e-02  2.426e+02   6.883 4.97e-11 ***
#month11        7.380e-02  3.073e-02  2.426e+02   2.402  0.01708 *  
#nncover       -3.489e-03  8.145e-04  1.158e+02  -4.284 3.81e-05 ***
#year2019       7.509e-03  3.329e-02  2.725e+02   0.226  0.82171 


```

```{r parmod posthoc, include=TRUE}
# post-hoc Tukey test
# visualize significant factors from anova(lme.parrmod)
r2(lme.parmod)
emmeans(lme.parmod, list(pairwise ~ month), adjust = "tukey") #pvaues
r.squaredGLMM(lme.parmod) 

emmip(lme.parmod, mafacover ~ month) # graph
# mafacover is 26.32... that values must be from the model

# testing the difference between slopes
parmod.interaction <- lm(normalized_par ~ mafacover * month + nncover, data = environ_mod)
anova(parmod.interaction) # p-values for the interaction
#Response: normalized_par
#                 Df Sum Sq Mean Sq F value    Pr(>F)    
#mafacover         1 1.3002 1.30023 61.4045 1.042e-13 ***
#month             6 1.7738 0.29563 13.9615 7.517e-14 ***
#nncover           1 0.9288 0.92885 43.8657 1.863e-10 ***
#mafacover:month   6 0.4314 0.07190  3.3954  0.003017 ** 
#Residuals       273 5.7807 0.02117 

summary(parmod.interaction)
#Coefficients:
#                    Estimate Std. Error t value Pr(>|t|)    
#(Intercept)        0.3862766  0.0497054   7.771 1.59e-13 ***
#mafacover         -0.0005520  0.0011464  -0.482 0.630546    
#month11            0.1821447  0.0587041   3.103 0.002118 ** 
#month3             0.3314858  0.0587041   5.647 4.10e-08 ***
#month4             0.1401540  0.0582609   2.406 0.016810 *  
#month5             0.3909382  0.0587041   6.659 1.51e-10 ***
#month7             0.3319017  0.0587041   5.654 3.95e-08 ***
#month9             0.3116276  0.0497403   6.265 1.44e-09 ***
#nncover           -0.0038419  0.0005844  -6.575 2.47e-10 ***
#mafacover:month11 -0.0036555  0.0016074  -2.274 0.023733 *  
#mafacover:month3  -0.0035133  0.0016074  -2.186 0.029691 *  
#mafacover:month4  -0.0018175  0.0023060  -0.788 0.431274    
#mafacover:month5  -0.0065078  0.0016074  -4.049 6.72e-05 ***
#mafacover:month7  -0.0055906  0.0016074  -3.478 0.000588 ***
#mafacover:month9  -0.0036851  0.0014646  -2.516 0.012440 *  
  
summary(aov(normalized_par ~ month, data = environ_mod))
TukeyHSD(aov(normalized_par ~ month, data = environ_mod))
plot(TukeyHSD(aov(normalized_par ~ month, data = environ_mod)))
#  Tukey multiple comparisons of means
#    95% family-wise confidence level#
#
#Fit: aov(formula = normalized_par ~ month, data = environ_mod)#
#
#$month
#             diff          lwr        upr     p adj
#11-1  0.073798678 -0.046899649 0.19449701 0.5384593
#3-1   0.227356081  0.106657754 0.34805441 0.0000011 <-- jan - march
#4-1   0.129940462  0.009242135 0.25063879 0.0256350 <--jan - april
#5-1   0.198055543  0.077357216 0.31875387 0.0000376 <-- jan - may
#7-1   0.166201365  0.045503038 0.28689969 0.0010983 <-- jan - july
#9-1   0.236618174  0.132090356 0.34114599 0.0000000 <-- jan - sept
#3-11  0.153557403  0.032859075 0.27425573 0.0036044 <-- nov - mar
#4-11  0.056141784 -0.064556543 0.17684011 0.8114307
#5-11  0.124256865  0.003558537 0.24495519 0.0389324 <-- nov. - may
#7-11  0.092402687 -0.028295641 0.21310101 0.2605762
#9-11  0.162819496  0.058291678 0.26734731 0.0001153 <-- nov. - sept
#4-3  -0.097415619 -0.218113946 0.02328271 0.2037021
#5-3  -0.029300538 -0.149998865 0.09139779 0.9912428
#7-3  -0.061154716 -0.181853043 0.05954361 0.7418701
#9-3   0.009262093 -0.095265725 0.11378991 0.9999723
#5-4   0.068115081 -0.052583247 0.18881341 0.6326584
#7-4   0.036260903 -0.084437425 0.15695923 0.9735310
#9-4   0.106677712  0.002149894 0.21120553 0.0420317 <-- april - sept.
#7-5  -0.031854178 -0.152552505 0.08884415 0.9863772
#9-5   0.038562631 -0.065965187 0.14309045 0.9290515
#9-7   0.070416809 -0.034111009 0.17494463 0.4165364

```

```{r parmod posthoc slope per month, include=TRUE}
# Obtain R2 slopes
parmod.interaction$coefficients
parmod.lst <- lstrends(parmod.interaction, "month", var="mafacover")
print(parmod.lst)

# Compare slopes
pairs(parmod.lst)
# normalized_par in Jan and May are sig different and Jan and July are sig different
#contrast          estimate      SE  df t.ratio p.value
# month1 - month11  0.003656 0.00173 274   2.117  0.3457
# month1 - month3   0.003513 0.00173 274   2.035  0.3954
# month1 - month4   0.001238 0.00248 274   0.500  0.9988
# month1 - month5   0.006508 0.00173 274   3.769  0.0038 <--
# month1 - month7   0.005591 0.00173 274   3.237  0.0227 <--
# month1 - month9   0.003805 0.00157 274   2.418  0.1949
# month11 - month3 -0.000142 0.00173 274  -0.082  1.0000
# month11 - month4 -0.002418 0.00248 274  -0.977  0.9587
# month11 - month5  0.002852 0.00173 274   1.652  0.6488
# month11 - month7  0.001935 0.00173 274   1.121  0.9214
# month11 - month9  0.000149 0.00157 274   0.095  1.0000
# month3 - month4  -0.002275 0.00248 274  -0.919  0.9693
# month3 - month5   0.002994 0.00173 274   1.734  0.5938
# month3 - month7   0.002077 0.00173 274   1.203  0.8926
# month3 - month9   0.000291 0.00157 274   0.185  1.0000
# month4 - month5   0.005270 0.00248 274   2.129  0.3387
# month4 - month7   0.004353 0.00248 274   1.758  0.5774
# month4 - month9   0.002567 0.00237 274   1.083  0.9328
# month5 - month7  -0.000917 0.00173 274  -0.531  0.9984
# month5 - month9  -0.002703 0.00157 274  -1.718  0.6046
# month7 - month9  -0.001786 0.00157 274  -1.135  0.9168
# P value adjustment: tukey method for comparing a family of 7 estimates 


# mean, SE: mafacover x month
parmod %>% 
  group_by(month, ) %>% 
  summarise(MEAN_normPAR=mean(normalized_par, na.rm = TRUE),
            SD = sd(normalized_par, na.rm = TRUE),
            N = length(normalized_par), 
            SE = ((sd(normalized_par, na.rm = TRUE))/sqrt(length((normalized_par))))
            )
```

```{r parmod means SD SE, include=TRUE}
# mean, SE: normpar x month
parmod %>% 
  group_by(month) %>% 
  summarise(MEAN_normPAR=mean(normalized_par, na.rm = TRUE),
            SD = sd(normalized_par, na.rm = TRUE),
            N = length(normalized_par), 
            SE = ((sd(normalized_par, na.rm = TRUE))/sqrt(length((normalized_par))))
            )
# A tibble: 7 × 5
#  month MEAN_par    SD     N     SE
#  <fct>    <dbl> <dbl> <int>  <dbl>
#1 1        0.219 0.156    36 0.0260
#2 3        0.447 0.167    36 0.0279
#3 4        0.349 0.139    36 0.0231
#4 5        0.417 0.223    36 0.0371
#5 7        0.385 0.192    36 0.0320
#6 9        0.456 0.158    72 0.0187
#7 11       0.293 0.172    36 0.0286

# mean, SE: normpar x year x month
parmod %>% 
  group_by(year, month) %>% 
  summarise(MEAN_normPAR=mean(normalized_par, na.rm = TRUE),
            SD = sd(normalized_par, na.rm = TRUE),
            N = length(normalized_par), 
            SE = ((sd(normalized_par, na.rm = TRUE))/sqrt(length((normalized_par))))
            )

# mean, SE: normpar x year x treatment
parmod %>% 
  group_by(year, treatment) %>% 
  summarise(MEAN_normPAR=mean(normalized_par, na.rm = TRUE),
            SD = sd(normalized_par, na.rm = TRUE),
            N = length(normalized_par), 
            SE = ((sd(normalized_par, na.rm = TRUE))/sqrt(length((normalized_par))))
            )

# mean, SE: normpar x treatment
parmod %>% 
  group_by(treatment) %>% 
  summarise(MEAN_normPAR=mean(normalized_par, na.rm = TRUE),
            SD = sd(normalized_par, na.rm = TRUE),
            N = length(normalized_par), 
            SE = ((sd(normalized_par, na.rm = TRUE))/sqrt(length((normalized_par))))
            )
# A tibble: 3 × 5
#  treatment MEAN_par    SD     N     SE
#  <chr>        <dbl> <dbl> <int>  <dbl>
#1 full         0.423 0.209    96 0.0214
#2 half         0.370 0.185    96 0.0189
#3 none         0.340 0.161    96 0.0164

# mean, SE: normpar x site
parmod %>% 
  group_by(site) %>% 
  summarise(MEAN_normPAR=mean(normalized_par, na.rm = TRUE),
            SD = sd(normalized_par, na.rm = TRUE),
            N = length(normalized_par), 
            SE = ((sd(normalized_par, na.rm = TRUE))/sqrt(length((normalized_par))))
            )
# A tibble: 2 × 5
#  site  MEAN_par    SD     N     SE
#  <chr>    <dbl> <dbl> <int>  <dbl>
#1 1        0.328 0.179   144 0.0149
#2 2        0.427 0.185   144 0.0154
```

```{r parmod extra stats code, include=FALSE}
# get stats on interactions
#emmeans(lme.parmod, list(pairwise ~ month), adjust = "tukey")
#emmeans(lme.parmod, list(pairwise ~ mafacover), adjust = "tukey")
#emmeans(lme.parmod, list(pairwise ~ mafacover + month), adjust = "tukey") # <--- What do these results mean?

# ordinal logistic regression
parmod$month <- as.factor(parmod$month)

ggplot(parmod, aes(x = month, y = normalized_par)) +
  geom_boxplot(size = .75) +
  geom_jitter(alpha = .5) +
 # facet_grid(site ~ year, margins = TRUE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))

# par x cover
parmod.r2 = lm(normalized_par ~ mafacover, data = parmod) 
# Extracting R-squared parameter from summary 
summary(parmod.r2)
#Coefficients:
#              Estimate Std. Error t value Pr(>|t|)    
#(Intercept)  0.4650392  0.0170491  27.276  < 2e-16 ***
#mafacover   -0.0033141  0.0005131  -6.459 4.53e-10 ***

#Residual standard error: 0.1766 on 286 degrees of freedom
#Multiple R-squared:  0.1273,	Adjusted R-squared:  0.1242 
#F-statistic: 41.71 on 1 and 286 DF,  p-value: 4.527e-10
summary(parmod.r2)$r.squared 
#[1] 0.1272865

parmod_mafacovver = lm(normalized_par ~ mafacover, data = parmod_nncover) # p is same as above
summary(parmod_mafacovver)
anova(parmod_mafacovver)

# par x nncover
parmod.nn = lm(normalized_par ~ nncover, data = parmod_nncover) 
summary(parmod.nn)
summary(parmod.nn)$r.squared 


# par x treatment
parmod.treat = aov(normalized_par ~ treatment, data = parmod) 
# Extracting R-squared parameter from summary 
summary(parmod.treat)
TukeyHSD(parmod.treat)
#Residuals:
#     Min       1Q   Median       3Q      Max 
#-0.39880 -0.13899 -0.00101  0.13941  0.43514 

#Coefficients:
#              Estimate Std. Error t value Pr(>|t|)    
#(Intercept)    0.42334    0.01900  22.283  < 2e-16 ***
#treatmenthalf -0.05365    0.02687  -1.997  0.04678 *  
#treatmentnone -0.08297    0.02687  -3.088  0.00221 ** 

#Residual standard error: 0.1861 on 285 degrees of freedom
#Multiple R-squared:  0.03327,	Adjusted R-squared:  0.02649 
#F-statistic: 4.905 on 2 and 285 DF,  p-value: 0.008051

#Fit: aov(formula = normalized_par ~ treatment, data = parmod)

#$treatment
#                 diff         lwr          upr     p adj
#half-full -0.05365265 -0.11695323  0.009647926 0.1147974
#none-full -0.08296590 -0.14626648 -0.019665321 0.0062500 <-- 
#none-half -0.02931325 -0.09261383  0.033987332 0.5204084

parmod %>% 
  group_by(treatment) %>% 
  summarize

# par x month
parmod.month = lm(normalized_par ~ month, data = parmod) 
# Extracting R-squared parameter from summary 
anova(parmod.month)
#Coefficients:
#            Estimate Std. Error t value Pr(>|t|)    
#(Intercept)  0.21923    0.02874   7.629 3.70e-13 ***
#month11      0.07380    0.04064   1.816  0.07046 .  
#month3       0.22736    0.04064   5.594 5.26e-08 ***
#month4       0.12994    0.04064   3.197  0.00155 ** 
#month5       0.19806    0.04064   4.873 1.84e-06 ***
#month7       0.16620    0.04064   4.089 5.65e-05 ***
#month9       0.23662    0.03520   6.723 9.93e-11 ***
parmod.month.may = lm(normalized_par ~ mafacover, data = parmod %>% filter((month == "5"))) 
summary(parmod.month.may)
parmod.month.july = lm(normalized_par ~ mafacover, data = parmod %>% filter((month == "7"))) 
summary(parmod.month.july)
parmod.month.jan = lm(normalized_par ~ mafacover, data = parmod %>% filter((month == "1"))) 
summary(parmod.month.jan)

anova(parmod.month)
anova(aov(normalized_par ~ month, data = parmod))
TukeyHSD(aov(normalized_par ~ month, data = parmod) )
plot(TukeyHSD(aov(normalized_par ~ month, data = parmod)))

# par x site
parmod.site = lm(normalized_par ~ site, data = parmod) 
# Extracting R-squared parameter from summary 
summary(parmod.site)
#Residuals:
#     Min       1Q   Median       3Q      Max 
#-0.40294 -0.13266 -0.00328  0.12013  0.53036 

#Coefficients:
#            Estimate Std. Error t value Pr(>|t|)    
#(Intercept)  0.32812    0.01519  21.599  < 2e-16 ***
#site2        0.09936    0.02148   4.625 5.68e-06 ***

olr.parmod <- polr(normalized_par ~ month + mafacover, data = parmod, Hess=TRUE)
summary(olr.parmod)

## view a summary of the model
summary(m)
```

4.  figures

```{r parmod figures, include=TRUE}

# boxplot: normpar x month
parbox.1 <- ggplot(data = parmod, 
       aes(x = month, y = normalized_par, color = month)) +
  labs(title = "Normalized PAR over time", x = "Month", y = "Normalized PAR") +
  geom_boxplot() +
  theme_bw() 
ggplotly(parbox.1)


# scatterplot: normpar x mafacover
parscatter.6 <- ggplot(data = environ_mod, aes(x = mafacover, y = normalized_par)) + 
  geom_point() +
labs(title = "Normalized PAR by Mature Shrub cover (%)", x = "MAFA cover (%)", y = "Nomalized PAR") + 
  geom_smooth()+
  theme_bw()
ggplotly(parscatter.6)

# scatterplot: normpar x nncover
parscatter.7 <- ggplot(data = environ_mod, aes(x = nncover, y = normalized_par)) + 
  geom_point() +
labs(title = "Normalized PAR by Non-native cover (%)", x = "Non-native cover (%)", y = "Nomalized PAR") +
  geom_smooth()+
  theme_bw()
ggplotly(parscatter.7)
parscatter.6+parscatter.7

plot3D(environ_mod$mafacover, environ_mod$nncover, environ_mod$normalized_par, colvar = NULL, pch = 16,
          xlab = "Shrub Cover (%)", ylab = "Non-Native Cover (%)", zlab = "Sunlight",
          theta = 30, phi = 30)

scatterplot3d(environ_mod$mafacover, environ_mod$nncover, environ_mod$normalized_par,
              xlab = "Shrub Cover (%)", ylab = "Non-Native Cover (%)", zlab = "Sunlight",
              color = "blue", pch = 16, angle = 55)

plot3D:: (environ_mod$mafacover, environ_mod$nncover, environ_mod$normalized_par, col = "blue",
       xlab = "Shrub Cover (%)", ylab = "Non-Native Cover (%)", zlab = "Sunlight",
       type = "s", size = 1)

# par in winter
winter_par <- ggplot(environ_mod %>% filter(month =="1" | month == "11" ), aes(x = mafacover, y = normalized_par)) +
  geom_point(aes(color = mafacover, y = normalized_par), shape = 16) +
  geom_smooth( se = FALSE, color = "forestgreen", formula = y ~ x) + 
  geom_point(aes(x = nncover), shape = 16) +
  geom_smooth(aes(x = nncover, y = normalized_par),  se = FALSE, color = "gold", formula = y ~ x) +
  labs(x = "Percent cover (%)", y = "Normalized PAR in winter", color = "Legend") +
  #scale_color_manual(values = c(mafacover = "blue", nncover = "green")) +
  theme_minimal()

# par in spring/summer
spring_par <- ggplot(environ_mod %>% filter(month =="5" | month == "7" ), aes(x = mafacover, y = normalized_par)) +
  geom_point(aes(color = mafacover, y = normalized_par), shape = 16) +
  geom_smooth( se = FALSE, color = "forestgreen", formula = y ~ x) + 
  geom_point(aes(x = nncover), shape = 16) +
  geom_smooth(aes(x = nncover, y = normalized_par),  se = FALSE, color = "gold", formula = y ~ x) +
  labs(x = "Percent cover (%)", y = "Normalized PAR in spring", color = "Legend") +
  #scale_color_manual(values = c(mafacover = "blue", nncover = "green")) +
  theme_minimal()

winter_par+spring_par  
  
  $mafacover, environ_mod$normalized_par, pch = 16, col =  "blue", xlab = "Cover (%)", ylab = "Normalized PAR", main = "Normalized PAR by Shrub cover and Non-native cover") 
points(environ_mod$nncover, environ_mod$normalized_par, pch = 16, col = "green") 
legend("topright", legend = c("Shrub Cover", "Grass Cover"), col = c("blue", "green"), pch = 16)


# scatterplot: normpar x mafacover (%) x month
parscatter.2 <- ggplot(data = parmod, aes(x = mafacover, y = normalized_par)) + 
  geom_point(aes(color = month)) +
  labs(title = "Normalized PAR by MAFA cover (%)", x = "MAFA canopy cover (%)", y = "Normalized PAR") +
  geom_smooth(method="lm", se = FALSE, fullrange = TRUE, 
             aes(color=month)) +
  theme_bw()
ggplotly(parscatter.2)

environ_mod_bycovertype <- read_csv("data/environ_mod_bycovertype.csv") 
parscatter.8 <-  ggplot(data = environ_mod_bycovertype, aes(x = percent_cover, y = normalized_par, col = cover_type)) + 
  geom_point() +
labs(title = "Normalized PAR by Shrub and Non-native cover (%)", x = "Percent Cover (%)", y = "Nomalized PAR") +
  geom_smooth(method="lm")+
  theme_bw()
print(parscatter.8)
```

```{r parmod additional figures, include=TRUE}
# scatterplot: normpar x date per treatment
parscatter.1 <- ggplot(data = parmod, aes(x = date, y = normalized_par)) + 
  geom_point(aes(color = treatment)) +
  scale_color_manual(values=c(treatmentcolors)) +
labs(title = "Normalized PAR over time", x = "Date", y = "Nomalized PAR") +
  geom_smooth(method="lm")+
  theme_bw()
ggplotly(parscatter.1)

# scatterplot: PAR x month <-- make site not continuous
parscatter.5 <- ggplot(data = parmod, aes(x = date, y = normalized_par)) + 
  geom_point(aes(color = site)) +
  scale_color_manual(values=c(sitecolors)) +
  labs(title = "Normalized PAR over time", x = "Date", y = "Normalized PAR") +
  theme_bw() 
ggplotly(parscatter.5)

# boxplot: PAR by site x treatment <-- broken and
parbox.2 <- ggplot(data = parmod, aes(x = treatment, y = normalized_par)) +
  geom_boxplot(aes(color = treatment)) +
  scale_color_manual(values=c(treatmentcolors)) +
  labs(title = "Normalized PAR over time", x = "MAFA canopy cover (%)", y = "Date") +
  theme_bw() 
ggplotly(parbox.2)


# scatterplot: PAR x mafacover x treatment <-- use treatmentcolor instead of default
parscatter.3 <- ggplot(data = parmod, aes(x = mafacover, y = normalized_par)) + 
  geom_point(aes(color = treatment)) +
  scale_color_manual(values=c(treatmentcolors)) +
  labs(title = "Normalized PAR by MAFA cover (%) and Treatment", x = "MAFA canopy cover (%)", y = "PAR") +
  theme_bw()
ggplotly(parscatter.3)

# scatterplot: PAR x mafacover x site <-- make site not continuous & use sitecolor instead of default
parscatter.4 <- ggplot(data = parmod, aes(x = mafacover, y = normalized_par)) + 
  geom_point(aes(color = site)) +
  scale_color_manual(values=c(sitecolors)) +
  labs(title = "Normalized PAR by MAFA cover (%) and Site", x = "MAFA canopy cover (%)", y = "PAR") +
  theme_bw() 
ggplotly(parscatter.4)

```


------------------------------------------------------------------------

## TDR linear mixed-effects model

1.  lmer
2.  testing the residuals for normality

```{r tdrmod test for normality, include = TRUE}

lme.tdrmod <- lmer(soil_moisture ~ treatment + mafacover + site  + month + nncover  +(1|plot_number) , 
                   data = tdrmod_nncover)

MOD <- lme.tdrmod

# Calculate model's residual and fitted values
F1 <- fitted(MOD)
E1 <- residuals(MOD, "pearson")

# See residuals as a histogram, look for normal distribution
hist(E1)

# Graph residuals against a normal distribution, look for all points to be on 1:1 line
#need to call next two lines together
qqnorm(E1, xlab = "Theoretical Quantiles", ylab = "Pearson Residuals")
qqline(E1)

# Graph residuals vs fitted values to inspect homogeneity of variance, look for a random scattering of plots
# run together 2 lines
plot(x=F1, y=E1, xlab="Fitted Model Values", ylab="Pearson Residuals", main = "Variance")
abline(h = 0) # looking for random scatter

# Check for crazy outliers, look for lines MUCH taller than the rest of data
plot(cooks.distance(MOD))

# Plot a box plot for each factor, look for equal variance amount levels along the zero line
# Box plots need to be assessed for every fixed effect (categorical factor) for your model. 
# Random effects need the qqline just like normality. 
# So, only site and treatment get box plots. 
# MAFA cover is a covariate (continuous variable).
boxplot(E1 ~ treatment, data = tdrmod)
abline(h = 0)

boxplot(E1 ~ site, data = tdrmod)
abline(h = 0)

boxplot(E1 ~ month, data = tdrmod)
abline(h = 0)

# Plot each random effect in the model, look for dots along 1:1 line
qqnorm(ranef(MOD)$plot_number[,1], main = "Plot Residuals")
qqline(ranef(MOD)$plot_number[,1])
```

3.  statistics

```{r tdrmod stats, include = TRUE}

# print 
print(lme.tdrmod)

anova(lme.tdrmod) # A significant p-value indicates that one or more significant differences 
#Type III Analysis of Variance Table with Satterthwaite's method
#          Sum Sq Mean Sq NumDF  DenDF  F value    Pr(>F)    
#treatment   79.3   39.65     2 36.033   7.4954 0.0018977 ** 
#mafacover    2.2    2.23     1 82.716   0.4221 0.5177001    
#site        97.3   97.34     1 41.271  18.4008 0.0001053 ***
#month     3704.8 1852.41     2 81.864 350.1884 < 2.2e-16 ***
#nncover     15.7   15.71     1 89.619   2.9706 0.0882366 .  

summary(lme.tdrmod)
#Fixed effects:
#               Estimate Std. Error        df t value Pr(>|t|)    
#(Intercept)    26.98241    1.27198  79.10862  21.213  < 2e-16 ***
#treatmenthalf  -1.32295    0.85992  36.15962  -1.538 0.132644    
#treatmentnone  -3.51618    0.93338  40.52520  -3.767 0.000526 ***
#mafacover       0.01694    0.02608  82.71644   0.650 0.517700    
#site2          -3.24325    0.75607  41.27106  -4.290 0.000105 ***
#month3         -3.84277    0.65403  89.71482  -5.875 7.06e-08 ***
#month4        -14.05069    0.54210  68.91046 -25.919  < 2e-16 ***
#nncover        -0.03718    0.02157  89.61930  -1.724 0.088237 .   


```

```{r tdrmod posthoc, include=TRUE}

# visualize significant factors from anova(lme.tdrmod)
emmip(lme.tdrmod, treatment ~ year)
# emmip(lme.tdrmod, month ~ treatment | site)

tdrmod.mafacover <- lm(soil_moisture ~ mafacover, data = tdrmod_nncover %>%  filter(year == "2019"))
anova(tdrmod.mafacover)
summary(tdrmod.mafacover)

tdrmod.nn <- lm(soil_moisture ~ nncover, data = tdrmod_nncover %>% filter(year == "2019"))
anova(tdrmod.nn)
summary(tdrmod.nn)

tdrmod.site <- lm(soil_moisture ~ site, data = tdrmod_nncover)
tdrmod.site <- lm(soil_moisture ~ site, data = tdrmod_nncover %>%  filter(year == "2019"))
anova(tdrmod.site)
summary(tdrmod.site)

tdrmod.treat <- aov(soil_moisture ~ treatment, data = tdrmod_nncover)
tdrmod.treat <- aov(soil_moisture ~ treatment, data = tdrmod_nncover %>%  filter(year == "2019"))
anova(tdrmod.treat)
summary(tdrmod.treat)
TukeyHSD(tdrmod.treat)

# stats on site treatment interactions
tdrmod.interaction <- lm(soil_moisture ~ site*treatment, data = tdrmod_nncover)
anova(tdrmod.interaction) # p-values for the interaction
#Response: soil_moisture
#                Df Sum Sq Mean Sq F value  Pr(>F)   
#site             1  344.6  344.57  7.7568 0.00638 **
#treatment        2  154.9   77.45  1.7434 0.18009   
#site:treatment   2    4.6    2.29  0.0516 0.94971   

# For TDR and nn cover, the significant plots may explain results we see later, but the fact that there are 2-3 plots that are significantly different from each other doesn't tell us the sites or treatments are significantly different from each other. 

# stats on individual plots: emmeans
emmeans(lme.tdrmod, list(pairwise ~ site*treatment), adjust = "tukey")
#lsmeans(lme.tdrmod, pairwise~site*treatment, adjust="tukey") # emmeans and lsmeans give the same results

#$`pairwise differences of site, treatment`
# 1                           estimate    SE   df t.ratio p.value
# site1 full - site2 full        3.939 0.875 50.9   4.500  0.0005
# site1 full - site1 half        0.871 0.833 35.3   1.045  0.8991
# site1 full - site2 half        4.810 1.076 36.6   4.472  0.0010
# site1 full - site1 nonene      3.172 0.930 41.2   3.411  0.0171
# site1 full - site2 nonene      7.111 1.063 36.2   6.690  <.0001
# site2 full - site1 half       -3.068 1.328 47.5  -2.311  0.2101
# site2 full - site2 half        0.871 0.833 35.3   1.045  0.8991
# site2 full - site1 nonene     -0.767 1.460 52.1  -0.525  0.9949
# site2 full - site2 nonene      3.172 0.930 41.2   3.411  0.0171
# site1 half - site2 half        3.939 0.875 50.9   4.500  0.0005
# site1 half - site1 nonene      2.302 0.798 33.0   2.883  0.0688
# site1 half - site2 nonene      6.241 1.098 37.6   5.684  <.0001
# site2 half - site1 nonene     -1.637 1.266 45.0  -1.294  0.7869
# site2 half - site2 nonene      2.302 0.798 33.0   2.883  0.0688
# site1 nonene - site2 nonene    3.939 0.875 50.9   4.500  0.0005

# tdr by month
tdrmod_nncover_bymonth <- aov(soil_moisture ~ month, data = tdrmod_nncover)
anova(tdrmod_nncover_bymonth)
TukeyHSD(aov(soil_moisture ~ month, data = tdrmod_nncover))
```

```{r tdrmod means SD SE, include = TRUE}

# mean, SE: tdr x treatment
tdrmod_nncover %>% 
  group_by(treatment) %>% 
  summarise(MEAN_tdr = mean(soil_moisture, na.rm = TRUE),
            SD = sd(soil_moisture, na.rm = TRUE),
            N = length(soil_moisture), 
            SE = ((sd(soil_moisture, na.rm = TRUE))/sqrt(length((soil_moisture))))
  )
# A tibble: 3 × 5
#  treatment MEAN_tdr    SD     N    SE
#  <chr>        <dbl> <dbl> <int> <dbl>
#1 full          17.9  7.31    36 1.22 
#2 half          17.3  7.11    36 1.19 
#3 nonene        15.1  5.95    36 0.992
            
# mean, SE: tdr x treatment in 2019
tdrmod_nncover %>% 
  filter(year == "2019") %>% 
  group_by(month, treatment) %>% 
  summarise(MEAN_tdr_2019 = mean(soil_moisture, na.rm = TRUE),
            SD = sd(soil_moisture, na.rm = TRUE),
            N = length(soil_moisture), 
            SE = ((sd(soil_moisture, na.rm = TRUE))/sqrt(length((soil_moisture))))
  )
# mean, SE: tdr x site
tdrsite_mean <- tdrmod_nncover %>% 
  group_by(site) %>% 
  summarise(MEAN_tdr=mean(soil_moisture, na.rm = TRUE),
            SD = sd(soil_moisture, na.rm = TRUE),
            N = length(soil_moisture), 
            SE = ((sd(soil_moisture, na.rm = TRUE))/sqrt(length((soil_moisture))))
            )
# A tibble: 2 × 5
#  site  MEAN_par    SD     N    SE
#  <chr>    <dbl> <dbl> <int> <dbl>
#1 1         18.5  7.07    54 0.962
#2 2         15.0  6.20    54 0.844

# mean, SD, SE for tdrmod x site x treatment interaction
tdrmod_nncover %>% 
  group_by(site, treatment) %>% 
  summarise(MEAN_tdr=mean(soil_moisture, na.rm = TRUE),
            SD = sd(soil_moisture, na.rm = TRUE),
            N = length(soil_moisture), 
            SE = ((sd(soil_moisture, na.rm = TRUE))/sqrt(length((soil_moisture))))
            )
# A tibble: 6 × 6
# Groups:   site [2]
#  site  treatment MEAN_tdr    SD     N    SE
#  <chr> <chr>        <dbl> <dbl> <int> <dbl>
#1 1     full          20.0  7.45    18  1.76
#2 1     half          18.9  7.46    18  1.76
#3 1     nonene        16.7  6.24    18  1.47
#4 2     full          15.8  6.74    18  1.59
#5 2     half          15.6  6.53    18  1.54
#6 2     nonene        13.5  5.33    18  1.26

```

```{r tdrmod additional stats, include=TRUE}

# TDR by Site and Treatment
# tdrmod$site  <- as.factor(tdrmod$site) # to make site a factor
tdrmod_site_treat <- aov(soil_moisture ~ site*treatment, data = tdrmod_nncover) 
anova(tdrmod_site_treat)
TukeyHSD(tdrmod_site_treat)
plot(TukeyHSD(tdrmod_site_treat))
# 2:none-1:full -6.4912037 -12.944263 -0.03814456 0.0477765

# TDR by Site <-- why does this say site is sig when it wasn't before?
tdrmod_site <- aov(soil_moisture ~ site, data = tdrmod_nncover) 
anova(tdrmod_site)
# site        1  344.6  344.57  7.7869 0.006242 **

tdrmod_treat <- aov(soil_moisture ~ treatment, data = tdrmod_nncover) 
anova(tdrmod_treat)
# treatment   2  154.9  77.446  1.6663 0.1939
 
# For TDR and nn cover, the significant plots may explain results we see later, but the fact that there are 2-3 plots that are significantly different from each other doesn't tell us the sites or treatments are significantly different from each other. 


```

4.  figures

```{r tdrmod figures, include=TRUE}
# boxplot: tdr mean and SD by site "+"
tdrbox.4 <- ggplot(data = tdrsite_mean, aes(x = site, y = MEAN_tdr)) + 
  geom_boxplot(aes(lower=MEAN_tdr, upper=MEAN_tdr, middle=MEAN_tdr, ymin=MEAN_tdr-SE, ymax=MEAN_tdr+SE), stat="identity") +
  labs(title = "Average Soil Moisture by Site", x = "Site", y = "Average Soil Moisture (%)")
tdrbox.4

# boxplot: tdr mean and SD by site "square"
tdrbox.5 <- ggplot(data = tdrsite_mean, aes(x = site, y = MEAN_tdr)) + 
  geom_boxplot(aes(lower=MEAN_tdr-SE, upper=MEAN_tdr+SE, middle=MEAN_tdr, ymin=MEAN_tdr-SE, ymax=MEAN_tdr+SE), stat="identity") +
  labs(title = "Average Soil Moisture by Site", x = "Site", y = "Average Soil Moisture (%)")
tdrbox.5

# boxplot: tdr x treatment (continuous x categorical)
tdrbox.3 <- ggplot(data = tdrmod_nncover, aes(x = treatment, y = soil_moisture)) +
  geom_boxplot(aes(fill = treatment)) +
  scale_fill_manual(values = c('#F6EECF', '#B09175', '#291611')) +
  labs(title = "Soil Moisture by Site", x = "MAFA canopy treatment", y = "Soil Moisture (%)") +
  theme_bw() 
ggplotly(tdrbox.3) %>% layout(boxmode = "group")

# boxplot: tdr x site (continuous x categorical)
tdrbox.2 <- ggplot(data = tdrmod_nncover, aes(x = site, y = soil_moisture)) +
  geom_boxplot(aes(fill = site)) +
  scale_fill_manual(values = c('#F6EECF', '#B09175', '#291611')) +
  labs(title = "Soil Moisture by Site", x = "Site", y = "Soil Moisture (%)") +
  theme_bw() 
ggplotly(tdrbox.2) #%>% layout(boxmode = "group")

# boxplot: tdr x site x treatment (continuous x categorical x categorical)
tdrbox.1 <- ggplot(data = tdrmod_nncover, aes(x = site, y = soil_moisture)) +
  geom_boxplot(aes(fill = treatment)) +
  scale_fill_manual(values = c('#F6EECF', '#B09175', '#291611')) +
  labs(title = "Soil Moisture by Site and Treatment", x = "Site", y = "Soil Moisture (%)") +
  theme_bw() 
ggplotly(tdrbox.1) %>% layout(boxmode = "group")
```

```{r tdrmod extra figures, include = TRUE}

# scatterplot: tdr x mafacover 
tdrscatter <- ggplot(data = tdrmod_nncover, aes(x = mafacover, y = soil_moisture)) + 
  geom_point(aes(color = site)) +
  scale_color_manual(values=c(sitecolors)) +
  labs(title = "Soil Moisture by Site and Treatment", x = "Site", y = "Soil Moisture (%)") +
  geom_smooth(method="lm", color = "#291611")+
  theme_bw()
ggplotly(tdrscatter)

```

------------------------------------------------------------------------

## Non-native cover linear mixed-effects model

1.  lmer
2.  testing the residuals for normality

```{r nnmod test for normality, include = TRUE}

#need to convert df to a tibble
#as_tibble(nnmod)
#print(nn)
#names(nnmod)
#print(nnmod)
#str(nnmod)
lme.nnmod <- lmer(nncover ~ treatment + mafacover + site  + soil_moisture + normalized_par+ (1|plot_number) +(1|year), # no month column, year = month
                   data = nnmod_environ) 

MOD <- lme.nnmod

# Calculate model's residual and fitted values
F1 <- fitted(MOD)
E1 <- residuals(MOD, "pearson")

# See residuals as a histogram, look for normal distribution
hist(E1)

# Graph residuals against a normal distribution, look for all points to be on 1:1 line
#need to call next two lines together
qqnorm(E1, xlab = "Theoretical Quantiles", ylab = "Pearson Residuals")
qqline(E1)

# Graph residuals vs fitted values to inspect homogeneity of variance, look for a random scattering of plots
# run together 2 lines
plot(x=F1, y=E1, xlab="Fitted Model Values", ylab="Pearson Residuals", main = "Variance")
abline(h = 0) # looking for random scatter

# Check for crazy outliers, look for lines MUCH taller than the rest of data
plot(cooks.distance(MOD))

# Plot a box plot for each factor, look for equal variance amount levels along the zero line
# Box plots need to be assessed for every fixed effect (categorical factor) for your model. 
# Random effects need the qqline just like normality. 
# So, only site and treatment get box plots. 
# MAFA cover is a covariate (continuous variable).
boxplot(E1 ~ treatment, data = nnmod)
abline(h = 0)

boxplot(E1 ~ site, data = nnmod)
abline(h = 0)


# Plot each random effect in the model, look for dots along 1:1 line
qqnorm(ranef(MOD)$plot_number[,1], main = "Plot Residuals")
qqline(ranef(MOD)$plot_number[,1])

qqnorm(ranef(MOD)$year[,1], main = "Plot Residuals")
qqline(ranef(MOD)$year[,1])
```

3.  statistics

```{r nnmod stats, include=TRUE}
# print 
print(lme.nnmod)

anova(lme.nnmod) # A significant p-value indicates that one or more significant differences exist between group means.
#Type III Analysis of Variance Table with Satterthwaite's method
#                Sum Sq Mean Sq NumDF  DenDF F value    Pr(>F)    
#treatment       758.58  379.29     2 36.908  3.5175 0.0399719 *  
#mafacover       782.80  782.80     1 58.283  7.2597 0.0091976 ** 
#site            166.73  166.73     1 48.399  1.5462 0.2196847    
#soil_moisture   490.05  490.05     1 53.361  4.5447 0.0376430 *  
#normalized_par 1593.30 1593.30     1 64.397 14.7762 0.0002797 ***

summary(lme.nnmod)
#Fixed effects:
#               Estimate Std. Error       df t value Pr(>|t|)    
#(Intercept)     84.9549    16.1816   2.8850   5.250  0.01483 *  
#treatmenthalf  -11.5685     4.3839  35.0804  -2.639  0.01232 *  
#treatmentnone   -9.2519     5.1371  44.5200  -1.801  0.07848 .  
#mafacover       -0.3499     0.1299  58.2831  -2.694  0.00920 ** 
#site2           -5.5159     4.4359  48.3991  -1.243  0.21968    
#soil_moisture   -1.2028     0.5642  53.3613  -2.132  0.03764 *  
#normalized_par -33.8881     8.8159  64.3967  -3.844  0.00028 ***
```

```{r nnmod posthoc, include=TRUE}
# visualize significant factors from anova(lme.tdrmod)
emmip(lme.nnmod, treatment ~ site)
# emmip(lme.tdrmod, month ~ treatment | site)

# convert from character to number
# nnmod$year <- as.numeric(nnmod$year)
# nnmod$site <- as.numeric(nnmod$site)

# convert from number to character
#nnmod$year <- as.character(nnmod$year)
#nnmod$site <- as.character(nnmod$site)
#nnmod$treatment <- as.character(nnmod$treatment)

# get stats on interactions
emmeans(lme.tdrmod, pairwise~year, adjust="tukey")
# year is NOT significant p=0.3811

#lsmeans(lme.tdrmod, pairwise~site*treatment, adjust="tukey") # emmeans and lsmeans give the same results
```

```{r nnmod mean SD SE, include=TRUE}

nnmod %>% 
  group_by(year) %>% 
  summarise(mean_nncover=mean(nncover, na.rm = TRUE),
            sd_nncover = sd(nncover, na.rm = TRUE), 
            N = length(nncover),
            SE_nncover=((sd(nncover, na.rm = TRUE))/sqrt(length((nncover))))
            )
# A tibble: 2 × 5
#  year  mean_nncover sd_nncover     N SE_nncover
#  <chr>        <dbl>      <dbl> <int>      <dbl>
#1 2018          36.0       12.9    36       2.16
#2 2019          39.2       16.6    36       2.76

nnmod %>% 
  group_by(treatment) %>% 
  summarise(mean_nncover=mean(nncover, na.rm = TRUE),
            sd_nncover = sd(nncover, na.rm = TRUE), 
            N = length(nncover),
            SE_nncover=((sd(nncover, na.rm = TRUE))/sqrt(length((nncover))))
            )
```

```{r nnmod - additional stats, include=TRUE}
# non-native cover by treatment
nnmod_treat <- aov(nncover ~ treatment, data = nnmod) 
nnmod_treat <- aov(nncover ~ treatment, data = na.omit(environ_mod))
anova(nnmod_treat)
TukeyHSD(nnmod_treat)
plot(TukeyHSD(nnmod_treat))

# nn by normPAR
nnmod_normpar <- lm(nncover ~ normalized_par, data = na.omit(environ_mod))
anova(nnmod_normpar)
summary(nnmod_normpar)

# nn by soilmoisture
nnmod_treat <- aov(nncover ~ treatment, data = na.omit(environ_mod))
anova(nnmod_treat)
TukeyHSD(nnmod_treat)
plot(TukeyHSD(nnmod_treat))

# non-native cover by treatment and site
nnmod_treat_site <- aov(nncover ~ treatment*site, data = nnmod) 
anova(nnmod_treat_site)
TukeyHSD(nnmod_treat_site)
plot(TukeyHSD(nnmod_treat_site))

# For TDR and nn cover, the significant plots may explain results we see later, but the fact that there are 2-3 plots that are significantly different from each other doesn't tell us the sites or treatments are significantly different from each other. 
```

4.  figures

```{r nnmod figures, include=TRUE}

# nnmod$site = as.factor(nnmod$site)

# boxplot: nncover x year
nnbox.1 <- ggplot(data = nnmod, aes(x = year, y = nncover)) + 
  geom_boxplot(aes(fill = year)) +
  scale_fill_manual(values = c('#F19B34', '#92A587')) +
 # scale_fill_manual(values = c('#F6EECF', '#B09175', '#291611')) +
  labs(title = "Non-native cover by Site and Treatment", x = "Site", y = "Non-native cover (%)") +
  geom_smooth(method="lm") +
  theme_bw()
ggplotly(nnbox.1)

# boxplot: nncover x site x treatment (no correlation)
nnmod$site = as.factor(nnmod$site)
nnbox.2 <- ggplot(data = nnmod, aes(x = site, y = nncover)) + 
  geom_boxplot(aes(fill = treatment)) +
 # scale_fill_manual(values = c('#F19B34', '#9F7E75', '#92A587')) +
  scale_fill_manual(values = c('#F6EECF', '#B09175', '#291611')) +
  labs(title = "Non-native cover by Site and Treatment", x = "Site", y = "Non-native cover (%)") +
  geom_smooth(method="lm") +
  theme_bw()
ggplotly(nnbox.2) %>% layout(boxmode = "group")

# boxplot: mafacover x treatment x site (no correlation)
nnbox.3 <- ggplot(data = nnmod, aes(x = treatment, y = nncover)) + 
  geom_boxplot(aes(fill = site)) +
  geom_smooth(method="lm") +
  labs(title = "Non-native cover by Treatment and Site", x = "Treatment", y = "Non-native cover (%)") +
  scale_fill_manual(values = c(sitecolors)) +
  # scale_fill_manual(values = c('#D3E3CA', '#92A587')) +
  theme_bw()
ggplotly(nnbox.3) %>% layout(boxmode = "group")

# scatterplot: nncover x mafacover (no correlation)
nnscatter.1 <- ggplot(data = nnmod, aes(x = mafacover, y = nncover)) + 
  geom_point() +
  geom_smooth(method="lm")+
  theme_bw()
ggplotly(nnscatter.1)

nncover_mafacover.lm <- lm( nncover ~ mafacover, data = na.omit(environ_mod))
summary(nncover_mafacover.lm)
MOD <- nncover_mafacover.lm 
r2(MOD)

# nn x normPAR
nnscatter.2 <- ggplot(data = na.omit(environ_mod), aes(x = normalized_par, y = nncover)) + 
  geom_point() +
  geom_smooth(method="lm")+
  theme_bw()
ggplotly(nnscatter.2)

nncover_normpar.lm <- lm( nncover ~ normalized_par, data = na.omit(environ_mod))
summary(nncover_normpar.lm)
MOD <- nncover_normpar.lm 
r2(MOD)

# nn x soilmoisture
nncover_soilmoisture.lm <- lm( nncover ~ soil_moisture, data = na.omit(environ_mod))
summary(nncover_soilmoisture.lm)
MOD <- nncover_soilmoisture.lm 
r2(MOD)


# nncover x treatment
nncover_treat.lm <- aov( nncover ~ treatment, data = na.omit(environ_mod) )
summary(nncover_treat.lm)
TukeyHSD(nncover_treat.lm)

# nncover x site
nncover_site.lm <- lm( nncover ~ site, data = na.omit(environ_mod))
summary(nncover_site.lm)

environ_mod %>%  
  na.omit() %>% 
  group_by(year, site) %>% 
  summarize(avg_nncover = mean(nncover), 
            SD = sd(nncover),
            N = length(nncover), 
            SE = ((sd(nncover))/sqrt(length((nncover)))))
```

### Non-native grass height and density
```{r explore nngrass height, include=TRUE}

nngrass2018_cover_height %>%  
  group_by(treatment) %>% 
  summarize(avg_grassheight_cm = mean(nn_grassheight_cm), 
            SD = sd(nn_grassheight_cm),
            N = length(nn_grassheight_cm), 
            SE = ((sd(nn_grassheight_cm))/sqrt(length((nn_grassheight_cm)))))
# A tibble: 3 × 5=
#  treatment avg_grassheight_cm    SD     N    SE
#  <chr>                  <dbl> <dbl> <int> <dbl>
#1 full                    20.5  8.18    60 1.06 
#2 half                    16.6  7.46    60 0.963
#3 none                    19.3  8.77    60 1.13 

# grass height by TREATMENT
nnheightboxplot.1 <- ggplot(data = nngrass2018_cover_height, aes(x = treatment, y = nn_grassheight_cm)) + 
  geom_boxplot() 
ggplotly(nnheightboxplot.1) %>% layout(boxmode = "group")

height_treatment_aov <- aov(nn_grassheight_cm ~ treatment, data = nngrass2018_cover_height)
summary(height_treatment_aov)
#             Df Sum Sq Mean Sq F value Pr(>F)  
#treatment     2    481   240.6   3.618 0.0288 * <-- treatment
#Residuals   177  11770    66.5  

TukeyHSD(height_treatment_aov) 
#             diff        lwr        upr     p adj
#half-full -3.9050 -7.4239875 -0.3860125 0.0255544 <-- half and full removal
#none-full -1.1825 -4.7014875  2.3364875 0.7070506
#none-half  2.7225 -0.7964875  6.2414875 0.1632428
plot(TukeyHSD(height_treatment_aov))


# grass height x MAFA PERCENT COVER
nnheightscatter.1 <- ggplot(data = nngrass2018_cover_height, aes(x = MAFA_coverpercent, y = nn_grassheight_cm)) +
         geom_point(aes(color = site)) +
  labs(title = "MAFA cover (%) by Non-native grass height (cm) and Treatment", x = "MAFA cover (%)", y = "Non-native grass height (cm)") +
  geom_smooth(method="lm", color = "#291611")+
  theme_bw()
ggplotly(nnheightscatter.1)

height_mafacover_aov <- aov(nn_grassheight_cm ~ MAFA_coverpercent, data = nngrass2018_cover_height)
summary(height_mafacover_aov)
#                   Df Sum Sq Mean Sq F value   Pr(>F)    
#MAFA_coverpercent   1   2386  2386.2   43.05 5.61e-10 *** <-- 
#Residuals         178   9865    55.4    

nnheightscatter.2 <- ggplot(data = nngrass2018_cover_height, aes(x = exo_coverpercent, y = nn_grassheight_cm)) +
         geom_point(aes(color = treatment)) +
  labs(title = "Exotic cover (%) by Non-native grass height (cm) and Treatment", x = "Exotic cover (%)", y = "Non-native grass height (cm)") +
  geom_smooth(method="lm", color = "#291611")+
  theme_bw()
ggplotly(nnheightscatter.2)



nnheightboxplot.2 <- ggplot(data = nngrass2018_cover_height, aes(x = site, y = nn_grassheight_cm)) + 
  geom_boxplot() 
ggplotly(nnheightboxplot.2) %>% layout(boxmode = "group")

```
 
```{r explore nn grass density, include=TRUE}

nngrass2018_cover_density %>%  
  group_by (treatment) %>% 
  summarize(mean_total_density_200cm2 = mean(total_density_200cm2), 
            SD = sd(total_density_200cm2),
            N = length(total_density_200cm2), 
            SE = ((sd(total_density_200cm2))/sqrt(length((total_density_200cm2)))))
# A tibble: 3 × 5
#  treatment mean_total_density_200cm2    SD     N    SE
#  <chr>                         <dbl> <dbl> <int> <dbl>
#1 full                           78.5  49.9    36  8.31
#2 half                           55.5  37.1    36  6.19
#3 none                           47.5  39.1    36  6.51

density_plot <- nngrass2018_cover_density %>%  
  group_by (treatment, plot_number) %>% 
  summarize(mean_total_density_200cm2 = mean(total_density_200cm2), 
            SD = sd(total_density_200cm2),
            N = length(total_density_200cm2), 
            SE = ((sd(total_density_200cm2))/sqrt(length((total_density_200cm2)))))
print(n = 36, density_plot)

# grass density by TREATMENT
nndensity_boxplot.1 <- ggplot(data = nngrass2018_cover_density, aes(x = treatment, y = total_density_200cm2)) + 
  geom_boxplot() 
ggplotly(nndensity_boxplot.1) %>% layout(boxmode = "group")

density_treatment_aov <- aov(total_density_200cm2 ~ treatment * as.numeric(plot_number), data = nngrass2018_cover_density)
summary(density_treatment_aov)
#                                   Df Sum Sq Mean Sq F value  Pr(>F)   
#treatment                           2  18668    9334   5.474 0.00552 **
#as.numeric(plot_number)             1   4837    4837   2.837 0.09517 . 
#treatment:as.numeric(plot_number)   2  10000    5000   2.933 0.05777 . 
#Residuals                         102 173912    1705                   
density_treatment_aov.1 <- aov(total_density_200cm2 ~ treatment + (1|as.numeric(plot_number)), data = nngrass2018_cover_density)
summary(density_treatment_aov.1)

TukeyHSD(density_treatment_aov.1) # non-factors ignored
#$treatment
#                diff       lwr         upr     p adj
#half-full -23.055556 -46.20362  0.09250669 0.0511631
#none-full -31.000000 -54.14806 -7.85193775 0.0054071 <-- none and full removal
#none-half  -7.944444 -31.09251 15.20361781 0.6938364
#plot(TukeyHSD(density_treatment_aov))


# nn grass density x MAFA PERCENT COVER
nnden_scatter.1 <- ggplot(data = nngrass2018_cover_density, aes(x = MAFA_coverpercent, y = total_density_200cm2)) +
         geom_point(aes(color = site)) +
  labs(title = "MAFA cover (%) by Non-native grass density (#/200cm2) and Treatment", x = "MAFA cover (%)", y = "Non-native grass density (#/200cm2)") +
  geom_smooth(method="lm", color = "#291611")+
  theme_bw()
ggplotly(nnden_scatter.1)

den_mafacover_aov <- aov(total_density_200cm2 ~ MAFA_coverpercent * as.numeric(plot_number), data = nngrass2018_cover_density)
den_mafacover_aov.1 <- aov(total_density_200cm2 ~ MAFA_coverpercent * (1|as.numeric(plot_number)), data = nngrass2018_cover_density)
summary(den_mafacover_aov)
#                                           Df Sum Sq Mean Sq F value  Pr(>F)   
#MAFA_coverpercent                           1   3410    3410   1.954 0.16514   
#as.numeric(plot_number)                     1  13389   13389   7.671 0.00665 ** <-- plot number
#MAFA_coverpercent:as.numeric(plot_number)   1   9097    9097   5.212 0.02446 * <-- plot number x mafa_cover
#Residuals            104 181520    1745      


nnden_scatter.2 <- ggplot(data = nngrass2018_cover_density, aes(x = exo_coverpercent, y = total_density_200cm2)) +
         geom_point(aes(color = treatment)) +
  labs(title = "Exotic cover (%) by Non-native grass density (N/200cm2) and Treatment", x = "Exotic cover (%)", y = "Non-native grass density (N/200cm2)") +
  geom_smooth(method="lm", color = "#291611")+
  theme_bw()
ggplotly(nnden_scatter.2)

nnden_boxplot.2 <- ggplot(data = nngrass2018_cover_density, aes(x = site, y = total_density_200cm2)) + 
  geom_boxplot() 
ggplotly(nnden_boxplot.2) %>% layout(boxmode = "group")

```
 
------------------------------------------------------------------------

# Question 1: Take aways

### PAR

-   PAR is significantly correlated with MAFA cover and month and mafacover*month.
-   PAR is not correlated with treatment, year, or site.
-   The slope of par x mafa cover is significantly different in May and July than January.
-   More canopy cover does mean more shade, and less canopy cover means more sun.


### TDR

-   soil moisture is significantly correlated with site 
-   There are no effects of treatment, MAFA canopy cover, year, or month on soil moisture.
-   Soil moisture is significantly greater at Site 1 than at Site 2 
- Soil moisture is significantly greater at some plots vs others (e.g., full removal at Site 1 has more soil moisture than full removal at Site 2) but the trends are not consistant, hence no significant difference by treatment or treatment*site.

### Non-native cover

-   Non-native cover is not correlated with Treatment, Site, MAFA cover (%), or year.
-   This could be because we measured non-native cover once a year at peak biomass/peak growth in May-June and % cover is a 2D metric 
- We collected density and grass height data within each plot in 2018 but not in 2019 and could at least discuss if there are differences between the average nn grass density or nn grass height between treatments as a way to "get at" the nn biomass or nn 3D-ness of the competition from nn grasses. 

# Question 2: How does seedling survival change by PAR, TDR, and mafacover?

Is canopy treatment or canopy cover a stronger predictor of the environmental conditions below the shrub canopy?

------------------------------------------------------------------------

# Glossary

## *df exploration*

- *dim(df)* gives you number of rows and columns in the df 
- *str(df)* gives you the structure of your dataframe 
- *names(df)* will give you the column names in the df 
- *install.packages()* to install packages 
- *installed.packages()* to see what packages are installed 
- *class(df)* to tell if df or tibble 
  + df \<- as_tibble(df) to turn into a tibble

## *dplyr*

- *filter()* for sub-setting row/observations 
- *select()* for sub-setting columns/variables 
- *mutate()* for transforming variables \* df %\>% mutatue(newcolumn_name = variable selection) \* ==, \<, \>, can make multiple new columns within one mutate command 
- *group_by(catvariable)* for numerical summaries of categories (e.g., site, treatment, species) 
- *summarise(meansurvival = mean(survival), n = n())* for numerical summaries of observations (e.g., height, survival, percent cover) + n = n() will count total observations for your variable meanWage + creates a new tibble with a summary for each level 
- *fivenum()* for all 5 summaries

## *statistics*

-   lmer: Fit Linear Mixed-Effects Models
    -   Fit a linear mixed-effects model (LMM) to data, via REML or maximum likelihood.
-   letters
    -   <https://statdoe.com/cld-customisation/>
-   emmeans-package
    -   emmeans() = Estimated marginal means
    -   emtrends()
-   ANOVA
    -   result \<- aov(response_variable \~ explanitory_variable, data = df) TukeyHSD(parmod_treatment) plot(TukeyHSD(parmod_treatment))
-   t-test: compare the means of two groups
    -   with data from two dfs --\> t.test(par1\$response_variable, par2(dollarsign)response_variable)
    -   with data from one df --\> t.test(normalized_par \~ year, data = parmod)

## *Rmd*

# Tips

*If things start to break*, run the code from the beginning. The environment may need to be cleared and reset. *DO NOT fix data in EXCEL.* Use R. Once you "finalize" your raw data, don't touch it or re-save it. Doing that can change the column formatting, which can break your importing code.

**end of code**
