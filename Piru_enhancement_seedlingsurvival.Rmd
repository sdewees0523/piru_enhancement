---
title: "Piru_enhancement_seedlingsurvival"
author: "Stephanie Ma Lucero"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load libraries

```{r libraries, message=FALSE}
library(here) # similar to set working directory
library(dplyr) # includes functions:
library(tidyverse) # data wrangling, includes packages: ggplot2, tibble, tidyr, rear, purrr, stringr, forcats
library(lme4)
library(lmerTest)
library(emmeans) 
library(lubridate)
library(patchwork)
```

# Load colors for graphs

```{r colors, include=TRUE}
devtools::install_github("an-bui/calecopal")

library(calecopal)
# all palettes
names(cal_palettes)

# Site colors: 1, 2 
cal_palette(name = "chaparral1", n = 5, type = "continuous") # [1] "#DCC27A" "#F19B34"
site1color <- "#DCC27A"
site2color <- "#F19B34"
site1outline <- "#9C8A58"
site2outline <- "#936126"
sitecolors <- c(site1color, site2color)

# Treatment colors: Full, half, none 
cal_palette(name = "chaparral3", n = 5, type = "continuous") # [1] "#D3E3CA", "#92A587", "#2F3525"
cal_palette(name = "desert", n = 5, type = "continuous") # [1] "#F6EECF", "#B09175", "#291611"
treatment1color <- "#F6EECF"
treatment2color <- "#B09175"
treatment3color <- "#291611"
treatmentcolors <- c(treatment1color, treatment2color, treatment3color)

```

# Question 2: How does seedling survival change with PAR, TDR, % nn cover, and species?

Notes:
* __response variable__: The variable you want to test. (e.g.,. PAR, TDR, nncover)
* __explanatory variables__: The variables that can explain the outcome. (e.g., treatment, mafacover, site)
* __data frame__: Include all the data you'll be working with. (e.g., combine par and mafa_cover_all)
* __formula__: a formula is a two-sided linear formula object describing both the _fixed-effects_ and _random effects_ part of the model, with the response on the left of a ~ operator and the terms, separated by + operators, on the right. 
* __random effects__: Random-effects terms are distinguished by vertical bars __(|)__ separating expressions for design matrices from grouping factors. Two vertical bars __(||)__ can be used to specify multiple uncorrelated random effects for the same grouping variable. 
  + Because of the way it is implemented, the ||-syntax works only for design matrices containing numeric (continuous) predictors; to fit models with independent categorical effects, see dummy or the lmer_alt function from the afex package.)
  
  

### Load PAR, TDR, and non-native percent cover data.

### Saved as a csv in the "Processed" data folder.
```{r load survival height par tdr nncover data csv, include=TRUE}

# survival and mortality data
survmort_load <- read_csv("data/processed/survmort.csv",
                      col_types = cols(
                        year = col_character(),
                        month = col_character(), 
                        site = col_character(),
                        plot_number = col_character(), 
                        treatment = col_character(),
                        species = col_character(), 
                        alive = col_integer(),
                        dead = col_integer(), 
                        month_count = col_integer(),
                        transplanted = col_character()
                      )
                        )
# survival and mortality data WITH species
survmort <- survmort_load %>% 
  dplyr::select(year, month, plot_number, treatment, species, alive, dead, site, month_count, transplanted) # %>%  
#  mutate(treatment = recode(treatment, no = "none"))

# survival and mortality data WITHOUT species
survmortnospp <- survmort_load %>% 
  dplyr::select(year, month, plot_number, treatment, alive, dead, site, month_count, transplanted) %>% 
 # mutate(treatment = recode(treatment, no = "none")) %>% 
  group_by(year, month, site, plot_number, treatment, month_count, transplanted) %>% 
  summarize(totalsurvival = sum(alive), 
            totalmortality = sum(dead)) %>% 
  ungroup()
print(survmortnospp) # :) yay! it worked!

survmortnospp %>% # check number of data points
  group_by(year, treatment) %>% 
  summarise(N = length(totalsurvival))
```

```{r load height par tdr nncover data csv, include=TRUE}

# loading in height data
height_raw <- read.csv(here("data", "survival_data.csv")) %>% 
  mutate(date = mdy(date)) #having R recognize date as a date

# PAR data
par_load <- read_csv("data/processed/par.csv",
  col_types = cols(
    date = col_character(),
    plot_number = col_character(),
    treatment = col_character(),
    year = col_character(),
    month = col_character(),
    site = col_character(),
    normalized_par = col_double()
    )
)

par <- par_load %>% 
  dplyr::select(year, month, site, plot_number, treatment, normalized_par)
print(par)

# TDR data
tdr_load <- read_csv("data/processed/tdr.csv",
  col_types = cols(
    plot_number = col_character(),
    treatment = col_character(),
    year = col_character(),
    month = col_character(),
    site = col_character(),
    soil_moisture = col_double()
    )
  )

tdr <- tdr_load %>% 
   dplyr::select(year, month, site, plot_number, treatment, soil_moisture)
print(tdr)  

# exotic percent cover
exotic_cover_all_load <- read_csv("data/processed/exotic_cover_all.csv",
  col_types = cols(
    date = col_character(),
    year = col_character(),
    site = col_character(),
    plot_number = col_character(),
    MAFA_removal = col_character(),
    cover_percent = col_double()
  )
)

exotic_cover_all <- exotic_cover_all_load %>% 
  dplyr::select(date, year, site, plot_number, MAFA_removal, cover_percent) %>% 
  rename(treatment = MAFA_removal)
print(exotic_cover_all)


#mafa_cover_all_load <- read_csv("data/processed/mafa_cover_all.csv",
#  col_types = cols(
#    plot_number = col_character(),
#    year = col_integer(),
#    cover_percent = col_double(),
#    site = col_integer()
#    )
#  )
#mafa_cover_all <- mafa_cover_all_load %>% 
#  select(plot_number, year, cover_percent, site) 
#print(mafa_cover_all)

```
  
***

# May 2018 

### Code to save for later on calculating survival rate or change between two time points. 

- RUN AFTER "SURVIVAL AT TIME POINTS" AND ONLY MAKE CODE IF IT'S NEEDED
  
```{r may 2018 rate of change, include=TRUE}

# YOU DON'T NEED TO CALCULATE SURVIVAL RATE RIGHT NOW
# JUST RUN MODELS TO SEE WHAT MAKES A DIFFERENCE AT SURVEY TIME POINT. 
# YOU CAN ALWAYS GO BACK AND CALCULATE RATE ON YOUR SECOND PASS.
# 
# 
# t1 = jan 2019- march 2019
# t2 = march 2019 - may 2019
# t3 = may 2019 - sept 2019
# t4 = sept 2019 - nov 2019

# 
#survmortnospp_2018 <- survmortnospp %>% 
#  dplyr::filter(year == "2018") %>% 
#  dplyr::select(!totalmortality) %>% 
#  dplyr::select(!month_count)

#survmortnospp_2018_wider <- survmortnospp_2018 %>%
#  pivot_wider(names_from = month, values_from = totalsurvival) 
  
#view(survmortnospp_2018_wider)

# END OF CREATING A WIDER DF
```

### How are site 1 and site 2 different? 

```{r may 2018 filter environmental data, include=TRUE}

# par april 2018 
par_april2018 <- dplyr::filter(par, year == "2018" & month =="4") %>% 
  dplyr::select(site, plot_number, treatment, normalized_par) %>% 
  mutate(treatment = case_when(treatment == "no" ~ "none",
                               TRUE ~ treatment))

#tdr april 2018
tdr_april2018 <- tdr %>% dplyr::filter(year == "2018" & month =="4") %>%  
  dplyr::select(site, plot_number, treatment, soil_moisture)  %>% 
  mutate(treatment = case_when(treatment == "nonene" ~ "none",
                               TRUE ~ treatment))
tdr_april2018$site <- factor(tdr_april2018$site, levels = c("1", "2"))

# nncover may 2018
nncover_may2018 <- dplyr::filter(exotic_cover_all, year == "2018") %>% 
  dplyr::select(site, plot_number, treatment, cover_percent)

site_cond <- full_join(par_april2018, tdr_april2018, by = c("site", "plot_number", "treatment")) %>% 
  full_join(nncover_may2018, by = c("site", "plot_number", "treatment"))
```

```{r may2018 site conditions ttest}

#soil moisture
t.test(soil_moisture~site, data = site_cond) 
# YES sig diff
# data:  soil_moisture by site
# t = 5.0592, df = 33.993, p-value = 1.44e-05

#norm_par
t.test(normalized_par~site, data = site_cond) 
# not sig diff
# data:  normalized_par by site
# t = -1.2109, df = 29.972, p-value = 0.2354

#nncover
t.test(cover_percent~site, data = site_cond) #nn cover
# not sig diff
# data:  cover_percent by site
# t = 0.2511, df = 33.554, p-value = 0.8033
```


### Subsetting dataframes survival, par, tdr, and nncover to May 2018 data
  - Add height at March 2018 to include in model

```{r MAY 2018 subset start end height rgr survival, include=TRUE}
# subsetting data for May 2018 survival
# survmortnospp = may 2018
# par = april 2018
# tdr = april 2018
# nncover = may 2018

#seedling height in March 2018 - STARTING HEIGHT
height_march <- height_raw %>% 
  filter(date >= "2018-02-23" & date <= "2018-03-31") %>% # filtering to only have rows of data taken in March 
  dplyr::select(plot_number, MAFA_removal, location, species, stem_height_cm, individual) %>% 
  rename(march_stem_height_cm = stem_height_cm) 

print(height_march %>%  # check number of individuals per plot
  group_by(plot_number) %>% 
  summarise(N = length(march_stem_height_cm))
)

#seedling height in May 2018 - ENDING HEIGHT
height_may <- height_raw %>% 
  filter(date >= "2018-05-01" & date <= "2018-05-31") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, stem_height_cm, individual) %>% 
  rename(may_stem_height_cm = stem_height_cm) %>% 
  mutate(individual = case_when(individual == "s" ~ "S",
                                individual == "c" ~ "C",
                                individual == "r" ~ "R",
                                TRUE ~ individual),
         may_stem_height_cm = as.numeric(may_stem_height_cm))  %>% 
  drop_na()

# growth rate from March to May 2018 - GROWTH RATE
growth_march_may <- right_join(height_march, height_may, by = c("plot_number", "MAFA_removal", "location", "species", "individual")) %>% 
  mutate(march_stem_height_cm = as.numeric(march_stem_height_cm)) %>% 
  drop_na() %>% 
  mutate(rgr = (log(may_stem_height_cm) - log(march_stem_height_cm))/60,
         plot_number = as.character(plot_number)) %>% # relative growth rate equation
  left_join(par_april2018, by = "plot_number") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, individual, rgr, normalized_par) %>% 
  left_join(tdr_april2018, by = "plot_number") %>% 
  dplyr::select(!site & !treatment) %>% 
  left_join(nncover_may2018, by = "plot_number") %>% 
  dplyr::select(!treatment) %>% 
  rename(exotic_percentcover = cover_percent) %>% 
  rename(treatment = MAFA_removal)

# seedling survival or dead in May 2018 - SURVIVAL 0-1
survival_may <- height_raw %>%  ## Need to change some of the individual labels to fix NAs when rejoin. 
  filter(date >= "2018-05-01" & date <= "2018-05-31") %>% # select for may 2018 data collection
  dplyr::select(plot_number, MAFA_removal, location, species, alive, individual) %>% 
  rename(may_alive = alive) %>% # 1 = alive
  mutate(may_alive = replace_na(may_alive, 0), # replace NAs with 0 = dead
         individual = case_when(individual == "s" ~ "S",
                                individual == "c" ~ "C",
                                individual == "r" ~ "R",
                                TRUE ~ individual))  # 0 = dead 1 = alive
```


```{r MAY 2018 join march to may data, include=TRUE}

# March to May 2018 join - JOIN 
# starting height, 0-1 may 2018, april 2018 normPAR, april 2018 tdr, nncover april 2018
height_march_surv_may_notransf <- full_join(height_march, survival_may, by = c("plot_number", "MAFA_removal", "location", "species", "individual")) %>% 
  mutate(march_stem_height_cm = as.numeric(march_stem_height_cm)) %>% # warning: one height "didn't plant"
  drop_na() %>% # drops nas 
  mutate(plot_number = as.character(plot_number)) %>% 
  left_join(par_april2018, by = "plot_number") %>% # join April 2018 PAR
  dplyr::select(plot_number, MAFA_removal, location, species, individual, march_stem_height_cm, may_alive, normalized_par) %>% 
  left_join(tdr_april2018, by = "plot_number") %>% # join April 2018 TDR
  dplyr::select(!site & !treatment) %>% 
  left_join(nncover_may2018, by = "plot_number") %>%  # join April 2018 nncover
  dplyr::select(!treatment) %>% 
  rename(exotic_percentcover = cover_percent) %>% 
  rename(treatment = MAFA_removal) # %>% 
 # left_join(growth_march_may, by = c("plot_number", "treatment", "location", "species", "individual", "normalized_par", "soil_moisture", "site", "exotic_percentcover"))
    # mutate(site = as.factor(site))
print(height_march_surv_may_notransf)

view(height_march_surv_may_notransf %>%  # check number of individuals per plot
  group_by(site, plot_number) %>% 
  summarise(N = length(individual))
)


```

```{r MAY 2018 transform data, include=TRUE}

# scale transform data: normPAR, tdr, nncover, starting height - SCALE
height_march_surv_may <- height_march_surv_may_notransf %>% 
  mutate(normalized_par = scale(normalized_par), # scale transforms the data; helps when comparing variables with different units; changes column names
         soil_moisture = scale(soil_moisture),
         exotic_percentcover = scale(exotic_percentcover),
         march_stem_height_cm = scale(march_stem_height_cm)) 
print(height_march_surv_may)
```

```{r join march to may 2018 data not transformed, include=TRUE}

# take height_march_surv_may %>%  
# group_by(plot) %>% 
# summarize by(sum(may_alive)) # to get total seedling survival 

may2018mod <- height_march_surv_may_notransf %>% 
  dplyr::select(plot_number, treatment, may_alive, site, normalized_par, soil_moisture, exotic_percentcover)
print(may2018mod)
```
 
```{r may2018mod test normality, include=FALSE}
# test if residuals are normally distributed on total_survival by plot and using non-transformed normPAR, tdr, nncover


```
 
- testing if the residuals are normally distributed
```{r notes lmer vs glmer, include=FALSE}

# lmer is used to fit linear mixed-effect models, so it assumes that the residual error has a Gaussian distribution. If your dependent variable A is a binary outcome (e.g. a yes/no response), then the error distribution is binomial and not Gaussian. In this case you have to use glmer, which allow to fit a generalized linear mixed-effects model: these models include a link function that allows to predict response variables with non-Gaussian distributions. 

# One example of link function that could work in your case is the logistic function, which takes an input with any value from negative to positive infinity and return an output that always takes values between zero and one, which is interpretable as the probability of the binary outcome (e.g. the probability of the subject responding 'yes').
```

- model with glmer
```{r MAY 2018 test normality glmer, include =TRUE}

# individual seedling survival in May 2018 as dependent variable
glme.may2018.mod <- glmer(as.factor(may_alive) ~ normalized_par + soil_moisture + exotic_percentcover + site + march_stem_height_cm + species + (1|plot_number) + (1|treatment) + (1|location) + (1|individual), 
                          # QUESTION -- why normalized_par * soil_moisture instead of +?
                          # treatment as independent because treatment wasn't significant in Q1
                          # QUESTION - add rgr as variable? the issue is not all rows have rgr value
                         family = binomial, # QUESTION -- what is family?
                         data = height_march_surv_may) # <-- DO I NEED TO INCLUDE TREATMENT IF IT WASN'T SIG? Now treatment is significant... 
# error message with scaled data --> Warning: Model failed to converge with max|grad| = 0.0958267 (tol = 0.002, component 1)
# error message with un-scaled data --> Warning: Some predictor variables are on very different scales: consider rescaling

# relative growth rate as dependent variable - don't run
glme_rgr_may2018 <- lmer(rgr ~ normalized_par*soil_moisture + exotic_percentcover + site + (1|plot_number),
                         data = growth_march_may)
# plot number not included because only data point per plot (n = 36)
                         
# model as lmer - response must be numeric
# can run lmer if running with TOTAL seedling survival by plot
#lmer.may2018.mod <- lmer(as.factor(may_alive) ~ normalized_par * soil_moisture + #exotic_percentcover + site + march_stem_height_cm + species + rgr + (1|plot_number) + #(1|treatment) + (1|location) + (1|individual), 
#                          # QUESTION -- why normalized_par * soil_moisture instead of +?
#                          # treatment as independent because treatment wasn't significant #in Q1
#                         data = height_march_surv_may) 

MOD <- glme.may2018.mod

# Calculate model's residual and fitted values
F1 <- fitted(MOD)
E1 <- residuals(MOD, "pearson")

# See residuals as a histogram, look for normal distribution
hist(E1) # looks normal!

# Graph residuals against a normal distribution, look for all points to be on 1:1 line
#need to call next two lines together
qqnorm(E1, xlab = "Theoretical Quantiles", ylab = "Pearson Residuals")
qqline(E1) # ends are a bit wonky... 

# Graph residuals vs fitted values to inspect homogeneity of variance, look for a random scattering of plots
# run together 2 lines
plot(x=F1, y=E1, xlab="Fitted Model Values", ylab="Pearson Residuals", main = "Variance")
abline(h = 0) # looking for random scatter

# Check for crazy outliers, look for lines MUCH taller than the rest of data
plot(cooks.distance(MOD))

# Plot a box plot for each factor, look for equal variance amount levels along the zero line
# Box plots need to be assessed for every fixed effect (categorical factor) for your model. 
# Random effects need the qqline just like normality. 
# So, only site and treatment get box plots. 
# exotic_cover is a covariate (continuous variable).

boxplot(E1 ~ site, data = height_march_surv_may) # <---- make sure to change to df, not the lme
abline(h = 0)
# error message - variable lengths differ

# Plot each random effect in the model - things in the (1|_), look for dots along 1:1 line
#qqnorm(ranef(MOD)$treatment[,1], main = "Plot Residuals")
#qqline(ranef(MOD)$treatment[,1]) # unique dates

```

- statistics on May 2018 model

```{r MAY 2018 - stats, include=TRUE}

print(glme.may2018.mod)
summary(glme.may2018.mod)
anova(glme.may2018.mod) # A significant p-value indicates that one or more significant differences exist between group means.
# seedling survival is not correlated with par, tdr, exotic percent cover, or site.
# SITE may be ecologically interesting (p = 0.0843)
# Type III Analysis of Variance Table with Satterthwaite's method
#                     Sum Sq Mean Sq NumDF  DenDF F value  Pr(>F)  
#normalized_par       1.8734  1.8734     1 30.996  0.2605 0.61338  
#soil_moisture        2.5569  2.5569     1 30.834  0.3556 0.55534  
#exotic_percentcover  1.7381  1.7381     1 25.546  0.2417 0.62718  
#site                22.9048 22.9048     1 30.273  3.1850 0.08434 .

summary(glme_rgr_may2018)
```

- figures 
```{r MAY 2018 figures - stem height survival site, include=TRUE}

## stem height x survival, paneled by site
# predict survival (S curve by 0-1)
stem_height_site_1_prediction <- seq(from = -1.2, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(normalized_par = mean(height_march_surv_may$normalized_par),
         exotic_percentcover = mean(height_march_surv_may$exotic_percentcover),
         site = "1",
         soil_moisture = mean(height_march_surv_may$soil_moisture),
         treatment = "full removal",
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

stem_height_site_2_prediction <- seq(from = -1.2, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(normalized_par = mean(height_march_surv_may$normalized_par),
         exotic_percentcover = mean(height_march_surv_may$exotic_percentcover),
         site = "2",
         soil_moisture = mean(height_march_surv_may$soil_moisture),
         treatment = "full removal",
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

site_1_sh_plot <- ggplot()+
  geom_point(data = height_march_surv_may %>%  filter(site == "1"), aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_site_1_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival",
       title = "Site 1")

site_2_sh_plot <- ggplot()+
  geom_point(data = height_march_surv_may %>%  filter(site == "2"), aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_site_2_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival",
       title = "Site 2")

site_1_sh_plot + site_2_sh_plot
```

```{r May 2018 figures - , include=TRUE}
# box.1 rgr x site
ggplot(growth_march_may, aes(x = site, y = rgr))+
  geom_boxplot()+
  theme_classic()+
  labs(x = "Planting Site",
       y = "Relative Growth Rate")

moisture_low_par_site_1 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(height_march_surv_may$normalized_par),
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

moisture_low_par_site_2 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(height_march_surv_may$normalized_par),
         exotic_percentcover = 0,
         site = "2",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

moisture_mean_par_site_1 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = 0,
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

moisture_mean_par_site_2 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = 0,
         exotic_percentcover = 0,
         site = "2",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

moisture_max_par_site_1 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(height_march_surv_may$normalized_par),
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

moisture_max_par_site_2 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(height_march_surv_may$normalized_par),
         exotic_percentcover = 0,
         site = "2",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

moisture_prediction_site_1 <- rbind(moisture_low_par_site_1, moisture_mean_par_site_1, moisture_max_par_site_1)

moisture_prediction_site_2 <- rbind(moisture_low_par_site_2, moisture_mean_par_site_2, moisture_max_par_site_2)

moisture_site_1_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(site == "1"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_prediction_site_1, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1) +
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability",
       title = "Site 1")

moisture_site_2_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(site == "2"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_prediction_site_2, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1) +
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability",
       title = "Site 2")

moisture_site_1_graph + moisture_site_2_graph

par_low_moisture_site_1 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(height_march_surv_may$soil_moisture),
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

par_low_moisture_site_2 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "2",
         soil_moisture = min(height_march_surv_may$soil_moisture),
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

par_mean_moisture_site_1 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = 0,
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

par_mean_moisture_site_2 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "2",
         soil_moisture = 0,
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

par_max_moisture_site_1 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(height_march_surv_may$soil_moisture),
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

par_max_moisture_site_2 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "2",
         soil_moisture = max(height_march_surv_may$soil_moisture),
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

par_prediction_site_1 <- rbind(par_low_moisture_site_1, par_mean_moisture_site_1, par_max_moisture_site_1)

par_prediction_site_2 <- rbind(par_low_moisture_site_2, par_mean_moisture_site_2, par_max_moisture_site_2)

par_site_1_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(site == "1"), aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_prediction_site_1, aes(x = normalized_par, y = alive, col = soil_moisture, group = soil_moisture), linewidth = 1) +
  theme_classic() +
  labs(x = "Normalized PAR", 
       y = "Survival Probability",
       title = "Site 1")

par_site_2_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(site == "2"), aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_prediction_site_2, aes(x = normalized_par, y = alive, col = soil_moisture, group = soil_moisture), linewidth = 1) +
  theme_classic() +
  labs(x = "Normalized PAR", 
       y = "Survival Probability",
       title = "Site 2")

par_site_1_graph + par_site_2_graph
```

## Repeat each model for each species

### CEOL 
```{r}
ceol_2018 <- height_march_surv_may %>% 
  filter(species == "CEOL")
  
AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = ceol_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2018))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = ceol_2018))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = ceol_2018))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2018))

AIC(glmer(as.factor(may_alive) ~ site + normalized_par + (1|plot_number),
          family = binomial,
          data = ceol_2018))

AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2018))

AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = ceol_2018))

AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2018))


summary(glmer(as.factor(may_alive) ~ soil_moisture + normalized_par + exotic_percentcover + march_stem_height_cm + site + (1|plot_number), 
          family = binomial,
          data = ceol_2018))

## Add Figure
``` 

### RHOV

```{r} 
rhov_2018 <- height_march_surv_may %>% 
  filter(species == "RHOV")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = rhov_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = rhov_2018))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = rhov_2018))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = rhov_2018))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + soil_moisture + (1|plot_number),
          family = binomial,
          data = rhov_2018))

rhov_model <- glmer(as.factor(may_alive) ~ march_stem_height_cm + soil_moisture + normalized_par + exotic_percentcover + site + (1|plot_number),
          family = binomial,
          data = rhov_2018)
summary(rhov_model)

stem_height_rhov_prediction <- seq(from = 0.5, to = 5, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = mean(rhov_2018$soil_moisture)) %>% 
  mutate(alive = predict(rhov_model, newdata = . , type = "response"))

ggplot()+
  geom_point(data = rhov_2018, aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_rhov_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival")


```

### HEAR

```{r}
hear_2018 <- height_march_surv_may %>% 
  filter(species == "HEAR")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture*normalized_par + (1|plot_number),
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + site + (1|plot_number),
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2018))

hear_model <- glmer(as.factor(may_alive) ~ soil_moisture* normalized_par + (1|plot_number), 
                         family = binomial,
                         data = hear_2018)

summary(hear_model)


moisture_hear_low_par <- seq(from = 6, to = 12, by = 0.5) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(hear_2018$normalized_par)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

moisture_hear_mid_par <- seq(from = 6, to = 12, by = 0.5) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = mean(hear_2018$normalized_par)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

moisture_hear_max_par <- seq(from = 6, to = 12, by = 0.5) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(hear_2018$normalized_par)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

moisture_hear_prediction <- rbind(moisture_hear_low_par, moisture_hear_max_par, moisture_hear_mid_par) 

ggplot()+
  geom_point(data = hear_2018, aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_hear_prediction, aes(x = soil_moisture, y = alive, col = normalized_par, group= normalized_par), linewidth = 1)+
  theme_classic()+
  labs(x = "Soil Moisture",
       y = "Probability of Survival")

par_hear_low_moisture <- seq(from = 0.1, to = 0.65, by = 0.01) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(hear_2018$soil_moisture)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

par_hear_mid_moisture <- seq(from = 0.1, to = 0.65, by = 0.01) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = mean(hear_2018$soil_moisture)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

par_hear_max_moisture <- seq(from = 0.1, to = 0.65, by = 0.01) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(hear_2018$soil_moisture)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

par_hear_prediction <- rbind(par_hear_low_moisture, par_hear_max_moisture, par_hear_mid_moisture) 

ggplot()+
  geom_point(data = hear_2018, aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_hear_prediction, aes(x = normalized_par, y = alive, col = soil_moisture, group= soil_moisture), linewidth = 1)+
  theme_classic()+
  labs(x = "Normalized PAR",
       y = "Probability of Survival")

```



```{r}
saap_2018 <- height_march_surv_may %>% 
  filter(species == "SAAP")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ site + normalized_par + (1|plot_number), 
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number), 
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number), 
          family = binomial,
          data = saap_2018))


saap_model <- glmer(as.factor(may_alive) ~ site + (1|plot_number),
                         family = binomial,
                         data = saap_2018)

summary(saap_model)
```

## Individual species for RGR 

### CEOL 

```{r}
ceol_rgr_2018 <- growth_march_may %>% 
  filter(species == "CEOL")
  
AIC(lmer(rgr ~ normalized_par +  (1|plot_number),
                         data = ceol_rgr_2018))

AIC(lmer(rgr ~ soil_moisture*normalized_par + (1|plot_number),
          data = ceol_rgr_2018))

AIC(lmer(rgr ~ exotic_percentcover + (1|plot_number), 
          data = ceol_rgr_2018))

AIC(lmer(rgr ~ site + (1|plot_number),
          data = ceol_rgr_2018))

AIC(lmer(rgr ~ normalized_par +  soil_moisture + (1|plot_number),
                         data = ceol_rgr_2018))

AIC(lmer(rgr ~ normalized_par + exotic_percentcover + (1|plot_number),
                         data = ceol_rgr_2018))

AIC(lmer(rgr ~ normalized_par + site + (1|plot_number),
                         data = ceol_rgr_2018))

ceol_2018rgr_model <- lmer(rgr ~ normalized_par +  (1|plot_number),
                         data = ceol_rgr_2018)

summary(ceol_2018rgr_model)
```
### Rhov

```{r}
rhov_rgr_2018 <- growth_march_may %>% 
  filter(species == "RHOV")
  
AIC(lmer(rgr ~ normalized_par+  (1|plot_number),
                         data = rhov_rgr_2018))

AIC(lmer(rgr ~ soil_moisture + (1|plot_number),
          data = rhov_rgr_2018))

AIC(lmer(rgr ~ exotic_percentcover + (1|plot_number), 
          data = rhov_rgr_2018))

AIC(lmer(rgr ~ site + (1|plot_number),
          data = rhov_rgr_2018))

AIC(lmer(rgr ~ site + normalized_par + (1|plot_number),
          data = rhov_rgr_2018))
AIC(lmer(rgr ~ site + soil_moisture + (1|plot_number),
          data = rhov_rgr_2018))
AIC(lmer(rgr ~ site + exotic_percentcover + (1|plot_number),
          data = rhov_rgr_2018))

rhov_2018rgr_model <- lmer(rgr ~ site + (1|plot_number),
          data = rhov_rgr_2018)
summary(rhov_2018rgr_model)

```

### HEAR

```{r}
hear_rgr_2018 <- growth_march_may %>% 
  filter(species == "RHOV")
  
AIC(lmer(rgr ~ normalized_par +  (1|plot_number),
                         data = hear_rgr_2018))

AIC(lmer(rgr ~ soil_moisture + (1|plot_number),
          data = hear_rgr_2018))

AIC(lmer(rgr ~ exotic_percentcover + (1|plot_number), 
          data = hear_rgr_2018))

AIC(lmer(rgr ~ site + (1|plot_number),
          data = hear_rgr_2018))

AIC(lmer(rgr ~ site + normalized_par + (1|plot_number),
          data = hear_rgr_2018))

AIC(lmer(rgr ~ site + soil_moisture + (1|plot_number),
          data = hear_rgr_2018))

AIC(lmer(rgr ~ site + exotic_percentcover + (1|plot_number),
          data = hear_rgr_2018))

hear_2018rgr_model <- lmer(rgr ~ site + (1|plot_number),
          data = hear_rgr_2018)

summary(hear_2018rgr_model)
```

## SAAP

```{r}
saap_rgr_2018 <- growth_march_may %>% 
  filter(species == "SAAP")
  
AIC(lmer(rgr ~ normalized_par +  (1|plot_number),
                         data = saap_rgr_2018))

AIC(lmer(rgr ~ soil_moisture + (1|plot_number),
          data = saap_rgr_2018))

AIC(lmer(rgr ~ exotic_percentcover + (1|plot_number), 
          data = saap_rgr_2018))

AIC(lmer(rgr ~ site + (1|plot_number),
          data = saap_rgr_2018))

AIC(lmer(rgr ~ normalized_par + soil_moisture + (1|plot_number),
                         data = saap_rgr_2018))

AIC(lmer(rgr ~ normalized_par + exotic_percentcover + (1|plot_number),
                         data = saap_rgr_2018))

AIC(lmer(rgr ~ normalized_par + site + (1|plot_number),
                         data = saap_rgr_2018))

saap_2018rgr_model <- lmer(rgr ~ normalized_par +  (1|plot_number),
                         data = saap_rgr_2018)

summary(saap_2018rgr_model)
```


# May 2019 Seedling survival 
  - add height
```{r may 2019 - join data, include=TRUE}
# subsetting data for May 2019 survival
# survmortnospp = may 2019
# par = may 2019
# tdr = march 2019
# nncover = 2019

par_may2019 <- dplyr::filter(par, year == "2019" & month =="5")
tdr_march2019 <- tdr %>% 
  dplyr::filter(year == "2019" & month == "3")

# Making height and survival dataframe

height_march_2019 <- height_raw %>% 
  filter(date == "2019-03-11") %>% # filtering to only have rows of data taken in March 
  dplyr::select(plot_number, MAFA_removal, location, species, stem_height_cm) %>% 
  rename(march_stem_height_cm = stem_height_cm)

survival_may_2019 <- height_raw %>% 
  filter(date>= "2019-04-30" & date <= "2019-05-01") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, alive) %>% 
  rename(may_alive = alive) %>% 
  mutate(may_alive = replace_na(may_alive, 0))  # 0= dead 1 = alive

height_march_surv_may_2019 <- full_join(height_march_2019, survival_may_2019, by = c("plot_number", "MAFA_removal", "location", "species")) %>% 
  mutate(march_stem_height_cm = as.numeric(march_stem_height_cm)) %>% 
  drop_na() %>%  # removing na's for now. But should an NA in alive be assumed as dead? 
  mutate(plot_number = as.character(plot_number)) %>% 
  left_join(par_april2018, by = "plot_number") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, march_stem_height_cm, may_alive, normalized_par) %>% 
  left_join(tdr_april2018, by = "plot_number") %>% 
  dplyr::select(!site & !treatment) %>% 
  left_join(nncover_may2018, by = "plot_number") %>% 
  dplyr::select(!treatment) %>% 
  rename(exotic_percentcover = cover_percent) %>% 
  rename(treatment = MAFA_removal) %>% 
  mutate(normalized_par = scale(normalized_par),
         soil_moisture = scale(soil_moisture),
         exotic_percentcover = scale(exotic_percentcover),
         march_stem_height_cm = scale(march_stem_height_cm))



```

```{r}
glme.may2019.mod <- glmer(as.factor(may_alive) ~ normalized_par * soil_moisture + exotic_percentcover + site + march_stem_height_cm + species + (1|plot_number), 
                         family = binomial,
                         data = height_march_surv_may_2019)
                         

MOD <- glme.may2019.mod

# Calculate model's residual and fitted values
F1 <- fitted(MOD)
E1 <- residuals(MOD, "pearson")

# See residuals as a histogram, look for normal distribution
hist(E1)

# Graph residuals against a normal distribution, look for all points to be on 1:1 line
#need to call next two lines together
qqnorm(E1, xlab = "Theoretical Quantiles", ylab = "Pearson Residuals")
qqline(E1)

# Graph residuals vs fitted values to inspect homogeneity of variance, look for a random scattering of plots
# run together 2 lines
plot(x=F1, y=E1, xlab="Fitted Model Values", ylab="Pearson Residuals", main = "Variance")
abline(h = 0) # looking for random scatter

# Check for crazy outliers, look for lines MUCH taller than the rest of data
plot(cooks.distance(MOD))

# Plot a box plot for each factor, look for equal variance amount levels along the zero line
# Box plots need to be assessed for every fixed effect (categorical factor) for your model. 
# Random effects need the qqline just like normality. 
# So, only site and treatment get box plots. 
# MAFA cover is a covariate (continuous variable).

boxplot(E1 ~ site, data = height_march_surv_may_2019) # <---- make sure to change to df, not the lme
abline(h = 0)

# Plot each random effect in the model - things in the (1|_), look for dots along 1:1 line
#qqnorm(ranef(MOD)$treatment[,1], main = "Plot Residuals")
#qqline(ranef(MOD)$treatment[,1]) # unique dates

```

```{r}
print(glme.may2019.mod)
summary(glme.may2019.mod)
anova(glme.may2019.mod) 

# post-hoc Tukey test
# get stats on interactions
emmeans(glme.may2019.mod, list(pairwise ~ site), adjust = "tukey")
# site is not significantly different (p = 0.0923)

# calculate mean survival at Site 1 and Site 2
height_march_surv_may_2019 %>% 
  group_by(site) %>% 
  summarise(MEAN_totalsurvival=mean(may_alive, na.rm = TRUE),
            SD = sd(may_alive, na.rm = TRUE), 
            N = length(may_alive), 
            SE = ((sd(may_alive, na.rm = TRUE))/sqrt(length((may_alive))))
  )
#  site  MEAN_totalsurvival    SD     N    SE
#  <chr>              <dbl> <dbl> <int> <dbl>
#   1                   6.67  3.36    18 0.792
#   2                   3.89  1.94    18 0.457
```

```{r}
## Soil moisture

moisture_site_1_low_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = min(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "1",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_2_low_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = min(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "2",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_1_mean_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = 0,
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "1",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_2_mean_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = 0,
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "2",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_1_max_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = max(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "1",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_2_max_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = max(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "2",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_1_prediction_2019 <- rbind(moisture_site_1_low_par_2019, moisture_site_1_mean_par_2019, moisture_site_1_max_par_2019)
moisture_site_2_prediction_2019 <- rbind(moisture_site_2_low_par_2019, moisture_site_2_mean_par_2019, moisture_site_2_max_par_2019)

site_1_sm_plot <- ggplot()+
  geom_point(data = height_march_surv_may_2019 %>%  filter(site == "1"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25) +
  geom_line(data = moisture_site_1_prediction_2019, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1)+
  theme_classic()+
  labs(x = "Soil Moisture (%)",
       y = "Probability of Survival",
       title = "Site 1")

site_2_sm_plot <- ggplot()+
  geom_point(data = height_march_surv_may_2019 %>%  filter(site == "2"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_site_2_prediction_2019, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1)+
  theme_classic()+
  labs(x = "Soil Moisture (%)",
       y = "Probability of Survival",
       title = "Site 2")

site_1_sm_plot + site_2_sm_plot
## stem height
stem_height_site_1_prediction <- seq(from = -1.7, to = 3.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(normalized_par = mean(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "1",
         soil_moisture = mean(height_march_surv_may_2019$soil_moisture),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

stem_height_site_2_prediction <- seq(from = -1.7, to = 3.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(normalized_par = mean(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "2",
         soil_moisture = mean(height_march_surv_may_2019$soil_moisture),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

site_1_sh_plot <- ggplot()+
  geom_point(data = height_march_surv_may_2019 %>%  filter(site == "1"), aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_site_1_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival",
       title = "Site 1")

site_2_sh_plot <- ggplot()+
  geom_point(data = height_march_surv_may_2019 %>%  filter(site == "2"), aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_site_2_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival",
       title = "Site 2")

site_1_sh_plot + site_2_sh_plot
```


## Repeat each model for each species

### CEOL 
```{r}
ceol_2019 <- height_march_surv_may_2019 %>% 
  filter(species == "CEOL")
  
AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ site + normalized_par + (1|plot_number),
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2019))


summary(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = ceol_2019))

## Add Figure
``` 

### RHOV

```{r} 
rhov_2019 <- height_march_surv_may_2019 %>% 
  filter(species == "RHOV")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ site + normalized_par +(1|plot_number), 
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number), 
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number), 
          family = binomial,
          data = rhov_2019))

rhov_model <- glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = rhov_2019)
summary(rhov_model)
```

### HEAR

```{r}
hear_2019 <- height_march_surv_may_2019 %>% 
  filter(species == "HEAR")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ normalized_par + site + (1|plot_number),
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2019))

hear_moisture_model_2019 <- glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number), 
                         family = binomial,
                         data = hear_2019)

summary(hear_moisture_model_2019)

hear_moisture_pred_2019 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = 1) %>% 
  mutate(alive = predict(hear_moisture_model_2019, newdata = ., type = "response"))

ggplot()+
  geom_point(data = hear_2019, aes(x = soil_moisture, y = may_alive), alpha = 0.5) +
  geom_line(data = hear_moisture_pred_2019, aes(x = soil_moisture, y = alive), linewidth = 1) +
  theme_classic()


```



```{r}
saap_2019 <- height_march_surv_may %>% 
  filter(species == "SAAP")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ site + normalized_par + (1|plot_number), 
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number), 
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number), 
          family = binomial,
          data = saap_2019))


saap_model <- glmer(as.factor(may_alive) ~ site + (1|plot_number),
                         family = binomial,
                         data = saap_2018)

summary(saap_model)
```
## Survival May - September

```{r MAY 2019 - join data, include=FALSE}
par_may2019 <- dplyr::filter(par, year == "2019" & month =="9")
tdr_july2019 <- tdr %>% 
  dplyr::filter(year == "2019" & month == "7")

# Making height and survival dataframe

height_may_2019 <- height_raw %>% 
  filter(date>= "2019-04-30" & date <= "2019-05-01") %>% # filtering to only have rows of data taken in March 
  dplyr::select(plot_number, MAFA_removal, location, species, stem_height_cm) %>% 
  rename(may_stem_height_cm = stem_height_cm)

survival_sep_2019 <- height_raw %>% 
  filter(date == "2019-09-19") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, alive) %>% 
  rename(sep_alive = alive) %>% 
  mutate(sep_alive = replace_na(sep_alive, 0))  # 0= dead 1 = alive

height_may_surv_sep_2019 <- full_join(height_may_2019, survival_sep_2019, by = c("plot_number", "MAFA_removal", "location", "species")) %>% 
  mutate(may_stem_height_cm = as.numeric(may_stem_height_cm)) %>% 
  drop_na() %>%  # removing na's for now. But should an NA in alive be assumed as dead? 
  mutate(plot_number = as.character(plot_number)) %>% 
  left_join(par_april2018, by = "plot_number") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, may_stem_height_cm, sep_alive, normalized_par) %>% 
  left_join(tdr_april2018, by = "plot_number") %>% 
  dplyr::select(!site & !treatment) %>% 
  left_join(nncover_may2018, by = "plot_number") %>% 
  dplyr::select(!treatment) %>% 
  rename(exotic_percentcover = cover_percent) %>% 
  rename(treatment = MAFA_removal) %>% 
  mutate(normalized_par = scale(normalized_par),
         soil_moisture = scale(soil_moisture),
         exotic_percentcover = scale(exotic_percentcover), 
         may_stem_height_cm = scale(may_stem_height_cm))
```

```{r}
glme.sep2019.mod <- glmer(as.factor(sep_alive) ~ normalized_par +  soil_moisture  + exotic_percentcover + site + may_stem_height_cm  + species + (1|plot_number), 
                         family = binomial,
                         data = height_may_surv_sep_2019)
                         

MOD <- glme.may2019.mod

# Calculate model's residual and fitted values
F1 <- fitted(MOD)
E1 <- residuals(MOD, "pearson")

# See residuals as a histogram, look for normal distribution
hist(E1)

# Graph residuals against a normal distribution, look for all points to be on 1:1 line
#need to call next two lines together
qqnorm(E1, xlab = "Theoretical Quantiles", ylab = "Pearson Residuals")
qqline(E1)

# Graph residuals vs fitted values to inspect homogeneity of variance, look for a random scattering of plots
# run together 2 lines
plot(x=F1, y=E1, xlab="Fitted Model Values", ylab="Pearson Residuals", main = "Variance")
abline(h = 0) # looking for random scatter

# Check for crazy outliers, look for lines MUCH taller than the rest of data
plot(cooks.distance(MOD))

# Plot a box plot for each factor, look for equal variance amount levels along the zero line
# Box plots need to be assessed for every fixed effect (categorical factor) for your model. 
# Random effects need the qqline just like normality. 
# So, only site and treatment get box plots. 
# MAFA cover is a covariate (continuous variable).

boxplot(E1 ~ site, data = height_march_surv_may_2019) # <---- make sure to change to df, not the lme
abline(h = 0)

# Plot each random effect in the model - things in the (1|_), look for dots along 1:1 line
#qqnorm(ranef(MOD)$treatment[,1], main = "Plot Residuals")
#qqline(ranef(MOD)$treatment[,1]) # unique dates

```

```{r}
print(glme.sep2019.mod)
summary(glme.sep2019.mod)

exotic_site1_2019 <- seq(from = -2.2, to = 2.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(exotic_percentcover = ".") %>% 
  mutate(normalized_par = 0,
         soil_moisture = 0, 
         site = "1",
         may_stem_height_cm = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(glme.sep2019.mod, newdata = ., type = "response"))

exotic_site2_2019 <- seq(from = -2.2, to = 2.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(exotic_percentcover = ".") %>% 
  mutate(normalized_par = 0,
         soil_moisture = 0, 
         site = "2",
         may_stem_height_cm = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(glme.sep2019.mod, newdata = ., type = "response"))

exotic_site1_plot_2019 <- ggplot() +
  geom_point(data = height_may_surv_sep_2019 %>%  filter(site == "1"), aes(x = exotic_percentcover, y = sep_alive), alpha = 0.25)+
  geom_line(data = exotic_site1_2019, aes(x= exotic_percentcover, y = alive), linewidth = 1)+
  theme_classic() +
  labs(title = "Site 1",
       x = "Exotic Percent Cover",
       y = "Survival Probability")

exotic_site2_plot_2019 <- ggplot() +
  geom_point(data = height_may_surv_sep_2019 %>%  filter(site == "2"), aes(x = exotic_percentcover, y = sep_alive), alpha = 0.25)+
  geom_line(data = exotic_site2_2019, aes(x= exotic_percentcover, y = alive), linewidth = 1)+
  theme_classic() +
  labs(title = "Site 2",
       x = "Exotic Percent Cover",
       y = "Survival Probability")

exotic_site1_plot_2019 + exotic_site2_plot_2019

height_site1_2019 <- seq(from = -1.6, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(may_stem_height_cm = ".") %>% 
  mutate(normalized_par = 0, 
         soil_moisture = 0,
         exotic_percentcover = 0,
         site = "1",
         plot_number = 1) %>% 
  mutate(alive = predict(glme.sep2019.mod, newdata = ., type = "response"))

height_site2_2019 <- seq(from = -1.6, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(may_stem_height_cm = ".") %>% 
  mutate(normalized_par = 0, 
         soil_moisture = 0,
         exotic_percentcover = 0,
         site = "2",
         plot_number = 1) %>% 
  mutate(alive = predict(glme.sep2019.mod, newdata = ., type = "response"))

height_site1_plot_2019 <- ggplot()+
  geom_point(data = height_may_surv_sep_2019 %>%  filter(site == "1"), aes(x = may_stem_height_cm, y = sep_alive), alpha = 0.25) +
  geom_line(data = height_site1_2019, aes(x = may_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(title = "Site 1",
       x = "Stem Height (cm)",
       y = "Survival Probability")

height_site2_plot_2019 <- ggplot()+
  geom_point(data = height_may_surv_sep_2019 %>%  filter(site == "2"), aes(x = may_stem_height_cm, y = sep_alive), alpha = 0.25) +
  geom_line(data = height_site2_2019, aes(x = may_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(title = "Site 2",
       x = "Stem Height (cm)",
       y = "Survival Probability")

height_site1_plot_2019 + height_site2_plot_2019

```

## Repeat each model for each species

### CEOL 
```{r}
ceol_2019_sep <- height_may_surv_sep_2019 %>% 
  filter(species == "CEOL")
  
AIC(glmer(as.factor(sep_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + normalized_par + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

ceol_2019_sep_model <- glmer(as.factor(sep_alive) ~ soil_moisture + (1|plot_number), 
          family = binomial,
          data = ceol_2019_sep)

summary(ceol_2019_sep_model)

ceol_moisture_2019 <- seq(from = -1.7, to = 1.7, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = 1) %>% 
  mutate(alive = predict(ceol_2019_sep_model, newdata = ., type = "response"))

ggplot()+
  geom_point(data = ceol_2019_sep, aes(x = soil_moisture, y = sep_alive), alpha = 0.25) +
  geom_line(data = ceol_moisture_2019, aes(x = soil_moisture, y = alive), linewidth = 1)+
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability")

``` 

### RHOV

```{r} 
rhov_2019_sep <- height_may_surv_sep_2019 %>% 
  filter(species == "RHOV")

AIC(glmer(as.factor(sep_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + normalized_par +(1|plot_number), 
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + soil_moisture + (1|plot_number), 
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + (1|plot_number), 
          family = binomial,
          data = rhov_2019_sep))

rhov_2019_sep_model <- glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = rhov_2019)
summary(rhov_2019_sep_model)
```

### HEAR

```{r}
hear_2019_sep <- height_may_surv_sep_2019 %>% 
  filter(species == "HEAR")

AIC(glmer(as.factor(sep_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ normalized_par + site + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + exotic_percentcover + soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + exotic_percentcover + normalized_par + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + exotic_percentcover + may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

hear_2019_sep_model <- glmer(as.factor(sep_alive) ~ site + exotic_percentcover + (1|plot_number), 
                         family = binomial,
                         data = hear_2019_sep)

summary(hear_2019_sep_model)

hear_exotic_site1_2019 <- seq(from = -2.2, to = 2.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(exotic_percentcover = ".") %>% 
  mutate(site = "1",
         plot_number = 1) %>% 
  mutate(alive = predict(hear_2019_sep_model, newdata = ., type = "response"))

hear_exotic_site2_2019 <- seq(from = -2.2, to = 2.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(exotic_percentcover = ".") %>% 
  mutate(site = "2",
         plot_number = 1) %>% 
  mutate(alive = predict(hear_2019_sep_model, newdata = ., type = "response"))

hear_exotic_site1_plot_2019 <- ggplot()+
  geom_point(data = hear_2019_sep %>% filter(site == "1"), aes(x = exotic_percentcover, y = sep_alive), alpha = 0.5) +
  geom_line(data = hear_exotic_site1_2019, aes(x = exotic_percentcover, y = alive), linewidth = 1) +
  theme_classic() +
  labs(title = "Site 1",
       x = "Exotic Percent Cover",
       y = "Survival Probability")

hear_exotic_site2_plot_2019 <- ggplot()+
  geom_point(data = hear_2019_sep %>% filter(site == "2"), aes(x = exotic_percentcover, y = sep_alive), alpha = 0.5) +
  geom_line(data = hear_exotic_site2_2019, aes(x = exotic_percentcover, y = alive), linewidth = 1) +
  theme_classic() +
  labs(title = "Site 2",
       x = "Exotic Percent Cover",
       y = "Survival Probability")

hear_exotic_site1_plot_2019 + hear_exotic_site2_plot_2019

```



```{r}
saap_2019_sep <- height_may_surv_sep_2019 %>%
  filter(species == "SAAP")

AIC(glmer(as.factor(sep_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~  + (1|plot_number),
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + normalized_par + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + soil_moisture + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + normalized_par + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + soil_moisture + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + normalized_par + soil_moisture + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + normalized_par + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

saap_2019_sep_model <- glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + normalized_par + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep)

summary(saap_2019_sep_model)

saap_height_site1_2019 <- seq(from = -1.4, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(may_stem_height_cm = ".") %>% 
  mutate(site = "1",
         normalized_par = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(saap_2019_sep_model, newdata = ., type = "response"))

saap_height_site2_2019 <- seq(from = -1.4, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(may_stem_height_cm = ".") %>% 
  mutate(site = "2",
         normalized_par = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(saap_2019_sep_model, newdata = ., type = "response"))


saap_height_site1_plot_2019 <- ggplot()+
  geom_point(data = saap_2019_sep %>% filter(site == "1"), aes(x = may_stem_height_cm, y = sep_alive), alpha = 0.5) +
  geom_line(data = saap_height_site1_2019, aes(x = may_stem_height_cm, y = alive), linewidth = 1) +
  theme_classic()+
  labs(title = "Site 1",
       x = "Stem Height (cm)",
       y = "Survival Probability")

saap_height_site2_plot_2019 <- ggplot()+
  geom_point(data = saap_2019_sep %>% filter(site == "2"), aes(x = may_stem_height_cm, y = sep_alive), alpha = 0.5) +
  geom_line(data = saap_height_site2_2019, aes(x = may_stem_height_cm, y = alive), linewidth = 1) +
  theme_classic()+
  labs(title = "Site 2",
       x = "Stem Height (cm)",
       y = "Survival Probability")

saap_height_site1_plot_2019 + saap_height_site2_plot_2019

saap_par_site1_2019 <- seq(from = -1.7, to = 2.3, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(site = "1",
         may_stem_height_cm = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(saap_2019_sep_model, newdata = ., type = "response"))

saap_par_site2_2019 <- seq(from = -1.7, to = 2.3, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(site = "2",
         may_stem_height_cm = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(saap_2019_sep_model, newdata = ., type = "response"))


saap_par_site1_plot_2019 <- ggplot()+
  geom_point(data = saap_2019_sep %>% filter(site == "1"), aes(x = normalized_par, y = sep_alive), alpha = 0.5) +
  geom_line(data = saap_par_site1_2019, aes(x = normalized_par, y = alive), linewidth = 1) +
  theme_classic()+
  labs(title = "Site 1",
       x = "Normalized PAR",
       y = "Survival Probability")

saap_par_site2_plot_2019 <- ggplot()+
  geom_point(data = saap_2019_sep %>% filter(site == "2"), aes(x = normalized_par, y = sep_alive), alpha = 0.5) +
  geom_line(data = saap_par_site2_2019, aes(x = normalized_par, y = alive), linewidth = 1) +
  theme_classic()+
  labs(title = "Site 2",
       x = "Normalized PAR",
       y = "Survival Probability")

saap_par_site1_plot_2019 + saap_par_site2_plot_2019
```
  
  