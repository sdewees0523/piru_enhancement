---
title: "Piru_enhancement_seedlingsurvival"
author: "Stephanie Ma Lucero"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load libraries, message=FALSE}
library(here) # similar to set working directory
library(dplyr) # includes functions:
library(tidyverse) # data wrangling, includes packages: ggplot2, tibble, tidyr, rear, purrr, stringr, forcats
library(lme4)
library(lmerTest)
library(DHARMa) #model diagnostics
library(performance)
library(emmeans) 
library(lubridate)
library(patchwork)
library(effects)
library(lattice)
library(MuMIn)
# library(Hmisc)

# for pretty output tables
install.packages("kableExtra")
# For dev version
# install.packages("devtools")
devtools::install_github("haozhu233/kableExtra")
library(kableExtra)
```

```{r colors for figures, include=FALSE}
devtools::install_github("an-bui/calecopal")

library(calecopal)
# all palettes
names(cal_palettes)

# Site colors: 1, 2 
cal_palette(name = "chaparral1", n = 5, type = "continuous") # [1] "#DCC27A" "#F19B34"
site1color <- "#DCC27A"
site2color <- "#F19B34"
site1outline <- "#9C8A58"
site2outline <- "#936126"
sitecolors <- c(site1color, site2color)

# Treatment colors: Full, half, none 
cal_palette(name = "chaparral3", n = 5, type = "continuous") # [1] "#D3E3CA", "#92A587", "#2F3525"
cal_palette(name = "desert", n = 5, type = "continuous") # [1] "#F6EECF", "#B09175", "#291611"
treatment1color <- "#F6EECF"
treatment2color <- "#B09175"
treatment3color <- "#291611"
treatmentcolors <- c(treatment1color, treatment2color, treatment3color)

```

# A. Question 2: How does seedling survival change with PAR, TDR, % nn cover, and species?

Notes:
* __response variable__: The variable you want to test. (e.g.,. PAR, TDR, nncover)
* __explanatory variables__: The variables that can explain the outcome. (e.g., treatment, mafacover, site)
* __data frame__: Include all the data you'll be working with. (e.g., combine par and mafa_cover_all)
* __formula__: a formula is a two-sided linear formula object describing both the _fixed-effects_ and _random effects_ part of the model, with the response on the left of a ~ operator and the terms, separated by + operators, on the right. 
* __random effects__: Random-effects terms are distinguished by vertical bars __(|)__ separating expressions for design matrices from grouping factors. Two vertical bars __(||)__ can be used to specify multiple uncorrelated random effects for the same grouping variable. 
  + Because of the way it is implemented, the ||-syntax works only for design matrices containing numeric (continuous) predictors; to fit models with independent categorical effects, see dummy or the lmer_alt function from the afex package.)
  
  

### A1. Load PAR, TDR, and non-native percent cover data.

- Loaded csvs from the "Processed" data folder.
```{r load survival csv, include=FALSE}

# survival and mortality data
survmort_load <- read_csv("data/processed/survmort.csv",
                      col_types = cols(
                        year = col_character(),
                        month = col_character(), 
                        site = col_character(),
                        plot_number = col_character(), 
                        treatment = col_character(),
                        species = col_character(), 
                        alive = col_integer(),
                        dead = col_integer(), 
                        month_count = col_integer(),
                        transplanted = col_character()
                      )
                        )
# survival and mortality data WITH species
survmort <- survmort_load %>% 
  dplyr::select(year, month, plot_number, treatment, species, alive, dead, site, month_count, transplanted) # %>%  
#  mutate(treatment = recode(treatment, no = "none"))


# total alive 2018
survmort %>% 
  filter (year == "2018" & month_count == "0") %>%  
   group_by(year) %>% 
  summarize(sum_alive = sum(alive), 
            sum_dead = sum(dead))

survmort %>% 
  filter (year == "2018" & month_count == "1") %>%  
   group_by(year) %>% 
  summarize(sum_alive = sum(alive), 
            sum_dead = sum(dead))

survmort %>% 
  filter (year == "2018" & month_count == "4") %>%  
   group_by(year) %>% 
  summarize(sum_alive = sum(alive), 
            sum_dead = sum(dead))

# total alive 2019 May
survmort %>% 
  filter (year == "2019" & month_count == "12") %>%  # January 2019
   group_by(year) %>% 
  summarize(sum_alive = sum(alive), 
            sum_dead = sum(dead))

survmort %>% 
  filter (year == "2019" & month_count == "16") %>%  # may 2019
   group_by(year) %>% 
  summarize(sum_alive = sum(alive), 
            sum_dead = sum(dead))

survmort %>% 
  filter (year == "2019" & month_count == "22") %>%  # november 2019 
   group_by(year) %>% 
  summarize(sum_alive = sum(alive), 
            sum_dead = sum(dead))

# total alive 2018 - SPECIES
survmort %>% 
  filter (year == "2018" & month_count == "0") %>%  
    group_by(year, month, month_count, species) %>% 
  summarize(sum_alive = sum(alive), 
            sum_dead = sum(dead))

survmort %>% 
  filter (year == "2018" & month_count == "1") %>%  
     group_by(year, month, month_count, species) %>% 
  summarize(sum_alive = sum(alive), 
            sum_dead = sum(dead))

survmort %>% 
  filter (year == "2018" & month_count == "4") %>%  
   group_by(year, month, month_count, species) %>% 
  summarize(sum_alive_Nov2019 = sum(alive), 
            sum_dead = sum(dead))


# total alive 2019 - SPECIES
survmort %>% 
  filter (year == "2019" & month_count == "12") %>%  
    group_by(year, month, month_count, species) %>% 
  summarize(sum_alive = sum(alive), 
            sum_dead = sum(dead))

survmort %>% 
  filter (year == "2019" & month_count == "16") %>%  
     group_by(year, month, month_count, species) %>% 
  summarize(sum_alive = sum(alive), 
            sum_dead = sum(dead))

survmort %>% 
  filter (year == "2019" & month_count == "22") %>%  
   group_by(year, month, month_count, species) %>% 
  summarize(sum_alive_Nov2019 = sum(alive), 
            sum_dead = sum(dead))



# survival and mortality data WITHOUT species
survmortnospp <- survmort_load %>% 
  dplyr::select(year, month, plot_number, treatment, alive, dead, site, month_count, transplanted) %>% 
 # mutate(treatment = recode(treatment, no = "none")) %>% 
  group_by(year, month, site, plot_number, treatment, month_count, transplanted) %>% 
  summarize(totalsurvival = sum(alive), 
            totalmortality = sum(dead)) %>% 
  ungroup()
print(survmortnospp) # :) yay! it worked!

survmortnospp %>% # check number of data points
  group_by(year, treatment) %>% 
  summarise(N = length(totalsurvival))

```

```{r load height par tdr nncover csv, include=TRUE}

# loading in height data
height_raw <- read.csv(here("data", "survival_data.csv")) %>% 
  mutate(date = mdy(date)) %>%  #having R recognize date as a date
  mutate(plot_number = as.character(plot_number)) %>% 
  mutate(stem_height_cm = as.numeric(stem_height_cm)) %>% 
  mutate(width_1_cm = as.numeric(width_1_cm)) %>% 
  mutate(width_2_cm = as.numeric(width_2_cm))
# In 2018 - Plot 26 - 1 SAAP not planted - right blue
# In 2018 - Plot 36 - 1 SAAP not planted - right green

# Calculate the volume of the ellipsoid: V = (4/3) * pi * axis a * axis b * axis c
height_raw$volume_cm3 <- (4/3) * pi * (height_raw$stem_height_cm/2) * (height_raw$width_1_cm/2) * (height_raw$width_2_cm/2)

# PAR data
par_load <- read_csv("data/processed/par.csv",
  col_types = cols(
    date = col_character(),
    plot_number = col_character(),
    treatment = col_character(),
    year = col_character(),
    month = col_character(),
    site = col_character(),
    normalized_par = col_double()
    )
)

par <- par_load %>% 
  dplyr::select(year, month, site, plot_number, treatment, normalized_par)
print(par)

# TDR data
tdr_load <- read_csv("data/processed/tdr.csv",
  col_types = cols(
    plot_number = col_character(),
    treatment = col_character(),
    year = col_character(),
    month = col_character(),
    site = col_character(),
    soil_moisture = col_double()
    )
  )

tdr <- tdr_load %>% 
   dplyr::select(year, month, site, plot_number, treatment, soil_moisture)
print(tdr)  

# exotic percent cover
exotic_cover_all_load <- read_csv("data/processed/exotic_cover_all.csv",
  col_types = cols(
    date = col_character(),
    year = col_character(),
    site = col_character(),
    plot_number = col_character(),
    MAFA_removal = col_character(),
    cover_percent = col_double()
  )
)

exotic_cover_all <- exotic_cover_all_load %>% 
  dplyr::select(date, year, site, plot_number, MAFA_removal, cover_percent) %>% 
  rename(treatment = MAFA_removal)
print(exotic_cover_all)


mafa_cover_all_load <- read_csv("data/processed/mafa_cover_all.csv",
  col_types = cols(
    plot_number = col_character(),
    year = col_integer(),
    cover_percent = col_double(),
    site = col_integer()
    )
  )

mafa_cover_all <- mafa_cover_all_load %>% 
#  select(plot_number, year, cover_percent, site) %>% 
  rename(mafacover = cover_percent) %>% 
  mutate(site = as.character(site))
print(mafa_cover_all)

```
  
***

# B. May 2018 models

### B1. Code to save for later on calculating survival rate or change between two time points. 

- RUN AFTER "SURVIVAL AT TIME POINTS" AND ONLY MAKE CODE IF IT'S NEEDED
  
```{r may 2018 rate of change wider df, include=TRUE}

# YOU DON'T NEED TO CALCULATE SURVIVAL RATE RIGHT NOW
# JUST RUN MODELS TO SEE WHAT MAKES A DIFFERENCE AT SURVEY TIME POINT. 
# YOU CAN ALWAYS GO BACK AND CALCULATE RATE ON YOUR SECOND PASS.
# 
# 
# t1 = mar 2018 - may 2018 <-- wet months / what we have
# t2 = jan 2019- may 2019 <-- wet months
# t3 = may 2019 - nov 2019 <-- dry months


# 
#survmortnospp_2018 <- survmortnospp %>% 
#  dplyr::filter(year == "2018") %>% 
#  dplyr::select(!totalmortality) %>% 
#  dplyr::select(!month_count)

#survmortnospp_2018_wider <- survmortnospp_2018 %>%
#  pivot_wider(names_from = month, values_from = totalsurvival) 
  
#view(survmortnospp_2018_wider)

# END OF CREATING A WIDER DF
```

```{r may 2018 filter environmental data, include=TRUE}

# par april 2018 
par_april2018 <- dplyr::filter(par, year == "2018" & month =="4") %>% 
  dplyr::select(site, plot_number, treatment, normalized_par) %>% 
  mutate(treatment = case_when(treatment == "no" ~ "none",
                               TRUE ~ treatment))

#tdr april 2018
tdr_april2018 <- tdr %>% dplyr::filter(year == "2018" & month =="4") %>%  
  dplyr::select(site, plot_number, treatment, soil_moisture)  %>% 
  mutate(treatment = case_when(treatment == "nonene" ~ "none",
                               TRUE ~ treatment))
tdr_april2018$site <- factor(tdr_april2018$site, levels = c("1", "2"))

# nncover may 2018
nncover_may2018 <- dplyr::filter(exotic_cover_all, year == "2018") %>% 
  #rename(treatment = MAFA_removal) %>% 
  dplyr::select(site, plot_number, treatment, cover_percent)

# mafacover may 2018
mafacover_may2018 <- dplyr::filter(mafa_cover_all, year == "2018") %>% 
  dplyr::select(site, year, plot_number, mafacover)

site_cond_2018 <- full_join(par_april2018, tdr_april2018, by = c("site", "plot_number", "treatment")) %>% 
  full_join(nncover_may2018, by = c("site", "plot_number", "treatment")) %>% 
  full_join(mafacover_may2018, by = c("site", "plot_number")) 

view(site_cond_2018)

write.csv(site_cond_2018, "data/processed/may2018_site_conditions.csv")
```

### B2. How are site 1 and site 2 different? 

```{r may2018 site conditions ttest, include=TRUE}

#soil moisture 
t.test(soil_moisture~site, data = site_cond_2018) 
# YES sig diff
# data:  soil_moisture by site
# t = 5.0592, df = 33.993, p-value = 1.44e-05  <-- - soil moiture is sig diff by Site 
site_cond_2018 %>%  
  group_by(site) %>% 
  summarize(avg_tdr = mean(soil_moisture), 
            SD = sd(soil_moisture),
            N = length(soil_moisture), 
            SE = ((sd(soil_moisture))/sqrt(length((soil_moisture)))))
# site  mean   SD      N    SE
#1	9.603704	1.157126	18	0.2727371
#2	7.665741	1.141167	18	0.2689756

# pretty table
march2018_tdrbysite_table <- site_cond_2018 %>%  
  group_by(site) %>% 
  summarize(avg_tdr = mean(soil_moisture), 
            SD = sd(soil_moisture),
            N = length(soil_moisture), 
            SE = ((sd(soil_moisture))/sqrt(length((soil_moisture)))))
march2018_tdrbysite_table %>%
  kbl(caption = "March to May 2018: TDR by site", digits = 3) %>%
  kable_classic(full_width = F, html_font = "Cambria")

summary(aov(soil_moisture ~ site, site_cond_2018))
#            Df Sum Sq Mean Sq F value   Pr(>F)    
#site         1   33.8   33.80    25.6 1.44e-05 ***
#Residuals   34   44.9    1.32                 

#norm_par
t.test(normalized_par~site, data = site_cond_2018) 
# not sig diff
# data:  normalized_par by site
# t = -1.2109, df = 29.972, p-value = 0.2354
site_cond_2018 %>%  
  group_by(site) %>% 
  summarize(avg_par = mean(normalized_par), 
            SD = sd(normalized_par),
            N = length(normalized_par), 
            SE = ((sd(normalized_par))/sqrt(length((normalized_par)))))
# site  mean   SD      N    SE
#1	0.3213315	0.1097804	18	0.02587548
#2	0.3770072	0.1612470	18	0.03800628

  
#nncover
t.test(cover_percent~site, data = site_cond_2018)
# not sig diff
# data:  cover_percent by site
# t = 0.2511, df = 33.554, p-value = 0.8033
site_cond_2018 %>%  
  group_by(site) %>% 
  summarize(avg_tdr = mean(cover_percent), 
            SD = sd(cover_percent),
            N = length(cover_percent), 
            SE = ((sd(cover_percent))/sqrt(length((cover_percent)))))
# site  mean   SD      N    SE
#1	36.58889	12.34307	18	2.909289
#2	35.49056	13.85799	18	3.266359

```


### B3. Subsetting dataframes survival, par, tdr, and nncover to May 2018 data
  - Add height at March 2018 to include in model
  
```{r may 2018 height and survival, include=TRUE}
# subsetting data for May 2018 survival
# survmortnospp = may 2018
# par = april 2018
# tdr = april 2018
# nncover = may 2018

#seedling height in March 2018 - STARTING HEIGHT
height_march <- height_raw %>% 
  filter(date >= "2018-02-23" & date <= "2018-03-31") %>% # filtering to only have rows of data taken in March 
  dplyr::select(plot_number, MAFA_removal, location, species, stem_height_cm, individual, volume_cm3) %>% 
  rename(march_stem_height_cm = stem_height_cm) %>% 
  drop_na()

print(height_march %>%  # check number of individuals per plot in March 2018
  group_by(plot_number) %>% 
  summarise(N = length(march_stem_height_cm)))
# not all plots had 18 seedlings planted in 2018 - Plot 26 and 36
# not all plots have 18 seedling height measurements

# seedling survival or dead in May 2018 - SURVIVAL 0-1
survival_may <- height_raw %>%  ## Need to change some of the individual labels to fix NAs when rejoin. 
  filter(date >= "2018-05-01" & date <= "2018-05-31") %>% # select for may 2018 data collection
  dplyr::select(plot_number, MAFA_removal, location, species, alive, individual) %>% 
  rename(may_alive = alive) %>% # 1 = alive
  mutate(may_alive = replace_na(may_alive, 0), # replace NAs with 0 = dead
         individual = case_when(individual == "s" ~ "S",
                                individual == "c" ~ "C",
                                individual == "r" ~ "R",
                                TRUE ~ individual))  # 0 = dead 1 = alive

print(survival_may %>%  # check number of individuals per plot in May 2018
  summarise(total_seedlings_march2018 = length(individual)))
# 648 seedlings that were alive in March 2018
# 18 * 36 = 648

print(survival_may %>%  # check number of individuals per plot in May 2018
        group_by(MAFA_removal) %>% 
  summarise(seedlingspertreat_march2018 = length(individual)))

```

- Add rgr at March 2018 to include in model
```{r may 2018 relative growth rate, include=TRUE}

#seedling height in May 2018 - ENDING HEIGHT
height_may <- height_raw %>% 
  filter(date >= "2018-05-01" & date <= "2018-05-31") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, stem_height_cm, individual) %>% 
  rename(may_stem_height_cm = stem_height_cm) %>% 
  mutate(individual = case_when(individual == "s" ~ "S",
                                individual == "c" ~ "C",
                                individual == "r" ~ "R",
                                TRUE ~ individual),
         may_stem_height_cm = as.numeric(may_stem_height_cm)) %>% 
  drop_na()

print(height_may %>%  # check number of individuals per plot in May 2018
  group_by(plot_number) %>% 
  summarise(N = length(may_stem_height_cm)))
print(height_may %>%  # check number of individuals per plot in May 2018
  summarise(total_seedlings_may2018 = length(may_stem_height_cm)))
# 310 seedlings that survived to May 2018

# growth rate from March to May 2018 - GROWTH RATE
growth_march_may <- right_join(height_march, height_may, by = c("plot_number", "MAFA_removal", "location", "species", "individual")) %>% 
  mutate(march_stem_height_cm = as.numeric(march_stem_height_cm)) %>% 
  drop_na() %>% 
  mutate(rgr = (log(may_stem_height_cm) - log(march_stem_height_cm))/60, # relative growth rate per day equation; 60 days between March and May
         plot_number = as.character(plot_number)) %>% 
  left_join(par_april2018, by = "plot_number") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, individual, rgr, normalized_par) %>% 
  left_join(tdr_april2018, by = "plot_number") %>% 
  dplyr::select(!site & !treatment) %>% 
  left_join(nncover_may2018, by = "plot_number") %>% 
  dplyr::select(!treatment) %>% 
  rename(exotic_percentcover = cover_percent) %>% 
  rename(treatment = MAFA_removal)
```

### B4. Join May 2018 data

NOTE: May 12, 2023 - need to re-check code to make sure all seedlings are included... including rgr omits seedlings that were alive in March and died in May because many dead seedlings were not re-measured in May 2018.

```{r may 2018 join march to may data, include=TRUE}

# March to May 2018 join - JOIN - 
# starting height, 0-1 may 2018, april 2018 normPAR, april 2018 tdr, nncover april 2018
height_march_surv_may_notransf <- full_join(height_march, survival_may, by = c("plot_number", "MAFA_removal", "location", "species", "individual")) %>% 
  mutate(march_stem_height_cm = as.numeric(march_stem_height_cm)) %>% # warning: one height "didn't plant"
  drop_na() %>% # drops nas 
  mutate(plot_number = as.character(plot_number)) %>% 
  left_join(par_april2018, by = "plot_number") %>% # join April 2018 PAR
  dplyr::select(plot_number, MAFA_removal, location, species, individual, march_stem_height_cm, may_alive, normalized_par, volume_cm3) %>% # include volume_cm3
  left_join(tdr_april2018, by = "plot_number") %>% # join April 2018 TDR
  dplyr::select(!site & !treatment) %>% 
  left_join(nncover_may2018, by = "plot_number") %>%  # join April 2018 nncover
  dplyr::select(!treatment) %>% 
  rename(exotic_percentcover = cover_percent) %>% 
  rename(treatment = MAFA_removal) %>% 
  left_join(mafacover_may2018, by = "plot_number") %>% 
    dplyr::select(!site.y) %>% 
  rename(site = site.x) %>% 
left_join(growth_march_may, by = c("plot_number", "treatment", "location", "species", "individual", "normalized_par", "site", "soil_moisture", "exotic_percentcover")) %>%  
   mutate(site = as.factor(site))

view(height_march_surv_may_notransf)

write.csv(height_march_surv_may_notransf, "data/processed/height_march_surv_may_notransf.csv")

print(height_march_surv_may_notransf %>%  # check number of individuals per plot
  group_by(site, species) %>% 
  summarise(N = length(individual))
)
# 606 seedlings
```

```{r may 2018 aov height x spp, include=TRUE}

#height
summary(aov(march_stem_height_cm ~ species, data = height_march_surv_may_notransf))
#          Df Sum Sq Mean Sq F value Pr(>F)    
#species       3   2990   996.7     313 <2e-16 ***
#Residuals   602   1917     3.2 
 
print(TukeyHSD(aov(march_stem_height_cm ~ species, data = height_march_surv_may_notransf)))
#HEAR is significantly taller than all the other species in March 2018
#SAAP, CEOL, and RHOV are all similar in height
#$species
#                diff        lwr        upr     p adj
#HEAR-CEOL  4.5865165  4.0757534  5.0972795 0.0000000 <-- HEAR - CEOL
#RHOV-CEOL -0.2545951 -0.8184931  0.3093028 0.6503705
#SAAP-CEOL  0.1248809 -0.4510153  0.7007772 0.9441751
#RHOV-HEAR -4.8411116 -5.3448044 -4.3374188 0.0000000 <-- HEAR - RHOV
#SAAP-HEAR -4.4616355 -4.9787254 -3.9445456 0.0000000 <-- HEAR - SAAP
#SAAP-RHOV  0.3794761 -0.1901589  0.9491110 0.3160699

#volume
summary(aov(volume_cm3 ~ species, data = height_march_surv_may_notransf))
#            Df  Sum Sq Mean Sq F value Pr(>F)    
#species       3 2608825  869608   147.3 <2e-16 ***
#Residuals   602 3554014    5904       
print(TukeyHSD(aov(volume_cm3 ~ species, data = height_march_surv_may_notransf)))
#$species
#                 diff        lwr        upr     p adj
#HEAR-CEOL  140.309690  118.31777  162.30161 0.0000000 <-- HEAR - CEOL
#RHOV-CEOL    1.720552  -22.55919   26.00030 0.9978392
#SAAP-CEOL    8.475339  -16.32102   33.27169 0.8149679
#RHOV-HEAR -138.589138 -160.27663 -116.90165 0.0000000 <-- HEAR - RHOV
#SAAP-HEAR -131.834351 -154.09868 -109.57002 0.0000000 <-- HEAR - SAAP
#SAAP-RHOV    6.754787  -17.77198   31.28155 0.8933340

# may 2018 alive vs dead by spp
print(height_march_surv_may_notransf %>%  
  group_by(species) %>% 
  summarise(N = length(may_alive), 
            total_survived = sum(may_alive >= 1), 
            total_died = sum(may_alive == "0"),
            percent_survived = 100*(sum(may_alive >= 1)/length(may_alive))))
#species    N   tot_sur tot_dead percent_surv
#CEOL	      130	35	    95	        26.92308
#HEAR	      215	100	    115	        46.51163
#RHOV	      136	34	    102	        25.00000
#SAAP	      125	21	    104	        16.80000

# may 2018 height x spp
print(height_march_surv_may_notransf %>%  
  group_by(species) %>% 
  summarise(height_avg_cm = mean(march_stem_height_cm), 
            height_sd_cm = sd(march_stem_height_cm)))

#average seedling volume
height_march_surv_may_notransf %>%  
  summarise(avg_vol_cm3 = mean(volume_cm3), 
            SD = sd(volume_cm3),
            N = length(volume_cm3), 
            SE = ((sd(volume_cm3))/sqrt(length((volume_cm3)))), 
            min = min(volume_cm3),
            max = max(volume_cm3))

# avg_vol_cm3  SD  N      SE              min        max
# 56.08124	100.9282	606	4.09993	  0.001047198	669.3631

#average seedling volume by alive/dead
height_march_surv_may_notransf %>%  
  group_by(species, may_alive) %>% 
  summarise(avg_vol_cm3 = mean(volume_cm3), 
            SD = sd(volume_cm3),
            N = length(volume_cm3), 
            SE = ((sd(volume_cm3))/sqrt(length((volume_cm3)))), 
            min = min(volume_cm3),
            max = max(volume_cm3))
# may_alive avg_vol_cm3  SD  N      SE              min        max
# 0	39.25811	85.43163	416	4.188630	0.001047198	669.3631
# 1	92.91502	120.80904	190	8.764409	0.232111337	663.7324
# 
# species may_alive avg_vol_cm3  SD  N      SE              min        max
#CEOL	0	3.553535	4.239300	95	0.4349430	0.001773953	25.57675
#CEOL	1	5.832308	5.808008	35	0.9817326	0.314700143	24.74139
#HEAR	0	125.733340	124.713902	115	11.6296313	0.001308997	669.36308
##HEAR	1	166.031652	125.928393	100	12.5928393	0.232111337	663.73245
#RHOV	0	4.987078	4.256540	102	0.4214603	0.003543717	22.23388
#RHOV	1	8.589176	7.011436	34	1.2024514	0.776610082	25.86159
#SAAP	0	9.863203	24.444078	104	2.3969390	0.001047198	142.49537
#SAAP	1	26.405982	50.512352	21	11.0226988	0.332719795	201.20173


# may 2018 vol x spp
print(height_march_surv_may_notransf %>%  
  group_by(species) %>% 
  summarise(avg_vol_cm3 = mean(volume_cm3), 
            SD = sd(volume_cm3),
            N = length(volume_cm3), 
            SE = ((sd(volume_cm3))/sqrt(length((volume_cm3))))))
#species    avg_vol_cm3   SD          N         SE
#CEOL	      4.167051	    4.797507	  130	      0.4207692
#HEAR	      144.476741	  126.600155	215	      8.6340589
#RHOV	      5.887603	    5.293661	  136	      0.4539277
#SAAP	      12.642390	    30.763829	  125	      2.7516005


# soil moisture
summary(aov(soil_moisture ~ may_alive, data = height_march_surv_may_notransf))
#               Df Sum Sq Mean Sq F value   Pr(>F)    
#soil_moisture   1   2.51  2.5085   11.85 0.000618 ***
#Residuals     604 127.92  0.2118

# may 2018 alive x tdr
height_march_surv_may_notransf %>%  
  group_by(may_alive) %>% 
  summarize(avg_tdr = mean(soil_moisture), 
            SD = sd(soil_moisture),
            N = length(soil_moisture), 
            SE = ((sd(soil_moisture))/sqrt(length((soil_moisture)))))
# may_alive avg_tdr SD  N       SE
#0	    8.561238	1.488091	416   	0.07295968
#1	9.001974	1.404786	190	    0.10191389

t.test(soil_moisture ~ may_alive, data = height_march_surv_may_notransf) 
# Soil moisture is significantly different betweeen alive and dead seedlings
#data:  soil_moisture by may_alive
#t = -3.5164, df = 386.18, p-value = 0.0004895
```

```{r may 2018 transform data, include=TRUE}

# scale transform data: normPAR, tdr, nncover, starting height - SCALE
height_march_surv_may <- height_march_surv_may_notransf %>% 
  mutate(normalized_par = scale(normalized_par), # scale transforms the data; helps when comparing variables with different units; changes column names
         soil_moisture = scale(soil_moisture),
         exotic_percentcover = scale(exotic_percentcover),
         march_stem_height_cm = scale(march_stem_height_cm),
         rgr = scale(rgr),
         volume_cm3 = scale(volume_cm3),
         may_alive = as.factor(may_alive),
        species = as.factor(species)) 
glimpse(height_march_surv_may)


write.csv(height_march_surv_may, "data/processed/height_march_surv_may.csv")



```

```{r notes on lmer vs glmer, include=FALSE}

# lmer is used to fit linear mixed-effect models, so it assumes that the residual error has a Gaussian distribution. 

# If your dependent variable A is a binary outcome (e.g. a yes/no response), then the error distribution is binomial and not Gaussian. In this case you have to use glmer, which allow to fit a generalized linear mixed-effects model: these models include a link function that allows to predict response variables with non-Gaussian distributions. 

# One example of link function that could work in your case is the logistic function, which takes an input with any value from negative to positive infinity and return an output that always takes values between zero and one, which is interpretable as the probability of the binary outcome (e.g. the probability of the subject responding 'yes').
```

### B4. Model may 2018 with glmers
- run glmer with:
--- mafacover
--- treatment
--- PAR + TDR
--- PAR  TDR
--- dredge all four models if possible
```{r may 2018 glmer MODELS, include=TRUE}
# check for binomial distribution:
# glmer - yes/no = binomial distribution
# 1.0 is perfect
# 1.7 is getting dicy
# >1.7 is not a good fit

#Moreover, the convergence code is zero which indicates that the model has not converged, and the estimated #variance for the random effect is zero. This means that potentially there is no variation within Anim_ID. #It would be a good idea to fit a model with glm() (ie without random intercepts but with Anim_ID as a fixed #effect) and see how the model estimates compare.

# ALL - mafacover with volume
glme.may2018.mod.mafacover <- glmer(may_alive ~ mafacover + species + volume_cm3 + site + (1|plot_number), 
                         family = binomial, 
                         data = height_march_surv_may, na.action = "na.fail")
summary(glme.may2018.mod.mafacover) # AIC = 694.6
#Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)   
#(Intercept) -0.501409   0.394745  -1.270  0.20401   
#mafacover   -0.002468   0.013144  -0.188  0.85107   
#speciesHEAR  0.492570   0.305648   1.612  0.10706   
#speciesRHOV -0.106578   0.292395  -0.365  0.71548   
#speciesSAAP -0.698528   0.323254  -2.161  0.03070 * 
#volume_cm3   0.354511   0.122637   2.891  0.00384 **
#site2       -0.830028   0.321107  -2.585  0.00974 **

#CEOL x mafacover - volume
height_march_surv_may_CEOL <- height_march_surv_may %>% 
  filter(species=="CEOL")
glme.may2018.mod.mafacover_CEOL <- glmer(may_alive ~ mafacover + volume_cm3 + site + (1|plot_number), 
                         family = binomial, 
                         data = height_march_surv_may_CEOL, na.action = "na.fail")
summary(glme.may2018.mod.mafacover_CEOL)
#Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)   
#(Intercept)  4.152385   2.427597   1.710  0.08717 . 
#mafacover   -0.005242   0.023159  -0.226  0.82094   
#volume_cm3   8.793670   4.595334   1.914  0.05567 . <-- vol
#site2       -1.632152   0.616645  -2.647  0.00813 ** <-- site
#---
#Signif. codes:  
#0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

#Correlation of Fixed Effects:
#           (Intr) mafcvr vlm_c3
#mafacover  -0.189              
#volume_cm3  0.971  0.020      
#site2      -0.146  0.498  0.010

glme.may2018.mod.mafacover_CEOL_summarytable %>%
  kbl(caption = "PAR values", digits = 0) %>%
  kable_classic(full_width = F, html_font = "Cambria")

#HEAR x mafacover - volume
height_march_surv_may_HEAR <- height_march_surv_may %>% 
  filter(species=="HEAR")
glme.may2018.mod.mafacover_HEAR <- glmer(may_alive ~ mafacover + volume_cm3 + site + (1|plot_number), 
                         family = binomial, 
                         data = height_march_surv_may_HEAR, na.action = "na.fail")
summary(glme.may2018.mod.mafacover_HEAR)
#Fixed effects:
#            Estimate Std. Error z value Pr(>|z|)   
#(Intercept) -0.19936    0.78291  -0.255  0.79901   
#mafacover   -0.01060    0.02865  -0.370  0.71149   
#volume_cm3   0.42894    0.14406   2.978  0.00291 ** <-- vol
#site2       -0.40895    0.69120  -0.592  0.55408 

#Correlation of Fixed Effects:
#           (Intr) mafcvr vlm_c3
#mafacover  -0.829              
#volume_cm3 -0.181  0.024       
#site2      -0.751  0.520 -0.019

#RHOV x mafacover - volume
height_march_surv_may_RHOV <- height_march_surv_may %>% 
  filter(species=="RHOV")
glme.may2018.mod.mafacover_RHOV <- glmer(may_alive ~ mafacover + volume_cm3 + site + (1|plot_number), 
                         family = binomial, 
                         data = height_march_surv_may_RHOV, na.action = "na.fail")
summary(glme.may2018.mod.mafacover_RHOV)

#Fixed effects:
#            Estimate Std. Error z value Pr(>|z|)   
#(Intercept)  4.83643    2.17392   2.225  0.02610 * 
#mafacover    0.01786    0.02192   0.815  0.41508   
#volume_cm3  12.44942    4.28343   2.906  0.00366 ** <-- vol
#site2       -0.42575    0.54653  -0.779  0.43598   

#Correlation of Fixed Effects:
#           (Intr) mafcvr vlm_c3
#mafacover  -0.245              
#volume_cm3  0.960 -0.004       
#site2      -0.260  0.513 -0.064

#SAAP x mafacover - volume
height_march_surv_may_SAAP <- height_march_surv_may %>% 
  filter(species=="SAAP")
glme.may2018.mod.mafacover_SAAP <- glmer(may_alive ~ mafacover + volume_cm3 + site + (1|plot_number), 
                         family = binomial, 
                         data = height_march_surv_may_SAAP, na.action = "na.fail")
summary(glme.may2018.mod.mafacover_SAAP)
#Fixed effects:
#            Estimate Std. Error z value Pr(>|z|)   
#(Intercept) -0.25845    0.60541  -0.427  0.66945   
#mafacover   -0.01991    0.02320  -0.858  0.39075   
#volume_cm3   0.76646    0.63176   1.213  0.22505   
#site2       -2.47834    0.84015  -2.950  0.00318 ** <-- site
#
#Correlation of Fixed Effects:
#           (Intr) mafcvr vlm_c3
#mafacover  -0.821              
#volume_cm3  0.332  0.020       
#site2      -0.415  0.378  0.130
#optimizer (Nelder_Mead) convergence code: 0 (OK)
#boundary (singular) fit: see help('isSingular')  <-- ???



# with height
glme.may2018.mod.mafacover_height <- glmer(may_alive ~ mafacover + species + march_stem_height_cm + site + (1|plot_number), 
                         family = binomial, 
                         data = height_march_surv_may, na.action = "na.fail")
summary(glme.may2018.mod.mafacover) # AIC =  702.2
#                      Estimate Std. Error z value Pr(>|z|)  
#(Intercept)          -0.568791   0.400547  -1.420   0.1556  
#mafacover            -0.004016   0.013159  -0.305   0.7602  
#speciesHEAR           0.713980   0.344592   2.072   0.0383 *
#speciesRHOV          -0.082089   0.292455  -0.281   0.7789  
#speciesSAAP          -0.668788   0.322712  -2.072   0.0382 *
#march_stem_height_cm  0.170082   0.145766   1.167   0.2433  
#site2                -0.820529   0.321036  -2.556   0.0106 *

MOD <- glme.may2018.mod.mafacover 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) 
#data:  simulationOutput
#dispersion = 1.0126, p-value = 0.856
#alternative hypothesis: two.sided
dredge(glme.may2018.mod.mafacover)
#Model selection table 
#     (Int)       mfc sit spc vlm_cm3 df   logLik  AICc delta weight
#15 -0.5558             +   +  0.3551  7 -339.319 692.8  0.00  0.648 <-- best model is without mafacover although pretty similar to with mafa cover.
#16 -0.5014 -0.002468   +   +  0.3545  8 -339.301 694.8  2.02  0.236


# treatment
glme.may2018.mod.mafatreat <- glmer(may_alive ~ treatment + species + volume_cm3 + site + (1|plot_number), 
                         family = binomial, 
                         data = height_march_surv_may, na.action = "na.fail")
summary(glme.may2018.mod.mafatreat) # AIC = 692.3
#    AIC      BIC   logLik deviance df.resid 
#   692.3    731.9   -337.1    674.3      597 

#Scaled residuals: 
#    Min      1Q  Median      3Q     Max 
#-2.3984 -0.6214 -0.4307  0.8271  2.8575 

#Random effects:
# Groups      Name        Variance Std.Dev.
# plot_number (Intercept) 0.2526   0.5026  
#Number of obs: 606, groups:  plot_number, 36

#Fixed effects:
#                      Estimate Std. Error z value Pr(>|z|)   
#(Intercept)            -0.3606     0.3122  -1.155  0.24797   
#treatmenthalf removal  -0.0228     0.3067  -0.074  0.94073   
#treatmentnone          -0.6086     0.3170  -1.920  0.05491 . 
#speciesHEAR             0.5138     0.3059   1.679  0.09307 . 
#speciesRHOV            -0.1009     0.2925  -0.345  0.73021   
#speciesSAAP            -0.6953     0.3233  -2.150  0.03154 * 
#volume_cm3              0.3435     0.1228   2.798  0.00515 **
#site2                  -0.7993     0.2592  -3.084  0.00204 **

glme.may2018.mod.mafatreat_HEAR <- glmer(may_alive ~ treatment + volume_cm3 + site + (1|plot_number), 
                         family = binomial, 
                         data = height_march_surv_may_HEAR, na.action = "na.fail")
summary(glme.may2018.mod.mafatreat_HEAR)
#Fixed effects:
#                      Estimate Std. Error z value Pr(>|z|)
#(Intercept)             0.1372     0.5919   0.232  0.81666
#treatmenthalf removal  -0.6629     0.7078  -0.937  0.34897
#treatmentnone          -1.0442     0.7130  -1.465  0.14303
#volume_cm3              0.4243     0.1438   2.950  0.00318 **
#site2                  -0.2726     0.5766  -0.473  0.63639

MOD <- glme.may2018.mod.mafatreat 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) 
#data:  simulationOutput
#dispersion = 1.0087, p-value = 0.816
#alternative hypothesis: two.sided
dredge(glme.may2018.mod.mafatreat)
#Model selection table 
#     (Int) sit spc trt vlm_cm3 df   logLik  AICc delta weight
#16 -0.3606   +   +   +  0.3435  9 -337.137 692.6  0.00  0.480


# environmental conditions FULL
# tdr + par
glme.may2018.mod.1 <- glmer(may_alive ~ 
                             normalized_par + soil_moisture # plus
                            + exotic_percentcover + site 
                            + volume_cm3 + species # plus
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_march_surv_may, na.action = "na.fail")
summary(glme.may2018.mod.1)
# AIC: 696.5
#Fixed effects:
#                    Estimate Std. Error z value Pr(>|z|)   
#(Intercept)         -0.69977    0.28854  -2.425  0.01530 * 
#normalized_par       0.00966    0.15166   0.064  0.94921   
#soil_moisture        0.25036    0.17752   1.410  0.15844   
#exotic_percentcover -0.01068    0.14764  -0.072  0.94232   
#site2               -0.48841    0.35111  -1.391  0.16421   
#volume_cm3           0.36269    0.12329   2.942  0.00326 ** <-- seedling volume
#speciesHEAR          0.48153    0.30614   1.573  0.11573   
#speciesRHOV         -0.10973    0.29242  -0.375  0.70748   
#speciesSAAP         -0.70437    0.32340  -2.178  0.02941 * <-- species SAAP
MOD <- glme.may2018.mod.1 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) 
#data:  simulationOutput
#dispersion = 1.01, p-value = 0.84
#alternative hypothesis: two.sided
dredge(glme.may2018.mod.1)

# tdr * par
glme.may2018.mod.2 <- glmer(may_alive ~ 
                             normalized_par * soil_moisture # times
                            + exotic_percentcover + site 
                            + volume_cm3 + species # plus ; march_stem_height_cm OR volume_cm3; vol has lower AIC
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_march_surv_may
                         #, na.action = "na.fail"
                         )
anova(glme.may2018.mod.2)
summary(glme.may2018.mod.2)
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                  -0.59678    0.26206  -2.277 0.022769 *  
#normalized_par                0.23082    0.13687   1.686 0.091724 .  
#soil_moisture                 0.39538    0.15547   2.543 0.010986 *  
#exotic_percentcover           0.05639    0.12384   0.455 0.648866    
#site2                        -0.53365    0.28874  -1.848 0.064569 .  
#volume_cm3                    0.35577    0.12244   2.906 0.003664 ** 
#speciesHEAR                   0.47571    0.30567   1.556 0.119635    
#speciesRHOV                  -0.12386    0.29338  -0.422 0.672899    
#speciesSAAP                  -0.74044    0.32505  -2.278 0.022728 *  
#normalized_par:soil_moisture  0.54188    0.13957   3.882 0.000103 ***
emmeans(glme.may2018.mod.2, list(pairwise ~ species), adjust = "tukey")
#$`pairwise differences of species`
# 1           estimate    SE  df z.ratio p.value
# CEOL - HEAR   -0.476 0.306 Inf  -1.556  0.4039
# CEOL - RHOV    0.124 0.293 Inf   0.422  0.9747
# CEOL - SAAP    0.740 0.325 Inf   2.278  0.1032
# HEAR - RHOV    0.600 0.304 Inf   1.973  0.1981
# HEAR - SAAP    1.216 0.330 Inf   3.683  0.0013
# RHOV - SAAP    0.617 0.324 Inf   1.900  0.2278

height_march_surv_may %>% 
  group_by(species, treatment) %>% 
  summarise(totalsurvival = sum(may_alive))

ggplot(data = height_march_surv_may, 
       x = species, 
       y = height_march_surv_may %>% sum(may_alive)) +
         geom_point() + geom_boxplot()
                                                          

# AIC: 684.9
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                  -0.59678    0.26206  -2.277 0.022769 *  
#normalized_par                0.23082    0.13687   1.686 0.091724 .  
#soil_moisture                 0.39538    0.15547   2.543 0.010986 *  <-- soil moisture
#exotic_percentcover           0.05639    0.12384   0.455 0.648866    
#site2                        -0.53365    0.28874  -1.848 0.064569 .  
#volume_cm3                    0.35577    0.12244   2.906 0.003664 ** <-- seedling volume 
#speciesHEAR                   0.47571    0.30567   1.556 0.119635    
#speciesRHOV                  -0.12386    0.29338  -0.422 0.672899    
#speciesSAAP                  -0.74044    0.32505  -2.278 0.022728 *  <-- species 
#normalized_par:soil_moisture  0.54188    0.13957   3.882 0.000103 *** <-- soil moisture x par
MOD <- glme.may2018.mod.2 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) # it follows a binomial distribution!
#data:  simulationOutput
#dispersion = 1.0009, p-value = 0.992
#alternative hypothesis: two.sided
dredge(glme.may2018.mod.2)
```

```{r may 2018 sandbox glmers, include=FALSE}
# additional models run but not used

glme.may2018.mod.3 <- glmer(may_alive ~ 
                             normalized_par * soil_moisture + exotic_percentcover + site + # times 
                             march_stem_height_cm * species + (1|plot_number), # times
                         family = binomial, 
                         data = height_march_surv_may)
summary(glme.may2018.mod.3)
# AIC = 693.0
#Fixed effects:
#                                 Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                      -1.01340    0.49204  -2.060   0.0394 *  
#normalized_par                    0.22136    0.14018   1.579   0.1143    
#soil_moisture                     0.40087    0.15856   2.528   0.0115 *   <-- tdr
#exotic_percentcover               0.06039    0.12550   0.481   0.6304    
#site2                            -0.51549    0.29315  -1.758   0.0787 .  
#march_stem_height_cm             -0.38527    0.71407  -0.540   0.5895    
#speciesHEAR                       1.08268    0.51634   2.097   0.0360 *  <-- spp
#speciesRHOV                       1.04482    0.70018   1.492   0.1356    
#speciesSAAP                      -0.09353    0.56593  -0.165   0.8687    
#normalized_par:soil_moisture      0.55959    0.14347   3.901  9.6e-05 *** <-- tdr x par
#march_stem_height_cm:speciesHEAR  0.49651    0.73104   0.679   0.4970    
#march_stem_height_cm:speciesRHOV  1.88603    1.06792   1.766   0.0774 .  
#march_stem_height_cm:speciesSAAP  1.20488    0.86272   1.397   0.1625  

glme.may2018.mod.4 <- glmer(may_alive ~ 
                             normalized_par + soil_moisture # plus
                             + site  # no exotic cover
                            + march_stem_height_cm + species # plus
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_march_surv_may)
summary(glme.may2018.mod.4)
# AIC: 702.6
#Fixed effects:
#                      Estimate Std. Error z value Pr(>|z|)   
#(Intercept)          -0.800772   0.293856  -2.725  0.00643 **
#normalized_par       -0.008121   0.138196  -0.059  0.95314   
#soil_moisture         0.232701   0.175242   1.328  0.18422   
#site2                -0.473156   0.351743  -1.345  0.17857   
#march_stem_height_cm  0.167865   0.145955   1.150  0.25010   
#speciesHEAR           0.717656   0.345187   2.079  0.03761 * 
#speciesRHOV          -0.085284   0.292455  -0.292  0.77058   
#speciesSAAP          -0.673299   0.322758  -2.086  0.03697 * 

glme.may2018.mod.5 <- glmer(may_alive ~ 
                             normalized_par * soil_moisture # times
                             + site  # no exotic cover
                            + march_stem_height_cm + species # plus
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_march_surv_may)
summary(glme.may2018.mod.5)
# AIC: 690.5
# Fixed effects:
#              Estimate Std. Error z value Pr(>|z|)    
# (Intercept)                  -0.67157    0.26866  -2.500   0.0124 *  
#normalized_par                0.19483    0.12569   1.550   0.1211    
#soil_moisture                 0.36456    0.15283   2.385   0.0171 *  
#site2                        -0.53426    0.28949  -1.846   0.0650 .  
#march_stem_height_cm          0.19324    0.14573   1.326   0.1849    
#speciesHEAR                   0.66010    0.34573   1.909   0.0562 .  
#speciesRHOV                  -0.09861    0.29338  -0.336   0.7368    
#speciesSAAP                  -0.71114    0.32455  -2.191   0.0284 *  
#normalized_par:soil_moisture  0.55034    0.13999   3.931 8.45e-05 ***

glme.may2018.mod.6 <- glmer(may_alive ~ 
                             normalized_par * soil_moisture # times
                             + site  # no exotic cover
                            + march_stem_height_cm * species # times
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_march_surv_may)
summary(glme.may2018.mod.6)
#AIC = 691.2
#Fixed effects:
#                                 Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                      -1.02113    0.49196  -2.076 0.037927 *  
#normalized_par                    0.19382    0.12861   1.507 0.131783    
#soil_moisture                     0.38623    0.15664   2.466 0.013674 *  <-- tdr
#site2                            -0.52400    0.29492  -1.777 0.075604 .  
#march_stem_height_cm             -0.40257    0.71296  -0.565 0.572316    
#speciesHEAR                       1.09326    0.51557   2.120 0.033965 *  <-- spp
#speciesRHOV                       1.04934    0.69983   1.499 0.133764    
#speciesSAAP                      -0.08406    0.56545  -0.149 0.881825    
#normalized_par:soil_moisture      0.55278    0.14379   3.844 0.000121 *** <-- par x tdr
#march_stem_height_cm:speciesHEAR  0.51221    0.73019   0.701 0.483009    
#march_stem_height_cm:speciesRHOV  1.89285    1.06699   1.774 0.076061 .  
#march_stem_height_cm:speciesSAAP  1.21723    0.86188   1.412 0.157861 

# MINIMAL MODELS

glme.may2018.mod.7 <- glmer(may_alive ~ 
                             normalized_par + soil_moisture + species + (1|plot_number), # plus
                         family = binomial, 
                         data = height_march_surv_may)
summary(glme.may2018.mod.7)
# AIC: 701.6 

glme.may2018.mod.8 <- glmer(may_alive ~ 
                             normalized_par * soil_moisture + species + (1|plot_number), # times
                         family = binomial, 
                         data = height_march_surv_may)
summary(glme.may2018.mod.8)
# AIC: 691.3  
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                   -1.0399     0.2213  -4.700 2.60e-06 ***
#normalized_par                 0.1509     0.1307   1.154 0.248345    
#soil_moisture                  0.5266     0.1319   3.991 6.57e-05 *** <-- tdr
#speciesHEAR                    0.9700     0.2546   3.810 0.000139 *** <-- species
#speciesRHOV                   -0.1128     0.2929  -0.385 0.700109    
#speciesSAAP                   -0.6973     0.3245  -2.149 0.031647 *  <-- species
#normalized_par:soil_moisture   0.5329     0.1466   3.636 0.000277 ***<-- tdr x par

 
# RELATIVE GROWTH RATE

# relative growth rate as dependent variable - Shane's code
glme_rgr_may2018.1 <- lmer(rgr ~ normalized_par*soil_moisture + exotic_percentcover + site + (1|plot_number),
                         data = growth_march_may)
summary(glme_rgr_may2018.1)
# no AIC
# Site 2 is significant



```

```{r }

MODmc <- glme.may2018.mod.mafacover 
MODtreat <- glme.may2018.mod.mafatreat
MOD1 <- glme.may2018.mod.1
MOD2 <- glme.may2018.mod.2

# Calculate model's residual and fitted values
F1 <- fitted(MOD)
E1 <- residuals(MOD, "pearson")

# Graph residuals vs fitted values to inspect homogeneity of variance, look for a random scattering of plots
# run together 2 lines
plot(x=F1, y=E1, xlab="Fitted Model Values", ylab="Pearson Residuals", main = "Variance")
abline(h = 0) # looking for random scatter

# Check for crazy outliers, look for lines MUCH taller than the rest of data
plot(cooks.distance(MOD))

# Plot a box plot for each factor, look for equal variance amount levels along the zero line
# Box plots need to be assessed for every fixed effect (categorical factor) for your model. 
# Random effects need the qqline just like normality. 
# So, only site and treatment get box plots. 
# exotic_cover is a covariate (continuous variable).

boxplot(E1 ~ site, data = height_march_surv_may) # <---- make sure to change to df, not the glmer
abline(h = 0)
# error message - variable lengths differ
print(height_march_surv_may %>%  # check number of individuals per plot in March 2018
  group_by(site) %>% 
  summarise(N = length(site)))
# site N
# 1	  318			
# 2 	288	

boxplot(E1 ~ species, data = height_march_surv_may) # <---- make sure to change to df, not the lme
abline(h = 0)

# Plot each random effect in the model - things in the (1|_), look for dots along 1:1 line
qqnorm(ranef(MOD)$plot_number[,1], main = "Plot Residuals")
qqline(ranef(MOD)$plot_number[,1]) # plot number

#qqnorm(ranef(MOD)$individual[,1], main = "Plot Residuals")
#qqline(ranef(MOD)$individual[,1]) # individual: blue, green, S, C, R

```


### Statistics

```{r may 2018 stats, include=TRUE}

print(glme.may2018.mod.2)
anova(glme.may2018.mod.2)
#Analysis of Variance Table
#                             npar Sum Sq Mean Sq F value
#normalized_par                  1  0.042   0.042  0.0425
#soil_moisture                   1  5.286   5.286  5.2864
#exotic_percentcover             1  0.007   0.007  0.0073
#site                            1  1.567   1.567  1.5666
#volume_cm3                      1 33.801  33.801 33.8014
#species                         3 11.730   3.910  3.9100
#normalized_par:soil_moisture    1 15.179  15.179 15.1794

summary(glme.may2018.mod.2)
# when normalized_par * soil_moisture and WITHOUT rgr 
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                  -0.67222    0.26791  -2.509   0.0121 *  
#normalized_par                0.22151    0.13682   1.619   0.1055    
#soil_moisture                 0.37873    0.15482   2.446   0.0144 * <-- soil moisture
#exotic_percentcover           0.05884    0.12325   0.477   0.6331    
#site2                        -0.52592    0.28791  -1.827   0.0677 .  
#march_stem_height_cm          0.19582    0.14592   1.342   0.1796    
#speciesHEAR                   0.65675    0.34598   1.898   0.0577 .  
#speciesRHOV                  -0.09939    0.29329  -0.339   0.7347    
#speciesSAAP                  -0.71330    0.32438  -2.199   0.0279 *  <-- species
#normalized_par:soil_moisture  0.55680    0.13963   3.988 6.67e-05 *** <-- interaction PAR x TDR



# when normalized_par * soil_moisture + nncover + species * march_stem_height_cm
#Fixed effects:
#                                 Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                      -1.01340    0.49204  -2.060   0.0394 *  
#normalized_par                    0.22136    0.14018   1.579   0.1143    
#soil_moisture                     0.40087    0.15856   2.528   0.0115 *  <-- soil moisture
#exotic_percentcover               0.06039    0.12550   0.481   0.6304    
#site2                            -0.51549    0.29315  -1.758   0.0787 .  
#march_stem_height_cm             -0.38527    0.71407  -0.540   0.5895    
#speciesHEAR                       1.08268    0.51634   2.097   0.0360 *  <-- spp hear
#speciesRHOV                       1.04482    0.70018   1.492   0.1356    
#speciesSAAP                      -0.09353    0.56593  -0.165   0.8687    
#normalized_par:soil_moisture      0.55959    0.14347   3.901  9.6e-05 *** <-- par x tdr
#march_stem_height_cm:speciesHEAR  0.49651    0.73104   0.679   0.4970    
#march_stem_height_cm:speciesRHOV  1.88603    1.06792   1.766   0.0774 .  
#march_stem_height_cm:speciesSAAP  1.20488    0.86272   1.397   0.1625 


# when normalized_par * soil_moisture + nncover and WITHOUT rgr or species
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                  -0.57868    0.17050  -3.394 0.000689 ***
#normalized_par                0.22687    0.13362   1.698 0.089519 .  
#soil_moisture                 0.36255    0.15091   2.402 0.016285 *  <-- soil moisture
#exotic_percentcover           0.05844    0.12111   0.483 0.629438    
#site2                        -0.52012    0.28056  -1.854 0.063762 .  
#march_stem_height_cm          0.52137    0.09360   5.570 2.55e-08 *** <-- march stem height
#normalized_par:soil_moisture  0.54752    0.13617   4.021 5.80e-05 *** <-- par x tdr interaction

# when normalized_par + soil_moisture and WITHOUT rgr = only species is significant
#Fixed effects:
#                      Estimate Std. Error z value Pr(>|z|)   
#(Intercept)          -0.800203   0.293996  -2.722  0.00649 **
#normalized_par       -0.012121   0.151858  -0.080  0.93638   
#soil_moisture         0.230743   0.178312   1.294  0.19565   
#exotic_percentcover  -0.009566   0.148175  -0.065  0.94853   
#site2                -0.474881   0.352830  -1.346  0.17833   
#march_stem_height_cm  0.167639   0.145981   1.148  0.25082   
#speciesHEAR           0.717822   0.345186   2.080  0.03757 * <-- species
#speciesRHOV          -0.085414   0.292463  -0.292  0.77025   
#speciesSAAP          -0.673506   0.322808  -2.086  0.03694 * <-- species

print(glme.may2018.modspp)
summary(glme.may2018.modspp)
# when normalized_par * soil_moisture and WITHOUT rgr = soil_moisture, norm_par*soil_moisture, species are significant
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                  -0.67222    0.26791  -2.509   0.0121 *  
#normalized_par                0.22151    0.13682   1.619   0.1055    
#soil_moisture                 0.37873    0.15482   2.446   0.0144 * <-- soil moisture
#exotic_percentcover           0.05884    0.12325   0.477   0.6331    
#site2                        -0.52592    0.28791  -1.827   0.0677 .  
#march_stem_height_cm          0.19582    0.14592   1.342   0.1796    
#speciesHEAR                   0.65675    0.34598   1.898   0.0577 .  
#speciesRHOV                  -0.09939    0.29329  -0.339   0.7347    
#speciesSAAP                  -0.71330    0.32438  -2.199   0.0279 *  <-- species
#normalized_par:soil_moisture  0.55680    0.13963   3.988 6.67e-05 *** <-- interaction PAR x TDR
# 
# when normalized_par * soil_moisture * nncover and WITHOUT rgr = soil_moisture, norm_par*soil_moisture, species are significant
#Fixed effects:
#                                                 Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                                      -0.70008    0.26985  -2.594 0.009478 ** 
#normalized_par                                    0.21233    0.13956   1.521 0.128169    
#soil_moisture                                     0.39759    0.17833   2.229 0.025783 *  
#exotic_percentcover                               0.05525    0.12237   0.451 0.651642    
#speciesHEAR                                       0.64219    0.34649   1.853 0.063827 .  
#speciesRHOV                                      -0.09718    0.29347  -0.331 0.740546    
#speciesSAAP                                      -0.71199    0.32487  -2.192 0.028405 *  
#site2                                            -0.51624    0.28299  -1.824 0.068118 .  
#march_stem_height_cm                              0.20034    0.14591   1.373 0.169737    
#normalized_par:soil_moisture                      0.60608    0.17582   3.447 0.000567 ***
#normalized_par:exotic_percentcover               -0.12603    0.11167  -1.129 0.259047     <-- nncover never significant factor
#soil_moisture:exotic_percentcover                 0.10619    0.14029   0.757 0.449112    
#normalized_par:soil_moisture:exotic_percentcover -0.04511    0.15725  -0.287 0.774232   

# Take home: when environmental conditions are considered separately, species is the main driving factor of seedling survival. However, we know environmntal variables do not act independently on seedling survival, so par x tdr is a better model that represents what is hapening in the field. 
# The interaction between Par*TDR and the species of seedling planted are correlated with seedling survival from March to May in 2018.

# Notes
# We included non-native percent cover but that was not significant by itself or when interacting with tdr and/or par so it was kept as an non-interactinve factor in the model. 
# The model including interactions between species * par * tdr didn't run so species remained a non-interacting factor.

print(glme.may2018.modspp_CEOL)
summary(glme.may2018.modspp_CEOL)


# when normalized_par + soil_moisture and WITH rgr
#Fixed effects:
#                     Estimate Std. Error z value Pr(>|z|)    
#(Intercept)           3.06593    0.61814   4.960 7.05e-07 ***
#normalized_par       -0.47379    0.19966  -2.373   0.0176 *  
#soil_moisture         0.60512    0.27015   2.240   0.0251 *  
#exotic_percentcover  -0.52274    0.21463  -2.436   0.0149 *  
#site2                -2.61512    0.53223  -4.913 8.95e-07 ***
#rgr                   0.17486    0.18525   0.944   0.3452    
#march_stem_height_cm  0.01186    0.23245   0.051   0.9593    
#speciesHEAR          -0.13926    0.60828  -0.229   0.8189    
#speciesRHOV          -0.80500    0.56642  -1.421   0.1553    
#speciesSAAP          -1.49677    0.61320  -2.441   0.0147 *  


# when normalized_par * soil_moisture and WITH rgr
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                   3.14554    0.62088   5.066 4.06e-07 ***
#normalized_par               -0.04689    0.24992  -0.188  0.85117    
#soil_moisture                 0.70144    0.26578   2.639  0.00831 ** 
#exotic_percentcover          -0.47463    0.19730  -2.406  0.01615 *  
#site2                        -2.71065    0.51212  -5.293 1.20e-07 ***
#rgr                           0.15780    0.18477   0.854  0.39309    
#march_stem_height_cm          0.03284    0.24099   0.136  0.89162    
#speciesHEAR                  -0.20153    0.61868  -0.326  0.74463    
#speciesRHOV                  -0.79117    0.56505  -1.400  0.16146    
#speciesSAAP                  -1.52418    0.61178  -2.491  0.01272 *  
#normalized_par:soil_moisture  0.64328    0.27406   2.347  0.01891 *  


# fixed level effects, pvalues, etc.
anova(glme.may2018.mod) # A significant p-value indicates that one or more significant differences exist between group means.
# no p-values because no replicates - each individual is an n of 1

```



```{r may 2018 post hoc, include=TRUE}

emmeans(glme.may2018.mod, list(pairwise ~ species), adjust = "tukey")

glmm_interaction <- glmer(factor(may_alive) ~ normalized_par * soil_moisture + species +
                            (1|plot_number),
                          family = binomial(link = "logit"),
                          data = height_march_surv_may)

summary(glmm_interaction)
```

```{r may 2018 tdr x par interaction on survival, include=TRUE}

# TAKE 1 
#surv_prediction <- seq(from = -1.6, to = 1.8, by = 0.1) %>% # x = soil moisture 
#  as.data.frame() %>% 
#  rename(soil_moisture = ".") %>% 
#  mutate(normalized_par = min(may18_partdr.interaction$normalized_par)) %>% 
#  mutate(alive = predict(may18_partdr.interaction, newdata = . , type = "response"))
#print(surv_prediction)

# glm model
may18_partdr.interaction <- glm(may_alive ~ normalized_par * soil_moisture * species, data = height_march_surv_may, family = binomial)
print(may18_partdr.interaction)
summary(may18_partdr.interaction)

# SAAP, HEAR, SOIL MOISTURE are significant

```

```{r may 2018 figures, include=TRUE}

# bagraph.1 - survival x species
may2018.1 <- ggplot(data = height_march_surv_may, aes(x = species, y = may_alive, fill = species)) +
  geom_bar(stat = "identity")
  labs(x = "Species",
       y = "Total Survival",
       title = "Total Alive in May 2018")
may2018.1


# bargraph.2 - survial x tdr

# TAKE 2
# Create interaction plot
may18_partdr.interaction.plot <- ggplot(may18_partdr.interaction, aes(x = normalized_par, y = may_alive, color = (soil_moisture))) +
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = FALSE) +
  labs(x = "PAR", y = "Alive", color = "TDR") +
  scale_color_continuous(name = "TDR") +
  theme_minimal()
may18_partdr.interaction.plot

# TAKE 3 
# Create a data frame with values of TDR and PAR for prediction
min_value <- min(height_march_surv_may$soil_moisture, na.rm = TRUE)
max_value <- max(height_march_surv_may$soil_moisture, na.rm = TRUE)
print(min_value)
print(max_value)

# Calculate row means of TDR matrix/array
TDR_row_means <- rowMeans(height_march_surv_may$soil_moisture) 
PAR_row_means <- rowMeans(height_march_surv_may$normalized_par)

# Create a new dataframe with the row means and other relevant variables
new_data <- data.frame(soil_moisture = TDR_row_means, normalized_par = PAR_row_means, may_alive = height_march_surv_may$may_alive)
print(new_data)

### CODE  BELOW HERE DOESN'T RUN

# Generate predicted values
new_data$alive_predicted <- predict(may18_partdr.interaction, newdata = new_data, type = "response")

# Create the plot
ggplot(height_may, aes(x = TDR_row_means * PAR, y = as.factor(alive), color = TDR_row_means)) +
  geom_jitter() +
  geom_line(data = new_data, aes(y = alive_predicted), color = "blue") +
  scale_color_continuous() +
  labs(x = "TDR_row_means * PAR", y = "Alive", color = "TDR_row_means")

partdr_predict <- expand.grid(soil_moisture = seq(min(height_march_surv_may$soil_moisture),
                                            max(height_march_surv_may$soil_moisture), length.out = 100),
                        normalized_par = seq(min(height_march_surv_may$normalized_par),
                                             max(height_march_surv_may$normalized_par), length.out = 100)) %>% 
  

# Predict probabilities of being "alive" for the new data
partdr_predict$prob_alive <- predict(may18_partdr.interaction, newdata = partdr_predict, type = "response")

# Create the interaction plot with the predictive line
ggplot(your_data, aes(x = TDR * PAR, y = alive)) +
  geom_point() +
  geom_line(data = new_data, aes(y = prob_alive), color = "red") +
  labs(x = "TDR * PAR", y = "Alive") +
  theme_minimal()

# TAKE 4 - shane's code
partdr_predict <- expand.grid(soil_moisture = seq(min(height_march_surv_may$soil_moisture),
                                            max(height_march_surv_may$soil_moisture), length.out = 100)) %>% 
  as.data.frame() %>% 
  mutate(normalized_par = mean(height_march_surv_may$normalized_par)) %>% 
  mutate(alive = predict(may18_partdr.interaction, newdata = . , type = "response"))


```


### Figures 

```{r may 2018 explore figures, include=FALSE}

maybox.1 <- ggplot(data = height_march_surv_may, 
       aes(x = may_alive, y = soil_moisture, color = may_alive)) +
  labs(title = "Normalized PAR over time", x = "Month", y = "Normalized PAR") +
  geom_boxplot() +
  theme_bw() 
ggplotly(maybox.1)

mayscatter.1 <- ggplot(data = height_march_surv_may, 
                       aes(x = soil_moisture, y = normalized_par)) +
  geom_point(aes(color = factor(may_alive))) +
  geom_jitter(width = 0.0, height = 0.0) +
  theme_classic()
mayscatter.1

```


# D. Prediction of survival in May 2018

```{r May 2018 figures stem height survival site, include=TRUE}

# stem height x survival, paneled by site
# figure: predict survival (S curve by 0-1)
stem_height_site_1_prediction <- seq(from = -1.2, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(normalized_par = mean(height_march_surv_may$normalized_par),
         exotic_percentcover = mean(height_march_surv_may$exotic_percentcover),
         site = "1",
         soil_moisture = mean(height_march_surv_may$soil_moisture),
         treatment = "full removal",
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

stem_height_site_2_prediction <- seq(from = -1.2, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(normalized_par = mean(height_march_surv_may$normalized_par),
         exotic_percentcover = mean(height_march_surv_may$exotic_percentcover),
         site = "2",
         soil_moisture = mean(height_march_surv_may$soil_moisture),
         treatment = "full removal",
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

site_1_sh_plot <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(site == "1"), aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_site_1_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic() +
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival",
       title = "Site 1")

site_2_sh_plot <- ggplot()+
  geom_point(data = height_march_surv_may %>%  filter(site == "2"), aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_site_2_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival",
       title = "Site 2")

site_1_sh_plot + site_2_sh_plot
```
- box plot of rgr May 2018
```{r may 2018 box plot rgr figure, include=FALSE}

# box.1 rgr x site
#ggplot(growth_march_may, aes(x = site, y = rgr))+
#  geom_boxplot()+
#  theme_classic()+
#  labs(x = "Planting Site",
#       y = "Relative Growth Rate")
```

- figure - prediction of survival x soil moisture x low, mean, and high PAR 
### D1. BY SITE
```{r May 2018 figure predict site by levels of par, include=TRUE}

# soil moisture x MIN par x Site 1
moisture_low_par_site_1 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% # range of soil moisture from height_march_surv_may
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(height_march_surv_may$normalized_par), # calculate norm_par minimum
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0, 
         species = "HEAR" ) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# soil moisture x MIN par x Site 2
moisture_low_par_site_2 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(height_march_surv_may$normalized_par), 
         exotic_percentcover = 0,
         site = "2",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# soil moisture x MEAN par x Site 1
moisture_mean_par_site_1 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = 0, # mean norm_par, data is scale transformed
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# soil moisture x MEAN par x Site 2
moisture_mean_par_site_2 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = 0,
         exotic_percentcover = 0,
         site = "2",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# soil moisture x MAX par x Site 1
moisture_max_par_site_1 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(height_march_surv_may$normalized_par), # calculate norm_par maximum
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

#soil moisture x MAX par x Site 2
moisture_max_par_site_2 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(height_march_surv_may$normalized_par),
         exotic_percentcover = 0,
         site = "2",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# rbind norm_par min, mean, max at Site 1
moisture_prediction_site_1 <- rbind(moisture_low_par_site_1, moisture_mean_par_site_1, moisture_max_par_site_1)

# rbind norm_par min, mean, max at Site 2
moisture_prediction_site_2 <- rbind(moisture_low_par_site_2, moisture_mean_par_site_2, moisture_max_par_site_2)

# prediction figure - site 1
moisture_site_1_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(site == "1"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_prediction_site_1, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1) +
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability",
       title = "Site 1")

# prediction figure - site 2
moisture_site_2_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(site == "2"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_prediction_site_2, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1) +
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability",
       title = "Site 2")

moisture_site_1_graph + moisture_site_2_graph
```

- figure - prediction of survival x norm_par x low, mean, and high TDR 
- by SITE
```{r May 2018 figure predict by levels of tdr, include=TRUE}

# par x MIN tdr x plot 1
# Site = "1" 
par_low_moisture_site_1 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(height_march_surv_may$soil_moisture), # min TDR
         exotic_percentcover = 0, # mean nncover
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# par x MIN tdr x plot 2
par_low_moisture_site_2 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(height_march_surv_may$soil_moisture),
         exotic_percentcover = 0,
         site = "2",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# par x MEAN tdr x plot 1
par_mean_moisture_site_1 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = 0,
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# par x MEAN tdr x plot 2
par_mean_moisture_site_2 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = 0,
         exotic_percentcover = 0,
         site = "2",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# par x MAX tdr x plot 1
par_max_moisture_site_1 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(height_march_surv_may$soil_moisture),
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# par x MAX tdr x plot 2
par_max_moisture_site_2 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(height_march_surv_may$soil_moisture),
         exotic_percentcover = 0,
         site = "2",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# rbind 
par_prediction_site_1 <- rbind(par_low_moisture_site_1, par_mean_moisture_site_1, par_max_moisture_site_1)

par_prediction_site_2 <- rbind(par_low_moisture_site_2, par_mean_moisture_site_2, par_max_moisture_site_2)

par_site_1_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(site == "1"), aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_prediction_site_1, aes(x = normalized_par, y = alive, col = soil_moisture, group = soil_moisture), linewidth = 1) +
  theme_classic() +
  labs(x = "Normalized PAR", 
       y = "Survival Probability",
       title = "Site 1")

par_site_2_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(site == "2"), aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_prediction_site_2, aes(x = normalized_par, y = alive, col = soil_moisture, group = soil_moisture), linewidth = 1) +
  theme_classic() +
  labs(x = "Normalized PAR", 
       y = "Survival Probability",
       title = "Site 2")

par_site_1_graph + par_site_2_graph
```

### D3. Prediction of survival May 2018 by species
```{r may 2018 glmer by species CEOL, include=TRUE}
#CEOL
glme.may2018.modspp_CEOL <- glmer(may_alive ~ 
                            normalized_par * soil_moisture # significant from Q1
                          + exotic_percentcover # not significant from Q1
                          + site + volume_cm3 
                          + (1|plot_number),
                                family = binomial, 
                         data = (height_march_surv_may %>% filter(species == "CEOL")))
MOD <- glme.may2018.modspp_CEOL 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) # follows binomial distribution

anova(glme.may2018.modspp_CEOL)
#Analysis of Variance Table
#                             npar Sum Sq Mean Sq F value
#normalized_par                  1 0.4337  0.4337  0.4337
#soil_moisture                   1 2.8874  2.8874  2.8874
#exotic_percentcover             1 0.4425  0.4425  0.4425
#site                            1 7.1409  7.1409  7.1409
#volume_cm3                      1 3.6865  3.6865  3.6865
#normalized_par:soil_moisture    1 1.5720  1.5720  1.5720
summary(glme.may2018.modspp_CEOL)
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)  
#(Intercept)                    4.0037     2.3822   1.681   0.0928 .
#normalized_par                 0.5641     0.3124   1.806   0.0710 .
#soil_moisture                  0.1535     0.3249   0.472   0.6366  
#exotic_percentcover            0.2004     0.2643   0.758   0.4482  
#site2                         -1.6835     0.6806  -2.473   0.0134 *
#volume_cm3                     8.5060     4.6305   1.837   0.0662 .
#normalized_par:soil_moisture   0.3512     0.2823   1.244   0.2135 

glme.may2018.modspp_CEOL_summarytable <- summary(glme.may2018.modspp_CEOL)
## pretty table
par_minmax %>%
  kbl(caption = "PAR values", digits = 0) %>%
  kable_classic(full_width = F, html_font = "Cambria")


emmeans(glme.may2018.modspp_CEOL, list(pairwise ~ site), adjust = "tukey")
#$`pairwise differences of site`
# 1             estimate    SE  df z.ratio p.value
# site1 - site2     1.68 0.681 Inf   2.473  0.0134
```
```{r may 2018 glmer by species HEAR}
#HEAR
glme.may2018.modspp_HEAR <- glmer(may_alive ~ 
                            normalized_par * soil_moisture # significant from Q1
                          + exotic_percentcover # not significant from Q1
                          + site + volume_cm3
                          + (1|plot_number),
                                family = binomial, 
                         data = (height_march_surv_may %>% filter(species == "HEAR")))
MOD <- glme.may2018.modspp_HEAR 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) # follows binomial distribution

anova(glme.may2018.modspp_HEAR)
summary(glme.may2018.modspp_HEAR)
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)   
#(Intercept)                   -0.6858     0.4411  -1.555  0.12004   
#normalized_par                 0.4987     0.3232   1.543  0.12281   
#soil_moisture                  1.0860     0.3847   2.823  0.00476 **
#exotic_percentcover            0.2710     0.2777   0.976  0.32915   
#site2                          0.6094     0.6743   0.904  0.36613   
#volume_cm3                     0.4077     0.1422   2.867  0.00414 **
#normalized_par:soil_moisture   1.0546     0.3546   2.974  0.00294 **

```
```{r may 2018 glmer by species RHOV}
#RHOV
glme.may2018.modspp_RHOV <- glmer(may_alive ~ 
                            normalized_par * soil_moisture # significant from Q1
                          + exotic_percentcover # not significant from Q1
                          + site + volume_cm3 
                          + (1|plot_number),
                                family = binomial, 
                         data = (height_march_surv_may %>% filter(species == "RHOV")))
MOD <- glme.may2018.modspp_RHOV 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) # follows binomial distribution

anova(glme.may2018.modspp_RHOV)
summary(glme.may2018.modspp_RHOV)
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)   
#(Intercept)                   5.30572    2.14883   2.469  0.01354 * 
#normalized_par               -0.39429    0.28418  -1.387  0.16530   
#soil_moisture                 0.06784    0.30305   0.224  0.82287   
#exotic_percentcover          -0.38734    0.25989  -1.490  0.13612   
#site2                        -0.54869    0.57549  -0.953  0.34038   
#volume_cm3                   12.67430    4.40938   2.874  0.00405 **
#normalized_par:soil_moisture  0.20739    0.27813   0.746  0.45587  

height_march %>% 
  filter(species == "RHOV") %>% 
  summarize(min_height = min(march_stem_height_cm),
            max_height = max(march_stem_height_cm)
            )
# min_height  max_height
#0.55	  4.48	

height_march %>% 
  filter(species == "HEAR") %>% 
  summarize(min_height = min(march_stem_height_cm),
            max_height = max(march_stem_height_cm)
            )
#min_height   max_height
#0.25	     14.861	
```

```{r may 2018 glmer by species SAAP}
#SAAP
glme.may2018.modspp_SAAP <- glmer(may_alive ~ 
                            normalized_par 
                            + soil_moisture # significant from Q1
                          + exotic_percentcover # not significant from Q1
                          + site # omitting site removes the error message
                          + volume_cm3 
                          + (1|plot_number),
                                family = binomial, 
                         data = (height_march_surv_may %>% filter(species == "SAAP")))
# error : boundary (singular) fit: see help('isSingular') 
# The model did fit, but it generated a warning because the random effects are very small. 
# FROM: https://stackoverflow.com/questions/60028673/lme4-error-boundary-singular-fit-see-issingular
ggplot(height_march_surv_may,aes(x=may_alive,y=volume_cm3,col=plot_number)) + 
  geom_jitter() +
  geom_boxplot(alpha=0.2) + 
  facet_wrap(~site)
ranef(glme.may2018.modspp_SAAP)

MOD <- glme.may2018.modspp_SAAP 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) # follows binomial distribution

anova(glme.may2018.modspp_SAAP)
summary(glme.may2018.modspp_SAAP)
#Fixed effects:
#                    Estimate Std. Error z value Pr(>|z|)   
#(Intercept)         -0.61197    0.42719  -1.433  0.15199   
#normalized_par       0.28085    0.34757   0.808  0.41908   
#soil_moisture       -0.02046    0.36101  -0.057  0.95480   
#exotic_percentcover  0.13061    0.31289   0.417  0.67637   
#site2               -2.34647    0.87205  -2.691  0.00713 **
#volume_cm3           0.88201    0.65495   1.347  0.17808 

emmeans(glme.may2018.modspp_SAAP, list(pairwise ~ site), adjust = "tukey")
#$`pairwise differences of site`
# 1             estimate    SE  df z.ratio p.value
# site1 - site2     2.35 0.872 Inf   2.691  0.0071
```

```{r may 2018 glmer by species testing normality, include=TRUE}

```

```{r may 2018 stats by species, include=TRUE}

print(glme.may2018.modspp_CEOL)
summary(glme.may2018.modspp_CEOL)
# Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)  
#(Intercept)                   -0.5339     0.6502  -0.821   0.4116  
#normalized_par                 0.6254     0.3537   1.768   0.0771 .
#soil_moisture                  0.0955     0.3642   0.262   0.7932  
#exotic_percentcover            0.2205     0.2969   0.743   0.4576  
#site2                         -1.9266     0.7697  -2.503   0.0123 * <-- site is significant
#march_stem_height_cm          -0.3505     0.8577  -0.409   0.6828  
#normalized_par:soil_moisture   0.3878     0.3124   1.242   0.2144  

print(glme.may2018.modspp_HEAR)
summary(glme.may2018.modspp_HEAR)
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)  
#(Intercept)                  -0.02166    0.55505  -0.039   0.9689  
#normalized_par               -0.23014    0.25407  -0.906   0.3650  
#soil_moisture                 0.18378    0.28832   0.637   0.5239  
#exotic_percentcover          -0.39685    0.23971  -1.656   0.0978 .
#site2                        -0.46420    0.54116  -0.858   0.3910  
#march_stem_height_cm          1.44888    0.80218   1.806   0.0709 .
#normalized_par:soil_moisture  0.26328    0.25373   1.038   0.2994  

print(glme.may2018.modspp_RHOV)
summary(glme.may2018.modspp_RHOV)
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)  
#(Intercept)                  -0.02166    0.55505  -0.039   0.9689  
#normalized_par               -0.23014    0.25407  -0.906   0.3650  
#soil_moisture                 0.18378    0.28832   0.637   0.5239  
#exotic_percentcover          -0.39685    0.23971  -1.656   0.0978 .
#site2                        -0.46420    0.54116  -0.858   0.3910  
#march_stem_height_cm          1.44888    0.80218   1.806   0.0709 .
#normalized_par:soil_moisture  0.26328    0.25373   1.038   0.2994  

print(glme.may2018.modspp_SAAP)
summary(glme.may2018.modspp_SAAP)
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)   
#(Intercept)                   -0.4643     0.4266  -1.089  0.27635   
#normalized_par                 0.1688     0.3603   0.469  0.63941   
#soil_moisture                  0.2287     0.3756   0.609  0.54257   
#exotic_percentcover            0.2943     0.3278   0.898  0.36926   
#site2                         -2.7165     0.9522  -2.853  0.00433 ** <-- site is significant
#march_stem_height_cm           0.9697     0.5084   1.907  0.05650 . 
#normalized_par:soil_moisture   0.7728     0.4113   1.879  0.06030 . 
```

- by SPECIES x soil moisture
```{r May 2018 figure predict species by levels of par, include=TRUE}

# glmer(may_alive ~ 
#     normalized_par * soil_moisture + exotic_percentcover + species + site + march_stem_height_cm + 
#     (1 | plot_number), data: height_march_surv_may)

# soil moisture x MIN par x HEAR
moisture_low_par_HEAR <- seq(from = -1.6, to = 1.8, by = 0.1) %>% # range of soil moisture from height_march_surv_may
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(height_march_surv_may$normalized_par), # calculate norm_par minimum
         exotic_percentcover = 0,
         site = "1",
         species = "HEAR",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MEAN par x HEAR
moisture_mean_par_HEAR <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = 0, # mean norm_par, data is scale transformed
         exotic_percentcover = 0,
         site = "1",
         species = "HEAR",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MAX par x HEAR
moisture_max_par_HEAR <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(height_march_surv_may$normalized_par), 
         exotic_percentcover = 0,
         site = "1",
         species = "HEAR",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))


# soil moisture x MIN par x CEOL
moisture_low_par_CEOL <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(height_march_surv_may$normalized_par), # calculate norm_par minimum
         exotic_percentcover = 0,
         site = "1",
         species = "CEOL",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MEAN par x CEOL
moisture_mean_par_CEOL <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = 0, # mean norm_par, data is scale transformed
         exotic_percentcover = 0,
         site = "1",
         species = "CEOL",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MAX par x CEOL
moisture_max_par_CEOL <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(height_march_surv_may$normalized_par), 
         exotic_percentcover = 0,
         site = "1",
         species = "CEOL",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MIN par x RHOV
moisture_low_par_RHOV <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(height_march_surv_may$normalized_par), # calculate norm_par minimum
         exotic_percentcover = 0,
         site = "1",
         species = "RHOV",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MEAN par x RHOV
moisture_mean_par_RHOV <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = 0, # mean norm_par, data is scale transformed
         exotic_percentcover = 0,
         site = "1",
         species = "RHOV",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MAX par x RHOV
moisture_max_par_RHOV <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(height_march_surv_may$normalized_par), 
         exotic_percentcover = 0,
         site = "1",
         species = "RHOV",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MIN par x SAAP
moisture_low_par_SAAP <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(height_march_surv_may$normalized_par), # calculate norm_par minimum
         exotic_percentcover = 0,
         site = "1",
         species = "SAAP",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MEAN par x SAAP
moisture_mean_par_SAAP <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = 0, # mean norm_par, data is scale transformed
         exotic_percentcover = 0,
         site = "1",
         species = "SAAP",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MAX par x SAAP
moisture_max_par_SAAP <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(height_march_surv_may$normalized_par), 
         exotic_percentcover = 0,
         site = "1",
         species = "SAAP",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# rbind norm_par min, mean, max for HEAR
moisture_prediction_HEAR <- rbind(moisture_low_par_HEAR, moisture_mean_par_HEAR, moisture_max_par_HEAR)

# rbind norm_par min, mean, max for CEOL
moisture_prediction_CEOL <- rbind(moisture_low_par_CEOL, moisture_mean_par_CEOL, moisture_max_par_CEOL)

# rbind norm_par min, mean, max for RHOV
moisture_prediction_RHOV <- rbind(moisture_low_par_RHOV, moisture_mean_par_RHOV, moisture_max_par_RHOV)

# rbind norm_par min, mean, max for SAAP
moisture_prediction_SAAP <- rbind(moisture_low_par_SAAP, moisture_mean_par_SAAP, moisture_max_par_SAAP)


# prediction figure - HEAR
moisture_HEAR_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "HEAR"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_prediction_HEAR, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1) +
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability",
       title = "HEAR")

# prediction figure - CEOL
moisture_CEOL_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "CEOL"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_prediction_CEOL, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1) +
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability",
       title = "CEOL")

# prediction figure - RHOV
moisture_RHOV_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "RHOV"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_prediction_RHOV, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1) +
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability",
       title = "RHOV")

# prediction figure - SAAP
moisture_SAAP_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "SAAP"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_prediction_SAAP, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1) +
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability",
       title = "SAAP")


moisture_CEOL_graph + moisture_HEAR_graph + moisture_RHOV_graph +moisture_SAAP_graph
```


### D4. Prediction May 2018 by SPECIES
```{r May 2018 figure predict species by levels of tdr, include=TRUE}

# glmer(may_alive ~ 
#     normalized_par * soil_moisture + exotic_percentcover + species + site + march_stem_height_cm + 
#     (1 | plot_number), data: height_march_surv_may)

# par x MIN tdr x HEAR
par_low_moisture_HEAR <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(height_march_surv_may$soil_moisture), # min tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "HEAR",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MEAN par x HEAR
par_mean_moisture_HEAR <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = 0, # mean tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "HEAR",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MAX par x HEAR
par_max_moisture_HEAR <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(height_march_surv_may$soil_moisture), # max tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "HEAR",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MIN par x CEOL
par_low_moisture_CEOL <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(height_march_surv_may$soil_moisture), # min tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "CEOL",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MEAN par x CEOL
par_mean_moisture_CEOL <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = 0, # mean tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "CEOL",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MAX par x CEOL
par_max_moisture_CEOL <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(height_march_surv_may$soil_moisture), # max tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "CEOL",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MIN par x RHOV
par_low_moisture_RHOV <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(height_march_surv_may$soil_moisture), # min tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "RHOV",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MEAN par x RHOV
par_mean_moisture_RHOV <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = 0, # mean tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "RHOV",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MAX par x RHOV
par_max_moisture_RHOV <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(height_march_surv_may$soil_moisture), # max tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "RHOV",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MIN par x SAAP
par_low_moisture_SAAP <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(height_march_surv_may$soil_moisture), # min tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "SAAP",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MEAN par x SAAP
par_mean_moisture_SAAP <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = 0, # mean tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "SAAP",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MAX par x SAAP
par_max_moisture_SAAP <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(height_march_surv_may$soil_moisture), # max tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "SAAP",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# rbind 
par_prediction_CEOL <- rbind(par_low_moisture_CEOL, par_mean_moisture_CEOL, par_max_moisture_CEOL)
par_prediction_HEAR <- rbind(par_low_moisture_HEAR, par_mean_moisture_HEAR, par_max_moisture_HEAR)
par_prediction_RHOV <- rbind(par_low_moisture_RHOV, par_mean_moisture_RHOV, par_max_moisture_RHOV)
par_prediction_SAAP <- rbind(par_low_moisture_SAAP, par_mean_moisture_SAAP, par_max_moisture_SAAP)

par_CEOL_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "CEOL"), aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_prediction_CEOL, aes(x = normalized_par, y = alive, col = soil_moisture, group = soil_moisture), linewidth = 1) +
  theme_classic() +
  labs(x = "Normalized PAR", 
       y = "Survival Probability",
       title = "CEOL")

par_HEAR_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "HEAR"), aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_prediction_CEOL, aes(x = normalized_par, y = alive, col = soil_moisture, group = soil_moisture), linewidth = 1) +
  theme_classic() +
  labs(x = "Normalized PAR", 
       y = "Survival Probability",
       title = "HEAR")

par_RHOV_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "RHOV"), aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_prediction_CEOL, aes(x = normalized_par, y = alive, col = soil_moisture, group = soil_moisture), linewidth = 1) +
  theme_classic() +
  labs(x = "Normalized PAR", 
       y = "Survival Probability",
       title = "RHOV")

par_SAAP_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "SAAP"), aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_prediction_CEOL, aes(x = normalized_par, y = alive, col = soil_moisture, group = soil_moisture), linewidth = 1) +
  theme_classic() +
  labs(x = "Normalized PAR", 
       y = "Survival Probability",
       title = "SAAP")

par_CEOL_graph + par_HEAR_graph + par_RHOV_graph + par_SAAP_graph
```
# END (Stephanie looked through the code from beginning to this point)

## Repeat each model for each species

### CEOL 
```{r CEOL may 2018 predict AIC values, include=TRUE}

# filter for ceol May 2018
ceol_2018 <- height_march_surv_may %>% 
  filter(species == "CEOL")
  
#ONE FACTOR AIC
# par
AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = ceol_2018))

# tdr
AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2018))

# nncover
AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = ceol_2018))

# site
AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = ceol_2018))

# march 2018 stem height
AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2018))

#TWO FACTOR AIC
# site + norm_par
AIC(glmer(as.factor(may_alive) ~ site + normalized_par + (1|plot_number),
          family = binomial,
          data = ceol_2018))

# site + tdr <-- lowest AIC
AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2018))
#[1] 143.3071

# site + nncover
AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = ceol_2018))

# site + march 2018 stem height
AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2018))
```
```{r CEOL may 2018 predict best model, include=TRUE}

summary(glmer(as.factor(may_alive) ~ soil_moisture + normalized_par + exotic_percentcover + march_stem_height_cm + site + (1|plot_number), 
          family = binomial,
          data = ceol_2018))

#Fixed effects:
#                      Estimate Std. Error z value Pr(>|z|)  
#(Intercept)          -0.713440   0.659574  -1.082   0.2794  
#soil_moisture         0.006624   0.372375   0.018   0.9858  
#normalized_par        0.505202   0.350863   1.440   0.1499  
#exotic_percentcover   0.192127   0.311171   0.617   0.5370  
#march_stem_height_cm -0.545067   0.861848  -0.632   0.5271  
#site2                -1.984967   0.809519  -2.452   0.0142 *


## Add Figure
``` 

### RHOV May 2018 - predict survival

```{r RHOV may 2018 AIC values, include=TRUE} 
rhov_2018 <- height_march_surv_may %>% 
  filter(species == "RHOV")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = rhov_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = rhov_2018))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = rhov_2018))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = rhov_2018))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + soil_moisture + (1|plot_number),
          family = binomial,
          data = rhov_2018))
```
```{r RHOV may 2018 prediction model, include=TRUE}

rhov_model <- glmer(as.factor(may_alive) ~ march_stem_height_cm + soil_moisture + normalized_par + exotic_percentcover + site + (1|plot_number),
          family = binomial,
          data = rhov_2018)
summary(rhov_model)

stem_height_rhov_prediction <- seq(from = 0.5, to = 5, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = mean(rhov_2018$soil_moisture), 
         normalized_par = 0, 
         exotic_percentcover = 0,
         site = "1") %>% 
  mutate(alive = predict(rhov_model, newdata = . , type = "response"))

ggplot()+
  geom_point(data = rhov_2018, aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_rhov_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival")


```

### HEAR

```{r}
hear_2018 <- height_march_surv_may %>% 
  filter(species == "HEAR")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture*normalized_par + (1|plot_number),
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + site + (1|plot_number),
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2018))

hear_model <- glmer(as.factor(may_alive) ~ soil_moisture* normalized_par + (1|plot_number), 
                         family = binomial,
                         data = hear_2018)

summary(hear_model)


moisture_hear_low_par <- seq(from = 6, to = 12, by = 0.5) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(hear_2018$normalized_par)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

moisture_hear_mid_par <- seq(from = 6, to = 12, by = 0.5) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = mean(hear_2018$normalized_par)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

moisture_hear_max_par <- seq(from = 6, to = 12, by = 0.5) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(hear_2018$normalized_par)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

moisture_hear_prediction <- rbind(moisture_hear_low_par, moisture_hear_max_par, moisture_hear_mid_par) 

ggplot()+
  geom_point(data = hear_2018, aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_hear_prediction, aes(x = soil_moisture, y = alive, col = normalized_par, group= normalized_par), linewidth = 1)+
  theme_classic()+
  labs(x = "Soil Moisture",
       y = "Probability of Survival")

par_hear_low_moisture <- seq(from = 0.1, to = 0.65, by = 0.01) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(hear_2018$soil_moisture)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

par_hear_mid_moisture <- seq(from = 0.1, to = 0.65, by = 0.01) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = mean(hear_2018$soil_moisture)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

par_hear_max_moisture <- seq(from = 0.1, to = 0.65, by = 0.01) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(hear_2018$soil_moisture)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

par_hear_prediction <- rbind(par_hear_low_moisture, par_hear_max_moisture, par_hear_mid_moisture) 

ggplot()+
  geom_point(data = hear_2018, aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_hear_prediction, aes(x = normalized_par, y = alive, col = soil_moisture, group= soil_moisture), linewidth = 1)+
  theme_classic()+
  labs(x = "Normalized PAR",
       y = "Probability of Survival")

```


SAAP 

```{r}
saap_2018 <- height_march_surv_may %>% 
  filter(species == "SAAP")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ site + normalized_par + (1|plot_number), 
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number), 
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number), 
          family = binomial,
          data = saap_2018))


saap_model <- glmer(as.factor(may_alive) ~ site + (1|plot_number),
                         family = binomial,
                         data = saap_2018)

summary(saap_model)
```

## Individual species for RGR 

### CEOL 

```{r}
ceol_rgr_2018 <- growth_march_may %>% 
  filter(species == "CEOL")
  
AIC(lmer(rgr ~ normalized_par +  (1|plot_number),
                         data = ceol_rgr_2018))

AIC(lmer(rgr ~ soil_moisture*normalized_par + (1|plot_number),
          data = ceol_rgr_2018))

AIC(lmer(rgr ~ exotic_percentcover + (1|plot_number), 
          data = ceol_rgr_2018))

AIC(lmer(rgr ~ site + (1|plot_number),
          data = ceol_rgr_2018))

AIC(lmer(rgr ~ normalized_par +  soil_moisture + (1|plot_number),
                         data = ceol_rgr_2018))

AIC(lmer(rgr ~ normalized_par + exotic_percentcover + (1|plot_number),
                         data = ceol_rgr_2018))

AIC(lmer(rgr ~ normalized_par + site + (1|plot_number),
                         data = ceol_rgr_2018))

ceol_2018rgr_model <- lmer(rgr ~ normalized_par +  (1|plot_number),
                         data = ceol_rgr_2018)

summary(ceol_2018rgr_model)
```
### Rhov

```{r}
rhov_rgr_2018 <- growth_march_may %>% 
  filter(species == "RHOV")
  
AIC(lmer(rgr ~ normalized_par+  (1|plot_number),
                         data = rhov_rgr_2018))

AIC(lmer(rgr ~ soil_moisture + (1|plot_number),
          data = rhov_rgr_2018))

AIC(lmer(rgr ~ exotic_percentcover + (1|plot_number), 
          data = rhov_rgr_2018))

AIC(lmer(rgr ~ site + (1|plot_number),
          data = rhov_rgr_2018))

AIC(lmer(rgr ~ site + normalized_par + (1|plot_number),
          data = rhov_rgr_2018))
AIC(lmer(rgr ~ site + soil_moisture + (1|plot_number),
          data = rhov_rgr_2018))
AIC(lmer(rgr ~ site + exotic_percentcover + (1|plot_number),
          data = rhov_rgr_2018))

rhov_2018rgr_model <- lmer(rgr ~ site + (1|plot_number),
          data = rhov_rgr_2018)
summary(rhov_2018rgr_model)

```

### HEAR

```{r}
hear_rgr_2018 <- growth_march_may %>% 
  filter(species == "HEAR")
  
AIC(lmer(rgr ~ normalized_par +  (1|plot_number),
                         data = hear_rgr_2018))

AIC(lmer(rgr ~ soil_moisture + (1|plot_number),
          data = hear_rgr_2018))

AIC(lmer(rgr ~ exotic_percentcover + (1|plot_number), 
          data = hear_rgr_2018))

AIC(lmer(rgr ~ site + (1|plot_number),
          data = hear_rgr_2018))

AIC(lmer(rgr ~ site + normalized_par + (1|plot_number),
          data = hear_rgr_2018))

AIC(lmer(rgr ~ site + soil_moisture + (1|plot_number),
          data = hear_rgr_2018))

AIC(lmer(rgr ~ site + exotic_percentcover + (1|plot_number),
          data = hear_rgr_2018))

hear_2018rgr_model <- lmer(rgr ~ site + (1|plot_number),
          data = hear_rgr_2018)

summary(hear_2018rgr_model)
```

## SAAP

```{r}
saap_rgr_2018 <- growth_march_may %>% 
  filter(species == "SAAP")
  
# 
AIC(lmer(rgr ~ normalized_par +  (1|plot_number),
                         data = saap_rgr_2018))

AIC(lmer(rgr ~ soil_moisture + (1|plot_number),
          data = saap_rgr_2018))

AIC(lmer(rgr ~ exotic_percentcover + (1|plot_number), 
          data = saap_rgr_2018))

AIC(lmer(rgr ~ site + (1|plot_number),
          data = saap_rgr_2018))

AIC(lmer(rgr ~ normalized_par + soil_moisture + (1|plot_number),
                         data = saap_rgr_2018))

AIC(lmer(rgr ~ normalized_par + exotic_percentcover + (1|plot_number),
                         data = saap_rgr_2018))

AIC(lmer(rgr ~ normalized_par + site + (1|plot_number),
                         data = saap_rgr_2018))

saap_2018rgr_model <- lmer(rgr ~ normalized_par +  (1|plot_number),
                         data = saap_rgr_2018)

summary(saap_2018rgr_model)
```


# E. January - May 2019 Seedling survival 
  - add height
```{r may 2019 subset environmental data, include=TRUE}
# subsetting data for Jan to May 2019 survival
#
# survmortnospp = may 2019
# par = may 2019
# tdr = march 2019
# nncover = 2019
# mafacover = 2019

# par may 2019 
par_may2019 <- dplyr::filter(par, year == "2019" & month =="5") %>% 
  dplyr::select(site, plot_number, treatment, normalized_par) %>% 
  mutate(treatment = case_when(treatment == "no" ~ "none",
                               TRUE ~ treatment))

# tdr March 2019
tdr_march2019 <- tdr %>% 
  dplyr::filter(year == "2019" & month == "3") %>% 
  dplyr::select(site, plot_number, treatment, soil_moisture)  %>% 
  mutate(treatment = case_when(treatment == "nonene" ~ "none",
                               TRUE ~ treatment))
tdr_march2019$site <- factor(tdr_march2019$site, levels = c("1", "2"))

# nncover may-june 2019
nncover_may2019 <- dplyr::filter(exotic_cover_all, year == "2019") %>% 
  dplyr::select(site, plot_number, treatment, cover_percent)
unique(nncover_may2019$plot_number)
glimpse(nncover_may2019)

# mafacover may 2019
mafacover_may2019 <- dplyr::filter(mafa_cover_all, year == "2019") %>% 
  dplyr::select(site, year, plot_number, mafacover)

# join par tdr nncover for may2019
site_cond_may2019 <- full_join(par_may2019, tdr_march2019, by = c("site", "plot_number", "treatment")) %>% 
  full_join(nncover_may2019, by = c("site", "plot_number", "treatment")) %>% 
    full_join(mafacover_may2019, by = c("site", "plot_number")) 
glimpse(site_cond_may2019)

write.csv(site_cond_may2019, "data/processed/may2019_site_conditions.csv")
```

```{r join data environmental and survmort data, include=TRUE}
# Making height and survival dataframe

# height for january 2019
height_jan_2019 <- height_raw %>% 
  filter(date >= "2019-01-25" & date <= "2019-01-30") %>% # filtering to only have rows of data taken in january 2019 
  dplyr::select(plot_number, MAFA_removal, location, species, stem_height_cm, volume_cm3) %>% 
  rename(jan_stem_height_cm = stem_height_cm, 
         jan_volume_cm3 = volume_cm3)

length(unique(height_jan_2019$plot_number)) # check number of plots 
# 36       

height_jan_2019 %>%  # check number of individuals per plot 
  group_by(plot_number) %>% 
  summarise(N = length(jan_stem_height_cm))
# 11 seedlings per plot

# height may 2019
height_may_2019 <- height_raw %>% 
  filter(date >= "2019-04-30" & date <= "2019-05-30") %>% # filtering to only have rows of data taken in may 2019 
   dplyr::select(plot_number, MAFA_removal, location, species, stem_height_cm, volume_cm3) %>% 
  rename(may_stem_height_cm = stem_height_cm, 
         may_volume_cm3 = volume_cm3)
list(unique(height_may_2019$plot_number)) # check captured all 36 plots with dates

# survival may 2019
survival_may_2019 <- height_raw %>% 
  filter(date>= "2019-04-30" & date <= "2019-05-30") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, alive) %>% 
  rename(may2019_alive = alive) %>% 
  mutate(may2019_alive = replace_na(may2019_alive, 0))  # 0= dead 1 = alive
list(unique(survival_may_2019$plot_number)) # check captured all 36 plots with dates

# growth rate from Jan to May 2019 - GROWTH RATE
growth_jan_may2019 <- right_join(height_jan_2019, height_may_2019, by = c("plot_number", "MAFA_removal", "location", "species")) %>% 
  mutate(jan_stem_height_cm = as.numeric(jan_stem_height_cm)) %>% 
  drop_na() %>% 
  mutate(rgr = (log(may_stem_height_cm) - log(jan_stem_height_cm))/(4*30)) # relative growth rate per day equation; 30 days per month


```


```{r may 2019 full join and scale, include=TRUE}

# full join - no data transformation
height_jan_surv_may_2019_notransf <- full_join(height_jan_2019, survival_may_2019, by = c("plot_number", "MAFA_removal", "location", "species")) %>% 
  mutate(jan_stem_height_cm = as.numeric(jan_stem_height_cm)) %>% 
  drop_na() %>%  # removing na's for now. But should an NA in alive be assumed as dead? 
  mutate(plot_number = as.character(plot_number)) %>% 
  left_join(site_cond_may2019, by = "plot_number") %>% 
  rename(exotic_percentcover = cover_percent) %>% 
  dplyr::select(!MAFA_removal)
print(height_jan_surv_may_2019_notransf)
write.csv(height_jan_surv_may_2019_notransf, "data/processed/height_jan_surv_may_2019_notransf.csv")

# full join - with data transformation
height_jan_surv_may_2019 <- full_join(height_jan_2019, survival_may_2019, by = c("plot_number", "MAFA_removal", "location", "species")) %>% 
  mutate(jan_stem_height_cm = as.numeric(jan_stem_height_cm)) %>% 
  drop_na() %>%  # removing na's for now. But should an NA in alive be assumed as dead? 
  mutate(plot_number = as.character(plot_number)) %>% 
  left_join(site_cond_may2019, by = "plot_number") %>% 
  rename(exotic_percentcover = cover_percent) %>% 
  dplyr::select(!MAFA_removal) %>% 
  mutate(normalized_par = scale(normalized_par),
         soil_moisture = scale(soil_moisture),
         exotic_percentcover = scale(exotic_percentcover),
         mafacover = scale(mafacover),
         jan_stem_height_cm = scale(jan_stem_height_cm),
         jan_volume_cm3 = scale(jan_volume_cm3))
glimpse(height_jan_surv_may_2019)

# check number of individuals per plot
print(height_jan_surv_may_2019 %>%  
  group_by(plot_number) %>% 
  summarise(N = length(plot_number))
) # plots 22 and 35 have 10 seedlings. All other plots have 11 seedlings/plot

# check number of individuals per species
print(height_jan_surv_may_2019 %>%  
  group_by(species) %>% 
  summarise(N = length(species))
) #species N
#CEOL	70			
#HEAR	108			
#RHOV	108			
#SAAP	108	

# as factor
height_jan_surv_may_2019 <- height_jan_surv_may_2019 %>% 
  mutate(may2019_alive = as.factor(may2019_alive),
         species = as.factor(species),
         site = as.factor(site))
glimpse(height_jan_surv_may_2019)
describe(height_jan_surv_may_2019)
write.csv(height_jan_surv_may_2019, "data/processed/height_jan_surv_may_2019.csv")

```

### E1. Basic stats on seedling survival - anovas and ttests
```{r}
# average seedling olume
height_jan_surv_may_2019_notransf %>%  
  summarize(avg_Jan_vol = mean(jan_volume_cm3), 
            N = length(jan_volume_cm3), 
            se = ((sd(jan_volume_cm3))/sqrt(length((jan_stem_height_cm)))), 
            min = min(jan_volume_cm3), 
            max = max(jan_volume_cm3))
# avg_Jan_vol   N se         min   max
# 62.56952	  394	4.152808	0.196337	540.5721

# data exploration by species

# HEIGHT 
tapply(height_jan_surv_may_2019_notransf$jan_stem_height_cm, height_jan_surv_may_2019_notransf$species,mean)
#    CEOL     HEAR     RHOV     SAAP 
#  2.620714 6.213889 2.218889 4.298519 
height_jan_surv_may_2019_notransf %>%  
  group_by(species) %>% 
  summarize(avg_height_may2019 = mean(jan_stem_height_cm), 
            SD = sd(jan_stem_height_cm),
            N = length(jan_stem_height_cm), 
            SE = ((sd(jan_stem_height_cm))/sqrt(length((jan_stem_height_cm)))))
summary(aov(jan_stem_height_cm ~ species, data = height_jan_surv_may_2019_notransf))
TukeyHSD(aov(jan_stem_height_cm ~ species, data = height_jan_surv_may_2019_notransf))
#             Df Sum Sq Mean Sq F value Pr(>F)    
#species       3 1014.0   338.0   140.7 <2e-16 ***
#Residuals   390  937.1     2.4    
#$species
#                diff       lwr        upr     p adj
#HEAR-CEOL  3.5931746  2.979466  4.2068831 0.0000000
#RHOV-CEOL -0.4018254 -1.015534  0.2118831 0.3306664
#SAAP-CEOL  1.6778042  1.064096  2.2915127 0.0000000
#RHOV-HEAR -3.9950000 -4.539272 -3.4507278 0.0000000
#SAAP-HEAR -1.9153704 -2.459643 -1.3710982 0.0000000
#SAAP-RHOV  2.0796296  1.535357  2.6239018 0.0000000


# VOLUME 
tapply(height_jan_surv_may_2019_notransf$jan_volume_cm3, height_jan_surv_may_2019_notransf$species,mean)
#      CEOL       HEAR       RHOV       SAAP 
# 14.369030 142.141754   8.013437  68.794423 
height_jan_surv_may_2019_notransf %>%  
  group_by(species) %>% 
  summarize(avg_vol_may2019 = mean(jan_volume_cm3), 
            SD = sd(jan_volume_cm3),
            N = length(jan_volume_cm3), 
            SE = ((sd(jan_volume_cm3))/sqrt(length((jan_volume_cm3)))))
summary(aov(jan_volume_cm3 ~ species, data = height_jan_surv_may_2019_notransf))
TukeyHSD(aov(jan_volume_cm3 ~ species, data = height_jan_surv_may_2019_notransf))
#$species
#                 diff        lwr        upr     p adj
#HEAR-CEOL  127.772724  103.23368  152.31176 0.0000000
#RHOV-CEOL   -6.355594  -30.89463   18.18345 0.9089998
#SAAP-CEOL   54.425392   29.88635   78.96443 0.0000001
#RHOV-HEAR -134.128317 -155.89096 -112.36568 0.0000000
#SAAP-HEAR  -73.347331  -95.10997  -51.58469 0.0000000
#SAAP-RHOV   60.780986   39.01835   82.54363 0.0000000


# SURVIVAL by species - the results are the same as table below :)
#tapply(as.integer(height_jan_surv_may_2019_notransf$may2019_alive), 
#       height_jan_surv_may_2019_notransf$species, mean) 
#   CEOL      HEAR      RHOV      SAAP 
#0.5857143 0.7407407 0.3611111 0.6388889 


# SURVIVAL
print(height_jan_surv_may_2019_notransf %>%  
  group_by(species) %>% 
  summarise(N = length(may2019_alive), 
            total_survived = sum(may2019_alive == "1"), 
            total_died = sum(may2019_alive == "0"),
            percent_survived = 100*(sum(may2019_alive == "1")/length(may2019_alive))))
# species N   total_surv  total_died  percent_survived
#CEOL	70	    41	          29	    58.57143
#HEAR	108	    80	          28	    74.07407
#RHOV	108	    39	          69    	36.11111
#SAAP	108	    69    	      39    	63.88889
summary(aov(may2019_alive ~ species, data = height_jan_surv_may_2019_notransf))
TukeyHSD(aov(may2019_alive ~ species, data = height_jan_surv_may_2019_notransf))
#             Df Sum Sq Mean Sq F value  Pr(>F)    
#species       3   8.34  2.7804   12.38 9.4e-08 ***
#Residuals   390  87.56  0.2245                
#$species
#                diff         lwr         upr     p adj
#HEAR-CEOL  0.1550265 -0.03256484  0.34261775 0.1447346
#RHOV-CEOL -0.2246032 -0.41219447 -0.03701188 0.0115076 <-- rhov and ceol
#SAAP-CEOL  0.0531746 -0.13441669  0.24076590 0.8844639
#RHOV-HEAR -0.3796296 -0.54599644 -0.21326282 0.0000001 <-- rhov and hear
#SAAP-HEAR -0.1018519 -0.26821866  0.06451496 0.3914784
#SAAP-RHOV  0.2777778  0.11141097  0.44414459 0.0001224 <-- rhov and saap


#  SITE
tapply(as.integer(height_jan_surv_may_2019_notransf$may2019_alive), 
       height_jan_surv_may_2019_notransf$site, mean) 
#        1         2 
# 0.7121212 0.4489796 
# 1: 71% and 2: 45%
print(height_jan_surv_may_2019_notransf %>%  
  group_by(site) %>% 
  summarise(N = length(may2019_alive), 
            total_survived = sum(may2019_alive == "1"), 
            total_died = sum(may2019_alive == "0"),
            percent_survived = 100*(sum(may2019_alive == "1")/length(may2019_alive))))
t.test(may2019_alive~site, data = height_jan_surv_may_2019_notransf) 
# site  N total_surv total_died percent_survived
#1	198	141	57	71.21212
#2	196	88	108	44.89796
t.test(may2019_alive~site, data = height_jan_surv_may_2019_notransf) 
# p-value = 7.843e-08


#  TREATMENT
tapply(as.integer(height_jan_surv_may_2019_notransf$may2019_alive), 
       height_jan_surv_may_2019_notransf$treatment, mean)
#     full      half      none 
#0.6307692 0.5227273 0.5909091 
print(height_jan_surv_may_2019_notransf %>%  
  group_by(treatment) %>% 
  summarise(N = length(may2019_alive), 
            total_survived = sum(may2019_alive == "1"), 
            total_died = sum(may2019_alive == "0"),
            percent_survived = 100*(sum(may2019_alive == "1")/length(may2019_alive))))
summary(aov(may2019_alive ~ treatment, data = height_jan_surv_may_2019_notransf))
# TukeyHSD(aov(may2019_alive ~ treatment, data = height_jan_surv_may_2019_notransf))

```


### E2. Basic stats on site - How are site 1 and site 2 different? 

```{r jan may 2019 site conditions ttest, include=TRUE}

#soil moisture 
t.test(soil_moisture~site, data = site_cond_may2019) 
# YES sig diff
# data:  soil_moisture by site
# t = 5.6653, df = 29.535, p-value = 3.76e-06
site_cond_may2019 %>%  
  group_by(site) %>% 
  summarize(avg_tdr = mean(soil_moisture), 
            SD = sd(soil_moisture),
            N = length(soil_moisture), 
            SE = ((sd(soil_moisture))/sqrt(length((soil_moisture)))))
# site  mean      SD      N     SE
#1    	22.10556	3.939597	18	0.9285719
#2	    15.79259	2.613453	18	0.6159968


#norm_par
t.test(normalized_par~site, data = site_cond_may2019) 
# not significant
# data:  normalized_par by site
# t = -1.5124, df = 33.969, p-value = 0.1397
site_cond_may2019 %>%  
  group_by(site) %>% 
  summarize(avg_par = mean(normalized_par), 
            SD = sd(normalized_par),
            N = length(normalized_par), 
            SE = ((sd(normalized_par))/sqrt(length((normalized_par)))))
# site  mean   SD      N    SE
#1    	0.3621245	0.2155215	18	0.05079891
#2	    0.4724443	0.2220996	18	0.05234938

#nncover
t.test(cover_percent~site, data = site_cond_may2019)
# Not sig
# data:  cover_percent by site
# t = 0.2511, df = 33.554, p-value = 0.8033
site_cond_may2019 %>%  
  group_by(site) %>% 
  summarize(avg_tdr = mean(cover_percent), 
            SD = sd(cover_percent),
            N = length(cover_percent), 
            SE = ((sd(cover_percent))/sqrt(length((cover_percent)))))
# site  mean   SD      N    SE
#1	36.58889	12.34307	18	2.909289
#2	35.49056	13.85799	18	3.266359


```

### E3. May 2019 glmer models
```{r may 2019 glmer model sandbox, include=FALSE}

MOD.dredge <- dredge(glme.may2019.mod.full)
MOD.dredge <- dredge(glme.may2019.mod.111)
MOD.dredge
#Moreover, the convergence code is zero which indicates that the model has not converged, and the estimated #variance for the random effect is zero. This means that potentially there is no variation within Anim_ID. #It would be a good idea to fit a model with glm() (ie without random intercepts but with Anim_ID as a fixed #effect) and see how the model estimates compare.

glme.may2019.mod.111 <- glmer(as.factor(may2019_alive) ~ site * species
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019, na.action = "na.fail")
summary(glme.may2019.mod.full)
# AIC = 468.6 
plot(allEffects(glme.may2019.mod.111))

# FULL MODELS




# WITH EXOTIC COVER

glme.may2019.mod.1 <- glmer(as.factor(may2019_alive) ~ 
                             normalized_par + soil_moisture # plus
                            + exotic_percentcover + site 
                            + jan_stem_height_cm + species # plus
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019)
summary(glme.may2019.mod.1)
# AIC: 472.2
#Fixed effects:
#                    Estimate Std. Error z value Pr(>|z|)   
#(Intercept)          0.90029    0.38777   2.322  0.02025 *  
#normalized_par      -0.27240    0.17384  -1.567  0.11713   
#soil_moisture        0.15323    0.23885   0.642  0.52118   
#exotic_percentcover  0.22781    0.17272   1.319  0.18717   
#site2               -1.02435    0.47720  -2.147  0.03183 * <-- site
#jan_stem_height_cm  -0.05829    0.17871  -0.326  0.74427   
#speciesHEAR          0.95463    0.46296   2.062  0.03921 * <-- species
#speciesRHOV         -1.13462    0.35559  -3.191  0.00142 ** <-- species
#speciesSAAP          0.32528    0.37115   0.876  0.38081 



glme.may2019.mod.2 <- glmer(as.factor(may2019_alive) ~ 
                             normalized_par * soil_moisture # times
                            + exotic_percentcover + site 
                            + jan_stem_height_cm + species # plus
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019)
summary(glme.may2019.mod.2)
# AIC: 472.5
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)   
#(Intercept)                   0.88791    0.38263   2.321  0.02031 * 
#normalized_par               -0.24133    0.17169  -1.406  0.15982   
#soil_moisture                 0.15254    0.23302   0.655  0.51270   
#exotic_percentcover           0.18393    0.17191   1.070  0.28465   
#site2                        -0.95004    0.46811  -2.030  0.04241 * <-- site
#jan_stem_height_cm           -0.06077    0.17846  -0.341  0.73345   
#speciesHEAR                   0.95992    0.46303   2.073  0.03816 * <-- species
#speciesRHOV                  -1.13268    0.35528  -3.188  0.00143 ** <-- species
#speciesSAAP                   0.32639    0.37113   0.879  0.37915   
#normalized_par:soil_moisture  0.24847    0.18851   1.318  0.18748   



glme.may2019.mod.21 <- glmer(as.factor(may2019_alive) ~ 
                             normalized_par + soil_moisture # plus
                            + exotic_percentcover + site 
                            + jan_stem_height_cm * species # times
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019)
summary(glme.may2019.mod.21)
# AIC = 477.7
#Fixed effects:
#                               Estimate Std. Error z value Pr(>|z|)  
#(Intercept)                     0.86136    0.49678   1.734   0.0829 .
#normalized_par                 -0.26414    0.17618  -1.499   0.1338  
#soil_moisture                   0.14782    0.24146   0.612   0.5404  
#exotic_percentcover             0.23210    0.17449   1.330   0.1835  
#site2                          -1.06084    0.48574  -2.184   0.0290 * <-- site
#jan_stem_height_cm             -0.16167    0.54309  -0.298   0.7659  
#speciesHEAR                     0.91391    0.58577   1.560   0.1187  
#speciesRHOV                    -0.81785    0.69048  -1.184   0.2362  
#speciesSAAP                     0.39747    0.47028   0.845   0.3980  
#jan_stem_height_cm:speciesHEAR  0.20696    0.63341   0.327   0.7439  
#jan_stem_height_cm:speciesRHOV  0.44242    0.85271   0.519   0.6039  
#jan_stem_height_cm:speciesSAAP  0.02396    0.59603   0.040   0.9679  

glme.may2019.mod.3 <- glmer(as.factor(may2019_alive) ~ 
                             normalized_par * soil_moisture # times
                            + exotic_percentcover + site 
                            + jan_stem_height_cm * species # times
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019)
summary(glme.may2019.mod.3)
# Warning: Model failed to converge with max|grad| = 0.00819763 (tol = 0.002, component 1)
# AIC = 478.0
#Fixed effects:
#                               Estimate Std. Error z value Pr(>|z|)  
#(Intercept)                     0.84716    0.49127   1.724   0.0846 .
#normalized_par                 -0.23316    0.17411  -1.339   0.1805  
#soil_moisture                   0.14801    0.23571   0.628   0.5300  
#exotic_percentcover             0.18824    0.17372   1.084   0.2785  
#site2                          -0.98447    0.47674  -2.065   0.0389 * <-- site
#jan_stem_height_cm             -0.16675    0.54292  -0.307   0.7587  
#speciesHEAR                     0.91146    0.58562   1.556   0.1196  
#speciesRHOV                    -0.83344    0.68760  -1.212   0.2255  
#speciesSAAP                     0.39950    0.46864   0.852   0.3940  
#normalized_par:soil_moisture    0.24927    0.19034   1.310   0.1903  
#jan_stem_height_cm:speciesHEAR  0.21834    0.63371   0.345   0.7304  
#jan_stem_height_cm:speciesRHOV  0.42159    0.85129   0.495   0.6204  
#jan_stem_height_cm:speciesSAAP  0.02646    0.59588   0.044   0.9646  

glme.may2019.mod.3glm <- glm(as.factor(may2019_alive) ~ 
                             normalized_par * soil_moisture # times
                            + exotic_percentcover + site 
                            + jan_stem_height_cm * species # times
                            + plot_number, 
                         family = binomial, 
                         data = height_jan_surv_may_2019)
summary(glme.may2019.mod.3glm)
# only Plot 4 was significant


# OMIT EXOTIC COVER


glme.may2019.mod.51 <- (glmer(as.factor(may2019_alive) ~ 
                             normalized_par * soil_moisture # times
                             + site # no exotic cover, with volume
                            + jan_volume_cm3 + species # plus
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019))
summary(glme.may2019.mod.51)
# AIC = 470.6
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)   
#(Intercept)                    0.9858     0.3877   2.542   0.0110 * 
#normalized_par                -0.2079     0.1710  -1.216   0.2239   
#soil_moisture                  0.2207     0.2296   0.961   0.3366   
#site2                         -0.8357     0.4653  -1.796   0.0725 . 
#jan_volume_cm3                 0.2003     0.1909   1.050   0.2939   
#speciesHEAR                    0.5708     0.4505   1.267   0.2051   
#speciesRHOV                   -1.1008     0.3527  -3.121   0.0018 ** <-- species
#speciesSAAP                    0.1541     0.3686   0.418   0.6759   
#normalized_par:soil_moisture   0.2851     0.1872   1.523   0.1279   


glme.may2019.mod.5 <- (glmer(as.factor(may2019_alive) ~ 
                             normalized_par * soil_moisture # times
                             + site # no exotic cover
                            + jan_stem_height_cm + species # plus
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019))
summary(glme.may2019.mod.5)
# AIC: 471.7
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)   
#(Intercept)                   0.85619    0.38308   2.235  0.02541 * 
#normalized_par               -0.21410    0.17104  -1.252  0.21067   
#soil_moisture                 0.21054    0.22996   0.916  0.35989   
#site2                        -0.87985    0.46786  -1.881  0.06003 . 
#jan_stem_height_cm           -0.05969    0.17888  -0.334  0.73861   
#speciesHEAR                   0.95833    0.46390   2.066  0.03885 * <-- species
#speciesRHOV                  -1.13097    0.35502  -3.186  0.00144 ** <-- species
#speciesSAAP                   0.32563    0.37127   0.877  0.38045   
#normalized_par:soil_moisture  0.28700    0.18706   1.534  0.12498  

glme.may2019.mod.4 <- glmer(as.factor(may2019_alive) ~ 
                             normalized_par + soil_moisture # plus
                             + site # no exotic cover
                            + jan_stem_height_cm + species # plus
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019)
summary(glme.may2019.mod.4)
# AIC: 471.9
#Fixed effects:
#                   Estimate Std. Error z value Pr(>|z|)   
#(Intercept)          0.8622     0.3902   2.210  0.02711 * 
#normalized_par      -0.2422     0.1751  -1.383  0.16651   
#soil_moisture        0.2271     0.2378   0.955  0.33947   
#site2               -0.9508     0.4824  -1.971  0.04876 *<-- site
#jan_stem_height_cm  -0.0564     0.1793  -0.315  0.75310   
#speciesHEAR          0.9521     0.4641   2.052  0.04021 * <-- species
#speciesRHOV         -1.1327     0.3553  -3.188  0.00143 ** <-- species
#speciesSAAP          0.3242     0.3714   0.873  0.38268  

glme.may2019.mod.41 <- glmer(as.factor(may2019_alive) ~ 
                             normalized_par + soil_moisture # plus
                             + site # no exotic cover, with volume
                            + jan_volume_cm3 + species # plus
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019)
summary(glme.may2019.mod.41)
# AIC: 470.9
#Fixed effects:
#               Estimate Std. Error z value Pr(>|z|)   
#(Intercept)      0.9922     0.3947   2.514  0.01194 * 
#normalized_par  -0.2360     0.1749  -1.349  0.17722   
#soil_moisture    0.2376     0.2374   1.001  0.31679   
#site2           -0.9064     0.4796  -1.890  0.05876 . 
#jan_volume_cm3   0.2027     0.1913   1.059  0.28950   
#speciesHEAR      0.5666     0.4503   1.258  0.20826   
#speciesRHOV     -1.1039     0.3531  -3.127  0.00177 **
#speciesSAAP      0.1524     0.3687   0.413  0.67934   



glme.may2019.mod.6 <- glmer(as.factor(may2019_alive) ~ 
                             normalized_par * soil_moisture # times
                             + site # no exotic cover
                            + jan_stem_height_cm  *species # times
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019)
#Warning: Model failed to converge with max|grad| = 0.00318041 (tol = 0.002, component 1)
summary(glme.may2019.mod.6)
# AIC = 477.2
# Fixed effects:
#                                Estimate Std. Error z value Pr(>|z|)  
#(Intercept)                     0.826763   0.492816   1.678   0.0934 .
#normalized_par                 -0.205320   0.173594  -1.183   0.2369  
#soil_moisture                   0.206357   0.232664   0.887   0.3751  
#site2                          -0.913006   0.476358  -1.917   0.0553 .
#jan_stem_height_cm             -0.144412   0.541825  -0.267   0.7898  
#speciesHEAR                     0.903075   0.586836   1.539   0.1238  
#speciesRHOV                    -0.847588   0.688692  -1.231   0.2184  
#speciesSAAP                     0.387224   0.469691   0.824   0.4097  
#normalized_par:soil_moisture    0.288910   0.188962   1.529   0.1263  
#jan_stem_height_cm:speciesHEAR  0.191418   0.632532   0.303   0.7622  
#jan_stem_height_cm:speciesRHOV  0.394426   0.849417   0.464   0.6424  
#jan_stem_height_cm:speciesSAAP  0.003975   0.594995   0.007   0.9947  




# MINIMAL MODELS

glme.may2018.mod.7 <- glmer(may_alive ~ 
                             normalized_par + soil_moisture + species + (1|plot_number), # plus
                         family = binomial, 
                         data = height_march_surv_may)
summary(glme.may2018.mod.7)
# AIC: 701.6 

glme.may2018.mod.8 <- glmer(may_alive ~ 
                             normalized_par * soil_moisture + species + (1|plot_number), # times
                         family = binomial, 
                         data = height_march_surv_may)
summary(glme.may2018.mod.8)
# AIC: 691.3  
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                   -1.0399     0.2213  -4.700 2.60e-06 ***
#normalized_par                 0.1509     0.1307   1.154 0.248345    
#soil_moisture                  0.5266     0.1319   3.991 6.57e-05 *** <-- tdr
#speciesHEAR                    0.9700     0.2546   3.810 0.000139 *** <-- species
#speciesRHOV                   -0.1128     0.2929  -0.385 0.700109    
#speciesSAAP                   -0.6973     0.3245  -2.149 0.031647 *  <-- species
#normalized_par:soil_moisture   0.5329     0.1466   3.636 0.000277 ***<-- tdr x par

```
 
```{r relative growth rates, include = true}
# RELATIVE GROWTH RATE

# relative growth rate as dependent variable - Shane's code
glme_rgr_may2018.1 <- lmer(rgr ~ normalized_par*soil_moisture + exotic_percentcover + site + (1|plot_number),
                         data = growth_march_may)
summary(glme_rgr_may2018.1)
# no AIC
# Site 2 is significant


#rgr MARCH to may 2018
ggplot(data = growth_march_may, 
       aes(x = species, y = rgr)) +
  geom_point() +
  geom_boxplot() +
  theme_bw()

summary(aov(rgr ~ species, data = growth_march_may))
#            Df    Sum Sq  Mean Sq F value Pr(>F)
#species      3 0.000404 1.348e-04   1.719  0.163
#Residuals    305 0.023919 7.842e-05        
TukeyHSD(aov(rgr ~ species, data = growth_march_may))
# $species
#                   diff          lwr         upr     p adj
#HEAR-CEOL -0.0019091829 -0.005687969 0.001869603 0.5603385
#RHOV-CEOL -0.0024371688 -0.006867196 0.001992858 0.4870778
#SAAP-CEOL  0.0007239310 -0.003996212 0.005444074 0.9788918
#RHOV-HEAR -0.0005279859 -0.004006298 0.002950326 0.9795116
#SAAP-HEAR  0.0026331138 -0.001207883 0.006474111 0.2894024
#SAAP-RHOV  0.0031610998 -0.001322111 0.007644310 0.2652069


#rgr JANUARY-may 2019
ggplot(data = growth_jan_may2019, aes(x = species, y = rgr)) + 
  geom_point() +
  geom_boxplot() +
  theme_bw()

summary(aov(rgr ~ species, data = growth_jan_may2019))
#            Df    Sum Sq  Mean Sq F value Pr(>F)
#species      3 0.001083 0.0003609   18.95 4.96e-11 ***
#Residuals   233 0.004438 0.0000190      
TukeyHSD(aov(rgr ~ species, data = growth_jan_may2019))
#Fit: aov(formula = rgr ~ species, data = growth_jan_may2019)

#$species
#                  diff           lwr           upr     p adj
#HEAR-CEOL -0.002234366 -0.0044168545 -5.187693e-05 0.0425417
#RHOV-CEOL -0.003680727 -0.0061348997 -1.226555e-03 0.0007771
#SAAP-CEOL  0.001903785 -0.0003289341  4.136505e-03 0.1244882
#RHOV-HEAR -0.001446362 -0.0035461154  6.533920e-04 0.2843751
#SAAP-HEAR  0.004138151  0.0023021119  5.974190e-03 0.0000001
#SAAP-RHOV  0.005584513  0.0034325964  7.736429e-03 0.0000000

#rgr JANUARY-may 2019 - SAAP by treatment
summary(aov(rgr ~ MAFA_removal, data = growth_jan_may2019 %>%  filter(species == "SAAP")))
TukeyHSD(aov(rgr ~ MAFA_removal, data = growth_jan_may2019 %>%  filter(species == "SAAP")))
#             Df    Sum Sq   Mean Sq F value Pr(>F)
#MAFA_removal  2 0.0000048 2.409e-06    0.09  0.914
#Residuals    68 0.0018232 2.681e-05   

#rgr may-nov 2019
ggplot(data = growth_may_nov2019, aes(x = species, y = rgr)) + 
  geom_point() +
  geom_boxplot() +
  theme_bw()

summary(aov(rgr ~ species, data = growth_may_nov2019))
#            Df    Sum Sq  Mean Sq F value Pr(>F)
#species      3 0.0000363 1.21e-05   1.716   0.17
#Residuals   87 0.0006133 7.05e-06      
TukeyHSD(aov(rgr ~ species, data = growth_may_nov2019))
#$species
#                   diff          lwr          upr     p adj
#HEAR-CEOL -0.0019100313 -0.004470106 0.0006500430 0.2134559
#RHOV-CEOL -0.0008807997 -0.004759967 0.0029983676 0.9334077
#SAAP-CEOL -0.0020803120 -0.004672190 0.0005115657 0.1604708
#RHOV-HEAR  0.0010292316 -0.002265217 0.0043236802 0.8456542
#SAAP-HEAR -0.0001702807 -0.001758765 0.0014182036 0.9922208
#SAAP-RHOV -0.0011995123 -0.004518735 0.0021197106 0.7798010

```

```{r may 2019 glmer MODELS, include=TRUE}

#Moreover, the convergence code is zero which indicates that the model has not converged, and the estimated #variance for the random effect is zero. This means that potentially there is no variation within Anim_ID. #It would be a good idea to fit a model with glm() (ie without random intercepts but with Anim_ID as a fixed #effect) and see how the model estimates compare.

# mafacover
glme.may2019.modcover <- glmer(as.factor(may2019_alive) ~ mafacover + species + jan_volume_cm3 + site + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019, na.action = "na.fail")
MOD <- glme.may2019.modcover 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) 
#data:  simulationOutput
#dispersion = 1.0068, p-value = 0.856
#alternative hypothesis: two.sided

anova(glme.may2019.modcover)
summary(glme.may2019.modcover)
#Fixed effects:
#               Estimate Std. Error z value Pr(>|z|)   
#(Intercept)     1.21459    0.38601   3.147  0.00165 **
#mafacover       0.02161    0.20786   0.104  0.91721   
#speciesHEAR     0.56226    0.44944   1.251  0.21092   
#speciesRHOV    -1.10355    0.35345  -3.122  0.00180 ** <-- species
#speciesSAAP     0.15371    0.36818   0.417  0.67632   
#jan_volume_cm3  0.20678    0.19061   1.085  0.27800   
#site2          -1.34081    0.42527  -3.153  0.00162 ** <-- site
emmeans(glme.may2019.modcover, list(pairwise ~ species), adjust = "tukey")
#$`pairwise differences of species`
# 1           estimate    SE  df z.ratio p.value
# CEOL - HEAR   -0.562 0.449 Inf  -1.251  0.5943
# CEOL - RHOV    1.104 0.353 Inf   3.122  0.0097 <--
# CEOL - SAAP   -0.154 0.368 Inf  -0.417  0.9755
# HEAR - RHOV    1.666 0.442 Inf   3.772  0.0009 <--
# HEAR - SAAP    0.409 0.358 Inf   1.142  0.6634
# RHOV - SAAP   -1.257 0.348 Inf  -3.609  0.0017 <--
plot(emmeans(glme.may2019.modcover, list(pairwise ~ species), adjust = "tukey"))
emmeans(glme.may2019.modcover, list(pairwise ~ site), adjust = "tukey")
#$`pairwise differences of site`
# 1             estimate    SE  df z.ratio p.value
# site1 - site2     1.34 0.425 Inf   3.153  0.0016
plot(emmeans(glme.may2019.modcover, list(pairwise ~ species), adjust = "tukey"))

dredge(glme.may2019.modcover)
#Model selection table 
#    (Int) jan_vlm_cm3      mfc sit spc df   logLik  AICc delta weight
#13 1.1190                        +   +  6 -228.322 468.9  0.00  0.443
#14 1.2270      0.2056            +   +  7 -227.711 469.7  0.85  0.289
#15 1.1160             0.006237   +   +  7 -228.322 470.9  2.07  0.157
#16 1.2150      0.2068 0.021610   +   +  8 -227.706 471.8  2.92  0.103
plot(allEffects(MOD))

# treatment
glme.may2019.modtreat <- glmer(as.factor(may2019_alive) ~ treatment + species + jan_volume_cm3 + site + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019, na.action = "na.fail")
anova(glme.may2019.modtreat)
#Analysis of Variance Table
#               npar Sum Sq Mean Sq F value
#treatment         2  1.152  0.5760  0.5760
#species           3 32.591 10.8635 10.8635
#jan_volume_cm3    1  1.708  1.7083  1.7083
#site              1 15.810 15.8096 15.8096

summary(glme.may2019.modtreat)
#Fixed effects:
#               Estimate Std. Error z value Pr(>|z|)    
#(Intercept)      1.5170     0.4489   3.379 0.000727 ***
#treatmenthalf   -0.5935     0.4219  -1.407 0.159531    
#treatmentnone   -0.2685     0.4193  -0.640 0.522006    
#speciesHEAR      0.5545     0.4495   1.234 0.217350    
#speciesRHOV     -1.1065     0.3534  -3.131 0.001743 **  <-- species
#speciesSAAP      0.1490     0.3680   0.405 0.685580    
#jan_volume_cm3   0.2083     0.1897   1.098 0.272077    
#site2           -1.3638     0.3490  -3.908 9.32e-05 *** <-- site
emmeans(glme.may2019.modtreat, list(pairwise ~ species), adjust = "tukey")
#$`pairwise differences of species`
# 1           estimate    SE  df z.ratio p.value
# CEOL - HEAR   -0.562 0.449 Inf  -1.251  0.5943
# CEOL - RHOV    1.104 0.353 Inf   3.122  0.0097 <--
# CEOL - SAAP   -0.154 0.368 Inf  -0.417  0.9755
# HEAR - RHOV    1.666 0.442 Inf   3.772  0.0009 <--
# HEAR - SAAP    0.409 0.358 Inf   1.142  0.6634
# RHOV - SAAP   -1.257 0.348 Inf  -3.609  0.0017 <--
plot(emmeans(glme.may2019.modtreat, list(pairwise ~ species), adjust = "tukey"))

emmeans(glme.may2019.modtreat, list(pairwise ~ site), adjust = "tukey")
#$`pairwise differences of site`
# 1             estimate    SE  df z.ratio p.value
# site1 - site2     1.36 0.349 Inf   3.908  0.0001
plot(emmeans(glme.may2019.modtreat, list(pairwise ~ site), adjust = "tukey"))

MOD <- glme.may2019.modtreat 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) 
#data:  simulationOutput
#dispersion = 1.0091, p-value = 0.832
#alternative hypothesis: two.sided
dredge(glme.may2019.modtreat)
#Model selection table 
#    (Int) jan_vlm_cm3 sit spc trt df   logLik  AICc delta weight
#7  1.1190               +   +      6 -228.322 468.9  0.00  0.455
#8  1.2270      0.2056   +   +      7 -227.711 469.7  0.85  0.297
#15 1.4030               +   +   +  8 -227.370 471.1  2.25  0.147
#16 1.5170      0.2083   +   +   +  9 -226.738 471.9  3.08  0.097
plot(allEffects(MOD))

# par * tdr
glme.may2019.mod.full <- glmer(as.factor(may2019_alive) ~ normalized_par  * soil_moisture + exotic_percentcover + site + jan_volume_cm3 + species 
                             + (1|plot_number) # random effect needed for glmer
                                , 
                         family = binomial(link = "logit"), 
                         data = height_jan_surv_may_2019)
anova(glme.may2019.mod.full)
summary(glme.may2019.mod.full)
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)   
#(Intercept)                   0.99162    0.38875   2.551   0.0107 * 
#normalized_par               -0.20453    0.17167  -1.191   0.2335   
#soil_moisture                 0.22296    0.22992   0.970   0.3322   
#exotic_percentcover           0.03682    0.16989   0.217   0.8284   
#site2                        -0.85403    0.47293  -1.806   0.0709 . 
#jan_volume_cm3                0.19646    0.19164   1.025   0.3053   
#speciesHEAR                   0.57678    0.45138   1.278   0.2013   
#speciesRHOV                  -1.10111    0.35277  -3.121   0.0018 ** <-- species
#speciesSAAP                   0.15712    0.36885   0.426   0.6701   
#normalized_par:soil_moisture  0.27628    0.19165   1.442   0.1494   

emmeans(glme.may2019.mod.full, list(pairwise ~ species), adjust = "tukey")
#$`pairwise differences of species`
# 1           estimate    SE  df z.ratio p.value
# CEOL - HEAR   -0.577 0.451 Inf  -1.278  0.5771
# CEOL - RHOV    1.101 0.353 Inf   3.121  0.0097 <-- 
# CEOL - SAAP   -0.157 0.369 Inf  -0.426  0.9740
# HEAR - RHOV    1.678 0.443 Inf   3.790  0.0009 <--
# HEAR - SAAP    0.420 0.359 Inf   1.168  0.6470
# RHOV - SAAP   -1.258 0.348 Inf  -3.616  0.0017 <--
 
MOD <- glme.may2019.mod.full 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) 
#data:  simulationOutput
#dispersion = 1.0086, p-value = 0.84
#alternative hypothesis: two.sided
dredge(glme.may2019.mod.full)
# Model selection table 
#    (Int)   ext_prc jan_vlm_cm3 nrm_par sit sol_mst spc df   logLik  AICc delta weight
#45 0.9315                       -0.2336   +           +  6 -232.861 477.9  0.00  0.167
#61 0.7997                       -0.2401   +  0.1948   +  7 -232.112 478.5  0.58  0.125
#47 1.0350                0.1883 -0.2267   +           +  7 -232.257 478.8  0.86  0.108
#63 0.9048                0.1993 -0.2330   +  0.2026   +  8 -231.448 479.3  1.33  0.086
#46 0.9517  0.082460             -0.2227   +           +  7 -232.595 479.5  1.54  0.077
#41 0.9775                                 +           +  5 -234.922 480.0  2.06  0.060
#62 0.8194  0.086630             -0.2285   +  0.1983   +  8 -231.820 480.0  2.07  0.059
#48 1.0420  0.064740      0.1731 -0.2189   +           +  8 -232.097 480.6  2.63  0.045
#43 1.0870                0.2035           +           +  6 -234.194 480.6  2.67  0.044
#57 0.8606                                 +  0.1793   +  6 -234.280 480.8  2.84  0.040
#64 0.9114  0.068030      0.1832 -0.2246   +  0.2046   +  9 -231.273 481.0  3.07  0.036
plot(allEffects(MOD))

# par * tdr
glme.may2019.mod.12 <- glmer(as.factor(may2019_alive) ~ 
                             normalized_par * soil_moisture # times
                            + exotic_percentcover + site # jan_volumne_cm3
                            + jan_volume_cm3 + species # plus
                            + (1|plot_number) # random effect needed for glmer
                          , 
                         family = binomial, 
                         data = height_jan_surv_may_2019, na.action = "na.fail")
summary(glme.may2019.mod.12)
#AIC = 472.6 
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)   
#(Intercept)                   0.99162    0.38875   2.551   0.0107 * 
#normalized_par               -0.20453    0.17167  -1.191   0.2335   
#soil_moisture                 0.22296    0.22992   0.970   0.3322   
#exotic_percentcover           0.03682    0.16989   0.217   0.8284   
#site2                        -0.85403    0.47293  -1.806   0.0709 . 
#jan_volume_cm3                0.19646    0.19164   1.025   0.3053   
#speciesHEAR                   0.57678    0.45138   1.278   0.2013   
#speciesRHOV                  -1.10111    0.35277  -3.121   0.0018 ** <-- species
#speciesSAAP                   0.15712    0.36885   0.426   0.6701   
#normalized_par:soil_moisture  0.27628    0.19165   1.442   0.1494   
MOD <- glme.may2019.mod.12 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) 
#data:  simulationOutput
#dispersion = 1.009, p-value = 0.912
#alternative hypothesis: two.sided
dredge(glme.may2019.mod.12)
#Model selection table 
#     (Int)   ext_prc jan_vlm_cm3 nrm_par sit sol_mst spc nrm_par:sol_mst df   logLik  AICc delta weight
#41  1.1190                                 +           +                  6 -228.322 468.9  0.00  0.109
plot(allEffects(MOD))



# additional code to visualize MOD data
plot(simulationOutput)
hist(simulationOutput)
testResiduals(simulationOutput)
plotResiduals(simulationOutput, height_jan_surv_may_2019$species) # you're looking for flat red line
plotResiduals(simulationOutput, height_jan_surv_may_2019$site) # 

# The testDispersion() function gives us a histogram of simulated expected values, and then a red line indicating our observed dispersion in our actual data. Additionally, this function performs a statistical test of our dispersion with the null hypothesis being “We do not have overdispersion”. 
# dispersion = 1.0114, p-value = 0.808

plot(residuals(MOD))
binned_residuals(MOD)
# Warning: About 80% of the residuals are inside the error bounds (~95% or higher would be good).
plot(allEffects(MOD))
r2(MOD)
# Conditional: R2 like a line
# Marginal R2: takes into account only fixed effects without random effects

#visualize alive data by random effect 
dotplot(ranef(MOD, condVar = T)) #condVar adds 95% confidence intervals around random effects estimates

# visualize data by plotting alive by random effect 
random.intercepts = ranef(MOD)$plot_number[["(Intercept)"]] # create vector of random intercepts by pulling them from model
plot.intercepts = fixef(MOD)[1] + random.intercepts # create intercepts estimates by adding effects together

```

```{r may 2019 figures}

may2019_box_values <- height_jan_surv_may_2019  %>% 
  group_by(site, species) %>%
  summarize(sum_may2019_alive = sum(as.integer(may2019_alive)), 
            SD = sd(as.integer(may2019_alive)),
            N = length(as.integer(may2019_alive)), 
            SE = ((sd(as.integer(may2019_alive)))/sqrt(length((as.integer(may2019_alive))))))
print(may2019_box_values)


glme.may2019.modcover.box1 <- ggplot(data = may2019_box_values, 
       aes(x = site, y = sum_may2019_alive, fill = species)) +
  geom_bar() + 
  #scale_x_discrete(labels = c("Site 1", "Site 2")) +
 # theme_bw() +
  geom_text(aes(label = paste(sum_may2019_alive, "N"))) +
  labs(x = "Site", 
       y = "Total alive (N)", 
       title = "Jan-May 2019 seedling survival by site")
plot(glme.may2019.modcover.box1)

# How to make column graphs with nested x-axis labels
# https://stackoverflow.com/questions/18165863/multirow-axis-labels-with-nested-grouping-variables


glme.may2019.modcover.box1 <- ggplot(data = may2019_box_values, 
        aes(x = site, y = sum_may2019_alive, col = species)) +
   geom_col() + 
   scale_x_discrete(labels = c("Site 1", "Site 2")) +
   theme_bw() +
   labs(x = "Site", 
        y = "Total alive (N)", 
        title = "Jan-May 2019 seedling survival by site")
plot(glme.may2019.modcover.box1)

glme.may2019.modcover.box1 <- ggplot(data = may2019_box_values, 
                                     aes(x = site, y = sum_may2019_alive, col = species)) +
  labs(title = "Jan-May 2019 seedling survival by site", x = "Site", y = "Total alive (N)") +
   geom_boxplot() +
   theme_bw() 
 plot(glme.may2019.modcover.box1)
 
 glme.may2019.modcover.box1 <- ggplot(data = may2019_box_values, 
        aes(x = site, y = sum_may2019_alive, fill = species)) +
   geom_boxplot() + 
   scale_x_discrete(labels = c("CEOL /n Site 1", "HEAR /n Site 1", "RHOV /n Site 1", "SAAP /n Site 1", "CEOL /n Site 2", "HEAR /n Site 2", "RHOV /n Site 2", "SAAP /n Site 2")) +
   theme_bw() +
   labs(x = "Site", 
        y = "Total alive (N)", 
        title = "Jan-May 2019 seedling survival by site")
 plot(glme.may2019.modcover.box1)
 glme.may2019.modcover.box1 <- ggplot(data = may2019_box_values, 
        aes(x = site, y = sum_may2019_alive, fill = species)) +
 geom_col(color = "black") +
   scale_x_discrete(labels = c("CEOL /n Site 1", "HEAR /n Site 1", "RHOV /n Site 1", "SAAP /n Site 1", "CEOL /n Site 2", "HEAR /n Site 2", "RHOV /n Site 2", "SAAP /n Site 2")) +
   theme_bw() +
   labs(x = "Site", 
        y = "Total alive (N)", 
        title = "Jan-May 2019 seedling survival by site")
 plot(glme.may2019.modcover.box1)
 glme.may2019.modcover.box1 <- ggplot(data = may2019_box_values, 
        aes(x = site, y = sum_may2019_alive, fill = species)) +
   geom_boxplot() + 
   scale_x_discrete(labels = c("CEOL /n Site 1", "HEAR /n Site 1", "RHOV /n Site 1", "SAAP /n Site 1", "CEOL /n Site 2", "HEAR /n Site 2", "RHOV /n Site 2", "SAAP /n Site 2")) +
   theme_bw() +
   labs(x = "Site", 
        y = "Total alive (N)", 
        title = "Jan-May 2019 seedling survival by site")
 plot(glme.may2019.modcover.box1)

glme.may2019.modcover <- glmer(as.factor(may2019_alive) ~ mafacover + species + jan_volume_cm3 + site + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019, na.action = "na.fail")


```


```{r may 2019 extra glmer code, include =FALSE}

glme.may2019 <- (glmer(as.factor(may2019_alive) ~ species + site + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019))

MOD <- glme.may2019 

simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput)
plot(simulationOutput)
hist(simulationOutput)
testResiduals(simulationOutput)
plotResiduals(simulationOutput, height_jan_surv_may_2019$species) # you're looking for flat red line
plotResiduals(simulationOutput, height_jan_surv_may_2019$site) # 

# The testDispersion() function gives us a histogram of simulated expected values, and then a red line indicating our observed dispersion in our actual data. Additionally, this function performs a statistical test of our dispersion with the null hypothesis being “We do not have overdispersion”. 
# dispersion = 1.0114, p-value = 0.808

plot(residuals(MOD))
binned_residuals(MOD)
# Warning: About 80% of the residuals are inside the error bounds (~95% or higher would be good).
plot(allEffects(MOD))
r2(MOD)
# Conditional: R2 like a line
# Marginal R2: takes into account only fixed effects without random effects

#visualize alive data by random effect 
dotplot(ranef(MOD, condVar = T)) #condVar adds 95% confidence intervals around random effects estimates

# visualize data by plotting alive by random effect 
random.intercepts = ranef(MOD)$plot_number[["(Intercept)"]] # create vector of random intercepts by pulling them from model
plot.intercepts = fixef(MOD)[1] + random.intercepts # create intercepts estimates by adding effects together

# not sure what this code is for
#for loop creating each individual curve ~ plot number
for (i in 1:length(random.intercepts)) {
  
  if (i ==1) curve(exp(plot.intercepts[i] + fixef(MOD)["Soil Moisture"]*x)/
                     (1 + exp(plot.intercepts[i] + fixef(MOD)["Soil Moisture"]*x)),
                   from = min(height_jan_surv_may_2019$soil_moisture), to = max(height_jan_surv_may_2019$soil_moisture), ylim = c(0,1), 
                   xlab = "Centered Soil Moisture", ylab = "Probability of Alive Jan-May 2019")
  
  if (i > 1) curve(exp(plot.intercepts[i] + fixef(MOD)["Soil Moisture"]*x)/
                     (1 + exp(plot.intercepts[i] + fixef(MOD)["Length"]*x)),
                   add = T)
}




# Calculate model's residual and fitted values
F1 <- fitted(MOD)
E1 <- residuals(MOD, "pearson")

# Graph residuals vs fitted values to inspect homogeneity of variance, look for a random scattering of plots
# run together 2 lines
plot(x=F1, y=E1, xlab="Fitted Model Values", ylab="Pearson Residuals", main = "Variance")
abline(h = 0) # looking for random scatter

# Check for crazy outliers, look for lines MUCH taller than the rest of data
plot(cooks.distance(MOD))


# Plot a box plot for each factor, look for equal variance amount levels along the zero line
# Box plots need to be assessed for every fixed effect (categorical factor) for your model. 
# Random effects need the qqline just like normality. 
# So, only site and treatment get box plots. 
# exotic_cover is a covariate (continuous variable).

boxplot(E1 ~ site, data = height_jan_surv_may_2019) # <---- make sure to change to df, not the glmer
abline(h = 0)

boxplot(E1 ~ species, data = height_jan_surv_may_2019) # <---- make sure to change to df, not the lme
abline(h = 0)

# Plot each random effect in the model - things in the (1|_), look for dots along 1:1 line
qqnorm(ranef(MOD)$plot_number[,1], main = "Plot Residuals")
qqline(ranef(MOD)$plot_number[,1]) # plot number


```
### E4. May 2019 post hoc

```{r may 2019 post hoc, include=TRUE}

# best model from dredge(glme.may2019.mod.12) is --> site and species 
glme.may2019.best <- (glmer(as.factor(may2019_alive) ~ species + site + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019, na.action = "na.fail")) #AIC = 468.6
summary(glme.may2019.best) # no colinearity in summary
#Fixed effects:
#            Estimate Std. Error z value Pr(>|z|)    
#(Intercept)   1.1192     0.3547   3.156 0.001602 ** 
#speciesHEAR   0.8627     0.3614   2.387 0.016998 *  
#speciesRHOV  -1.1224     0.3535  -3.175 0.001497 ** 
#speciesSAAP   0.2867     0.3479   0.824 0.409890    
#site2        -1.3896     0.3579  -3.883 0.000103 ***
  
glme.may2019.secondbest <- (glm(as.factor(may2019_alive) ~ species * site + (1|plot_number) # When run as a glm, AIC: 473.63.
                                , 
                         family = binomial, 
                         data = height_jan_surv_may_2019)) #AIC = 461.3. 
summary(glme.may2019.secondbest) # lots of colinearity in the summary :/

MOD <- glme.may2019.best 

simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput)
plot(simulationOutput)
hist(simulationOutput)
testResiduals(simulationOutput)
plotResiduals(simulationOutput, height_jan_surv_may_2019$species) # you're looking for flat red line
plotResiduals(simulationOutput, height_jan_surv_may_2019$site) # 

# The testDispersion() function gives us a histogram of simulated expected values, and then a red line indicating our observed dispersion in our actual data. Additionally, this function performs a statistical test of our dispersion with the null hypothesis being “We do not have overdispersion”. 
# dispersion = 1.0114, p-value = 0.808

plot(residuals(MOD))
binned_residuals(MOD)
# Warning: About 80% of the residuals are inside the error bounds (~95% or higher would be good).
plot(allEffects(MOD))
r2(MOD)
#Conditional R2: 0.335
#     Marginal R2: 0.214
dredge(glme.may2019.best)
#Model selection table 
#  (Intrc) site specs df   logLik  AICc delta weight
#4  1.1190    +     +  6 -228.322 468.9  0.00  0.997 <-- best model
#3  0.4300          +  5 -235.096 480.3 11.49  0.003
#2  0.9988    +        3 -249.099 504.3 35.40  0.000
#1  0.3882             2 -255.870 515.8 46.91  0.000
#Models ranked by AICc(x) 
#Random terms (all models): 
#  1 | plot_number
anova(glme.may2019.best)

glmm_interactionmay2019_species <- glmer(factor(may2019_alive) ~  species + (1|plot_number),
                          family = binomial(link = "logit"),
                          data = height_jan_surv_may_2019)
summary(glmm_interactionmay2019_species)
# AIC: 480.2
#Fixed effects:
#            Estimate Std. Error z value Pr(>|z|)   
#(Intercept)   0.4300     0.3210   1.340  0.18035   
#speciesHEAR   0.8546     0.3609   2.368  0.01789 * 
#speciesRHOV  -1.1293     0.3525  -3.204  0.00136 **
#speciesSAAP   0.2774     0.3472   0.799  0.42431   

glmm_interactionmay2019_site <- glmer(factor(may2019_alive) ~  site + (1|plot_number), # When run as a glm, AIC: 511.36.
                          family = binomial(link = "logit"),
                          data = height_jan_surv_may_2019)
print(glmm_interactionmay2019_site)
summary(glmm_interactionmay2019_site)
# AIC: 504.2
# Fixed effects:
#            Estimate Std. Error z value Pr(>|z|)    
#(Intercept)   0.9988     0.2277   4.387 1.15e-05 ***
#site2        -1.2197     0.3127  -3.900 9.62e-05 ***


```


### E5. May 2019 - survival by species

```{r may 2019 glmer by species CEOL, include=TRUE}
#CEOL
glme.may2019.mod.full_CEOL_vol <- glmer(as.factor(may2019_alive) ~ normalized_par  * soil_moisture + exotic_percentcover + site + jan_volume_cm3 
                             + (1|plot_number), 
                         family = binomial(link = "logit"), 
                         data = (height_jan_surv_may_2019 %>% filter(species == "CEOL")))

glme.may2019.mod.full_CEOL_height <- glmer(as.factor(may2019_alive) ~ normalized_par  * soil_moisture + exotic_percentcover + site + jan_stem_height_cm 
                             + (1|plot_number), 
                         family = binomial(link = "logit"), 
                         data = (height_jan_surv_may_2019 %>% filter(species == "CEOL")))

MOD <- glme.may2019.mod.full_CEOL_vol 
MOD <- glme.may2019.mod.full_CEOL_height
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) # follows binomial distribution

anova(glme.may2019.mod.full_CEOL_vol)
#Analysis of Variance Table
#                             npar Sum Sq Mean Sq F value
#normalized_par                  1 1.3742  1.3742  1.3742
#soil_moisture                   1 4.0621  4.0621  4.0621
#exotic_percentcover             1 0.5114  0.5114  0.5114
#site                            1 2.7681  2.7681  2.7681
#jan_volume_cm3                  1 0.1424  0.1424  0.1424
#normalized_par:soil_moisture    1 0.5544  0.5544  0.5544

summary(glme.may2019.mod.full_CEOL_vol)
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)
#(Intercept)                    1.0987     1.2441   0.883    0.377
#normalized_par                -0.1178     0.3622  -0.325    0.745
#soil_moisture                  0.2593     0.4772   0.543    0.587
#exotic_percentcover            0.2745     0.3549   0.773    0.439
#site2                         -1.4844     1.0574  -1.404    0.160
#jan_volume_cm3                -0.2403     1.7961  -0.134    0.894
#normalized_par:soil_moisture   0.3140     0.4409   0.712    0.476

#Correlation of Fixed Effects:
#            (Intr) nrmlz_ sl_mst extc_p site2  jn_v_3
#normalzd_pr  0.195                                   
#soil_moistr -0.311 -0.033                            
#extc_prcntc -0.071  0.016  0.079                     
#site2       -0.374 -0.132  0.548 -0.254              
#jan_vlm_cm3  0.840  0.146 -0.111 -0.205  0.099       
#nrmlzd_pr:_  0.334  0.161 -0.032 -0.223  0.064  0.341

summary(glme.may2019.mod.full_CEOL_height)
# model run with volume vs height makes no difference - no variables are significant, no variables predict CEOL survival.

emmeans(glme.may2019.mod.full_CEOL_vol, list(pairwise ~ site), adjust = "tukey")

```

```{r may 2019 glmer by species HEAR, include=TRUE}
#HEAR
glme.may2019.mod.full_HEAR_vol <- glmer(as.factor(may2019_alive) ~ normalized_par  * soil_moisture + exotic_percentcover + site + jan_volume_cm3 
                             + (1|plot_number), 
                         family = binomial(link = "logit"), 
                         data = (height_jan_surv_may_2019 %>% filter(species == "HEAR")))

MOD <- glme.may2019.mod.full_HEAR_vol 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) # follows binomial distribution

anova(glme.may2019.mod.full_HEAR_vol)
#Analysis of Variance Table
#                             npar Sum Sq Mean Sq F value
#normalized_par                  1 5.8742  5.8742  5.8742
#soil_moisture                   1 5.0897  5.0897  5.0897
#exotic_percentcover             1 0.3782  0.3782  0.3782
#site                            1 3.5767  3.5767  3.5767
#jan_volume_cm3                  1 0.0137  0.0137  0.0137
#normalized_par:soil_moisture    1 0.0001  0.0001  0.0001
#
summary(glme.may2019.mod.full_HEAR_vol)
#Fixed effects:
#                              Estimate Std. Error z value Pr(>|z|)   
#(Intercept)                   2.544377   0.851639   2.988  0.00281 **
#normalized_par               -0.726634   0.361734  -2.009  0.04456 * <-- normPAR
#soil_moisture                 0.063631   0.501135   0.127  0.89896   
#exotic_percentcover          -0.136961   0.310149  -0.442  0.65878   
#site2                        -1.881442   1.026064  -1.834  0.06671 . 
#jan_volume_cm3               -0.029132   0.255309  -0.114  0.90916   
#normalized_par:soil_moisture  0.003847   0.417743   0.009  0.99265   

glme.may2019.mod.full_HEAR_height <- glmer(as.factor(may2019_alive) ~ normalized_par  * soil_moisture + exotic_percentcover + site + jan_stem_height_cm 
                             + (1|plot_number), 
                         family = binomial(link = "logit"), 
                         data = (height_jan_surv_may_2019 %>% filter(species == "HEAR")))

MOD <- glme.may2019.mod.full_HEAR_height 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) # follows binomial distribution

anova(glme.may2019.mod.full_HEAR_height)
summary(glme.may2019.mod.full_HEAR_height)
#Fixed effects:
#                              Estimate Std. Error z value Pr(>|z|)   
#(Intercept)                   2.645862   0.909667   2.909  0.00363 **
#normalized_par               -0.729848   0.360445  -2.025  0.04288 * <-- normPAR
#soil_moisture                 0.055867   0.503680   0.111  0.91168   
#exotic_percentcover          -0.137025   0.310476  -0.441  0.65897   
#site2                        -1.900379   1.024917  -1.854  0.06371 . 
#jan_stem_height_cm           -0.112949   0.371346  -0.304  0.76101   
#normalized_par:soil_moisture  0.001182   0.418614   0.003  0.99775   

glme.may2019.mod.full_HEAR.scatter <- ggplot(data = height_jan_surv_may_2019 %>%  filter(species == "HEAR"), 
                       aes(x = may2019_alive, y = normalized_par, col = normalized_par)) +
  geom_point(aes(color = normalized_par)) +
  geom_jitter(width = 0.0, height = 0.0) +
  theme_classic()
glme.may2019.mod.full_HEAR.scatter

height_jan_surv_may_2019 %>%  
  filter(species == "HEAR") %>%  
  group_by(may2019_alive) %>% 
  summarize(mean_normPAR_HEAR = mean(normalized_par), 
            SE = ((sd(normalized_par))/sqrt(length((normalized_par)))), 
                  N = length(normalized_par))

ggplot(data = height_jan_surv_may_2019 %>%  filter(species == "HEAR"), 
       aes(x = as.factor(may2019_alive), y = normalized_par)) +
  geom_point() +
  geom_boxplot() +
  theme_bw()

# HEAR x mafacover
height_jan_surv_may_2019_HEAR <- height_jan_surv_may_2019 %>%  filter (species == "HEAR")

glme.may2019.modcover_HEAR <- glmer(as.factor(may2019_alive) ~ mafacover + jan_volume_cm3 + site + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019_HEAR, na.action = "na.fail")

anova(glme.may2019.modcover_HEAR)
summary(glme.may2019.modcover_HEAR)
#Fixed effects:
#               Estimate Std. Error z value Pr(>|z|)   
#(Intercept)     2.57416    0.83089   3.098  0.00195 **
#mafacover       0.32503    0.39168   0.830  0.40664   
#jan_volume_cm3  0.02282    0.25249   0.090  0.92800   
#site2          -2.03783    0.89076  -2.288  0.02215 * <-- site

glme.may2019.modtreat_HEAR <- glmer(as.factor(may2019_alive) ~ jan_volume_cm3 + treatment + site + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019_HEAR, na.action = "na.fail")

anova(glme.may2019.modtreat_HEAR)
summary(glme.may2019.modtreat_HEAR)
#Fixed effects:
#               Estimate Std. Error z value Pr(>|z|)   
#(Intercept)      3.0202     0.9485   3.184  0.00145 **
#jan_volume_cm3   0.0194     0.2561   0.076  0.93963   
#treatmenthalf   -0.3873     0.8085  -0.479  0.63192   
#treatmentnone   -0.4236     0.8038  -0.527  0.59819   
#site2           -2.3947     0.8201  -2.920  0.00350 ** <-- site
```

```{r may 2019 glmer by species RHOV, include=TRUE}
#RHOV
glme.may2019.mod.full_RHOV_vol <- glmer(as.factor(may2019_alive) ~ normalized_par  * soil_moisture + exotic_percentcover + site + jan_volume_cm3 
                             + (1|plot_number), 
                         family = binomial(link = "logit"), 
                         data = (height_jan_surv_may_2019 %>% filter(species == "RHOV")))

glme.may2019.mod.full_RHOV_height <- glmer(as.factor(may2019_alive) ~ normalized_par  * soil_moisture + exotic_percentcover + site + jan_stem_height_cm 
                             + (1|plot_number), 
                         family = binomial(link = "logit"), 
                         data = (height_jan_surv_may_2019 %>% filter(species == "RHOV")))

MOD <- glme.may2019.mod.full_RHOV_vol
MOD <- glme.may2019.mod.full_RHOV_height
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) # follows binomial distribution

anova(glme.may2019.mod.full_RHOV_vol)
#Analysis of Variance Table
#                             npar Sum Sq Mean Sq F value
#normalized_par                  1 0.8118  0.8118  0.8118
#soil_moisture                   1 8.3508  8.3508  8.3508
#exotic_percentcover             1 0.8740  0.8740  0.8740
#site                            1 4.4811  4.4811  4.4811
#jan_volume_cm3                  1 2.9589  2.9589  2.9589
#normalized_par:soil_moisture    1 1.9824  1.9824  1.9824

summary(glme.may2019.mod.full_RHOV_vol)
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)  
#(Intercept)                    2.6449     1.7022   1.554   0.1202  
#normalized_par                -0.2989     0.2627  -1.138   0.2551  
#soil_moisture                  0.4456     0.3121   1.428   0.1534  
#exotic_percentcover            0.2373     0.2455   0.967   0.3338  
#site2                         -1.1758     0.6447  -1.824   0.0682 .
#jan_volume_cm3                 4.2517     2.5625   1.659   0.0971 .
#normalized_par:soil_moisture   0.3956     0.2809   1.408   0.1591  
#Correlation of Fixed Effects:
#            (Intr) nrmlz_ sl_mst extc_p site2  jn_v_3
#normalzd_pr  0.072                                   
#soil_moistr -0.051 -0.188                            
#extc_prcntc -0.051  0.143  0.015                     
#site2       -0.103 -0.201  0.611 -0.249              
#jan_vlm_cm3  0.975  0.003  0.085 -0.086  0.066       
#nrmlzd_pr:_ -0.075 -0.320  0.105 -0.172  0.109 -0.042
#optimizer (Nelder_Mead) convergence code: 0 (OK)
#boundary (singular) fit: see help('isSingular')

anova(glme.may2019.mod.full_RHOV_height)
summary(glme.may2019.mod.full_RHOV_height)
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)  
#(Intercept)                  -0.02472    0.67258  -0.037    0.971  
#normalized_par               -0.31082    0.26092  -1.191    0.234  
#soil_moisture                 0.39811    0.30753   1.295    0.195  
#exotic_percentcover           0.27946    0.24343   1.148    0.251  
#site2                        -1.31590    0.64386  -2.044    0.041 *
#jan_stem_height_cm            0.07658    0.67187   0.114    0.909  
#normalized_par:soil_moisture  0.43687    0.27747   1.574    0.115 
```

```{r may 2019 glmer by species SAAP, include=TRUE}
#SAAP
glme.may2019.mod.full_SAAP_vol <- glmer(as.factor(may2019_alive) ~ normalized_par  * soil_moisture + exotic_percentcover + site + jan_volume_cm3 
                             + (1|plot_number), 
                         family = binomial(link = "logit"), 
                         data = (height_jan_surv_may_2019 %>% filter(species == "SAAP")))

glme.may2019.mod.full_SAAP_height <- glmer(as.factor(may2019_alive) ~ normalized_par  * soil_moisture + exotic_percentcover + site + jan_stem_height_cm
                             + (1|plot_number), 
                         family = binomial(link = "logit"), 
                         data = (height_jan_surv_may_2019 %>% filter(species == "SAAP")))

MOD <- glme.may2019.mod.full_SAAP_vol
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) # follows binomial distribution

anova(glme.may2019.mod.full_SAAP_vol)
#Analysis of Variance Table
#                             npar  Sum Sq Mean Sq F value
#normalized_par                  1 0.11317 0.11317  0.1132
#soil_moisture                   1 0.11398 0.11398  0.1140
#exotic_percentcover             1 0.04935 0.04935  0.0494
#site                            1 0.04983 0.04983  0.0498
#jan_volume_cm3                  1 0.88477 0.88477  0.8848
#normalized_par:soil_moisture    1 1.14394 1.14394  1.1439

summary(glme.may2019.mod.full_SAAP_vol)
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)
#(Intercept)                   0.55568    0.50568   1.099    0.272
#normalized_par               -0.08395    0.29822  -0.282    0.778
#soil_moisture                 0.16461    0.39791   0.414    0.679
#exotic_percentcover          -0.20883    0.30271  -0.690    0.490
#site2                         0.36695    0.83894   0.437    0.662
#jan_volume_cm3                0.31944    0.37434   0.853    0.393
#normalized_par:soil_moisture  0.33512    0.32698   1.025    0.305

summary(glme.may2019.mod.full_SAAP_height)
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)
#(Intercept)                   0.63139    0.55477   1.138    0.255
#normalized_par               -0.07787    0.31618  -0.246    0.805
#soil_moisture                 0.13509    0.42053   0.321    0.748
#exotic_percentcover          -0.13772    0.30289  -0.455    0.649
#site2                         0.29914    0.90741   0.330    0.742
#jan_stem_height_cm           -0.01814    0.28111  -0.065    0.949
#normalized_par:soil_moisture  0.35772    0.34129   1.048    0.295

emmeans(glme.may2019.mod.full_SAAP, list(pairwise ~ site), adjust = "tukey")
#$`pairwise differences of site`
# 1             estimate    SE  df z.ratio p.value
# site1 - site2     1.68 0.681 Inf   2.473  0.0134


# RGR by species in Jan - May 2019
ggplot(data = growth_jan_may2019, aes(x = species, y = rgr)) + #growth_march_may for 2018
  geom_point() +
  geom_boxplot() +
  theme_bw()

summary(aov(rgr ~ species, data = growth_jan_may2019))
TukeyHSD(aov(rgr ~ species, data = growth_jan_may2019))

```

### E6. May 2019 Predictions
```{r , include = FALSE}
## Soil moisture

moisture_site_1_low_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = min(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "1",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019., newdata = . , type = "response"))

moisture_site_2_low_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = min(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "2",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_1_mean_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = 0,
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "1",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_2_mean_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = 0,
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "2",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_1_max_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = max(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "1",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_2_max_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = max(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "2",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_1_prediction_2019 <- rbind(moisture_site_1_low_par_2019, moisture_site_1_mean_par_2019, moisture_site_1_max_par_2019)
moisture_site_2_prediction_2019 <- rbind(moisture_site_2_low_par_2019, moisture_site_2_mean_par_2019, moisture_site_2_max_par_2019)

site_1_sm_plot <- ggplot()+
  geom_point(data = height_march_surv_may_2019 %>%  filter(site == "1"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25) +
  geom_line(data = moisture_site_1_prediction_2019, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1)+
  theme_classic()+
  labs(x = "Soil Moisture (%)",
       y = "Probability of Survival",
       title = "Site 1")

site_2_sm_plot <- ggplot()+
  geom_point(data = height_march_surv_may_2019 %>%  filter(site == "2"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_site_2_prediction_2019, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1)+
  theme_classic()+
  labs(x = "Soil Moisture (%)",
       y = "Probability of Survival",
       title = "Site 2")

site_1_sm_plot + site_2_sm_plot
## stem height
stem_height_site_1_prediction <- seq(from = -1.7, to = 3.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(normalized_par = mean(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "1",
         soil_moisture = mean(height_march_surv_may_2019$soil_moisture),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

stem_height_site_2_prediction <- seq(from = -1.7, to = 3.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(normalized_par = mean(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "2",
         soil_moisture = mean(height_march_surv_may_2019$soil_moisture),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

site_1_sh_plot <- ggplot()+
  geom_point(data = height_march_surv_may_2019 %>%  filter(site == "1"), aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_site_1_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival",
       title = "Site 1")

site_2_sh_plot <- ggplot()+
  geom_point(data = height_march_surv_may_2019 %>%  filter(site == "2"), aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_site_2_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival",
       title = "Site 2")

site_1_sh_plot + site_2_sh_plot
```


### E7. Predictions for each species

#### CEOL 
```{r}
ceol_2019 <- height_march_surv_may_2019 %>% 
  filter(species == "CEOL")
  
AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ site + normalized_par + (1|plot_number),
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2019))


summary(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = ceol_2019))

## Add Figure
``` 

#### RHOV

```{r} 
rhov_2019 <- height_march_surv_may_2019 %>% 
  filter(species == "RHOV")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ site + normalized_par +(1|plot_number), 
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number), 
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number), 
          family = binomial,
          data = rhov_2019))

rhov_model <- glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = rhov_2019)
summary(rhov_model)
```

#### HEAR

```{r}
hear_2019 <- height_march_surv_may_2019 %>% 
  filter(species == "HEAR")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ normalized_par + site + (1|plot_number),
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2019))

hear_moisture_model_2019 <- glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number), 
                         family = binomial,
                         data = hear_2019)

summary(hear_moisture_model_2019)

hear_moisture_pred_2019 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = 1) %>% 
  mutate(alive = predict(hear_moisture_model_2019, newdata = ., type = "response"))

ggplot()+
  geom_point(data = hear_2019, aes(x = soil_moisture, y = may_alive), alpha = 0.5) +
  geom_line(data = hear_moisture_pred_2019, aes(x = soil_moisture, y = alive), linewidth = 1) +
  theme_classic()


```

#### SAAP
```{r}
saap_2019 <- height_march_surv_may %>% 
  filter(species == "SAAP")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ site + normalized_par + (1|plot_number), 
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number), 
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number), 
          family = binomial,
          data = saap_2019))


saap_model <- glmer(as.factor(may_alive) ~ site + (1|plot_number),
                         family = binomial,
                         data = saap_2018)

summary(saap_model)
```

# F. Survival May - November 2019

```{r May - Nov 2019 subset data, include=TRUE}

# subsetting data for May - Nov 2019 survival
#
# survmortnospp = nov 2019
# par = nov 2019
# tdr = march 2019 #wettest time of year
# nncover = 2019
# mafacover = 2019

# par Nov 2019
par_nov2019 <- dplyr::filter(par, year == "2019" & month =="11") %>% 
  dplyr::select(site, plot_number, treatment, normalized_par) 
glimpse(par_nov2019)

# OMIT TDR since TDR was only recorded in March 2019 and this is for May-November 2019
#tdr_july2019 <- tdr %>% 
#  dplyr::filter(year == "2019" & month == "3") # tdr March 2019 - df created from May 2019 
#glimpse(tdr_march2019)
#tdr_march2019 <- tdr %>% 
#  dplyr::filter(year == "2019" & month == "3") %>% 
#  dplyr::select(site, plot_number, treatment, soil_moisture)  %>% 
#  mutate(treatment = case_when(treatment == "nonene" ~ "none",
#                               TRUE ~ treatment))
#tdr_march2019$site <- factor(tdr_march2019$site, levels = c("1", "2"))  

# nncover may-june 2019 - df created from May 2019 
glimpse(nncover_may2019)
#nncover_may2019 <- dplyr::filter(exotic_cover_all, year == "2019") %>% 
#  dplyr::select(site, plot_number, treatment, cover_percent)
#unique(nncover_may2019$plot_number)

# mafacover may 2019 - df created from May 2019 
glimpse(mafacover_may2019)
#mafacover_may2019 <- dplyr::filter(mafa_cover_all, year == "2019") %>% 
#  dplyr::select(site, year, plot_number, mafacover)

# join par tdr nncover for nov2019
site_cond_nov2019 <- full_join(par_nov2019, nncover_may2019, by = c("site", "plot_number", "treatment")) %>% # omit tdr because soil moisture in may doesn't make sense to model survival in dry months
    full_join(mafacover_may2019, by = c("site", "plot_number")) 
print(site_cond_nov2019)

write.csv(site_cond_nov2019, "data/processed/nov2019_site_conditions.csv")
```

```{r may 2019 height survival df, include=TRUE}
# Making height and survival dataframe

# height may 2019 - calculated in Jan-May 2019
height_may_2019 <- height_raw %>% 
  filter(date >= "2019-04-30" & date <= "2019-05-30") %>% # filtering to only have rows of data taken in may 2019 
   dplyr::select(plot_number, MAFA_removal, location, species, stem_height_cm, volume_cm3) %>% 
  rename(may_stem_height_cm = stem_height_cm, 
         may_volume_cm3 = volume_cm3)
list(unique(height_may_2019$plot_number)) # check captured all 36 plots with dates

# height nov 2019
height_nov_2019 <- height_raw %>% 
  filter(date >= "2019-11-01" & date <= "2019-12-01") %>% # filtering to only have rows of data taken in nov 2019 
   dplyr::select(plot_number, MAFA_removal, location, species, stem_height_cm, volume_cm3) %>% 
  rename(nov_stem_height_cm = stem_height_cm, 
         nov_volume_cm3 = volume_cm3) %>% 
  na.omit()
height_nov_2019 %>% 
  group_by(species) %>% 
  summarize(N = length(nov_stem_height_cm))

# survival Nov 2019
survival_nov_2019 <- height_raw %>% 
  filter(date == "2019-11-23") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, alive) %>% 
  rename(nov_alive = alive) %>% 
  mutate(nov_alive = replace_na(nov_alive, 0))  # 0= dead 1 = alive
glimpse(survival_nov_2019)
list(unique(survival_nov_2019$plot_number)) # check captured all 36 plots with dates

# growth rate from May to Nov 2019 - GROWTH RATE
growth_may_nov2019 <- right_join(height_may_2019, height_nov_2019, by = c("plot_number", "MAFA_removal", "location", "species")) %>% 
  #mutate(may_stem_height_cm = as.numeric(_stem_height_cm)) %>% 
  drop_na() %>% 
  mutate(rgr = (log(nov_stem_height_cm) - log(may_stem_height_cm))/(6*30)) # relative growth rate per day equation; 30 days per month

# RGR by species in May - Nov 2019
ggplot(data = growth_may_nov2019, aes(x = species, y = rgr)) + #growth_march_may for 2018
  geom_point() +
  geom_boxplot() +
  theme_bw()

summary(aov(rgr ~ species, data = growth_may_nov2019))
#            Df    Sum Sq  Mean Sq F value Pr(>F)
#species      3 0.0000363 1.21e-05   1.716   0.17
#Residuals   87 0.0006133 7.05e-06      
TukeyHSD(aov(rgr ~ species, data = growth_may_nov2019))
       
       
```

#### Join environmental and survival df and scale
```{r nov 2019 transform data, include=TRUE}

# full join - no data transformation
height_may_surv_nov_2019_notransf <- full_join(height_may_2019, survival_nov_2019, by = c("plot_number", "MAFA_removal", "location", "species")) %>% 
  mutate(may_stem_height_cm = as.numeric(may_stem_height_cm)) %>% 
  drop_na() %>%  # removing na's for now. But should an NA in alive be assumed as dead? 
  mutate(plot_number = as.character(plot_number)) %>% 
  left_join(site_cond_nov2019, by = "plot_number") %>% 
  rename(exotic_percentcover = cover_percent) %>% 
  dplyr::select(!MAFA_removal)
print(height_may_surv_nov_2019_notransf)
write.csv(height_may_surv_nov_2019_notransf, "data/processed/height_may_surv_nov_2019_notransf.csv")

# full join - with data transformation
height_may_surv_nov_2019 <- full_join(height_may_2019, survival_nov_2019, by = c("plot_number", "MAFA_removal", "location", "species")) %>% 
  mutate(may_stem_height_cm = as.numeric(may_stem_height_cm)) %>% 
  drop_na() %>%  # removing na's for now. But should an NA in alive be assumed as dead? 
  mutate(plot_number = as.character(plot_number)) %>% 
  left_join(site_cond_nov2019, by = "plot_number") %>% 
  rename(exotic_percentcover = cover_percent) %>% 
  dplyr::select(!MAFA_removal) %>% 
  mutate(normalized_par = scale(normalized_par),
         exotic_percentcover = scale(exotic_percentcover), 
         may_stem_height_cm = scale(may_stem_height_cm), 
         mafacover = scale(mafacover),
         may_stem_height_cm = scale(may_stem_height_cm),
         may_volume_cm3 = scale(may_volume_cm3))
print(height_may_surv_nov_2019)
```

### F1. Basic stats on seedling survival - anovas and ttests

```{r}
# data exploration of survival by species

# HEIGHT 
height_may_surv_nov_2019_notransf %>%  
  group_by(species) %>% 
  summarize(avg_height_may2019 = mean(may_stem_height_cm), 
            SD = sd(may_stem_height_cm),
            N = length(may_stem_height_cm), 
            SE = ((sd(may_stem_height_cm))/sqrt(length((may_stem_height_cm)))))
summary(aov(may_stem_height_cm ~ species, data = height_may_surv_nov_2019_notransf))
TukeyHSD(aov(may_stem_height_cm ~ species, data = height_may_surv_nov_2019_notransf))
#$species
#                diff        lwr       upr     p adj
#HEAR-CEOL  2.6467380  1.4620183  3.831458 0.0000001 <-- hear and ceol
#RHOV-CEOL -1.5337806 -2.8659781 -0.201583 0.0167503
#SAAP-CEOL  3.1906321  1.9755301  4.405734 0.0000000 <-- saap and ceol
#RHOV-HEAR -4.1805185 -5.3203271 -3.040710 0.0000000 <-- hear and rhov
#SAAP-HEAR  0.5438942 -0.4565488  1.544337 0.4963399
#SAAP-RHOV  4.7244127  3.5530563  5.895769 0.0000000 <-- saap and rhov

# VOLUME 
height_may_surv_nov_2019_notransf %>%  
  group_by(species) %>% 
  summarize(avg_vol_may2019 = mean(may_volume_cm3), 
            SD = sd(may_volume_cm3),
            N = length(may_volume_cm3), 
            SE = ((sd(may_volume_cm3))/sqrt(length((may_volume_cm3)))))
summary(aov(may_volume_cm3 ~ species, data = height_may_surv_nov_2019_notransf))
TukeyHSD(aov(may_volume_cm3 ~ species, data = height_may_surv_nov_2019_notransf))
#$species
#                 diff        lwr       upr     p adj
#HEAR-CEOL   97.554673   46.24790 148.86145 0.0000097 
#RHOV-CEOL  -13.839957  -71.53357  43.85366 0.9253608
#SAAP-CEOL   90.949297   38.32675 143.57184 0.0000712
#RHOV-HEAR -111.394630 -160.75644 -62.03282 0.0000001
#SAAP-HEAR   -6.605376  -49.93166  36.72091 0.9791357
#SAAP-RHOV  104.789254   54.06120 155.51731 0.0000013


# SURVIVAL
print(height_may_surv_nov_2019_notransf %>%  
  group_by(species) %>% 
  summarise(N = length(nov_alive), 
            total_survived = sum(nov_alive == "1"), 
            total_died = sum(nov_alive == "0"),
            percent_survived = 100*(sum(nov_alive == "1")/length(nov_alive))))
summary(aov(nov_alive ~ species, data = height_may_surv_nov_2019_notransf))
TukeyHSD(aov(nov_alive ~ species, data = height_may_surv_nov_2019_notransf))
#$species
#                 diff         lwr         upr     p adj
#HEAR-CEOL  0.25740741  0.03177926  0.48303556 0.0181557 <-- hear and ceol
#RHOV-CEOL -0.01666667 -0.27038177  0.23704843 0.9982493
#SAAP-CEOL  0.30714286  0.07572843  0.53855729 0.0038972 <-- saap and ceol
#RHOV-HEAR -0.27407407 -0.49114898 -0.05699917 0.0068121 <-- hear and rhov
#SAAP-HEAR  0.04973545 -0.14079748  0.24026838 0.9062973
#SAAP-RHOV  0.32380952  0.10072638  0.54689266 0.0012420 <-- saap and rhov


# data exploration of survival by site and treatment

#  SITE
print(height_may_surv_nov_2019_notransf %>%  
  group_by(site) %>% 
  summarise(N = length(nov_alive), 
            mean_survival = mean(nov_alive),
            total_survived = sum(nov_alive == "1"), 
            total_died = sum(nov_alive == "0"),
            percent_survived = 100*(sum(nov_alive == "1")/length(nov_alive))))
t.test(nov_alive~site, data = height_may_surv_nov_2019_notransf) 
# data:  nov_alive by site
# t = 3.2805, df = 210.26, p-value = 0.001213


#  TREATMENT

print(height_may_surv_nov_2019_notransf %>%  
  group_by(treatment) %>% 
  summarise(N = length(nov_alive), 
            mean_survival = mean(nov_alive),
            total_survived = sum(nov_alive == "1"), 
            total_died = sum(nov_alive == "0"),
            percent_survived = 100*(sum(nov_alive == "1")/length(nov_alive))))
summary(aov(nov_alive ~ treatment, data = height_may_surv_nov_2019_notransf))
TukeyHSD(aov(nov_alive ~ treatment, data = height_may_surv_nov_2019_notransf))
#treatment
#                 diff         lwr          upr     p adj
#half-full  0.19642857  0.02082773  0.372029414 0.0240464 <--
#none-full  0.01309524 -0.15771247  0.183902950 0.9821339
#none-half -0.18333333 -0.36094878 -0.005717884 0.0412930 <-- 



```

### F2. Basic stats on site - How are site 1 and site 2 different? 

```{r jan nov 2019 site conditions ttest, include=TRUE}

#soil moisture 
t.test(soil_moisture~site, data = site_cond_nov2019) # same as May 2019
# YES sig diff
# data:  soil_moisture by site
# t = 5.6653, df = 29.535, p-value = 3.76e-06
site_cond_nov2019 %>%  
  group_by(site) %>% 
  summarize(avg_tdr = mean(soil_moisture), 
            SD = sd(soil_moisture),
            N = length(soil_moisture), 
            SE = ((sd(soil_moisture))/sqrt(length((soil_moisture)))))
# site  mean      SD      N     SE
#1    	22.10556	3.939597	18	0.9285719
#2	    15.79259	2.613453	18	0.6159968


#norm_par
t.test(normalized_par~site, data = site_cond_nov2019) 
# PAR by site is significantly different
# data:  normalized_par by site
#t = -5.1832, df = 25.07, p-value = 2.303e-05
site_cond_nov2019 %>%  
  group_by(site) %>% 
  summarize(avg_par = mean(normalized_par), 
            SD = sd(normalized_par),
            N = length(normalized_par), 
            SE = ((sd(normalized_par))/sqrt(length((normalized_par)))))
# site  mean   SD      N    SE
# 1     0.1805103	0.08270182	18	0.01949301 <-- site 1 is darker, more shady compared to Site 2
# 2	    0.4055448	0.16458910	18	0.03879402

#nncover
t.test(cover_percent~site, data = site_cond_nov2019)
# Not sig
#data:  cover_percent by site
#t = -1.2375, df = 29.093, p-value = 0.2258
site_cond_nov2019 %>%  
  group_by(site) %>% 
  summarize(avg_nncover = mean(cover_percent), 
            SD = sd(cover_percent),
            N = length(cover_percent), 
            SE = ((sd(cover_percent))/sqrt(length((cover_percent)))))
# site  mean   SD      N    SE
#1	35.83333	12.61302	18	2.972917
#2	42.61111	19.51512	18	4.599758


```

### F3. November 2019 glmer models
```{r nov 2019 glmer MODELS, include=TRUE}

#Moreover, the convergence code is zero which indicates that the model has not converged, and the estimated #variance for the random effect is zero. This means that potentially there is no variation within Anim_ID. #It would be a good idea to fit a model with glm() (ie without random intercepts but with Anim_ID as a fixed #effect) and see how the model estimates compare.

# mafacover
glme.nov2019.modcover <- glmer(as.factor(nov_alive) ~ mafacover + species + site + may_volume_cm3  + (1|plot_number), 
                         family = binomial, 
                         data = height_may_surv_nov_2019, na.action = "na.fail")
anova(glme.nov2019.modcover)
summary(glme.nov2019.modcover)
# AIC: 259.6 
#Fixed effects:
#               Estimate Std. Error z value Pr(>|z|)   
#(Intercept)     -1.5610     0.4965  -3.144  0.00167 **
#mafacover        0.5311     0.1941   2.736  0.00623 ** <-- mafacover
#speciesHEAR      1.2967     0.5573   2.326  0.01999 * <-- species
#speciesRHOV     -0.1623     0.6446  -0.252  0.80123   
#speciesSAAP      1.7256     0.5715   3.019  0.00253 ** <-- species
#may_volume_cm3   0.3512     0.1891   1.857  0.06334 . 
#site2           -0.8247     0.3939  -2.094  0.03628 * <-- site



# glme.nov2019.modcover x species
emmeans(glme.nov2019.modcover, list(pairwise ~ species), adjust = "tukey")
#$`pairwise differences of species`
# 1           estimate    SE  df z.ratio p.value
# CEOL - HEAR   -1.297 0.557 Inf  -2.326  0.0921
# CEOL - RHOV    0.162 0.645 Inf   0.252  0.9944
# CEOL - SAAP   -1.726 0.571 Inf  -3.019  0.0135 <-- 
# HEAR - RHOV    1.459 0.562 Inf   2.595  0.0466 <--
# HEAR - SAAP   -0.429 0.373 Inf  -1.149  0.6590
# RHOV - SAAP   -1.888 0.574 Inf  -3.288  0.0056 <--
plot(emmeans(glme.nov2019.modcover, list(pairwise ~ species), adjust = "tukey"))


# glme.nov2019.modcover x species
emmeans(glme.nov2019.modcover, list(pairwise ~ site), adjust = "tukey")
#$`pairwise differences of site`
# 1             estimate    SE  df z.ratio p.value
# site1 - site2    0.825 0.394 Inf   2.094  0.0363


MOD <- glme.nov2019.modcover 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) 
dredge(glme.nov2019.modcover)
#Model selection table 
#     (Int)    mfc may_vlm_cm3 sit spc df   logLik  AICc delta weight
#16 -1.5610 0.5311      0.3512   +   +  8 -121.807 260.2  0.00  0.519 <-- best model
plot(allEffects(MOD))

# treatment
glme.nov2019.modtreat <- glmer(as.factor(nov_alive) ~ treatment + species + may_volume_cm3 + site + (1|plot_number), 
                         family = binomial, 
                         data = height_may_surv_nov_2019, na.action = "na.fail")
anova(glme.nov2019.modtreat)
summary(glme.nov2019.modtreat)
#Fixed effects:
#               Estimate Std. Error z value Pr(>|z|)    
#(Intercept)     -1.7204     0.5366  -3.206 0.001346 ** 
#treatmenthalf    1.0658     0.4027   2.647 0.008123 ** <-- treatment 
#treatmentnone    0.2015     0.4072   0.495 0.620729    
#speciesHEAR      1.2190     0.5564   2.191 0.028465 *  <-- species
#speciesRHOV     -0.2029     0.6456  -0.314 0.753360    
#speciesSAAP      1.6393     0.5704   2.874 0.004051 ** <-- species
#may_volume_cm3   0.3892     0.1894   2.055 0.039896 *  <-- volume
#site2           -1.2429     0.3720  -3.341 0.000834 *** <-- site

emmeans(glme.nov2019.modtreat, list(pairwise ~ treatment), adjust = "tukey")
plot(emmeans(glme.nov2019.modtreat, list(pairwise ~ treatment), adjust = "tukey"))
#$`pairwise differences of treatment`
# 1           estimate    SE  df z.ratio p.value
# full - half   -1.066 0.403 Inf  -2.647  0.0221 <--
# full - none   -0.201 0.407 Inf  -0.495  0.8738
# half - none    0.864 0.400 Inf   2.160  0.0782
emmeans(glme.nov2019.modtreat, list(pairwise ~ species), adjust = "tukey")
#$`pairwise differences of species`
# 1           estimate    SE  df z.ratio p.value
# CEOL - HEAR   -1.219 0.556 Inf  -2.191  0.1257
# CEOL - RHOV    0.203 0.646 Inf   0.314  0.9893
# CEOL - SAAP   -1.639 0.570 Inf  -2.874  0.0211 <-- 
# HEAR - RHOV    1.422 0.561 Inf   2.534  0.0548
# HEAR - SAAP   -0.420 0.371 Inf  -1.133  0.6689
# RHOV - SAAP   -1.842 0.573 Inf  -3.217  0.0071 <--
plot(emmeans(glme.nov2019.modtreat, list(pairwise ~ species), adjust = "tukey"))

emmeans(glme.nov2019.modcover, list(pairwise ~ site), adjust = "tukey")
#$`pairwise differences of site`
# 1             estimate    SE  df z.ratio p.value
# site1 - site2    0.825 0.394 Inf   2.094  0.0363

#Treatment x HEAR
glme.nov2019.modtreat_HEAR <- glmer(as.factor(nov_alive) ~ treatment + site + may_volume_cm3  + (1|plot_number), 
                         family = binomial, 
                         data = nov2019.modcover_HEAR, na.action = "na.fail")
anova(glme.nov2019.modtreat_HEAR)
summary(glme.nov2019.modtreat_HEAR)
#Fixed effects:
#               Estimate Std. Error z value Pr(>|z|)  
#(Intercept)     -0.7446     0.6100  -1.221   0.2222  
#treatmenthalf    1.8256     0.8236   2.217   0.0266 * <-- treatment
#treatmentnone    0.2604     0.7930   0.328   0.7427  
#site2           -1.6645     0.7508  -2.217   0.0266 * <-- site
#may_volume_cm3   0.4736     0.3639   1.302   0.1930  
#---
#Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

#Correlation of Fixed Effects:
#            (Intr) trtmnth trtmntn site2 
#treatmnthlf -0.636                       
#treatmentnn -0.645  0.547                
#site2       -0.149 -0.283  -0.184        
#may_vlm_cm3 -0.250 -0.004  -0.002   0.040

#Treatment x SAAP <-- boundary (singular) fit: see help('isSingular')
glme.nov2019.modtreat_SAAP <- glmer(as.factor(nov_alive) ~ treatment + site + may_volume_cm3  + (1|plot_number), 
                         family = binomial, 
                         data = nov2019.modcover_SAAP, na.action = "na.fail")
anova(glme.nov2019.modtreat_SAAP)
summary(glme.nov2019.modtreat_SAAP)
#Generalized linear mixed model fit by maximum likelihood (Laplace Approximation) ['glmerMod']
# Family: binomial  ( logit )
#Formula: as.factor(nov_alive) ~ treatment + site + may_volume_cm3 + (1 |      plot_number)
#   Data: nov2019.modcover_SAAP

#     AIC      BIC   logLik deviance df.resid 
#   101.6    115.1    -44.8     89.6       64 

#Scaled residuals: 
#    Min      1Q  Median      3Q     Max 
#-2.0347 -0.7751 -0.6033  0.9678  1.6719 

#Random effects:
# Groups      Name        Variance Std.Dev.
# plot_number (Intercept) 0        0       
#Number of obs: 70, groups:  plot_number, 32

#Fixed effects:
#               Estimate Std. Error z value Pr(>|z|)
#(Intercept)     0.09015    0.46248   0.195    0.845
#treatmenthalf   0.12587    0.63342   0.199    0.842
#treatmentnone  -0.21709    0.61614  -0.352    0.725
#site2          -0.67000    0.53671  -1.248    0.212
#may_volume_cm3  0.34627    0.22815   1.518    0.129

#Correlation of Fixed Effects:
#            (Intr) trtmnth trtmntn site2  
#            treatmnthlf -0.563                       
#treatmentnn -0.532  0.481                
#site2       -0.411 -0.102  -0.217        
#may_vlm_cm3 -0.139 -0.066  -0.154   0.283
#optimizer (Nelder_Mead) convergence code: 0 (OK)
#boundary (singular) fit: see help('isSingular') <-- NOT A GREAT MODEL

MOD <- glme.nov2019.modtreat 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) 
#dispersion = 1.0113, p-value = 0.856
#alternative hypothesis: two.sided
dredge(glme.nov2019.modtreat)
#Model selection table 
#     (Int) may_vlm_cm3 sit spc trt df   logLik  AICc delta weight
#16 -1.7200      0.3892   +   +   +  9 -121.899 262.6  0.00  0.630 <-- best model
plot(allEffects(MOD))

# par, no tdr
glme.nov2019.mod1 <- glmer(as.factor(nov_alive) ~ normalized_par + exotic_percentcover + site + may_volume_cm3 + species 
                             + (1|plot_number) # random effect needed for glmer
                                , 
                         family = binomial(link = "logit"), 
                         data = height_may_surv_nov_2019, na.action = "na.fail")
anova(glme.nov2019.mod1)
summary(glme.nov2019.mod1)
#Fixed effects:
#                    Estimate Std. Error z value Pr(>|z|)   
#(Intercept)          -1.4951     0.5152  -2.902  0.00371 **
#normalized_par       -0.2230     0.2492  -0.895  0.37083   
#exotic_percentcover  -0.2984     0.2083  -1.433  0.15194   
#site2                -0.8456     0.5238  -1.614  0.10643   
#may_volume_cm3        0.4490     0.2015   2.228  0.02590 * <-- volume
#speciesHEAR           1.1858     0.5644   2.101  0.03563 *  <-- species
#speciesRHOV          -0.1315     0.6460  -0.204  0.83865   
#speciesSAAP           1.6117     0.5754   2.801  0.00509 ** <-- species
emmeans(glme.nov2019.mod1, list(pairwise ~ species), adjust = "tukey")
#Results are averaged over the levels of: site 
#Results are given on the logit (not the response) scale. 
#Confidence level used: 0.95 

#$`pairwise differences of species`
# 1           estimate    SE  df z.ratio p.value
# CEOL - HEAR   -1.186 0.564 Inf  -2.101  0.1527
# CEOL - RHOV    0.132 0.646 Inf   0.204  0.9970
# CEOL - SAAP   -1.612 0.575 Inf  -2.801  0.0262 <-- saap
# HEAR - RHOV    1.317 0.568 Inf   2.318  0.0939
# HEAR - SAAP   -0.426 0.376 Inf  -1.134  0.6687
# RHOV - SAAP   -1.743 0.575 Inf  -3.032  0.0130 <-- saap

plot(emmeans(glme.nov2019.mod1, list(pairwise ~ species), adjust = "tukey"))
#$`pairwise differences of species`
# 1           estimate    SE  df z.ratio p.value
# CEOL - HEAR   -1.186 0.564 Inf  -2.101  0.1527
# CEOL - RHOV    0.132 0.646 Inf   0.204  0.9970
# CEOL - SAAP   -1.612 0.575 Inf  -2.801  0.0262 <-- 
# HEAR - RHOV    1.317 0.568 Inf   2.318  0.0939
# HEAR - SAAP   -0.426 0.376 Inf  -1.134  0.6687
# RHOV - SAAP   -1.743 0.575 Inf  -3.032  0.0130 <-- 


MOD <- glme.nov2019.mod1 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) 
#data:  simulationOutput
#dispersion = 1.0086, p-value = 0.84
#alternative hypothesis: two.sided


# par, no tdr + mafacover
glme.nov2019.mod_cover <- glmer(as.factor(nov_alive) ~ mafacover  + normalized_par + exotic_percentcover + site + may_volume_cm3 + species 
                             + (1|plot_number) # random effect needed for glmer
                                , 
                         family = binomial(link = "logit"), 
                         data = height_may_surv_nov_2019, na.action = "na.fail")
anova(glme.nov2019.mod_cover)
summary(glme.nov2019.mod_cover)



# par, no tdr + treatment
glme.nov2019.mod_treatment <- glmer(as.factor(nov_alive) ~ treatment  + normalized_par + exotic_percentcover + site + may_volume_cm3 + species 
                             + (1|plot_number) # random effect needed for glmer
                                , 
                         family = binomial(link = "logit"), 
                         data = height_may_surv_nov_2019, na.action = "na.fail")
anova(glme.nov2019.mod_treatment)
summary(glme.nov2019.mod_treatment)

```
```{r nov 2019 glmer sand box}
dredge(glme.nov2019.mod1)
#Model selection table 
#     (Int) ext_prc may_vlm_cm3 nrm_par sit  sol_mst spc df   logLik  AICc delta weight
#43 -1.3490              0.4086           +            +  7 -125.432 265.4  0.00  0.167
#44 -1.3860 -0.2909      0.4446           +            +  8 -124.408 265.4  0.09  0.159
#48 -1.4950 -0.2984      0.4490 -0.2230   +            +  9 -124.009 266.8  1.46  0.081
#47 -1.4520              0.4107 -0.2090   +            +  8 -125.092 266.8  1.46  0.080
#40 -1.7640 -0.3592      0.5053 -0.4850                +  8 -125.337 267.3  1.95  0.063
#59 -1.3770              0.4084           +  0.04898   +  8 -125.413 267.5  2.10  0.058
#60 -1.4140 -0.2915      0.4445           +  0.04968   +  9 -124.387 267.6  2.21  0.055
#39 -1.7780              0.4685 -0.5242                +  7 -126.905 268.3  2.94  0.038
#41 -1.5380                               +            +  6 -127.992 268.4  3.00  0.037
#63 -1.4370              0.4111 -0.2260   + -0.04078   +  9 -125.080 269.0  3.60  0.028
#64 -1.4780 -0.2980      0.4494 -0.2415   + -0.04485   + 10 -123.994 269.0  3.61  0.027 <-- full model
plot(allEffects(MOD))

# par * tdr
glme.nov2019.mod2 <- glmer(as.factor(nov_alive) ~ 
                             normalized_par * soil_moisture # times
                            + exotic_percentcover + site # jan_volumne_cm3
                            + may_volume_cm3 + species # plus
                            + (1|plot_number) # random effect needed for glmer
                          , 
                         family = binomial, 
                         data = height_may_surv_nov_2019, na.action = "na.fail")
summary(glme.nov2019.mod2)
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)   
#(Intercept)                   -1.5826     0.5520  -2.867  0.00414 **
#normalized_par                -0.3648     0.3295  -1.107  0.26830   
#soil_moisture                 -0.1479     0.3049  -0.485  0.62763   
#exotic_percentcover           -0.3393     0.2175  -1.560  0.11877   
#site2                         -0.9294     0.5693  -1.632  0.10258   
#may_volume_cm3                 0.4593     0.2009   2.286  0.02226 * <-- volume
#speciesHEAR                    1.1716     0.5655   2.072  0.03829 * <-- species
#speciesRHOV                   -0.1301     0.6483  -0.201  0.84097   
#speciesSAAP                    1.6041     0.5764   2.783  0.00539 ** <-- species
#normalized_par:soil_moisture  -0.1834     0.2747  -0.667  0.50446   
MOD <- glme.nov2019.mod2 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) 
#data:  simulationOutput
#dispersion = 1.009, p-value = 0.912
#alternative hypothesis: two.sided
dredge(glme.nov2019.mod2)
#Model selection table 
#      (Int) ext_prc may_vlm_cm3 nrm_par sit  sol_mst spc nrm_par:sol_mst df   logLik  AICc delta weight
#43  -1.3490              0.4086           +            +                  7 -125.432 265.4  0.00  0.160
#44  -1.3860 -0.2909      0.4446           +            +                  8 -124.408 265.4  0.09  0.153
#48  -1.4950 -0.2984      0.4490 -0.2230   +            +                  9 -124.009 266.8  1.46  0.077
#47  -1.4520              0.4107 -0.2090   +            +                  8 -125.092 266.8  1.46  0.077
#40  -1.7640 -0.3592      0.5053 -0.4850                +                  8 -125.337 267.3  1.95  0.060
#59  -1.3770              0.4084           +  0.04898   +                  8 -125.413 267.5  2.10  0.056
#60  -1.4140 -0.2915      0.4445           +  0.04968   +                  9 -124.387 267.6  2.21  0.053
#39  -1.7780              0.4685 -0.5242                +                  7 -126.905 268.3  2.94  0.037
#41  -1.5380                               +            +                  6 -127.992 268.4  3.00  0.036
#63  -1.4370              0.4111 -0.2260   + -0.04078   +                  9 -125.080 269.0  3.60  0.027
#64  -1.4780 -0.2980      0.4494 -0.2415   + -0.04485   +                 10 -123.994 269.0  3.61  0.026
#42  -1.5860 -0.2322                       +            +                  7 -127.331 269.2  3.80  0.024
#56  -1.7800 -0.3527      0.4971 -0.4105      0.11540   +                  9 -125.232 269.3  3.90  0.023
#52  -1.7960 -0.3598      0.5000              0.38950   +                  8 -126.521 269.7  4.32  0.019
#45  -1.6360                     -0.2002   +            +                  7 -127.679 269.8  4.49  0.017
#55  -1.7970              0.4586 -0.4213      0.15590   +                  8 -126.720 270.1  4.72  0.015
#57  -1.5750                               +  0.06399   +                  7 -127.959 270.4  5.05  0.013
#51  -1.8170              0.4624              0.44330   +                  7 -128.000 270.5  5.14  0.012
#46  -1.6890 -0.2387             -0.2118   +            +                  8 -126.977 270.6  5.23  0.012
#128 -1.5830 -0.3393      0.4594 -0.3648   + -0.14790   +        -0.18340 11 -123.771 270.7  5.36  0.011 <-- full model
plot(allEffects(MOD))



# additional code to visualize MOD data
plot(simulationOutput)
hist(simulationOutput)
testResiduals(simulationOutput)
plotResiduals(simulationOutput, height_jan_surv_may_2019$species) # you're looking for flat red line
plotResiduals(simulationOutput, height_jan_surv_may_2019$site) # 

# The testDispersion() function gives us a histogram of simulated expected values, and then a red line indicating our observed dispersion in our actual data. Additionally, this function performs a statistical test of our dispersion with the null hypothesis being “We do not have overdispersion”. 
# dispersion = 1.0114, p-value = 0.808

plot(residuals(MOD))
binned_residuals(MOD)
# Warning: About 80% of the residuals are inside the error bounds (~95% or higher would be good).
plot(allEffects(MOD))
r2(MOD)
# Conditional: R2 like a line
# Marginal R2: takes into account only fixed effects without random effects

#visualize alive data by random effect 
dotplot(ranef(MOD, condVar = T)) #condVar adds 95% confidence intervals around random effects estimates

# visualize data by plotting alive by random effect 
random.intercepts = ranef(MOD)$plot_number[["(Intercept)"]] # create vector of random intercepts by pulling them from model
plot.intercepts = fixef(MOD)[1] + random.intercepts # create intercepts estimates by adding effects together

```

```{r nov 2019 glmer dredge and more models sandbox, include=TRUE}

# mafacover is the best model
glme.nov2019.best <- glmer(as.factor(nov_alive) ~ mafacover + species + may_volume_cm3 + site + (1|plot_number), 
                         family = binomial, 
                         data = height_may_surv_nov_2019, na.action = "na.fail")
summary(glme.nov2019.best)
# AIC: 259.6  
#Fixed effects:
#               Estimate Std. Error z value Pr(>|z|)   
#(Intercept)     -1.5610     0.4965  -3.144  0.00167 **
#mafacover        0.5311     0.1941   2.736  0.00623 ** <-- mafacover
#speciesHEAR      1.2967     0.5573   2.326  0.01999 *  <-- spp
#speciesRHOV     -0.1623     0.6446  -0.252  0.80123   
#speciesSAAP      1.7256     0.5715   3.019  0.00253 ** <-- spp
#may_volume_cm3   0.3512     0.1891   1.857  0.06334 . 
#site2           -0.8247     0.3939  -2.094  0.03628 * <-- site
#Correlation of Fixed Effects:
#            (Intr) mafcvr spHEAR spRHOV spSAAP my_v_3
#mafacover   -0.249                                   
#speciesHEAR -0.840  0.102                            
#speciesRHOV -0.660  0.002  0.571                     
#speciesSAAP -0.821  0.148  _0.782_  0.560            <-- collinearity between SAAP and HEAR... driven by similar conditions?           
#may_vlm_cm3  0.167 -0.054 -0.309  0.047 -0.239       
#site2       -0.167  0.299 -0.112  0.036 -0.156  0.122

glme.nov2019.notbest <- glmer(as.factor(nov_alive) ~ mafacover + species + site + (1|plot_number), 
                         family = binomial, 
                         data = height_may_surv_nov_2019, na.action = "na.fail")
summary(glme.nov2019.notbest)
# AIC:  261.6
#Fixed effects:
#            Estimate Std. Error z value Pr(>|z|)    
#(Intercept)  -1.7301     0.4904  -3.528 0.000419 ***
#mafacover     0.5608     0.1910   2.936 0.003328 ** <-- mafacover
#speciesHEAR   1.6341     0.5308   3.079 0.002079 ** <-- species
#speciesRHOV  -0.2156     0.6450  -0.334 0.738191    
#speciesSAAP   2.0424     0.5528   3.694 0.000220 *** <-- species
#site2        -0.9443     0.3861  -2.446 0.014448 *  <-- site
#Correlation of Fixed Effects:
#            (Intr) mafcvr spHEAR spRHOV spSAAP
#mafacover   -0.248                            
#speciesHEAR -0.844  0.097                     
#speciesRHOV -0.678  0.007  0.617              
#speciesSAAP -0.824  0.148  _0.773_  0.593            <-- collinearity between SAAP and HEAR... driven by similar conditions?         
#site2       -0.182  0.300 -0.079  0.031 -0.136

MOD <- glme.nov2019.best 

simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput)
plot(simulationOutput)
hist(simulationOutput)
testResiduals(simulationOutput)
plotResiduals(simulationOutput, height_may_surv_nov_2019$species) # you're looking for flat red line
plotResiduals(simulationOutput, height_may_surv_nov_2019$site) # 

# The testDispersion() function gives us a histogram of simulated expected values, and then a red line indicating our observed dispersion in our actual data. Additionally, this function performs a statistical test of our dispersion with the null hypothesis being “We do not have overdispersion”. 
# dispersion = 1.0114, p-value = 0.808

plot(residuals(MOD))
binned_residuals(MOD)
# Warning: About 80% of the residuals are inside the error bounds (~95% or higher would be good).
plot(allEffects(MOD))
r2(MOD)
#Conditional R2: 0.322
#     Marginal R2: 0.304
dredge(glme.nov2019.best)
#Model selection table 
#     (Int)    mfc may_vlm_cm3 sit spc df   logLik  AICc delta weight
#16 -1.5610 0.5311      0.3512   +   +  8 -121.807 260.2  0.00  0.519 <-- already the best model
anova(glme.nov2019.best) # no p-values

# by mafacover
glmm_interactionNOV2019_mfcv <- glmer(factor(nov_alive) ~  mafacover + (1|plot_number),
                          family = binomial(link = "logit"),
                          data = height_may_surv_nov_2019)
summary(glmm_interactionNOV2019_mfcv)
#Fixed effects:
#            Estimate Std. Error z value Pr(>|z|)    
#(Intercept)  -0.7978     0.1638  -4.870 1.12e-06 ***
#mafacover     0.5743     0.1649   3.482 0.000498 ***
  
# by species
glmm_interactionNOV2019_spp <- glmer(factor(nov_alive) ~  species + (1|plot_number),
                          family = binomial(link = "logit"),
                          data = height_may_surv_nov_2019)
summary(glmm_interactionNOV2019_spp)
#Fixed effects:
#            Estimate Std. Error z value Pr(>|z|)    
#(Intercept)  -2.1274     0.5206  -4.086 4.38e-05 ***
#speciesHEAR   1.5930     0.5348   2.978 0.002897 ** 
#speciesRHOV  -0.1232     0.6485  -0.190 0.849366    
#speciesSAAP   1.9205     0.5578   3.443 0.000575 ***

# by site
glmm_interactionNOV2019_site <- glmer(factor(nov_alive) ~  site + (1|plot_number),
                          family = binomial(link = "logit"),
                          data = height_may_surv_nov_2019)
summary(glmm_interactionNOV2019_site)
#Fixed effects:
#            Estimate Std. Error z value Pr(>|z|)   
#(Intercept)  -0.4230     0.1962  -2.156  0.03108 * 
#site2        -0.9862     0.3490  -2.826  0.00471 **

# by volume
glmm_interactionNOV2019_vol <- glmer(factor(nov_alive) ~  may_volume_cm3 + (1|plot_number),
                          family = binomial(link = "logit"),
                          data = height_may_surv_nov_2019)
summary(glmm_interactionNOV2019_vol)
#Fixed effects:
#               Estimate Std. Error z value Pr(>|z|)    
#(Intercept)     -0.8253     0.1933  -4.270 1.95e-05 ***
#may_volume_cm3   0.7734     0.1865   4.146 3.38e-05 ***
```

### F4. November 2019 glmer models - survival by species

```{r nov 2019 summary survival by species, include = TRUE}

print(height_may_surv_nov_2019_notransf %>%  
  group_by(species, site) %>% 
  summarise(N_May2019 = length(nov_alive), 
            total_survived_NOV2019 = sum(nov_alive == "1"), 
            total_died = sum(nov_alive == "0"),
            percent_survived = 100*(sum(nov_alive == "1")/length(nov_alive))))

```


```{r nov 2019 glmer by species CEOL, include=TRUE}

# par and nn cover - original glmer
glme.nov2019.mod1_ceol <- glmer(as.factor(nov_alive) ~ normalized_par + exotic_percentcover + site + may_volume_cm3  
                             + (1|plot_number), 
                         family = binomial(link = "logit"), 
                         data = (height_may_surv_nov_2019 %>% filter(species == "CEOL")), na.action = "na.fail")
# Warning:  Hessian is numerically singular: parameters are not uniquely determined
# most CEOL die so it's not easy for the model to predict what lives. 
view(height_may_surv_nov_2019 %>% filter(species == "CEOL"))

MOD <- glme.nov2019.mod1_ceol 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) # follows binomial distribution

summary(glme.nov2019.mod1_ceol)
#Fixed effects:
#                     Estimate Std. Error z value Pr(>|z|)
#(Intercept)           -1.8324     1.3895  -1.319    0.187
#normalized_par        -1.3809     1.3576  -1.017    0.309
#exotic_percentcover   -0.3674     0.7910  -0.464    0.642
#site2                -20.0969  2048.0003  -0.010    0.992
#may_volume_cm3         0.7887     1.4961   0.527    0.598
anova(glme.nov2019.mod1_ceol)
#Analysis of Variance Table
#                    npar  Sum Sq Mean Sq F value
#normalized_par         1 1.33845 1.33845  1.3384
#exotic_percentcover    1 0.12709 0.12709  0.1271
#site                   1 0.00000 0.00000  0.0000
#may_volume_cm3         1 0.29739 0.29739  0.2974

# plot 0-1
glme.nov2019.mod1_ceol.scatter <- ggplot(data = height_may_surv_nov_2019 %>%  filter (species == "CEOL"), 
                       aes(x = normalized_par, y = nov_alive, col = normalized_par)) +
  geom_point(aes(color = normalized_par)) +
  geom_jitter(width = 0.0, height = 0.0) +
  theme_classic()
glme.nov2019.mod1_ceol.scatter


# site 1 only with par and nncover
glme.nov2019.mod1_ceol_site1 <- glmer(as.factor(nov_alive) ~ normalized_par + exotic_percentcover + may_volume_cm3  
                             + (1|plot_number), 
                         family = binomial(link = "logit"), 
                         data = (height_may_surv_nov_2019 %>% filter(species == "CEOL")) %>%  filter(site == "1"), na.action = "na.fail")

MOD <- glme.nov2019.mod1_ceol_site1 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) # follows binomial distribution

anova(glme.nov2019.mod1_ceol_site1)
summary(glme.nov2019.mod1_ceol_site1)
#Fixed effects:
#                    Estimate Std. Error z value Pr(>|z|)
#(Intercept)          -1.8324     1.3895  -1.319    0.187
#normalized_par       -1.3809     1.3576  -1.017    0.309
#exotic_percentcover  -0.3674     0.7910  -0.464    0.642
#may_volume_cm3        0.7887     1.4961   0.527    0.598


# CEOL x mafacover <-- Warning: unable to evaluate scaled gradientWarning:  Hessian is numerically singular: parameters are not uniquely determined
nov2019.modcover_CEOL<- height_may_surv_nov_2019 %>% filter(species == "CEOL")
glme.nov2019.modcover_CEOL <- glmer(as.factor(nov_alive) ~ mafacover + site + may_volume_cm3  + (1|plot_number), # and with treatment
                         family = binomial, 
                         data = nov2019.modcover_CEOL, na.action = "na.fail")

glme.nov2019.mod1_ceol_cover <- glmer(as.factor(nov_alive) ~ mafacover    + may_volume_cm3  
                             + (1|plot_number), 
                         family = binomial(link = "logit"), 
                         data = (height_may_surv_nov_2019 %>% filter(species == "CEOL")) %>%  filter(site == "1"), na.action = "na.fail")
summary(glme.nov2019.mod1_ceol_cover)

glme.nov2019.mod1_ceol_treat <- glmer(as.factor(nov_alive) ~ treatment    + may_volume_cm3  
                             + (1|plot_number), 
                         family = binomial(link = "logit"), 
                         data = (height_may_surv_nov_2019 %>% filter(species == "CEOL")) %>%  filter(site == "1"), na.action = "na.fail")
summary(glme.nov2019.mod1_ceol_cover)

```

```{r nov 2019 glmer by species HEAR, include=TRUE}


view(height_may_surv_nov_2019 %>% filter(species == "HEAR"))
glimpse(height_may_surv_nov_2019)

height_may_surv_nov_2019_HEAR <- height_may_surv_nov_2019 %>% filter(species == "HEAR")

glme.nov2019.mod1_HEAR <- glmer(as.factor(nov_alive) ~ normalized_par + exotic_percentcover + site + may_volume_cm3  
                             + (1|plot_number), 
                         family = binomial, 
                         data = height_may_surv_nov_2019_HEAR, na.action = "na.fail")


dredge(glme.nov2019.mod1_HEAR)


MOD <- glme.nov2019.mod1_HEAR 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) # follows binomial distribution

anova(glme.nov2019.mod1_HEAR)
#Analysis of Variance Table
#                    npar Sum Sq Mean Sq F value
#normalized_par         1 5.6310  5.6310  5.6310
#exotic_percentcover    1 0.1891  0.1891  0.1891
#site                   1 1.3548  1.3548  1.3548
#may_volume_cm3         1 2.9665  2.9665  2.9665

summary(glme.nov2019.mod1_HEAR)
#Fixed effects:
#                    Estimate Std. Error z value Pr(>|z|)  
#(Intercept)          -0.5497     0.5430  -1.012   0.3114  
#normalized_par       -0.6535     0.4629  -1.412   0.1580  
#exotic_percentcover  -0.2429     0.3827  -0.635   0.5256  
#site2                -0.7217     0.9611  -0.751   0.4527  
#may_volume_cm3        0.6435     0.3852   1.671   0.0948 .


# MAFA cover x HEAR
nov2019.modcover_HEAR <- height_may_surv_nov_2019 %>% filter(species == "HEAR")
glme.nov2019.modcover_HEAR <- glmer(as.factor(nov_alive) ~ mafacover + site + may_volume_cm3  + (1|plot_number), 
                         family = binomial, 
                         data = nov2019.modcover_HEAR, na.action = "na.fail")
anova(glme.nov2019.modcover_HEAR)
summary(glme.nov2019.modcover_HEAR)
# 
#Fixed effects:
#               Estimate Std. Error z value Pr(>|z|)  
#(Intercept)     -0.4151     0.4889  -0.849   0.3959  
#mafacover        0.8711     0.4317   2.018   0.0436 * <--mafacover predicts HEAR survival
#site2           -1.0359     0.8123  -1.275   0.2022  
#may_volume_cm3   0.4880     0.3741   1.305   0.1920  
#---
#Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
#Correlation of Fixed Effects:
#            (Intr) mafcvr site2 
#mafacover   -0.357              
#site2       -0.563  0.212       
#may_vlm_cm3 -0.339  0.004  0.062


# scatter
glme.nov2019.mod1_HEAR.scatter <- ggplot(data = height_may_surv_nov_2019 %>%  filter(species == "HEAR"), 
                       aes(x = normalized_par, y = nov_alive, col = normalized_par)) +
  geom_point(aes(color = normalized_par)) +
  geom_jitter(width = 0.0, height = 0.0) +
  theme_classic()
glme.nov2019.mod1_HEAR.scatter

# with mafacover 
glme.nov2019.mod1_HEAR_cover <- glmer(as.factor(nov_alive) ~ mafacover  +normalized_par + exotic_percentcover + site + may_volume_cm3  
                             + (1|plot_number), 
                         family = binomial(link = "logit"), 
                         data = (height_may_surv_nov_2019 %>% filter(species == "HEAR")), na.action = "na.fail")
summary(glme.nov2019.mod1_HEAR_cover)

# with treatment 
glme.nov2019.mod1_HEAR_treat <- glmer(as.factor(nov_alive) ~ treatment  +normalized_par + exotic_percentcover + may_volume_cm3  
                             + (1|plot_number), 
                         family = binomial(link = "logit"), 
                         data = (height_may_surv_nov_2019 %>% filter(species == "HEAR") %>%  filter(site =="1")), na.action = "na.fail")
summary(glme.nov2019.mod1_HEAR_treat)

# with treatment and mafa cover
glme.nov2019.mod1_HEAR_treat_site1 <- glmer(as.factor(nov_alive) ~ treatment  +normalized_par + exotic_percentcover  + may_volume_cm3  
                             + (1|plot_number), 
                         family = binomial(link = "logit"), 
                         data = (height_may_surv_nov_2019 %>% filter(species == "HEAR") %>%  filter(site == "1")), na.action = "na.fail")
summary(glme.nov2019.mod1_HEAR_treat_site1)


# survival in May-Nov 2019 - for HEAR 
HEAR_survivalNov2019 <- height_may_surv_nov_2019_notransf %>%  
        filter(year == "2019" & species == "HEAR") %>%  
  group_by(site, treatment) %>% 
  summarise(N = length(nov_alive), 
            mean_survival = mean(nov_alive),
            total_survived = sum(nov_alive == "1"), 
            total_died = sum(nov_alive == "0"),
            percent_survived = 100*(sum(nov_alive == "1")/length(nov_alive)))

summary(aov(nov_alive ~ treatment, data = height_may_surv_nov_2019_notransf %>% 
              filter(year == "2019" & species == "HEAR")))
TukeyHSD(aov(nov_alive ~ treatment, data = height_may_surv_nov_2019_notransf %>% 
              filter(year == "2019" & species == "HEAR")))
#$treatment
#                 diff         lwr         upr     p adj
#half-full  0.36813187  0.06230787  0.67395587 0.0142108 <--
#none-full  0.01058201 -0.29229117  0.31345519 0.9961657
#none-half -0.35754986 -0.66608863 -0.04901108 0.0190451 <--

summary(aov(nov_alive ~ treatment, data = height_may_surv_nov_2019_notransf %>% 
              filter(year == "2019" & species == "HEAR" &  site == "1")))
TukeyHSD(aov(nov_alive ~ treatment, data = height_may_surv_nov_2019_notransf %>% 
              filter(year == "2019" & species == "HEAR" &  site == "1")))
#$treatment
#                diff         lwr        upr     p adj
#half-full  0.3529412 -0.02731465  0.7331970 0.0738002
#none-full -0.2039216 -0.59664810  0.1888050 0.4261472
#none-half -0.5568627 -0.94958927 -0.1641362 0.0035684 <-- 

summary(aov(nov_alive ~ treatment, data = height_may_surv_nov_2019_notransf))
TukeyHSD(aov(nov_alive ~ treatment, data = height_may_surv_nov_2019_notransf))


```



```{r nov 2019 glmer by species RHOV, include=TRUE}
glme.nov2019.mod1_rhov <- glmer(as.factor(nov_alive) ~ normalized_par + exotic_percentcover + site + may_volume_cm3  
                             + (1|plot_number), 
                         family = binomial(link = "logit"), 
                         data = (height_may_surv_nov_2019 %>% filter(species == "RHOV")), na.action = "na.fail")
# boundary (singular) fit: see help('isSingular')
view(height_may_surv_nov_2019 %>% filter(species == "RHOV"))

MOD <- glme.nov2019.mod1_rhov 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) # follows binomial distribution

anova(glme.nov2019.mod1_rhov)
#Analysis of Variance Table
#                    npar  Sum Sq Mean Sq F value
#normalized_par         1 0.55950 0.55950  0.5595
#exotic_percentcover    1 0.45509 0.45509  0.4551
#site                   1 0.00000 0.00000  0.0000
#may_volume_cm3         1 2.75012 2.75012  2.7501

summary(glme.nov2019.mod1_rhov)
#Fixed effects:
#                     Estimate Std. Error z value Pr(>|z|)
#(Intercept)           -1.8324     1.3895  -1.319    0.187
#normalized_par        -1.3809     1.3576  -1.017    0.309
#exotic_percentcover   -0.3674     0.7910  -0.464    0.642
#site2                -20.0969  2048.0003  -0.010    0.992
#may_volume_cm3         0.7887     1.4961   0.527    0.598

# RHOV x mafacover <-- boundary (singular) fit: see help('isSingular')
nov2019.modcover_RHOV<- height_may_surv_nov_2019 %>% filter(species == "RHOV")
glme.nov2019.modcover_RHOV <- glmer(as.factor(nov_alive) ~ mafacover + site + may_volume_cm3  + (1|plot_number), # and with treatment
                         family = binomial, 
                         data = nov2019.modcover_RHOV, na.action = "na.fail")

glme.nov2019.mod1_rhov.scatter <- ggplot(data = height_may_surv_nov_2019 %>%  filter(species == "RHOV"), 
                       aes(x = normalized_par, y = nov_alive, col = normalized_par)) +
  geom_point(aes(color = normalized_par)) +
  geom_jitter(width = 0.0, height = 0.0) +
  theme_classic()
glme.nov2019.mod1_rhov.scatter

print(height_may_surv_nov_2019_notransf %>%  
  group_by(species, site) %>% 
  summarise(N_May2019 = length(nov_alive), 
            total_survived_NOV2019 = sum(nov_alive == "1"), 
            total_died = sum(nov_alive == "0"),
            percent_survived = 100*(sum(nov_alive == "1")/length(nov_alive))))
```

```{r nov 2019 glmer by species SAAP, include=TRUE}
glme.nov2019.mod1_SAAP <- glmer(as.factor(nov_alive) ~ normalized_par + exotic_percentcover + site + may_volume_cm3  
                             + (1|plot_number), 
                         family = binomial(link = "logit"), 
                         data = (height_may_surv_nov_2019 %>% filter(species == "SAAP")), na.action = "na.fail")
# boundary (singular) fit: see help('isSingular')

lm(as.factor(nov_alive) ~ may_volume_cm3,   nov2019.modcover_SAAP, na.action = "na.fail")
#Coefficients:
#   (Intercept)  may_volume_cm3  
#       1.43068         0.09043  

view(height_may_surv_nov_2019 %>% filter(species == "SAAP"))

MOD <- glme.nov2019.mod1_SAAP 
simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput) # follows binomial distribution

anova(glme.nov2019.mod1_SAAP)
#Analysis of Variance Table
#                    npar  Sum Sq Mean Sq F value
#normalized_par         1 1.03272 1.03272  1.0327
#exotic_percentcover    1 0.86853 0.86853  0.8685
#site                   1 2.09376 2.09376  2.0938
#may_volume_cm3         1 2.36168 2.36168  2.3617

summary(glme.nov2019.mod1_SAAP)
#Fixed effects:
#                    Estimate Std. Error z value Pr(>|z|)
#(Intercept)          0.08400    0.39132   0.215    0.830
#normalized_par       0.08197    0.32029   0.256    0.798
#exotic_percentcover -0.28751    0.28713  -1.001    0.317
#site2               -0.79546    0.68135  -1.167    0.243
#may_volume_cm3       0.34217    0.22266   1.537    0.124



# MAFA cover x SAAP <-- boundary (singular) fit: see help('isSingular')
nov2019.modcover_SAAP <- height_may_surv_nov_2019 %>% filter(species == "SAAP")
glme.nov2019.modcover_SAAP <- glmer(as.factor(nov_alive) ~ mafacover + site + may_volume_cm3  + (1|plot_number), 
                         family = binomial, 
                         data = nov2019.modcover_SAAP, na.action = "na.fail") 

summary(glme.nov2019.modcover_SAAP)
#Fixed effects:
#               Estimate Std. Error z value Pr(>|z|)
#(Intercept)     0.04697    0.35986   0.131    0.896
#mafacover       0.14254    0.27422   0.520    0.603
#site2          -0.61560    0.55740  -1.104    0.269
#may_volume_cm3  0.31331    0.22240   1.409    0.159

#Correlation of Fixed Effects:
#            (Intr) mafcvr site2 
#mafacover   -0.131              
#site2       -0.696  0.333       
#may_vlm_cm3 -0.267 -0.170  0.191
#optimizer (Nelder_Mead) convergence code: 0 (OK)
#boundary (singular) fit: see help('isSingular')

# treatment x SAAP <-- boundary (singular) fit: see help('isSingular')
glme.nov2019.modtreat_SAAP <- glmer(as.factor(nov_alive) ~ treatment + site + may_volume_cm3  + (1|plot_number), 
                         family = binomial, 
                         data = nov2019.modcover_SAAP, na.action = "na.fail") 
summary(glme.nov2019.modtreat_SAAP)

glme.nov2019.mod1_SAAP.scatter <- ggplot(data = height_may_surv_nov_2019 %>%  filter(species == "SAAP"), 
                       aes(x = normalized_par, y = nov_alive, col = normalized_par)) +
  geom_point(aes(color = normalized_par)) +
  geom_jitter(width = 0.0, height = 0.0) +
  theme_classic()
glme.nov2019.mod1_SAAP.scatter

# SAAP sandbox... nothing is ever significant. Survival is driven by "luck"
glme.nov2019.mod1_SAAP_cover <- glmer(as.factor(nov_alive) ~ mafacover +treatment + normalized_par + exotic_percentcover + site + may_volume_cm3  
                             + (1|plot_number) , 
                         family = binomial(link = "logit"), 
                         data = (height_may_surv_nov_2019 %>% filter(species == "SAAP")), na.action = "na.fail")

summary(glme.nov2019.mod1_SAAP_cover)
ggplot(height_may_surv_nov_2019,aes(x=nov_alive,y=may_vol,col=treatment)) + geom_jitter() + geom_boxplot(alpha=0.2) + facet_wrap(~treatment)


# with mafacover - Site 1
glme.nov2019.mod1_SAAP_cover <- glmer(as.factor(nov_alive) ~ mafacover  +normalized_par + exotic_percentcover  + may_volume_cm3  
                             + (1|plot_number), 
                         family = binomial(link = "logit"), 
                         data = (height_may_surv_nov_2019 %>% filter(species == "SAAP") %>%  filter(site =="1")), na.action = "na.fail")
summary(glme.nov2019.mod1_SAAP_cover)

# with treatment 
glme.nov2019.mod1_SAAP_treat <- glmer(as.factor(nov_alive) ~ treatment  +normalized_par + exotic_percentcover + may_volume_cm3  
                             + (1|plot_number), 
                         family = binomial(link = "logit"), 
                         data = (height_may_surv_nov_2019 %>% filter(species == "SAAP") %>%  filter(site =="1")), na.action = "na.fail")
summary(glme.nov2019.mod1_SAAP_treat)

# with treatment and mafa cover
glme.nov2019.mod1_SAAP_treat_site1 <- glmer(as.factor(nov_alive) ~ treatment  +normalized_par + exotic_percentcover  + may_volume_cm3  
                             + (1|plot_number), 
                         family = binomial(link = "logit"), 
                         data = (height_may_surv_nov_2019 %>% filter(species == "SAAP") %>%  filter(site == "1")), na.action = "na.fail")
summary(glme.nov2019.mod1_SAAP_treat_site1)


# survival in May-Nov 2019 - for SAAP 
height_may_surv_nov_2019_notransf %>%  
        filter(year == "2019" & species == "SAAP") %>%  
  group_by(site) %>% 
  summarise(N = length(nov_alive), 
            mean_survival = mean(nov_alive),
            total_survived = sum(nov_alive == "1"), 
            total_died = sum(nov_alive == "0"),
            percent_survived = 100*(sum(nov_alive == "1")/length(nov_alive)))

summary(aov(nov_alive ~ treatment, data = height_may_surv_nov_2019_notransf %>% 
              filter(year == "2019" & species == "SAAP")))
summary(aov(nov_alive ~ treatment, data = height_may_surv_nov_2019_notransf %>% 
              filter(year == "2019" & species == "SAAP" &  site == "2")))
TukeyHSD(aov(nov_alive ~ treatment, data = height_may_surv_nov_2019_notransf %>% 
              filter(year == "2019" & species == "SAAP")))


summary(aov(nov_alive ~ treatment, data = height_may_surv_nov_2019_notransf))
TukeyHSD(aov(nov_alive ~ treatment, data = height_may_surv_nov_2019_notransf))
```


# G. May - September 2019

## G1. September 2019 Predictions

```{r september 2019 predictions, include=FALSE}
print(glme.sep2019.mod)
summary(glme.sep2019.mod)

exotic_site1_2019 <- seq(from = -2.2, to = 2.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(exotic_percentcover = ".") %>% 
  mutate(normalized_par = 0,
         soil_moisture = 0, 
         site = "1",
         may_stem_height_cm = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(glme.sep2019.mod, newdata = ., type = "response"))

exotic_site2_2019 <- seq(from = -2.2, to = 2.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(exotic_percentcover = ".") %>% 
  mutate(normalized_par = 0,
         soil_moisture = 0, 
         site = "2",
         may_stem_height_cm = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(glme.sep2019.mod, newdata = ., type = "response"))

exotic_site1_plot_2019 <- ggplot() +
  geom_point(data = height_may_surv_sep_2019 %>%  filter(site == "1"), aes(x = exotic_percentcover, y = sep_alive), alpha = 0.25)+
  geom_line(data = exotic_site1_2019, aes(x= exotic_percentcover, y = alive), linewidth = 1)+
  theme_classic() +
  labs(title = "Site 1",
       x = "Exotic Percent Cover",
       y = "Survival Probability")

exotic_site2_plot_2019 <- ggplot() +
  geom_point(data = height_may_surv_sep_2019 %>%  filter(site == "2"), aes(x = exotic_percentcover, y = sep_alive), alpha = 0.25)+
  geom_line(data = exotic_site2_2019, aes(x= exotic_percentcover, y = alive), linewidth = 1)+
  theme_classic() +
  labs(title = "Site 2",
       x = "Exotic Percent Cover",
       y = "Survival Probability")

exotic_site1_plot_2019 + exotic_site2_plot_2019

height_site1_2019 <- seq(from = -1.6, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(may_stem_height_cm = ".") %>% 
  mutate(normalized_par = 0, 
         soil_moisture = 0,
         exotic_percentcover = 0,
         site = "1",
         plot_number = 1) %>% 
  mutate(alive = predict(glme.sep2019.mod, newdata = ., type = "response"))

height_site2_2019 <- seq(from = -1.6, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(may_stem_height_cm = ".") %>% 
  mutate(normalized_par = 0, 
         soil_moisture = 0,
         exotic_percentcover = 0,
         site = "2",
         plot_number = 1) %>% 
  mutate(alive = predict(glme.sep2019.mod, newdata = ., type = "response"))

height_site1_plot_2019 <- ggplot()+
  geom_point(data = height_may_surv_sep_2019 %>%  filter(site == "1"), aes(x = may_stem_height_cm, y = sep_alive), alpha = 0.25) +
  geom_line(data = height_site1_2019, aes(x = may_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(title = "Site 1",
       x = "Stem Height (cm)",
       y = "Survival Probability")

height_site2_plot_2019 <- ggplot()+
  geom_point(data = height_may_surv_sep_2019 %>%  filter(site == "2"), aes(x = may_stem_height_cm, y = sep_alive), alpha = 0.25) +
  geom_line(data = height_site2_2019, aes(x = may_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(title = "Site 2",
       x = "Stem Height (cm)",
       y = "Survival Probability")

height_site1_plot_2019 + height_site2_plot_2019

```

## G2. September 2019 Predictions by species

### CEOL 

```{r predictions sept 2019 ceol}
ceol_2019_sep <- height_may_surv_sep_2019 %>% 
  filter(species == "CEOL")
  
AIC(glmer(as.factor(sep_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + normalized_par + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

ceol_2019_sep_model <- glmer(as.factor(sep_alive) ~ soil_moisture + (1|plot_number), 
          family = binomial,
          data = ceol_2019_sep)

summary(ceol_2019_sep_model)

ceol_moisture_2019 <- seq(from = -1.7, to = 1.7, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = 1) %>% 
  mutate(alive = predict(ceol_2019_sep_model, newdata = ., type = "response"))

ggplot()+
  geom_point(data = ceol_2019_sep, aes(x = soil_moisture, y = sep_alive), alpha = 0.25) +
  geom_line(data = ceol_moisture_2019, aes(x = soil_moisture, y = alive), linewidth = 1)+
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability")

``` 

### RHOV

```{r predictions sept 2019 rhov} 
rhov_2019_sep <- height_may_surv_sep_2019 %>% 
  filter(species == "RHOV")

AIC(glmer(as.factor(sep_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + normalized_par +(1|plot_number), 
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + soil_moisture + (1|plot_number), 
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + (1|plot_number), 
          family = binomial,
          data = rhov_2019_sep))

rhov_2019_sep_model <- glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = rhov_2019)
summary(rhov_2019_sep_model)
```

### HEAR

```{r predictions sept 2019 hear}
hear_2019_sep <- height_may_surv_sep_2019 %>% 
  filter(species == "HEAR")

AIC(glmer(as.factor(sep_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ normalized_par + site + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + exotic_percentcover + soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + exotic_percentcover + normalized_par + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + exotic_percentcover + may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

hear_2019_sep_model <- glmer(as.factor(sep_alive) ~ site + exotic_percentcover + (1|plot_number), 
                         family = binomial,
                         data = hear_2019_sep)

summary(hear_2019_sep_model)

hear_exotic_site1_2019 <- seq(from = -2.2, to = 2.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(exotic_percentcover = ".") %>% 
  mutate(site = "1",
         plot_number = 1) %>% 
  mutate(alive = predict(hear_2019_sep_model, newdata = ., type = "response"))

hear_exotic_site2_2019 <- seq(from = -2.2, to = 2.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(exotic_percentcover = ".") %>% 
  mutate(site = "2",
         plot_number = 1) %>% 
  mutate(alive = predict(hear_2019_sep_model, newdata = ., type = "response"))

hear_exotic_site1_plot_2019 <- ggplot()+
  geom_point(data = hear_2019_sep %>% filter(site == "1"), aes(x = exotic_percentcover, y = sep_alive), alpha = 0.5) +
  geom_line(data = hear_exotic_site1_2019, aes(x = exotic_percentcover, y = alive), linewidth = 1) +
  theme_classic() +
  labs(title = "Site 1",
       x = "Exotic Percent Cover",
       y = "Survival Probability")

hear_exotic_site2_plot_2019 <- ggplot()+
  geom_point(data = hear_2019_sep %>% filter(site == "2"), aes(x = exotic_percentcover, y = sep_alive), alpha = 0.5) +
  geom_line(data = hear_exotic_site2_2019, aes(x = exotic_percentcover, y = alive), linewidth = 1) +
  theme_classic() +
  labs(title = "Site 2",
       x = "Exotic Percent Cover",
       y = "Survival Probability")

hear_exotic_site1_plot_2019 + hear_exotic_site2_plot_2019

```

### SAAP

```{r predictions sept 2019 saap}
saap_2019_sep <- height_may_surv_sep_2019 %>%
  filter(species == "SAAP")

AIC(glmer(as.factor(sep_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~  + (1|plot_number),
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + normalized_par + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + soil_moisture + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + normalized_par + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + soil_moisture + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + normalized_par + soil_moisture + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + normalized_par + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

saap_2019_sep_model <- glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + normalized_par + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep)

summary(saap_2019_sep_model)

saap_height_site1_2019 <- seq(from = -1.4, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(may_stem_height_cm = ".") %>% 
  mutate(site = "1",
         normalized_par = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(saap_2019_sep_model, newdata = ., type = "response"))

saap_height_site2_2019 <- seq(from = -1.4, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(may_stem_height_cm = ".") %>% 
  mutate(site = "2",
         normalized_par = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(saap_2019_sep_model, newdata = ., type = "response"))


saap_height_site1_plot_2019 <- ggplot()+
  geom_point(data = saap_2019_sep %>% filter(site == "1"), aes(x = may_stem_height_cm, y = sep_alive), alpha = 0.5) +
  geom_line(data = saap_height_site1_2019, aes(x = may_stem_height_cm, y = alive), linewidth = 1) +
  theme_classic()+
  labs(title = "Site 1",
       x = "Stem Height (cm)",
       y = "Survival Probability")

saap_height_site2_plot_2019 <- ggplot()+
  geom_point(data = saap_2019_sep %>% filter(site == "2"), aes(x = may_stem_height_cm, y = sep_alive), alpha = 0.5) +
  geom_line(data = saap_height_site2_2019, aes(x = may_stem_height_cm, y = alive), linewidth = 1) +
  theme_classic()+
  labs(title = "Site 2",
       x = "Stem Height (cm)",
       y = "Survival Probability")

saap_height_site1_plot_2019 + saap_height_site2_plot_2019

saap_par_site1_2019 <- seq(from = -1.7, to = 2.3, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(site = "1",
         may_stem_height_cm = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(saap_2019_sep_model, newdata = ., type = "response"))

saap_par_site2_2019 <- seq(from = -1.7, to = 2.3, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(site = "2",
         may_stem_height_cm = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(saap_2019_sep_model, newdata = ., type = "response"))


saap_par_site1_plot_2019 <- ggplot()+
  geom_point(data = saap_2019_sep %>% filter(site == "1"), aes(x = normalized_par, y = sep_alive), alpha = 0.5) +
  geom_line(data = saap_par_site1_2019, aes(x = normalized_par, y = alive), linewidth = 1) +
  theme_classic()+
  labs(title = "Site 1",
       x = "Normalized PAR",
       y = "Survival Probability")

saap_par_site2_plot_2019 <- ggplot()+
  geom_point(data = saap_2019_sep %>% filter(site == "2"), aes(x = normalized_par, y = sep_alive), alpha = 0.5) +
  geom_line(data = saap_par_site2_2019, aes(x = normalized_par, y = alive), linewidth = 1) +
  theme_classic()+
  labs(title = "Site 2",
       x = "Normalized PAR",
       y = "Survival Probability")

saap_par_site1_plot_2019 + saap_par_site2_plot_2019
```
  
  