---
title: "Piru_enhancement_seedlingsurvival"
author: "Stephanie Ma Lucero"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load libraries, message=FALSE}
library(here) # similar to set working directory
library(dplyr) # includes functions:
library(tidyverse) # data wrangling, includes packages: ggplot2, tibble, tidyr, rear, purrr, stringr, forcats
library(lme4)
library(lmerTest)
library(DHARMa) #model diagnostics
library(performance)
library(emmeans) 
library(lubridate)
library(patchwork)
library(effects)
library(lattice)
library(MuMIn)
```

```{r colors for figures, include=TRUE}
devtools::install_github("an-bui/calecopal")

library(calecopal)
# all palettes
names(cal_palettes)

# Site colors: 1, 2 
cal_palette(name = "chaparral1", n = 5, type = "continuous") # [1] "#DCC27A" "#F19B34"
site1color <- "#DCC27A"
site2color <- "#F19B34"
site1outline <- "#9C8A58"
site2outline <- "#936126"
sitecolors <- c(site1color, site2color)

# Treatment colors: Full, half, none 
cal_palette(name = "chaparral3", n = 5, type = "continuous") # [1] "#D3E3CA", "#92A587", "#2F3525"
cal_palette(name = "desert", n = 5, type = "continuous") # [1] "#F6EECF", "#B09175", "#291611"
treatment1color <- "#F6EECF"
treatment2color <- "#B09175"
treatment3color <- "#291611"
treatmentcolors <- c(treatment1color, treatment2color, treatment3color)

```

# Question 2: How does seedling survival change with PAR, TDR, % nn cover, and species?

Notes:
* __response variable__: The variable you want to test. (e.g.,. PAR, TDR, nncover)
* __explanatory variables__: The variables that can explain the outcome. (e.g., treatment, mafacover, site)
* __data frame__: Include all the data you'll be working with. (e.g., combine par and mafa_cover_all)
* __formula__: a formula is a two-sided linear formula object describing both the _fixed-effects_ and _random effects_ part of the model, with the response on the left of a ~ operator and the terms, separated by + operators, on the right. 
* __random effects__: Random-effects terms are distinguished by vertical bars __(|)__ separating expressions for design matrices from grouping factors. Two vertical bars __(||)__ can be used to specify multiple uncorrelated random effects for the same grouping variable. 
  + Because of the way it is implemented, the ||-syntax works only for design matrices containing numeric (continuous) predictors; to fit models with independent categorical effects, see dummy or the lmer_alt function from the afex package.)
  
  

### Load PAR, TDR, and non-native percent cover data.

- Loaded csvs from the "Processed" data folder.
```{r load survival csv, include=TRUE}

# survival and mortality data
survmort_load <- read_csv("data/processed/survmort.csv",
                      col_types = cols(
                        year = col_character(),
                        month = col_character(), 
                        site = col_character(),
                        plot_number = col_character(), 
                        treatment = col_character(),
                        species = col_character(), 
                        alive = col_integer(),
                        dead = col_integer(), 
                        month_count = col_integer(),
                        transplanted = col_character()
                      )
                        )
# survival and mortality data WITH species
survmort <- survmort_load %>% 
  dplyr::select(year, month, plot_number, treatment, species, alive, dead, site, month_count, transplanted) # %>%  
#  mutate(treatment = recode(treatment, no = "none"))

# survival and mortality data WITHOUT species
survmortnospp <- survmort_load %>% 
  dplyr::select(year, month, plot_number, treatment, alive, dead, site, month_count, transplanted) %>% 
 # mutate(treatment = recode(treatment, no = "none")) %>% 
  group_by(year, month, site, plot_number, treatment, month_count, transplanted) %>% 
  summarize(totalsurvival = sum(alive), 
            totalmortality = sum(dead)) %>% 
  ungroup()
print(survmortnospp) # :) yay! it worked!

survmortnospp %>% # check number of data points
  group_by(year, treatment) %>% 
  summarise(N = length(totalsurvival))

```

```{r load height par tdr nncover csv, include=TRUE}

# loading in height data
height_raw <- read.csv(here("data", "survival_data.csv")) %>% 
  mutate(date = mdy(date)) %>%  #having R recognize date as a date
  mutate(plot_number = as.character(plot_number)) %>% 
  mutate(stem_height_cm = as.numeric(stem_height_cm)) %>% 
  mutate(width_1_cm = as.numeric(width_1_cm)) %>% 
  mutate(width_2_cm = as.numeric(width_2_cm))
# In 2018 - Plot 26 - 1 SAAP not planted - right blue
# In 2018 - Plot 36 - 1 SAAP not planted - right green

# Calculate the volume of the ellipsoid: V = (4/3) * pi * axis a * axis b * axis c
height_raw$volume_cm3 <- (4/3) * pi * (height_raw$stem_height_cm/2) * (height_raw$width_1_cm/2) * (height_raw$width_2_cm/2)

# PAR data
par_load <- read_csv("data/processed/par.csv",
  col_types = cols(
    date = col_character(),
    plot_number = col_character(),
    treatment = col_character(),
    year = col_character(),
    month = col_character(),
    site = col_character(),
    normalized_par = col_double()
    )
)

par <- par_load %>% 
  dplyr::select(year, month, site, plot_number, treatment, normalized_par)
print(par)

# TDR data
tdr_load <- read_csv("data/processed/tdr.csv",
  col_types = cols(
    plot_number = col_character(),
    treatment = col_character(),
    year = col_character(),
    month = col_character(),
    site = col_character(),
    soil_moisture = col_double()
    )
  )

tdr <- tdr_load %>% 
   dplyr::select(year, month, site, plot_number, treatment, soil_moisture)
print(tdr)  

# exotic percent cover
exotic_cover_all_load <- read_csv("data/processed/exotic_cover_all.csv",
  col_types = cols(
    date = col_character(),
    year = col_character(),
    site = col_character(),
    plot_number = col_character(),
    MAFA_removal = col_character(),
    cover_percent = col_double()
  )
)

exotic_cover_all <- exotic_cover_all_load %>% 
  dplyr::select(date, year, site, plot_number, MAFA_removal, cover_percent) %>% 
  rename(treatment = MAFA_removal)
print(exotic_cover_all)


#mafa_cover_all_load <- read_csv("data/processed/mafa_cover_all.csv",
#  col_types = cols(
#    plot_number = col_character(),
#    year = col_integer(),
#    cover_percent = col_double(),
#    site = col_integer()
#    )
#  )
#mafa_cover_all <- mafa_cover_all_load %>% 
#  select(plot_number, year, cover_percent, site) 
#print(mafa_cover_all)

```
  
***

# May 2018 

### Code to save for later on calculating survival rate or change between two time points. 

- RUN AFTER "SURVIVAL AT TIME POINTS" AND ONLY MAKE CODE IF IT'S NEEDED
  
```{r may 2018 rate of change wider df, include=TRUE}

# YOU DON'T NEED TO CALCULATE SURVIVAL RATE RIGHT NOW
# JUST RUN MODELS TO SEE WHAT MAKES A DIFFERENCE AT SURVEY TIME POINT. 
# YOU CAN ALWAYS GO BACK AND CALCULATE RATE ON YOUR SECOND PASS.
# 
# 
# t1 = mar 2018 - may 2018 <-- wet months / what we have
# t2 = jan 2019- may 2019 <-- wet months
# t3 = may 2019 - nov 2019 <-- dry months


# 
#survmortnospp_2018 <- survmortnospp %>% 
#  dplyr::filter(year == "2018") %>% 
#  dplyr::select(!totalmortality) %>% 
#  dplyr::select(!month_count)

#survmortnospp_2018_wider <- survmortnospp_2018 %>%
#  pivot_wider(names_from = month, values_from = totalsurvival) 
  
#view(survmortnospp_2018_wider)

# END OF CREATING A WIDER DF
```

```{r may 2018 filter environmental data, include=TRUE}

# par april 2018 
par_april2018 <- dplyr::filter(par, year == "2018" & month =="4") %>% 
  dplyr::select(site, plot_number, treatment, normalized_par) %>% 
  mutate(treatment = case_when(treatment == "no" ~ "none",
                               TRUE ~ treatment))

#tdr april 2018
tdr_april2018 <- tdr %>% dplyr::filter(year == "2018" & month =="4") %>%  
  dplyr::select(site, plot_number, treatment, soil_moisture)  %>% 
  mutate(treatment = case_when(treatment == "nonene" ~ "none",
                               TRUE ~ treatment))
tdr_april2018$site <- factor(tdr_april2018$site, levels = c("1", "2"))

# nncover may 2018
nncover_may2018 <- dplyr::filter(exotic_cover_all, year == "2018") %>% 
  #rename(treatment = MAFA_removal) %>% 
  dplyr::select(site, plot_number, treatment, cover_percent)

site_cond_2018 <- full_join(par_april2018, tdr_april2018, by = c("site", "plot_number", "treatment")) %>% 
  full_join(nncover_may2018, by = c("site", "plot_number", "treatment"))
glimpse(site_cond_2018)

write.csv(site_cond_2018, "data/processed/may2018_site_conditions.csv")
```

### How are site 1 and site 2 different? 

```{r may2018 site conditions ttest, include=TRUE}

#soil moisture 
t.test(soil_moisture~site, data = site_cond_2018) 
# YES sig diff
# data:  soil_moisture by site
# t = 5.0592, df = 33.993, p-value = 1.44e-05  <-- - soil moiture is sig diff by Site 
site_cond_2018 %>%  
  group_by(site) %>% 
  summarize(avg_tdr = mean(soil_moisture), 
            SD = sd(soil_moisture),
            N = length(soil_moisture), 
            SE = ((sd(soil_moisture))/sqrt(length((soil_moisture)))))
# site  mean   SD      N    SE
#1	9.603704	1.157126	18	0.2727371
#2	7.665741	1.141167	18	0.2689756

#norm_par
t.test(normalized_par~site, data = site_cond_2018) 
# not sig diff
# data:  normalized_par by site
# t = -1.2109, df = 29.972, p-value = 0.2354
site_cond_2018 %>%  
  group_by(site) %>% 
  summarize(avg_par = mean(normalized_par), 
            SD = sd(normalized_par),
            N = length(normalized_par), 
            SE = ((sd(normalized_par))/sqrt(length((normalized_par)))))
# site  mean   SD      N    SE
#1	0.3213315	0.1097804	18	0.02587548
#2	0.3770072	0.1612470	18	0.03800628

#nncover
t.test(cover_percent~site, data = site_cond_2018)
# not sig diff
# data:  cover_percent by site
# t = 0.2511, df = 33.554, p-value = 0.8033
site_cond_2018 %>%  
  group_by(site) %>% 
  summarize(avg_tdr = mean(cover_percent), 
            SD = sd(cover_percent),
            N = length(cover_percent), 
            SE = ((sd(cover_percent))/sqrt(length((cover_percent)))))
# site  mean   SD      N    SE
#1	36.58889	12.34307	18	2.909289
#2	35.49056	13.85799	18	3.266359

```


### Subsetting dataframes survival, par, tdr, and nncover to May 2018 data
  - Add height at March 2018 to include in model
  
```{r may 2018 height and survival, include=TRUE}
# subsetting data for May 2018 survival
# survmortnospp = may 2018
# par = april 2018
# tdr = april 2018
# nncover = may 2018

#seedling height in March 2018 - STARTING HEIGHT
height_march <- height_raw %>% 
  filter(date >= "2018-02-23" & date <= "2018-03-31") %>% # filtering to only have rows of data taken in March 
  dplyr::select(plot_number, MAFA_removal, location, species, stem_height_cm, individual) %>% 
  rename(march_stem_height_cm = stem_height_cm) %>% 
  drop_na()

print(height_march %>%  # check number of individuals per plot in March 2018
  group_by(plot_number) %>% 
  summarise(N = length(march_stem_height_cm)))
# not all plots had 18 seedlings planted in 2018 - Plot 26 and 36
# not all plots have 18 seedling height measurements

# seedling survival or dead in May 2018 - SURVIVAL 0-1
survival_may <- height_raw %>%  ## Need to change some of the individual labels to fix NAs when rejoin. 
  filter(date >= "2018-05-01" & date <= "2018-05-31") %>% # select for may 2018 data collection
  dplyr::select(plot_number, MAFA_removal, location, species, alive, individual) %>% 
  rename(may_alive = alive) %>% # 1 = alive
  mutate(may_alive = replace_na(may_alive, 0), # replace NAs with 0 = dead
         individual = case_when(individual == "s" ~ "S",
                                individual == "c" ~ "C",
                                individual == "r" ~ "R",
                                TRUE ~ individual))  # 0 = dead 1 = alive

```

- Add rgr at March 2018 to include in model
```{r may 2018 relative growth rate, include=TRUE}

#seedling height in May 2018 - ENDING HEIGHT
height_may <- height_raw %>% 
  filter(date >= "2018-05-01" & date <= "2018-05-31") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, stem_height_cm, individual) %>% 
  rename(may_stem_height_cm = stem_height_cm) %>% 
  mutate(individual = case_when(individual == "s" ~ "S",
                                individual == "c" ~ "C",
                                individual == "r" ~ "R",
                                TRUE ~ individual),
         may_stem_height_cm = as.numeric(may_stem_height_cm)) %>% 
  drop_na()

print(height_may %>%  # check number of individuals per plot in May 2018
  group_by(plot_number) %>% 
  summarise(N = length(may_stem_height_cm)))

# growth rate from March to May 2018 - GROWTH RATE
growth_march_may <- right_join(height_march, height_may, by = c("plot_number", "MAFA_removal", "location", "species", "individual")) %>% 
  mutate(march_stem_height_cm = as.numeric(march_stem_height_cm)) %>% 
  drop_na() %>% 
  mutate(rgr = (log(may_stem_height_cm) - log(march_stem_height_cm))/60, # relative growth rate per day equation; 60 days between March and May
         plot_number = as.character(plot_number)) %>% 
  left_join(par_april2018, by = "plot_number") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, individual, rgr, normalized_par) %>% 
  left_join(tdr_april2018, by = "plot_number") %>% 
  dplyr::select(!site & !treatment) %>% 
  left_join(nncover_may2018, by = "plot_number") %>% 
  dplyr::select(!treatment) %>% 
  rename(exotic_percentcover = cover_percent) %>% 
  rename(treatment = MAFA_removal)
```

### Join May 2018 data - 

NOTE: May 12, 2023 - need to re-check code to make sure all seedlings are included... including rgr omits seedlings that were alive in March and died in May because many dead seedlings were not re-measured in May 2018.

```{r may 2018 join march to may data, include=TRUE}

# March to May 2018 join - JOIN - 
# starting height, 0-1 may 2018, april 2018 normPAR, april 2018 tdr, nncover april 2018
height_march_surv_may_notransf <- full_join(height_march, survival_may, by = c("plot_number", "MAFA_removal", "location", "species", "individual")) %>% 
  mutate(march_stem_height_cm = as.numeric(march_stem_height_cm)) %>% # warning: one height "didn't plant"
  drop_na() %>% # drops nas 
  mutate(plot_number = as.character(plot_number)) %>% 
  left_join(par_april2018, by = "plot_number") %>% # join April 2018 PAR
  dplyr::select(plot_number, MAFA_removal, location, species, individual, march_stem_height_cm, may_alive, normalized_par) %>% 
  left_join(tdr_april2018, by = "plot_number") %>% # join April 2018 TDR
  dplyr::select(!site & !treatment) %>% 
  left_join(nncover_may2018, by = "plot_number") %>%  # join April 2018 nncover
  dplyr::select(!treatment) %>% 
  rename(exotic_percentcover = cover_percent) %>% 
  rename(treatment = MAFA_removal) %>% 
 left_join(growth_march_may, by = c("plot_number", "treatment", "location", "species", "individual", "normalized_par", "soil_moisture", "site", "exotic_percentcover")) %>%  
   mutate(site = as.factor(site))
view(height_march_surv_may_notransf)

write.csv(height_march_surv_may_notransf, "data/processed/height_march_surv_may_notransf.csv")

print(height_march_surv_may_notransf %>%  # check number of individuals per plot
  group_by(site, plot_number) %>% 
  summarise(N = length(individual))
)
```

```{r may 2018 aov height x spp, include=TRUE}

#height
summary(aov(march_stem_height_cm ~ species, data = height_march_surv_may_notransf))
#          Df Sum Sq Mean Sq F value Pr(>F)    
#species       3   2990   996.7     313 <2e-16 ***
#Residuals   602   1917     3.2 
 
print(TukeyHSD(aov(march_stem_height_cm ~ species, data = height_march_surv_may_notransf)))
#HEAR is significantly taller than all the other species in March 2018
#SAAP, CEOL, and RHOV are all similar in height
#$species
#                diff        lwr        upr     p adj
#HEAR-CEOL  4.5865165  4.0757534  5.0972795 0.0000000 <-- HEAR - CEOL
#RHOV-CEOL -0.2545951 -0.8184931  0.3093028 0.6503705
#SAAP-CEOL  0.1248809 -0.4510153  0.7007772 0.9441751
#RHOV-HEAR -4.8411116 -5.3448044 -4.3374188 0.0000000 <-- HEAR - RHOV
#SAAP-HEAR -4.4616355 -4.9787254 -3.9445456 0.0000000 <-- HEAR - SAAP
#SAAP-RHOV  0.3794761 -0.1901589  0.9491110 0.3160699

#volume
summary(aov(march_volume_cm3 ~ species, data = height_march_surv_may_notransf))
#            Df  Sum Sq Mean Sq F value Pr(>F)    
#species       3 2608825  869608   147.3 <2e-16 ***
#Residuals   602 3554014    5904       
print(TukeyHSD(aov(march_volume_cm3 ~ species, data = height_march_surv_may_notransf)))
#$species
#                 diff        lwr        upr     p adj
#HEAR-CEOL  140.309690  118.31777  162.30161 0.0000000 <-- HEAR - CEOL
#RHOV-CEOL    1.720552  -22.55919   26.00030 0.9978392
#SAAP-CEOL    8.475339  -16.32102   33.27169 0.8149679
#RHOV-HEAR -138.589138 -160.27663 -116.90165 0.0000000 <-- HEAR - RHOV
#SAAP-HEAR -131.834351 -154.09868 -109.57002 0.0000000 <-- HEAR - SAAP
#SAAP-RHOV    6.754787  -17.77198   31.28155 0.8933340

# may 2018 alive vs dead by spp
print(height_march_surv_may %>%  
  #group_by(species) %>% 
  summarise(N = length(may_alive), 
            total_survived = sum(may_alive == "1"), 
            total_died = sum(may_alive == "0"),
            percent_survived = 100*(sum(may_alive == "1")/length(may_alive))))
#species    N   tot_sur tot_dead percent_surv
#CEOL	      130	35	    95	        26.92308
#HEAR	      215	100	    115	        46.51163
#RHOV	      136	34	    102	        25.00000
#SAAP	      125	21	    104	        16.80000

# may 2018 height x spp
print(height_march_surv_may_notransf %>%  
  group_by(species) %>% 
  summarise(height_avg_cm = mean(march_stem_height_cm), 
            height_sd_cm = sd(march_stem_height_cm)))

# may 2018 vol x spp
print(height_march_surv_may_notransf %>%  
  group_by(species) %>% 
  summarise(avg_vol_cm3 = mean(march_volume_cm3), 
            SD = sd(march_volume_cm3),
            N = length(march_volume_cm3), 
            SE = ((sd(march_volume_cm3))/sqrt(length((march_volume_cm3))))))
#species    avg_vol_cm3   SD          N         SE
#CEOL	      4.167051	    4.797507	  130	      0.4207692
#HEAR	      144.476741	  126.600155	215	      8.6340589
#RHOV	      5.887603	    5.293661	  136	      0.4539277
#SAAP	      12.642390	    30.763829	  125	      2.7516005


# soil moisture
summary(aov(soil_moisture ~ may_alive, data = height_march_surv_may_notransf))
#               Df Sum Sq Mean Sq F value   Pr(>F)    
#soil_moisture   1   2.51  2.5085   11.85 0.000618 ***
#Residuals     604 127.92  0.2118

# may 2018 alive x tdr
height_march_surv_may_notransf %>%  
  group_by(may_alive) %>% 
  summarize(avg_tdr = mean(soil_moisture), 
            SD = sd(soil_moisture),
            N = length(soil_moisture), 
            SE = ((sd(soil_moisture))/sqrt(length((soil_moisture)))))
# may_alive avg_tdr SD  N       SE
#0	    8.561238	1.488091	416   	0.07295968
#1	9.001974	1.404786	190	    0.10191389

t.test(soil_moisture ~ may_alive, data = height_march_surv_may_notransf) 
# Soil moisture is significantly different betweeen alive and dead seedlings
#data:  soil_moisture by may_alive
#t = -3.5164, df = 386.18, p-value = 0.0004895
```

```{r may 2018 transform data, include=TRUE}

# scale transform data: normPAR, tdr, nncover, starting height - SCALE
height_march_surv_may <- height_march_surv_may_notransf %>% 
  mutate(normalized_par = scale(normalized_par), # scale transforms the data; helps when comparing variables with different units; changes column names
         soil_moisture = scale(soil_moisture),
         exotic_percentcover = scale(exotic_percentcover),
         march_stem_height_cm = scale(march_stem_height_cm),
         rgr = scale(rgr),
         march_volume_cm3 = scale(march_volume_cm3),
         may_alive = as.factor(may_alive),
        species = as.factor(species)) 
glimpse(height_march_surv_may)

write.csv(height_march_surv_may, "data/processed/height_march_surv_may.csv")



```

```{r notes on lmer vs glmer, include=FALSE}

# lmer is used to fit linear mixed-effect models, so it assumes that the residual error has a Gaussian distribution. 

# If your dependent variable A is a binary outcome (e.g. a yes/no response), then the error distribution is binomial and not Gaussian. In this case you have to use glmer, which allow to fit a generalized linear mixed-effects model: these models include a link function that allows to predict response variables with non-Gaussian distributions. 

# One example of link function that could work in your case is the logistic function, which takes an input with any value from negative to positive infinity and return an output that always takes values between zero and one, which is interpretable as the probability of the binary outcome (e.g. the probability of the subject responding 'yes').
```

- model may 2018 with glmer
- Check for binomial distribution of height_march_surv_may$may_alive
```{r save chi squared goodness of fit function, include=FALSE}

### Bard - only need to run once

# Arguments
# observed <- height_march_surv_may$may_alive
# p <- rep(1/length(observed), length(observed))

# Write the function
chi_square_goodness_of_fit <- function(observed, p) {
  if(length(observed) != length(p)) {stop("The length of the observd frequencies must be equal to the length of the expected proportions.")
  }
  chi_square <- sum((observed - p)^2 / p) # calculate chi-square stats
  degrees_of_freedom <- length(observed) - 1 # calculate degrees of freedom
  p_value <- pchisq(chi_square, degrees_of_freedom, lower.tail = FALSE) # calculate p-value
  return(list( # return the results
    chi_square = chi_square, 
    degrees_of_freedom = degrees_of_freedom, 
    p_value = p_value))
  }

# save as file in R
save(chi_square_goodness_of_fit, file = "chi_square_goodness_of_fit.R")

# load function
load("chi_square_goodness_of_fit.R")
```
```{r may 2018 goodness of fit chi squared, include=TRUE}

### BARD or ... 
load("chi_square_goodness_of_fit.R") # load function
observed <- height_march_surv_may$may_alive
p <- rep(1/length(observed), length(observed))
print(chi_square_goodness_of_fit(observed, p)) # NA = perfect fit


### CHATGPT
observed <- as.integer(height_march_surv_may$may_alive) # Define the observed frequencies
expected_probs <- rep(1/length(observed), length(observed)) # Define the expected probabilities

total_observed <- sum(observed) # Calculate the expected frequencies
expected <- expected_probs * total_observed

chisq_result <- chisq.test(observed, p = expected_probs) # Perform the chi-square test

cat("Observed frequencies:", observed, "\n") # Print the observed and expected frequencies
cat("Expected frequencies:", expected, "\n")

cat("Chi-square test result:\n") # Print the chi-square test result
print(chisq_result)


```

```{r may 2018 glmer MODELS, include=TRUE}

# FULL MODELS

glme.may2018.mod.1 <- glmer(may_alive ~ 
                             normalized_par + soil_moisture # plus
                            + exotic_percentcover + site 
                            + march_stem_height_cm + species # plus
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_march_surv_may)
summary(glme.may2018.mod.1)
# AIC: 704.6
#Fixed effects:
#                      Estimate Std. Error z value Pr(>|z|)   
#(Intercept)          -0.800203   0.293996  -2.722  0.00649 **
#normalized_par       -0.012121   0.151858  -0.080  0.93638   
#soil_moisture         0.230743   0.178312   1.294  0.19565   
#exotic_percentcover  -0.009566   0.148175  -0.065  0.94853   
#site2                -0.474881   0.352830  -1.346  0.17833   
#march_stem_height_cm  0.167639   0.145981   1.148  0.25082   
#speciesHEAR           0.717822   0.345186   2.080  0.03757 * <-- species
#speciesRHOV          -0.085414   0.292463  -0.292  0.77025   
#speciesSAAP          -0.673506   0.322808  -2.086  0.03694 * <-- species

glme.may2018.mod.2 <- glmer(may_alive ~ 
                             normalized_par * soil_moisture # times
                            + exotic_percentcover + site  
                            + march_stem_height_cm + species # plus
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_march_surv_may)
summary(glme.may2018.mod.2)
# AIC: 692.3
# Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                  -0.67222    0.26791  -2.509   0.0121 *  
#normalized_par                0.22151    0.13682   1.619   0.1055    
#soil_moisture                 0.37873    0.15482   2.446   0.0144 *  <-- tdr
#exotic_percentcover           0.05884    0.12325   0.477   0.6331    
#site2                        -0.52592    0.28791  -1.827   0.0677 .  
#march_stem_height_cm          0.19582    0.14592   1.342   0.1796    
#speciesHEAR                   0.65675    0.34598   1.898   0.0577 .  
#speciesRHOV                  -0.09939    0.29329  -0.339   0.7347    
#speciesSAAP                  -0.71330    0.32438  -2.199   0.0279 *  <-- species
#normalized_par:soil_moisture  0.55680    0.13963   3.988 6.67e-05 ***<-- par x tdr


glme.may2018.mod.3 <- glmer(may_alive ~ 
                             normalized_par * soil_moisture + exotic_percentcover + site + # times 
                             march_stem_height_cm * species + (1|plot_number), # times
                         family = binomial, 
                         data = height_march_surv_may)
summary(glme.may2018.mod.3)
# AIC = 693.0
#Fixed effects:
#                                 Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                      -1.01340    0.49204  -2.060   0.0394 *  
#normalized_par                    0.22136    0.14018   1.579   0.1143    
#soil_moisture                     0.40087    0.15856   2.528   0.0115 *   <-- tdr
#exotic_percentcover               0.06039    0.12550   0.481   0.6304    
#site2                            -0.51549    0.29315  -1.758   0.0787 .  
#march_stem_height_cm             -0.38527    0.71407  -0.540   0.5895    
#speciesHEAR                       1.08268    0.51634   2.097   0.0360 *  <-- spp
#speciesRHOV                       1.04482    0.70018   1.492   0.1356    
#speciesSAAP                      -0.09353    0.56593  -0.165   0.8687    
#normalized_par:soil_moisture      0.55959    0.14347   3.901  9.6e-05 *** <-- tdr x par
#march_stem_height_cm:speciesHEAR  0.49651    0.73104   0.679   0.4970    
#march_stem_height_cm:speciesRHOV  1.88603    1.06792   1.766   0.0774 .  
#march_stem_height_cm:speciesSAAP  1.20488    0.86272   1.397   0.1625  

glme.may2018.mod.4 <- glmer(may_alive ~ 
                             normalized_par + soil_moisture # plus
                             + site  # no exotic cover
                            + march_stem_height_cm + species # plus
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_march_surv_may)
summary(glme.may2018.mod.4)
# AIC: 702.6
#Fixed effects:
#                      Estimate Std. Error z value Pr(>|z|)   
#(Intercept)          -0.800772   0.293856  -2.725  0.00643 **
#normalized_par       -0.008121   0.138196  -0.059  0.95314   
#soil_moisture         0.232701   0.175242   1.328  0.18422   
#site2                -0.473156   0.351743  -1.345  0.17857   
#march_stem_height_cm  0.167865   0.145955   1.150  0.25010   
#speciesHEAR           0.717656   0.345187   2.079  0.03761 * 
#speciesRHOV          -0.085284   0.292455  -0.292  0.77058   
#speciesSAAP          -0.673299   0.322758  -2.086  0.03697 * 

glme.may2018.mod.5 <- glmer(may_alive ~ 
                             normalized_par * soil_moisture # times
                             + site  # no exotic cover
                            + march_stem_height_cm + species # plus
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_march_surv_may)
summary(glme.may2018.mod.5)
# AIC: 690.5
# Fixed effects:
#              Estimate Std. Error z value Pr(>|z|)    
# (Intercept)                  -0.67157    0.26866  -2.500   0.0124 *  
#normalized_par                0.19483    0.12569   1.550   0.1211    
#soil_moisture                 0.36456    0.15283   2.385   0.0171 *  
#site2                        -0.53426    0.28949  -1.846   0.0650 .  
#march_stem_height_cm          0.19324    0.14573   1.326   0.1849    
#speciesHEAR                   0.66010    0.34573   1.909   0.0562 .  
#speciesRHOV                  -0.09861    0.29338  -0.336   0.7368    
#speciesSAAP                  -0.71114    0.32455  -2.191   0.0284 *  
#normalized_par:soil_moisture  0.55034    0.13999   3.931 8.45e-05 ***

glme.may2018.mod.6 <- glmer(may_alive ~ 
                             normalized_par * soil_moisture # times
                             + site  # no exotic cover
                            + march_stem_height_cm * species # times
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_march_surv_may)
summary(glme.may2018.mod.6)
#AIC = 691.2
#Fixed effects:
#                                 Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                      -1.02113    0.49196  -2.076 0.037927 *  
#normalized_par                    0.19382    0.12861   1.507 0.131783    
#soil_moisture                     0.38623    0.15664   2.466 0.013674 *  <-- tdr
#site2                            -0.52400    0.29492  -1.777 0.075604 .  
#march_stem_height_cm             -0.40257    0.71296  -0.565 0.572316    
#speciesHEAR                       1.09326    0.51557   2.120 0.033965 *  <-- spp
#speciesRHOV                       1.04934    0.69983   1.499 0.133764    
#speciesSAAP                      -0.08406    0.56545  -0.149 0.881825    
#normalized_par:soil_moisture      0.55278    0.14379   3.844 0.000121 *** <-- par x tdr
#march_stem_height_cm:speciesHEAR  0.51221    0.73019   0.701 0.483009    
#march_stem_height_cm:speciesRHOV  1.89285    1.06699   1.774 0.076061 .  
#march_stem_height_cm:speciesSAAP  1.21723    0.86188   1.412 0.157861 

# MINIMAL MODELS

glme.may2018.mod.7 <- glmer(may_alive ~ 
                             normalized_par + soil_moisture + species + (1|plot_number), # plus
                         family = binomial, 
                         data = height_march_surv_may)
summary(glme.may2018.mod.7)
# AIC: 701.6 

glme.may2018.mod.8 <- glmer(may_alive ~ 
                             normalized_par * soil_moisture + species + (1|plot_number), # times
                         family = binomial, 
                         data = height_march_surv_may)
summary(glme.may2018.mod.8)
# AIC: 691.3  
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                   -1.0399     0.2213  -4.700 2.60e-06 ***
#normalized_par                 0.1509     0.1307   1.154 0.248345    
#soil_moisture                  0.5266     0.1319   3.991 6.57e-05 *** <-- tdr
#speciesHEAR                    0.9700     0.2546   3.810 0.000139 *** <-- species
#speciesRHOV                   -0.1128     0.2929  -0.385 0.700109    
#speciesSAAP                   -0.6973     0.3245  -2.149 0.031647 *  <-- species
#normalized_par:soil_moisture   0.5329     0.1466   3.636 0.000277 ***<-- tdr x par

 
# RELATIVE GROWTH RATE

# relative growth rate as dependent variable - Shane's code
glme_rgr_may2018.1 <- lmer(rgr ~ normalized_par*soil_moisture + exotic_percentcover + site + (1|plot_number),
                         data = growth_march_may)
summary(glme_rgr_may2018.1)
# no AIC
# Site 2 is significant

```

```{r may 2018 glmer, include =TRUE}
# glmer - yes/no = binomial distribution
# 1.0 is perfect
# 1.7 is getting dicy
# >1.7 is not a good fit

# model 2
glme.may2018.mod <- glmer(may_alive ~ 
                             normalized_par * soil_moisture # significant from Q1
                            + exotic_percentcover + site   # nncover not significant from Q1
                            + march_stem_height_cm + species # plus
                            + (1|plot_number), # don't add right/left or individual code (blue, green, )
                         family = binomial, 
                         data = height_march_surv_may)

MOD <- glme.may2018.mod 

# Calculate model's residual and fitted values
F1 <- fitted(MOD)
E1 <- residuals(MOD, "pearson")

# Graph residuals vs fitted values to inspect homogeneity of variance, look for a random scattering of plots
# run together 2 lines
plot(x=F1, y=E1, xlab="Fitted Model Values", ylab="Pearson Residuals", main = "Variance")
abline(h = 0) # looking for random scatter

# Check for crazy outliers, look for lines MUCH taller than the rest of data
plot(cooks.distance(MOD))



# Plot a box plot for each factor, look for equal variance amount levels along the zero line
# Box plots need to be assessed for every fixed effect (categorical factor) for your model. 
# Random effects need the qqline just like normality. 
# So, only site and treatment get box plots. 
# exotic_cover is a covariate (continuous variable).

boxplot(E1 ~ site, data = height_march_surv_may) # <---- make sure to change to df, not the glmer
abline(h = 0)
# error message - variable lengths differ
print(height_march_surv_may %>%  # check number of individuals per plot in March 2018
  group_by(site) %>% 
  summarise(N = length(site)))
# site N
# 1	  318			
# 2 	288	

boxplot(E1 ~ species, data = height_march_surv_may) # <---- make sure to change to df, not the lme
abline(h = 0)

# Plot each random effect in the model - things in the (1|_), look for dots along 1:1 line
qqnorm(ranef(MOD)$plot_number[,1], main = "Plot Residuals")
qqline(ranef(MOD)$plot_number[,1]) # plot number

#qqnorm(ranef(MOD)$individual[,1], main = "Plot Residuals")
#qqline(ranef(MOD)$individual[,1]) # individual: blue, green, S, C, R

```


### Statistics

```{r may 2018 stats, include=TRUE}

print(glme.may2018.mod)
summary(glme.may2018.mod)
# when normalized_par * soil_moisture and WITHOUT rgr 
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                  -0.67222    0.26791  -2.509   0.0121 *  
#normalized_par                0.22151    0.13682   1.619   0.1055    
#soil_moisture                 0.37873    0.15482   2.446   0.0144 * <-- soil moisture
#exotic_percentcover           0.05884    0.12325   0.477   0.6331    
#site2                        -0.52592    0.28791  -1.827   0.0677 .  
#march_stem_height_cm          0.19582    0.14592   1.342   0.1796    
#speciesHEAR                   0.65675    0.34598   1.898   0.0577 .  
#speciesRHOV                  -0.09939    0.29329  -0.339   0.7347    
#speciesSAAP                  -0.71330    0.32438  -2.199   0.0279 *  <-- species
#normalized_par:soil_moisture  0.55680    0.13963   3.988 6.67e-05 *** <-- interaction PAR x TDR



# when normalized_par * soil_moisture + nncover + species * march_stem_height_cm
#Fixed effects:
#                                 Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                      -1.01340    0.49204  -2.060   0.0394 *  
#normalized_par                    0.22136    0.14018   1.579   0.1143    
#soil_moisture                     0.40087    0.15856   2.528   0.0115 *  <-- soil moisture
#exotic_percentcover               0.06039    0.12550   0.481   0.6304    
#site2                            -0.51549    0.29315  -1.758   0.0787 .  
#march_stem_height_cm             -0.38527    0.71407  -0.540   0.5895    
#speciesHEAR                       1.08268    0.51634   2.097   0.0360 *  <-- spp hear
#speciesRHOV                       1.04482    0.70018   1.492   0.1356    
#speciesSAAP                      -0.09353    0.56593  -0.165   0.8687    
#normalized_par:soil_moisture      0.55959    0.14347   3.901  9.6e-05 *** <-- par x tdr
#march_stem_height_cm:speciesHEAR  0.49651    0.73104   0.679   0.4970    
#march_stem_height_cm:speciesRHOV  1.88603    1.06792   1.766   0.0774 .  
#march_stem_height_cm:speciesSAAP  1.20488    0.86272   1.397   0.1625 


# when normalized_par * soil_moisture + nncover and WITHOUT rgr or species
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                  -0.57868    0.17050  -3.394 0.000689 ***
#normalized_par                0.22687    0.13362   1.698 0.089519 .  
#soil_moisture                 0.36255    0.15091   2.402 0.016285 *  <-- soil moisture
#exotic_percentcover           0.05844    0.12111   0.483 0.629438    
#site2                        -0.52012    0.28056  -1.854 0.063762 .  
#march_stem_height_cm          0.52137    0.09360   5.570 2.55e-08 *** <-- march stem height
#normalized_par:soil_moisture  0.54752    0.13617   4.021 5.80e-05 *** <-- par x tdr interaction

# when normalized_par + soil_moisture and WITHOUT rgr = only species is significant
#Fixed effects:
#                      Estimate Std. Error z value Pr(>|z|)   
#(Intercept)          -0.800203   0.293996  -2.722  0.00649 **
#normalized_par       -0.012121   0.151858  -0.080  0.93638   
#soil_moisture         0.230743   0.178312   1.294  0.19565   
#exotic_percentcover  -0.009566   0.148175  -0.065  0.94853   
#site2                -0.474881   0.352830  -1.346  0.17833   
#march_stem_height_cm  0.167639   0.145981   1.148  0.25082   
#speciesHEAR           0.717822   0.345186   2.080  0.03757 * <-- species
#speciesRHOV          -0.085414   0.292463  -0.292  0.77025   
#speciesSAAP          -0.673506   0.322808  -2.086  0.03694 * <-- species

print(glme.may2018.modspp)
summary(glme.may2018.modspp)
# when normalized_par * soil_moisture and WITHOUT rgr = soil_moisture, norm_par*soil_moisture, species are significant
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                  -0.67222    0.26791  -2.509   0.0121 *  
#normalized_par                0.22151    0.13682   1.619   0.1055    
#soil_moisture                 0.37873    0.15482   2.446   0.0144 * <-- soil moisture
#exotic_percentcover           0.05884    0.12325   0.477   0.6331    
#site2                        -0.52592    0.28791  -1.827   0.0677 .  
#march_stem_height_cm          0.19582    0.14592   1.342   0.1796    
#speciesHEAR                   0.65675    0.34598   1.898   0.0577 .  
#speciesRHOV                  -0.09939    0.29329  -0.339   0.7347    
#speciesSAAP                  -0.71330    0.32438  -2.199   0.0279 *  <-- species
#normalized_par:soil_moisture  0.55680    0.13963   3.988 6.67e-05 *** <-- interaction PAR x TDR
# 
# when normalized_par * soil_moisture * nncover and WITHOUT rgr = soil_moisture, norm_par*soil_moisture, species are significant
#Fixed effects:
#                                                 Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                                      -0.70008    0.26985  -2.594 0.009478 ** 
#normalized_par                                    0.21233    0.13956   1.521 0.128169    
#soil_moisture                                     0.39759    0.17833   2.229 0.025783 *  
#exotic_percentcover                               0.05525    0.12237   0.451 0.651642    
#speciesHEAR                                       0.64219    0.34649   1.853 0.063827 .  
#speciesRHOV                                      -0.09718    0.29347  -0.331 0.740546    
#speciesSAAP                                      -0.71199    0.32487  -2.192 0.028405 *  
#site2                                            -0.51624    0.28299  -1.824 0.068118 .  
#march_stem_height_cm                              0.20034    0.14591   1.373 0.169737    
#normalized_par:soil_moisture                      0.60608    0.17582   3.447 0.000567 ***
#normalized_par:exotic_percentcover               -0.12603    0.11167  -1.129 0.259047     <-- nncover never significant factor
#soil_moisture:exotic_percentcover                 0.10619    0.14029   0.757 0.449112    
#normalized_par:soil_moisture:exotic_percentcover -0.04511    0.15725  -0.287 0.774232   

# Take home: when environmental conditions are considered separately, species is the main driving factor of seedling survival. However, we know environmntal variables do not act independently on seedling survival, so par x tdr is a better model that represents what is hapening in the field. 
# The interaction between Par*TDR and the species of seedling planted are correlated with seedling survival from March to May in 2018.

# Notes
# We included non-native percent cover but that was not significant by itself or when interacting with tdr and/or par so it was kept as an non-interactinve factor in the model. 
# The model including interactions between species * par * tdr didn't run so species remained a non-interacting factor.

print(glme.may2018.modspp_CEOL)
summary(glme.may2018.modspp_CEOL)


# when normalized_par + soil_moisture and WITH rgr
#Fixed effects:
#                     Estimate Std. Error z value Pr(>|z|)    
#(Intercept)           3.06593    0.61814   4.960 7.05e-07 ***
#normalized_par       -0.47379    0.19966  -2.373   0.0176 *  
#soil_moisture         0.60512    0.27015   2.240   0.0251 *  
#exotic_percentcover  -0.52274    0.21463  -2.436   0.0149 *  
#site2                -2.61512    0.53223  -4.913 8.95e-07 ***
#rgr                   0.17486    0.18525   0.944   0.3452    
#march_stem_height_cm  0.01186    0.23245   0.051   0.9593    
#speciesHEAR          -0.13926    0.60828  -0.229   0.8189    
#speciesRHOV          -0.80500    0.56642  -1.421   0.1553    
#speciesSAAP          -1.49677    0.61320  -2.441   0.0147 *  


# when normalized_par * soil_moisture and WITH rgr
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                   3.14554    0.62088   5.066 4.06e-07 ***
#normalized_par               -0.04689    0.24992  -0.188  0.85117    
#soil_moisture                 0.70144    0.26578   2.639  0.00831 ** 
#exotic_percentcover          -0.47463    0.19730  -2.406  0.01615 *  
#site2                        -2.71065    0.51212  -5.293 1.20e-07 ***
#rgr                           0.15780    0.18477   0.854  0.39309    
#march_stem_height_cm          0.03284    0.24099   0.136  0.89162    
#speciesHEAR                  -0.20153    0.61868  -0.326  0.74463    
#speciesRHOV                  -0.79117    0.56505  -1.400  0.16146    
#speciesSAAP                  -1.52418    0.61178  -2.491  0.01272 *  
#normalized_par:soil_moisture  0.64328    0.27406   2.347  0.01891 *  


# fixed level effects, pvalues, etc.
anova(glme.may2018.mod) # A significant p-value indicates that one or more significant differences exist between group means.
# no p-values because no replicates - each individual is an n of 1

```



```{r may 2018 post hoc, include=TRUE}

glmm_interaction <- glmer(factor(may_alive) ~ normalized_par * soil_moisture + species +
                            (1|plot_number),
                          family = binomial(link = "logit"),
                          data = height_march_surv_may)

summary(glmm_interaction)
```

```{r may 2018 tdr x par interaction on survival, include=TRUE}

# TAKE 1 
#surv_prediction <- seq(from = -1.6, to = 1.8, by = 0.1) %>% # x = soil moisture 
#  as.data.frame() %>% 
#  rename(soil_moisture = ".") %>% 
#  mutate(normalized_par = min(may18_partdr.interaction$normalized_par)) %>% 
#  mutate(alive = predict(may18_partdr.interaction, newdata = . , type = "response"))
#print(surv_prediction)

# glm model
may18_partdr.interaction <- glm(may_alive ~ normalized_par * soil_moisture * species, data = height_march_surv_may, family = binomial)
print(may18_partdr.interaction)
summary(may18_partdr.interaction)
# SAAP, HEAR, SOIL MOISTURE are significant

```
```{r may 2018 figures, include=TRUE}

# bagraph.1 - survival x species
may2018.1 <- ggplot(data = height_march_surv_may, aes(x = species, y = may_alive, fill = species)) +
  geom_bar(stat = "identity")
  labs(x = "Species",
       y = "Total Survival",
       title = "Total Alive in May 2018")
may2018.1


# bargraph.2 - survial x tdr

# TAKE 2
# Create interaction plot
may18_partdr.interaction.plot <- ggplot(may18_partdr.interaction, aes(x = normalized_par, y = may_alive, color = (soil_moisture))) +
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = FALSE) +
  labs(x = "PAR", y = "Alive", color = "TDR") +
  scale_color_continuous(name = "TDR") +
  theme_minimal()
may18_partdr.interaction.plot

# TAKE 3 
# Create a data frame with values of TDR and PAR for prediction
min_value <- min(height_march_surv_may$soil_moisture, na.rm = TRUE)
max_value <- max(height_march_surv_may$soil_moisture, na.rm = TRUE)
print(min_value)
print(max_value)

# Calculate row means of TDR matrix/array
TDR_row_means <- rowMeans(height_march_surv_may$soil_moisture) 
PAR_row_means <- rowMeans(height_march_surv_may$normalized_par)

# Create a new dataframe with the row means and other relevant variables
new_data <- data.frame(soil_moisture = TDR_row_means, normalized_par = PAR_row_means, may_alive = height_march_surv_may$may_alive)
print(new_data)

### CODE  BELOW HERE DOESN'T RUN

# Generate predicted values
new_data$alive_predicted <- predict(may18_partdr.interaction, newdata = new_data, type = "response")

# Create the plot
ggplot(height_may, aes(x = TDR_row_means * PAR, y = as.factor(alive), color = TDR_row_means)) +
  geom_jitter() +
  geom_line(data = new_data, aes(y = alive_predicted), color = "blue") +
  scale_color_continuous() +
  labs(x = "TDR_row_means * PAR", y = "Alive", color = "TDR_row_means")

partdr_predict <- expand.grid(soil_moisture = seq(min(height_march_surv_may$soil_moisture),
                                            max(height_march_surv_may$soil_moisture), length.out = 100),
                        normalized_par = seq(min(height_march_surv_may$normalized_par),
                                             max(height_march_surv_may$normalized_par), length.out = 100)) %>% 
  

# Predict probabilities of being "alive" for the new data
partdr_predict$prob_alive <- predict(may18_partdr.interaction, newdata = partdr_predict, type = "response")

# Create the interaction plot with the predictive line
ggplot(your_data, aes(x = TDR * PAR, y = alive)) +
  geom_point() +
  geom_line(data = new_data, aes(y = prob_alive), color = "red") +
  labs(x = "TDR * PAR", y = "Alive") +
  theme_minimal()

# TAKE 4 - shane's code
partdr_predict <- expand.grid(soil_moisture = seq(min(height_march_surv_may$soil_moisture),
                                            max(height_march_surv_may$soil_moisture), length.out = 100)) %>% 
  as.data.frame() %>% 
  mutate(normalized_par = mean(height_march_surv_may$normalized_par)) %>% 
  mutate(alive = predict(may18_partdr.interaction, newdata = . , type = "response"))


```


### Figures 

```{r may 2018 explore figures, include=FALSE}

maybox.1 <- ggplot(data = height_march_surv_may, 
       aes(x = may_alive, y = soil_moisture, color = may_alive)) +
  labs(title = "Normalized PAR over time", x = "Month", y = "Normalized PAR") +
  geom_boxplot() +
  theme_bw() 
ggplotly(maybox.1)

mayscatter.1 <- ggplot(data = height_march_surv_may, 
                       aes(x = soil_moisture, y = normalized_par)) +
  geom_point(aes(color = factor(may_alive))) +
  geom_jitter(width = 0.0, height = 0.0) +
  theme_classic()
mayscatter.1

```


- prediction of survival in May 2018

```{r May 2018 figures stem height survival site, include=TRUE}

# stem height x survival, paneled by site
# figure: predict survival (S curve by 0-1)
stem_height_site_1_prediction <- seq(from = -1.2, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(normalized_par = mean(height_march_surv_may$normalized_par),
         exotic_percentcover = mean(height_march_surv_may$exotic_percentcover),
         site = "1",
         soil_moisture = mean(height_march_surv_may$soil_moisture),
         treatment = "full removal",
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

stem_height_site_2_prediction <- seq(from = -1.2, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(normalized_par = mean(height_march_surv_may$normalized_par),
         exotic_percentcover = mean(height_march_surv_may$exotic_percentcover),
         site = "2",
         soil_moisture = mean(height_march_surv_may$soil_moisture),
         treatment = "full removal",
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

site_1_sh_plot <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(site == "1"), aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_site_1_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic() +
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival",
       title = "Site 1")

site_2_sh_plot <- ggplot()+
  geom_point(data = height_march_surv_may %>%  filter(site == "2"), aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_site_2_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival",
       title = "Site 2")

site_1_sh_plot + site_2_sh_plot
```
- box plot of rgr May 2018
```{r may 2018 box plot rgr figure, include=FALSE}

# box.1 rgr x site
#ggplot(growth_march_may, aes(x = site, y = rgr))+
#  geom_boxplot()+
#  theme_classic()+
#  labs(x = "Planting Site",
#       y = "Relative Growth Rate")
```

- figure - prediction of survival x soil moisture x low, mean, and high PAR 
- BY SITE
```{r May 2018 figure predict site by levels of par, include=TRUE}

# soil moisture x MIN par x Site 1
moisture_low_par_site_1 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% # range of soil moisture from height_march_surv_may
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(height_march_surv_may$normalized_par), # calculate norm_par minimum
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0, 
         species = "HEAR" ) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# soil moisture x MIN par x Site 2
moisture_low_par_site_2 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(height_march_surv_may$normalized_par), 
         exotic_percentcover = 0,
         site = "2",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# soil moisture x MEAN par x Site 1
moisture_mean_par_site_1 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = 0, # mean norm_par, data is scale transformed
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# soil moisture x MEAN par x Site 2
moisture_mean_par_site_2 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = 0,
         exotic_percentcover = 0,
         site = "2",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# soil moisture x MAX par x Site 1
moisture_max_par_site_1 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(height_march_surv_may$normalized_par), # calculate norm_par maximum
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

#soil moisture x MAX par x Site 2
moisture_max_par_site_2 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(height_march_surv_may$normalized_par),
         exotic_percentcover = 0,
         site = "2",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# rbind norm_par min, mean, max at Site 1
moisture_prediction_site_1 <- rbind(moisture_low_par_site_1, moisture_mean_par_site_1, moisture_max_par_site_1)

# rbind norm_par min, mean, max at Site 2
moisture_prediction_site_2 <- rbind(moisture_low_par_site_2, moisture_mean_par_site_2, moisture_max_par_site_2)

# prediction figure - site 1
moisture_site_1_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(site == "1"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_prediction_site_1, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1) +
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability",
       title = "Site 1")

# prediction figure - site 2
moisture_site_2_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(site == "2"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_prediction_site_2, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1) +
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability",
       title = "Site 2")

moisture_site_1_graph + moisture_site_2_graph
```

- figure - prediction of survival x norm_par x low, mean, and high TDR 
- by SITE
```{r May 2018 figure predict by levels of tdr, include=TRUE}

# par x MIN tdr x plot 1
# Site = "1" 
par_low_moisture_site_1 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(height_march_surv_may$soil_moisture), # min TDR
         exotic_percentcover = 0, # mean nncover
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# par x MIN tdr x plot 2
par_low_moisture_site_2 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(height_march_surv_may$soil_moisture),
         exotic_percentcover = 0,
         site = "2",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# par x MEAN tdr x plot 1
par_mean_moisture_site_1 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = 0,
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# par x MEAN tdr x plot 2
par_mean_moisture_site_2 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = 0,
         exotic_percentcover = 0,
         site = "2",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# par x MAX tdr x plot 1
par_max_moisture_site_1 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(height_march_surv_may$soil_moisture),
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# par x MAX tdr x plot 2
par_max_moisture_site_2 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(height_march_surv_may$soil_moisture),
         exotic_percentcover = 0,
         site = "2",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# rbind 
par_prediction_site_1 <- rbind(par_low_moisture_site_1, par_mean_moisture_site_1, par_max_moisture_site_1)

par_prediction_site_2 <- rbind(par_low_moisture_site_2, par_mean_moisture_site_2, par_max_moisture_site_2)

par_site_1_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(site == "1"), aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_prediction_site_1, aes(x = normalized_par, y = alive, col = soil_moisture, group = soil_moisture), linewidth = 1) +
  theme_classic() +
  labs(x = "Normalized PAR", 
       y = "Survival Probability",
       title = "Site 1")

par_site_2_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(site == "2"), aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_prediction_site_2, aes(x = normalized_par, y = alive, col = soil_moisture, group = soil_moisture), linewidth = 1) +
  theme_classic() +
  labs(x = "Normalized PAR", 
       y = "Survival Probability",
       title = "Site 2")

par_site_1_graph + par_site_2_graph
```

- BY SPECIES
```{r may 2018 glmer by species, include=TRUE}
#CEOL
glme.may2018.modspp_CEOL <- glmer(may_alive ~ 
                            normalized_par * soil_moisture # significant from Q1
                          + exotic_percentcover # not significant from Q1
                          + site + march_stem_height_cm 
                          + (1|plot_number),
                                family = binomial, 
                         data = (height_march_surv_may %>% filter(species == "CEOL")))

#HEAR
glme.may2018.modspp_HEAR <- glmer(may_alive ~ 
                            normalized_par * soil_moisture # significant from Q1
                          + exotic_percentcover # not significant from Q1
                          + site + march_stem_height_cm
                          + (1|plot_number),
                                family = binomial, 
                         data = (height_march_surv_may %>% filter(species == "HEAR")))

#RHOV
glme.may2018.modspp_RHOV <- glmer(may_alive ~ 
                            normalized_par * soil_moisture # significant from Q1
                          + exotic_percentcover # not significant from Q1
                          + site + march_stem_height_cm 
                          + (1|plot_number),
                                family = binomial, 
                         data = (height_march_surv_may %>% filter(species == "RHOV")))
# error : boundary (singular) fit: see help('isSingular')

#SAAP
glme.may2018.modspp_SAAP <- glmer(may_alive ~ 
                            normalized_par * soil_moisture # significant from Q1
                          + exotic_percentcover # not significant from Q1
                          + site + march_stem_height_cm 
                          + (1|plot_number),
                                family = binomial, 
                         data = (height_march_surv_may %>% filter(species == "SAAP")))
# error : boundary (singular) fit: see help('isSingular')
```

```{r may 2018 glmer by species testing normality, include=TRUE}
MOD <- glme.may2018.modspp_CEOL #or
MOD <- glme.may2018.modspp_HEAR #or
MOD <- glme.may2018.modspp_RHOV #or
MOD <- glme.may2018.modspp_SAAP 


# Calculate model's residual and fitted values
F1 <- fitted(MOD)
E1 <- residuals(MOD, "pearson")

# See residuals as a histogram, look for normal distribution
hist(E1) 
# looks bimodal... 

# Graph residuals against a normal distribution, look for all points to be on 1:1 line
#need to call next two lines together
qqnorm(E1, xlab = "Theoretical Quantiles", ylab = "Pearson Residuals")
qqline(E1) # ends are a bit wonky... 

# Graph residuals vs fitted values to inspect homogeneity of variance, look for a random scattering of plots
# run together 2 lines
plot(x=F1, y=E1, xlab="Fitted Model Values", ylab="Pearson Residuals", main = "Variance")
abline(h = 0) # looking for random scatter

#
#
# code from here to the end of the section hasn't been checked. 
#
#

# Check for crazy outliers, look for lines MUCH taller than the rest of data
#plot(cooks.distance(MOD))

# Plot a box plot for each factor, look for equal variance amount levels along the zero line
# Box plots need to be assessed for every fixed effect (categorical factor) for your model. 
# Random effects need the qqline just like normality. 
# So, only site and treatment get box plots. 
# exotic_cover is a covariate (continuous variable).

boxplot(E1 ~ site, data = height_march_surv_may) # <---- make sure to change to df, not the lme
abline(h = 0)
# error message - variable lengths differ
print(height_march_surv_may %>%  # check number of individuals per plot in March 2018
  group_by(site) %>% 
  summarise(N = length(site)))

boxplot(E1 ~ species, data = height_march_surv_may) # <---- make sure to change to df, not the lme
abline(h = 0)
# error message - variable lengths differ <-- omitting rgr in model it now runs
print(height_march_surv_may %>%  # check number of individuals per plot in March 2018
  group_by(species) %>% 
  summarise(N = length(species)))
# species N
# CEOL	  130			
# HEAR	  215			
# RHOV	  136			
# SAAP	  125	

# Plot each random effect in the model - things in the (1|_), look for dots along 1:1 line
qqnorm(ranef(MOD)$plot_number[,1], main = "Plot Residuals")
qqline(ranef(MOD)$plot_number[,1]) # plot number

#qqnorm(ranef(MOD)$individual[,1], main = "Plot Residuals")
#qqline(ranef(MOD)$individual[,1]) # individual: blue, green, S, C, R
```

```{r may 2018 stats by species, include=TRUE}

print(glme.may2018.modspp_CEOL)
summary(glme.may2018.modspp_CEOL)
# Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)  
#(Intercept)                   -0.5339     0.6502  -0.821   0.4116  
#normalized_par                 0.6254     0.3537   1.768   0.0771 .
#soil_moisture                  0.0955     0.3642   0.262   0.7932  
#exotic_percentcover            0.2205     0.2969   0.743   0.4576  
#site2                         -1.9266     0.7697  -2.503   0.0123 * <-- site is significant
#march_stem_height_cm          -0.3505     0.8577  -0.409   0.6828  
#normalized_par:soil_moisture   0.3878     0.3124   1.242   0.2144  

print(glme.may2018.modspp_HEAR)
summary(glme.may2018.modspp_HEAR)
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)  
#(Intercept)                  -0.02166    0.55505  -0.039   0.9689  
#normalized_par               -0.23014    0.25407  -0.906   0.3650  
#soil_moisture                 0.18378    0.28832   0.637   0.5239  
#exotic_percentcover          -0.39685    0.23971  -1.656   0.0978 .
#site2                        -0.46420    0.54116  -0.858   0.3910  
#march_stem_height_cm          1.44888    0.80218   1.806   0.0709 .
#normalized_par:soil_moisture  0.26328    0.25373   1.038   0.2994  

print(glme.may2018.modspp_RHOV)
summary(glme.may2018.modspp_RHOV)
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)  
#(Intercept)                  -0.02166    0.55505  -0.039   0.9689  
#normalized_par               -0.23014    0.25407  -0.906   0.3650  
#soil_moisture                 0.18378    0.28832   0.637   0.5239  
#exotic_percentcover          -0.39685    0.23971  -1.656   0.0978 .
#site2                        -0.46420    0.54116  -0.858   0.3910  
#march_stem_height_cm          1.44888    0.80218   1.806   0.0709 .
#normalized_par:soil_moisture  0.26328    0.25373   1.038   0.2994  

print(glme.may2018.modspp_SAAP)
summary(glme.may2018.modspp_SAAP)
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)   
#(Intercept)                   -0.4643     0.4266  -1.089  0.27635   
#normalized_par                 0.1688     0.3603   0.469  0.63941   
#soil_moisture                  0.2287     0.3756   0.609  0.54257   
#exotic_percentcover            0.2943     0.3278   0.898  0.36926   
#site2                         -2.7165     0.9522  -2.853  0.00433 ** <-- site is significant
#march_stem_height_cm           0.9697     0.5084   1.907  0.05650 . 
#normalized_par:soil_moisture   0.7728     0.4113   1.879  0.06030 . 
```

- by SPECIES x soil moisture
```{r May 2018 figure predict species by levels of par, include=TRUE}

# glmer(may_alive ~ 
#     normalized_par * soil_moisture + exotic_percentcover + species + site + march_stem_height_cm + 
#     (1 | plot_number), data: height_march_surv_may)

# soil moisture x MIN par x HEAR
moisture_low_par_HEAR <- seq(from = -1.6, to = 1.8, by = 0.1) %>% # range of soil moisture from height_march_surv_may
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(height_march_surv_may$normalized_par), # calculate norm_par minimum
         exotic_percentcover = 0,
         site = "1",
         species = "HEAR",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MEAN par x HEAR
moisture_mean_par_HEAR <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = 0, # mean norm_par, data is scale transformed
         exotic_percentcover = 0,
         site = "1",
         species = "HEAR",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MAX par x HEAR
moisture_max_par_HEAR <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(height_march_surv_may$normalized_par), 
         exotic_percentcover = 0,
         site = "1",
         species = "HEAR",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))


# soil moisture x MIN par x CEOL
moisture_low_par_CEOL <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(height_march_surv_may$normalized_par), # calculate norm_par minimum
         exotic_percentcover = 0,
         site = "1",
         species = "CEOL",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MEAN par x CEOL
moisture_mean_par_CEOL <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = 0, # mean norm_par, data is scale transformed
         exotic_percentcover = 0,
         site = "1",
         species = "CEOL",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MAX par x CEOL
moisture_max_par_CEOL <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(height_march_surv_may$normalized_par), 
         exotic_percentcover = 0,
         site = "1",
         species = "CEOL",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MIN par x RHOV
moisture_low_par_RHOV <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(height_march_surv_may$normalized_par), # calculate norm_par minimum
         exotic_percentcover = 0,
         site = "1",
         species = "RHOV",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MEAN par x RHOV
moisture_mean_par_RHOV <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = 0, # mean norm_par, data is scale transformed
         exotic_percentcover = 0,
         site = "1",
         species = "RHOV",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MAX par x RHOV
moisture_max_par_RHOV <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(height_march_surv_may$normalized_par), 
         exotic_percentcover = 0,
         site = "1",
         species = "RHOV",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MIN par x SAAP
moisture_low_par_SAAP <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(height_march_surv_may$normalized_par), # calculate norm_par minimum
         exotic_percentcover = 0,
         site = "1",
         species = "SAAP",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MEAN par x SAAP
moisture_mean_par_SAAP <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = 0, # mean norm_par, data is scale transformed
         exotic_percentcover = 0,
         site = "1",
         species = "SAAP",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MAX par x SAAP
moisture_max_par_SAAP <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(height_march_surv_may$normalized_par), 
         exotic_percentcover = 0,
         site = "1",
         species = "SAAP",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# rbind norm_par min, mean, max for HEAR
moisture_prediction_HEAR <- rbind(moisture_low_par_HEAR, moisture_mean_par_HEAR, moisture_max_par_HEAR)

# rbind norm_par min, mean, max for CEOL
moisture_prediction_CEOL <- rbind(moisture_low_par_CEOL, moisture_mean_par_CEOL, moisture_max_par_CEOL)

# rbind norm_par min, mean, max for RHOV
moisture_prediction_RHOV <- rbind(moisture_low_par_RHOV, moisture_mean_par_RHOV, moisture_max_par_RHOV)

# rbind norm_par min, mean, max for SAAP
moisture_prediction_SAAP <- rbind(moisture_low_par_SAAP, moisture_mean_par_SAAP, moisture_max_par_SAAP)


# prediction figure - HEAR
moisture_HEAR_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "HEAR"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_prediction_HEAR, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1) +
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability",
       title = "HEAR")

# prediction figure - CEOL
moisture_CEOL_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "CEOL"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_prediction_CEOL, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1) +
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability",
       title = "CEOL")

# prediction figure - RHOV
moisture_RHOV_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "RHOV"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_prediction_RHOV, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1) +
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability",
       title = "RHOV")

# prediction figure - SAAP
moisture_SAAP_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "SAAP"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_prediction_SAAP, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1) +
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability",
       title = "SAAP")


moisture_CEOL_graph + moisture_HEAR_graph + moisture_RHOV_graph +moisture_SAAP_graph
```


- by SPECIES
```{r May 2018 figure predict species by levels of tdr, include=TRUE}

# glmer(may_alive ~ 
#     normalized_par * soil_moisture + exotic_percentcover + species + site + march_stem_height_cm + 
#     (1 | plot_number), data: height_march_surv_may)

# par x MIN par x HEAR
par_low_moisture_HEAR <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(height_march_surv_may$soil_moisture), # min tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "HEAR",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MEAN par x HEAR
par_mean_moisture_HEAR <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = 0, # mean tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "HEAR",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MAX par x HEAR
par_max_moisture_HEAR <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(height_march_surv_may$soil_moisture), # max tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "HEAR",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MIN par x CEOL
par_low_moisture_CEOL <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(height_march_surv_may$soil_moisture), # min tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "CEOL",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MEAN par x CEOL
par_mean_moisture_CEOL <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = 0, # mean tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "CEOL",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MAX par x CEOL
par_max_moisture_CEOL <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(height_march_surv_may$soil_moisture), # max tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "CEOL",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MIN par x RHOV
par_low_moisture_RHOV <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(height_march_surv_may$soil_moisture), # min tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "RHOV",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MEAN par x RHOV
par_mean_moisture_RHOV <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = 0, # mean tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "RHOV",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MAX par x RHOV
par_max_moisture_RHOV <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(height_march_surv_may$soil_moisture), # max tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "RHOV",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MIN par x SAAP
par_low_moisture_SAAP <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(height_march_surv_may$soil_moisture), # min tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "SAAP",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MEAN par x SAAP
par_mean_moisture_SAAP <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = 0, # mean tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "SAAP",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MAX par x SAAP
par_max_moisture_SAAP <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(height_march_surv_may$soil_moisture), # max tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "SAAP",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# rbind 
par_prediction_CEOL <- rbind(par_low_moisture_CEOL, par_mean_moisture_CEOL, par_max_moisture_CEOL)
par_prediction_HEAR <- rbind(par_low_moisture_HEAR, par_mean_moisture_HEAR, par_max_moisture_HEAR)
par_prediction_RHOV <- rbind(par_low_moisture_RHOV, par_mean_moisture_RHOV, par_max_moisture_RHOV)
par_prediction_SAAP <- rbind(par_low_moisture_SAAP, par_mean_moisture_SAAP, par_max_moisture_SAAP)

par_CEOL_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "CEOL"), aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_prediction_CEOL, aes(x = normalized_par, y = alive, col = soil_moisture, group = soil_moisture), linewidth = 1) +
  theme_classic() +
  labs(x = "Normalized PAR", 
       y = "Survival Probability",
       title = "CEOL")

par_HEAR_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "HEAR"), aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_prediction_CEOL, aes(x = normalized_par, y = alive, col = soil_moisture, group = soil_moisture), linewidth = 1) +
  theme_classic() +
  labs(x = "Normalized PAR", 
       y = "Survival Probability",
       title = "HEAR")

par_RHOV_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "RHOV"), aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_prediction_CEOL, aes(x = normalized_par, y = alive, col = soil_moisture, group = soil_moisture), linewidth = 1) +
  theme_classic() +
  labs(x = "Normalized PAR", 
       y = "Survival Probability",
       title = "RHOV")

par_SAAP_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "SAAP"), aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_prediction_CEOL, aes(x = normalized_par, y = alive, col = soil_moisture, group = soil_moisture), linewidth = 1) +
  theme_classic() +
  labs(x = "Normalized PAR", 
       y = "Survival Probability",
       title = "SAAP")

par_CEOL_graph + par_HEAR_graph + par_RHOV_graph + par_SAAP_graph
```
# END

## Repeat each model for each species

### CEOL 
```{r CEOL may 2018 predict AIC values, include=TRUE}

# filter for ceol May 2018
ceol_2018 <- height_march_surv_may %>% 
  filter(species == "CEOL")
  
#ONE FACTOR AIC
# par
AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = ceol_2018))

# tdr
AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2018))

# nncover
AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = ceol_2018))

# site
AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = ceol_2018))

# march 2018 stem height
AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2018))

#TWO FACTOR AIC
# site + norm_par
AIC(glmer(as.factor(may_alive) ~ site + normalized_par + (1|plot_number),
          family = binomial,
          data = ceol_2018))

# site + tdr <-- lowest AIC
AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2018))
#[1] 143.3071

# site + nncover
AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = ceol_2018))

# site + march 2018 stem height
AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2018))
```
```{r CEOL may 2018 predict best model, include=TRUE}

summary(glmer(as.factor(may_alive) ~ soil_moisture + normalized_par + exotic_percentcover + march_stem_height_cm + site + (1|plot_number), 
          family = binomial,
          data = ceol_2018))

#Fixed effects:
#                      Estimate Std. Error z value Pr(>|z|)  
#(Intercept)          -0.713440   0.659574  -1.082   0.2794  
#soil_moisture         0.006624   0.372375   0.018   0.9858  
#normalized_par        0.505202   0.350863   1.440   0.1499  
#exotic_percentcover   0.192127   0.311171   0.617   0.5370  
#march_stem_height_cm -0.545067   0.861848  -0.632   0.5271  
#site2                -1.984967   0.809519  -2.452   0.0142 *


## Add Figure
``` 

### RHOV May 2018 - predict survival

```{r RHOV may 2018 AIC values, include=TRUE} 
rhov_2018 <- height_march_surv_may %>% 
  filter(species == "RHOV")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = rhov_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = rhov_2018))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = rhov_2018))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = rhov_2018))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + soil_moisture + (1|plot_number),
          family = binomial,
          data = rhov_2018))
```
```{r RHOV may 2018 prediction model, include=TRUE}

rhov_model <- glmer(as.factor(may_alive) ~ march_stem_height_cm + soil_moisture + normalized_par + exotic_percentcover + site + (1|plot_number),
          family = binomial,
          data = rhov_2018)
summary(rhov_model)

stem_height_rhov_prediction <- seq(from = 0.5, to = 5, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = mean(rhov_2018$soil_moisture), 
         normalized_par = 0, 
         exotic_percentcover = 0,
         site = "1") %>% 
  mutate(alive = predict(rhov_model, newdata = . , type = "response"))

ggplot()+
  geom_point(data = rhov_2018, aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_rhov_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival")


```

### HEAR

```{r}
hear_2018 <- height_march_surv_may %>% 
  filter(species == "HEAR")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture*normalized_par + (1|plot_number),
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + site + (1|plot_number),
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2018))

hear_model <- glmer(as.factor(may_alive) ~ soil_moisture* normalized_par + (1|plot_number), 
                         family = binomial,
                         data = hear_2018)

summary(hear_model)


moisture_hear_low_par <- seq(from = 6, to = 12, by = 0.5) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(hear_2018$normalized_par)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

moisture_hear_mid_par <- seq(from = 6, to = 12, by = 0.5) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = mean(hear_2018$normalized_par)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

moisture_hear_max_par <- seq(from = 6, to = 12, by = 0.5) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(hear_2018$normalized_par)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

moisture_hear_prediction <- rbind(moisture_hear_low_par, moisture_hear_max_par, moisture_hear_mid_par) 

ggplot()+
  geom_point(data = hear_2018, aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_hear_prediction, aes(x = soil_moisture, y = alive, col = normalized_par, group= normalized_par), linewidth = 1)+
  theme_classic()+
  labs(x = "Soil Moisture",
       y = "Probability of Survival")

par_hear_low_moisture <- seq(from = 0.1, to = 0.65, by = 0.01) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(hear_2018$soil_moisture)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

par_hear_mid_moisture <- seq(from = 0.1, to = 0.65, by = 0.01) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = mean(hear_2018$soil_moisture)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

par_hear_max_moisture <- seq(from = 0.1, to = 0.65, by = 0.01) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(hear_2018$soil_moisture)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

par_hear_prediction <- rbind(par_hear_low_moisture, par_hear_max_moisture, par_hear_mid_moisture) 

ggplot()+
  geom_point(data = hear_2018, aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_hear_prediction, aes(x = normalized_par, y = alive, col = soil_moisture, group= soil_moisture), linewidth = 1)+
  theme_classic()+
  labs(x = "Normalized PAR",
       y = "Probability of Survival")

```


SAAP 

```{r}
saap_2018 <- height_march_surv_may %>% 
  filter(species == "SAAP")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ site + normalized_par + (1|plot_number), 
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number), 
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number), 
          family = binomial,
          data = saap_2018))


saap_model <- glmer(as.factor(may_alive) ~ site + (1|plot_number),
                         family = binomial,
                         data = saap_2018)

summary(saap_model)
```

## Individual species for RGR 

### CEOL 

```{r}
ceol_rgr_2018 <- growth_march_may %>% 
  filter(species == "CEOL")
  
AIC(lmer(rgr ~ normalized_par +  (1|plot_number),
                         data = ceol_rgr_2018))

AIC(lmer(rgr ~ soil_moisture*normalized_par + (1|plot_number),
          data = ceol_rgr_2018))

AIC(lmer(rgr ~ exotic_percentcover + (1|plot_number), 
          data = ceol_rgr_2018))

AIC(lmer(rgr ~ site + (1|plot_number),
          data = ceol_rgr_2018))

AIC(lmer(rgr ~ normalized_par +  soil_moisture + (1|plot_number),
                         data = ceol_rgr_2018))

AIC(lmer(rgr ~ normalized_par + exotic_percentcover + (1|plot_number),
                         data = ceol_rgr_2018))

AIC(lmer(rgr ~ normalized_par + site + (1|plot_number),
                         data = ceol_rgr_2018))

ceol_2018rgr_model <- lmer(rgr ~ normalized_par +  (1|plot_number),
                         data = ceol_rgr_2018)

summary(ceol_2018rgr_model)
```
### Rhov

```{r}
rhov_rgr_2018 <- growth_march_may %>% 
  filter(species == "RHOV")
  
AIC(lmer(rgr ~ normalized_par+  (1|plot_number),
                         data = rhov_rgr_2018))

AIC(lmer(rgr ~ soil_moisture + (1|plot_number),
          data = rhov_rgr_2018))

AIC(lmer(rgr ~ exotic_percentcover + (1|plot_number), 
          data = rhov_rgr_2018))

AIC(lmer(rgr ~ site + (1|plot_number),
          data = rhov_rgr_2018))

AIC(lmer(rgr ~ site + normalized_par + (1|plot_number),
          data = rhov_rgr_2018))
AIC(lmer(rgr ~ site + soil_moisture + (1|plot_number),
          data = rhov_rgr_2018))
AIC(lmer(rgr ~ site + exotic_percentcover + (1|plot_number),
          data = rhov_rgr_2018))

rhov_2018rgr_model <- lmer(rgr ~ site + (1|plot_number),
          data = rhov_rgr_2018)
summary(rhov_2018rgr_model)

```

### HEAR

```{r}
hear_rgr_2018 <- growth_march_may %>% 
  filter(species == "HEAR")
  
AIC(lmer(rgr ~ normalized_par +  (1|plot_number),
                         data = hear_rgr_2018))

AIC(lmer(rgr ~ soil_moisture + (1|plot_number),
          data = hear_rgr_2018))

AIC(lmer(rgr ~ exotic_percentcover + (1|plot_number), 
          data = hear_rgr_2018))

AIC(lmer(rgr ~ site + (1|plot_number),
          data = hear_rgr_2018))

AIC(lmer(rgr ~ site + normalized_par + (1|plot_number),
          data = hear_rgr_2018))

AIC(lmer(rgr ~ site + soil_moisture + (1|plot_number),
          data = hear_rgr_2018))

AIC(lmer(rgr ~ site + exotic_percentcover + (1|plot_number),
          data = hear_rgr_2018))

hear_2018rgr_model <- lmer(rgr ~ site + (1|plot_number),
          data = hear_rgr_2018)

summary(hear_2018rgr_model)
```

## SAAP

```{r}
saap_rgr_2018 <- growth_march_may %>% 
  filter(species == "SAAP")
  
# 
AIC(lmer(rgr ~ normalized_par +  (1|plot_number),
                         data = saap_rgr_2018))

AIC(lmer(rgr ~ soil_moisture + (1|plot_number),
          data = saap_rgr_2018))

AIC(lmer(rgr ~ exotic_percentcover + (1|plot_number), 
          data = saap_rgr_2018))

AIC(lmer(rgr ~ site + (1|plot_number),
          data = saap_rgr_2018))

AIC(lmer(rgr ~ normalized_par + soil_moisture + (1|plot_number),
                         data = saap_rgr_2018))

AIC(lmer(rgr ~ normalized_par + exotic_percentcover + (1|plot_number),
                         data = saap_rgr_2018))

AIC(lmer(rgr ~ normalized_par + site + (1|plot_number),
                         data = saap_rgr_2018))

saap_2018rgr_model <- lmer(rgr ~ normalized_par +  (1|plot_number),
                         data = saap_rgr_2018)

summary(saap_2018rgr_model)
```


#January - May 2019 Seedling survival 
  - add height
```{r may 2019 subset environmental data, include=TRUE}
# subsetting data for Jan to May 2019 survival
#
# survmortnospp = may 2019
# par = may 2019
# tdr = march 2019
# nncover = 2019

# par may 2019 
par_may2019 <- dplyr::filter(par, year == "2019" & month =="5") %>% 
  dplyr::select(site, plot_number, treatment, normalized_par) %>% 
  mutate(treatment = case_when(treatment == "no" ~ "none",
                               TRUE ~ treatment))

# tdr March 2019
tdr_march2019 <- tdr %>% 
  dplyr::filter(year == "2019" & month == "3") %>% 
  dplyr::select(site, plot_number, treatment, soil_moisture)  %>% 
  mutate(treatment = case_when(treatment == "nonene" ~ "none",
                               TRUE ~ treatment))
tdr_march2019$site <- factor(tdr_march2019$site, levels = c("1", "2"))

# nncover may-june 2019
nncover_may2019 <- dplyr::filter(exotic_cover_all, year == "2019") %>% 
  dplyr::select(site, plot_number, treatment, cover_percent)
unique(nncover_may2019$plot_number)
glimpse(nncover_may2019)

# join par tdr nncover for may2019
site_cond_may2019 <- full_join(par_may2019, tdr_march2019, by = c("site", "plot_number", "treatment")) %>% 
  full_join(nncover_may2018, by = c("site", "plot_number", "treatment"))
glimpse(site_cond_may2019)

write.csv(site_cond_may2019, "data/processed/may2019_site_conditions.csv")
```

```{r join data environmental and survmort data, include=TRUE}
# Making height and survival dataframe

# height for january 2019
height_jan_2019 <- height_raw %>% 
  filter(date >= "2019-01-25" & date <= "2019-01-30") %>% # filtering to only have rows of data taken in january 2019 
  dplyr::select(plot_number, MAFA_removal, location, species, stem_height_cm, volume_cm3) %>% 
  rename(jan_stem_height_cm = stem_height_cm, 
         jan_volume_cm3 = volume_cm3)

length(unique(height_march_surv_may$plot_number)) # check number of plots 
# 36       

print(height_jan_2019 %>%  # check number of individuals per plot 
  group_by(plot_number) %>% 
  summarise(N = length(jan_stem_height_cm)))
# 11 seedlings per plot

# height may 2019
height_may_2019 <- height_raw %>% 
  filter(date >= "2019-04-30" & date <= "2019-05-30") %>% # filtering to only have rows of data taken in january 2019 
   dplyr::select(plot_number, MAFA_removal, location, species, stem_height_cm, volume_cm3) %>% 
  rename(may_stem_height_cm = stem_height_cm, 
         may_volume_cm3 = volume_cm3)
list(unique(height_may_2019$plot_number)) # check captured all 36 plots with dates

# survival may 2019
survival_may_2019 <- height_raw %>% 
  filter(date>= "2019-04-30" & date <= "2019-05-30") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, alive) %>% 
  rename(may2019_alive = alive) %>% 
  mutate(may2019_alive = replace_na(may2019_alive, 0))  # 0= dead 1 = alive
list(unique(survival_may_2019$plot_number)) # check captured all 36 plots with dates

# growth rate from Jan to May 2019 - GROWTH RATE
growth_jan_may2019 <- right_join(height_jan_2019, height_may_2019, by = c("plot_number", "MAFA_removal", "location", "species")) %>% 
  mutate(jan_stem_height_cm = as.numeric(jan_stem_height_cm)) %>% 
  drop_na() %>% 
  mutate(rgr = (log(may_stem_height_cm) - log(jan_stem_height_cm))/(4*30)) # relative growth rate per day equation; 30 days per month
```


```{r may 2019 full join, include=TRUE}
# full join
height_jan_surv_may_2019 <- full_join(height_jan_2019, survival_may_2019, by = c("plot_number", "MAFA_removal", "location", "species")) %>% 
  mutate(jan_stem_height_cm = as.numeric(jan_stem_height_cm)) %>% 
  drop_na() %>%  # removing na's for now. But should an NA in alive be assumed as dead? 
  mutate(plot_number = as.character(plot_number)) %>% 
  left_join(site_cond_may2019, by = "plot_number") %>% 
  rename(exotic_percentcover = cover_percent) %>% 
  dplyr::select(!MAFA_removal) %>% 
  mutate(normalized_par = scale(normalized_par),
         soil_moisture = scale(soil_moisture),
         exotic_percentcover = scale(exotic_percentcover),
         jan_stem_height_cm = scale(jan_stem_height_cm),
         jan_volume_cm3 = scale(jan_volume_cm3))
view(height_jan_surv_may_2019)

# check number of individuals per plot
print(height_jan_surv_may_2019 %>%  
  group_by(plot_number) %>% 
  summarise(N = length(plot_number))
)

# check number of individuals per species
print(height_jan_surv_may_2019 %>%  
  group_by(species) %>% 
  summarise(N = length(species))
)

# as factor
height_jan_surv_may_2019 <- height_jan_surv_may_2019 %>% 
  mutate(may2019_alive = as.factor(may2019_alive),
         species = as.factor(species),
         site = as.factor(site))
glimpse(height_jan_surv_may_2019)

write.csv(height_jan_surv_may_2019, "data/processed/height_jan_surv_may_2019.csv")

```


```{r}
# data exploration - lookin' at the means 
tapply(as.integer(height_jan_surv_may_2019$may2019_alive), height_jan_surv_may_2019$species, mean)
tapply(as.integer(height_jan_surv_may_2019$may2019_alive), height_jan_surv_may_2019$site, mean)
tapply(as.integer(height_jan_surv_may_2019$may2019_alive), height_jan_surv_may_2019$normalized_par, mean)


```


### How are site 1 and site 2 different? 

```{r jan may 2019 site conditions ttest, include=TRUE}

#soil moisture 
t.test(soil_moisture~site, data = site_cond_may2019) 
# YES sig diff
# data:  soil_moisture by site
# t = 5.6653, df = 29.535, p-value = 3.76e-06
site_cond_may2019 %>%  
  group_by(site) %>% 
  summarize(avg_tdr = mean(soil_moisture), 
            SD = sd(soil_moisture),
            N = length(soil_moisture), 
            SE = ((sd(soil_moisture))/sqrt(length((soil_moisture)))))
# site  mean      SD      N     SE
#1    	22.10556	3.939597	18	0.9285719
#2	    15.79259	2.613453	18	0.6159968


#norm_par
t.test(normalized_par~site, data = site_cond_may2019) 
# not significant
# data:  normalized_par by site
# t = -1.5124, df = 33.969, p-value = 0.1397
site_cond_may2019 %>%  
  group_by(site) %>% 
  summarize(avg_par = mean(normalized_par), 
            SD = sd(normalized_par),
            N = length(normalized_par), 
            SE = ((sd(normalized_par))/sqrt(length((normalized_par)))))
# site  mean   SD      N    SE
#1    	0.3621245	0.2155215	18	0.05079891
#2	    0.4724443	0.2220996	18	0.05234938

#nncover
t.test(cover_percent~site, data = site_cond_may2019)
# Not sig
# data:  cover_percent by site
# t = 0.2511, df = 33.554, p-value = 0.8033
site_cond_may2019 %>%  
  group_by(site) %>% 
  summarize(avg_tdr = mean(cover_percent), 
            SD = sd(cover_percent),
            N = length(cover_percent), 
            SE = ((sd(cover_percent))/sqrt(length((cover_percent)))))
# site  mean   SD      N    SE
#1	36.58889	12.34307	18	2.909289
#2	35.49056	13.85799	18	3.266359


```


```{r may 2019 glmer MODELS, include=TRUE}

MOD.dredge <- dredge(glme.may2019.mod.full)
MOD.dredge <- dredge(glme.may2019.mod.111)
MOD.dredge
#Moreover, the convergence code is zero which indicates that the model has not converged, and the estimated #variance for the random effect is zero. This means that potentially there is no variation within Anim_ID. #It would be a good idea to fit a model with glm() (ie without random intercepts but with Anim_ID as a fixed #effect) and see how the model estimates compare.

glme.may2019.mod.111 <- glmer(as.factor(may2019_alive) ~ site * species
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019)
summary(glme.may2019.mod.full)
# AIC = 468.6 
plot(allEffects(glme.may2019.mod.111))

# FULL MODELS


# WITH EXOTIC COVER

glme.may2019.mod.full <- glmer(as.factor(may2019_alive) ~ 
                             normalized_par + soil_moisture # plus
                            + exotic_percentcover + site # jan_volumne_cm3
                            + jan_volume_cm3 + species # plus
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019)
summary(glme.may2019.mod.full)
# AIC = 471.2 
#Fixed effects:
#                    Estimate Std. Error z value Pr(>|z|)   
#(Intercept)           1.0245     0.3927   2.609  0.00909 **
#normalized_par       -0.2661     0.1741  -1.528  0.12651   
#soil_moisture         0.1661     0.2389   0.695  0.48686   
#exotic_percentcover   0.2204     0.1733   1.272  0.20345   
#site2                -0.9783     0.4753  -2.058  0.03956 * <-- sites
#jan_volume_cm3        0.1931     0.1911   1.010  0.31234   
#speciesHEAR           0.5806     0.4505   1.289  0.19745   
#speciesRHOV          -1.1063     0.3534  -3.130  0.00175 ** <-- species
#speciesSAAP           0.1594     0.3686   0.432  0.66539   

glme.may2019.mod.12 <- glmer(as.factor(may2019_alive) ~ 
                             normalized_par * soil_moisture # times
                            + exotic_percentcover + site # jan_volumne_cm3
                            + jan_volume_cm3 + species # plus
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019)
summary(glme.may2019.mod.12)
#AIC = 471.6
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)   
#(Intercept)                    1.0123     0.3876   2.612  0.00900 **
#normalized_par                -0.2348     0.1720  -1.365  0.17218   
#soil_moisture                  0.1652     0.2331   0.709  0.47847   
#exotic_percentcover            0.1767     0.1725   1.024  0.30565   
#site2                         -0.9033     0.4662  -1.937  0.05270 . 
#jan_volume_cm3                 0.1927     0.1909   1.010  0.31265   
#speciesHEAR                    0.5823     0.4507   1.292  0.19637   
#speciesRHOV                   -1.1030     0.3530  -3.124  0.00178 ** <-- species
#speciesSAAP                    0.1598     0.3686   0.434  0.66451   
#normalized_par:soil_moisture   0.2485     0.1890   1.315  0.18848   



glme.may2019.mod.1 <- glmer(as.factor(may2019_alive) ~ 
                             normalized_par + soil_moisture # plus
                            + exotic_percentcover + site 
                            + jan_stem_height_cm + species # plus
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019)
summary(glme.may2019.mod.1)
# AIC: 472.2
#Fixed effects:
#                    Estimate Std. Error z value Pr(>|z|)   
#(Intercept)          0.90029    0.38777   2.322  0.02025 *  
#normalized_par      -0.27240    0.17384  -1.567  0.11713   
#soil_moisture        0.15323    0.23885   0.642  0.52118   
#exotic_percentcover  0.22781    0.17272   1.319  0.18717   
#site2               -1.02435    0.47720  -2.147  0.03183 * <-- site
#jan_stem_height_cm  -0.05829    0.17871  -0.326  0.74427   
#speciesHEAR          0.95463    0.46296   2.062  0.03921 * <-- species
#speciesRHOV         -1.13462    0.35559  -3.191  0.00142 ** <-- species
#speciesSAAP          0.32528    0.37115   0.876  0.38081 



glme.may2019.mod.2 <- glmer(as.factor(may2019_alive) ~ 
                             normalized_par * soil_moisture # times
                            + exotic_percentcover + site 
                            + jan_stem_height_cm + species # plus
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019)
summary(glme.may2019.mod.2)
# AIC: 472.5
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)   
#(Intercept)                   0.88791    0.38263   2.321  0.02031 * 
#normalized_par               -0.24133    0.17169  -1.406  0.15982   
#soil_moisture                 0.15254    0.23302   0.655  0.51270   
#exotic_percentcover           0.18393    0.17191   1.070  0.28465   
#site2                        -0.95004    0.46811  -2.030  0.04241 * <-- site
#jan_stem_height_cm           -0.06077    0.17846  -0.341  0.73345   
#speciesHEAR                   0.95992    0.46303   2.073  0.03816 * <-- species
#speciesRHOV                  -1.13268    0.35528  -3.188  0.00143 ** <-- species
#speciesSAAP                   0.32639    0.37113   0.879  0.37915   
#normalized_par:soil_moisture  0.24847    0.18851   1.318  0.18748   

glme.may2019.mod.21 <- glmer(as.factor(may2019_alive) ~ 
                             normalized_par + soil_moisture # plus
                            + exotic_percentcover + site 
                            + jan_stem_height_cm * species # times
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019)
summary(glme.may2019.mod.21)
# AIC = 477.7
#Fixed effects:
#                               Estimate Std. Error z value Pr(>|z|)  
#(Intercept)                     0.86136    0.49678   1.734   0.0829 .
#normalized_par                 -0.26414    0.17618  -1.499   0.1338  
#soil_moisture                   0.14782    0.24146   0.612   0.5404  
#exotic_percentcover             0.23210    0.17449   1.330   0.1835  
#site2                          -1.06084    0.48574  -2.184   0.0290 * <-- site
#jan_stem_height_cm             -0.16167    0.54309  -0.298   0.7659  
#speciesHEAR                     0.91391    0.58577   1.560   0.1187  
#speciesRHOV                    -0.81785    0.69048  -1.184   0.2362  
#speciesSAAP                     0.39747    0.47028   0.845   0.3980  
#jan_stem_height_cm:speciesHEAR  0.20696    0.63341   0.327   0.7439  
#jan_stem_height_cm:speciesRHOV  0.44242    0.85271   0.519   0.6039  
#jan_stem_height_cm:speciesSAAP  0.02396    0.59603   0.040   0.9679  

glme.may2019.mod.3 <- glmer(as.factor(may2019_alive) ~ 
                             normalized_par * soil_moisture # times
                            + exotic_percentcover + site 
                            + jan_stem_height_cm * species # times
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019)
summary(glme.may2019.mod.3)
# Warning: Model failed to converge with max|grad| = 0.00819763 (tol = 0.002, component 1)
# AIC = 478.0
#Fixed effects:
#                               Estimate Std. Error z value Pr(>|z|)  
#(Intercept)                     0.84716    0.49127   1.724   0.0846 .
#normalized_par                 -0.23316    0.17411  -1.339   0.1805  
#soil_moisture                   0.14801    0.23571   0.628   0.5300  
#exotic_percentcover             0.18824    0.17372   1.084   0.2785  
#site2                          -0.98447    0.47674  -2.065   0.0389 * <-- site
#jan_stem_height_cm             -0.16675    0.54292  -0.307   0.7587  
#speciesHEAR                     0.91146    0.58562   1.556   0.1196  
#speciesRHOV                    -0.83344    0.68760  -1.212   0.2255  
#speciesSAAP                     0.39950    0.46864   0.852   0.3940  
#normalized_par:soil_moisture    0.24927    0.19034   1.310   0.1903  
#jan_stem_height_cm:speciesHEAR  0.21834    0.63371   0.345   0.7304  
#jan_stem_height_cm:speciesRHOV  0.42159    0.85129   0.495   0.6204  
#jan_stem_height_cm:speciesSAAP  0.02646    0.59588   0.044   0.9646  
glme.may2019.mod.3glm <- glm(as.factor(may2019_alive) ~ 
                             normalized_par * soil_moisture # times
                            + exotic_percentcover + site 
                            + jan_stem_height_cm * species # times
                            + plot_number, 
                         family = binomial, 
                         data = height_jan_surv_may_2019)
summary(glme.may2019.mod.3glm)
# only Plot 4 was significant


# OMIT EXOTIC COVER


glme.may2019.mod.51 <- (glmer(as.factor(may2019_alive) ~ 
                             normalized_par * soil_moisture # times
                             + site # no exotic cover, with volume
                            + jan_volume_cm3 + species # plus
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019))
summary(glme.may2019.mod.51)
# AIC = 470.6
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)   
#(Intercept)                    0.9858     0.3877   2.542   0.0110 * 
#normalized_par                -0.2079     0.1710  -1.216   0.2239   
#soil_moisture                  0.2207     0.2296   0.961   0.3366   
#site2                         -0.8357     0.4653  -1.796   0.0725 . 
#jan_volume_cm3                 0.2003     0.1909   1.050   0.2939   
#speciesHEAR                    0.5708     0.4505   1.267   0.2051   
#speciesRHOV                   -1.1008     0.3527  -3.121   0.0018 ** <-- species
#speciesSAAP                    0.1541     0.3686   0.418   0.6759   
#normalized_par:soil_moisture   0.2851     0.1872   1.523   0.1279   


glme.may2019.mod.5 <- (glmer(as.factor(may2019_alive) ~ 
                             normalized_par * soil_moisture # times
                             + site # no exotic cover
                            + jan_stem_height_cm + species # plus
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019))
summary(glme.may2019.mod.5)
# AIC: 471.7
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)   
#(Intercept)                   0.85619    0.38308   2.235  0.02541 * 
#normalized_par               -0.21410    0.17104  -1.252  0.21067   
#soil_moisture                 0.21054    0.22996   0.916  0.35989   
#site2                        -0.87985    0.46786  -1.881  0.06003 . 
#jan_stem_height_cm           -0.05969    0.17888  -0.334  0.73861   
#speciesHEAR                   0.95833    0.46390   2.066  0.03885 * <-- species
#speciesRHOV                  -1.13097    0.35502  -3.186  0.00144 ** <-- species
#speciesSAAP                   0.32563    0.37127   0.877  0.38045   
#normalized_par:soil_moisture  0.28700    0.18706   1.534  0.12498  

glme.may2019.mod.4 <- glmer(as.factor(may2019_alive) ~ 
                             normalized_par + soil_moisture # plus
                             + site # no exotic cover
                            + jan_stem_height_cm + species # plus
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019)
summary(glme.may2019.mod.4)
# AIC: 471.9
#Fixed effects:
#                   Estimate Std. Error z value Pr(>|z|)   
#(Intercept)          0.8622     0.3902   2.210  0.02711 * 
#normalized_par      -0.2422     0.1751  -1.383  0.16651   
#soil_moisture        0.2271     0.2378   0.955  0.33947   
#site2               -0.9508     0.4824  -1.971  0.04876 *<-- site
#jan_stem_height_cm  -0.0564     0.1793  -0.315  0.75310   
#speciesHEAR          0.9521     0.4641   2.052  0.04021 * <-- species
#speciesRHOV         -1.1327     0.3553  -3.188  0.00143 ** <-- species
#speciesSAAP          0.3242     0.3714   0.873  0.38268  

glme.may2019.mod.41 <- glmer(as.factor(may2019_alive) ~ 
                             normalized_par + soil_moisture # plus
                             + site # no exotic cover, with volume
                            + jan_volume_cm3 + species # plus
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019)
summary(glme.may2019.mod.41)
# AIC: 470.9
#Fixed effects:
#               Estimate Std. Error z value Pr(>|z|)   
#(Intercept)      0.9922     0.3947   2.514  0.01194 * 
#normalized_par  -0.2360     0.1749  -1.349  0.17722   
#soil_moisture    0.2376     0.2374   1.001  0.31679   
#site2           -0.9064     0.4796  -1.890  0.05876 . 
#jan_volume_cm3   0.2027     0.1913   1.059  0.28950   
#speciesHEAR      0.5666     0.4503   1.258  0.20826   
#speciesRHOV     -1.1039     0.3531  -3.127  0.00177 **
#speciesSAAP      0.1524     0.3687   0.413  0.67934   



glme.may2019.mod.6 <- glmer(as.factor(may2019_alive) ~ 
                             normalized_par * soil_moisture # times
                             + site # no exotic cover
                            + jan_stem_height_cm  *species # times
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019)
#Warning: Model failed to converge with max|grad| = 0.00318041 (tol = 0.002, component 1)
summary(glme.may2019.mod.6)
# AIC = 477.2
# Fixed effects:
#                                Estimate Std. Error z value Pr(>|z|)  
#(Intercept)                     0.826763   0.492816   1.678   0.0934 .
#normalized_par                 -0.205320   0.173594  -1.183   0.2369  
#soil_moisture                   0.206357   0.232664   0.887   0.3751  
#site2                          -0.913006   0.476358  -1.917   0.0553 .
#jan_stem_height_cm             -0.144412   0.541825  -0.267   0.7898  
#speciesHEAR                     0.903075   0.586836   1.539   0.1238  
#speciesRHOV                    -0.847588   0.688692  -1.231   0.2184  
#speciesSAAP                     0.387224   0.469691   0.824   0.4097  
#normalized_par:soil_moisture    0.288910   0.188962   1.529   0.1263  
#jan_stem_height_cm:speciesHEAR  0.191418   0.632532   0.303   0.7622  
#jan_stem_height_cm:speciesRHOV  0.394426   0.849417   0.464   0.6424  
#jan_stem_height_cm:speciesSAAP  0.003975   0.594995   0.007   0.9947  




# MINIMAL MODELS

glme.may2018.mod.7 <- glmer(may_alive ~ 
                             normalized_par + soil_moisture + species + (1|plot_number), # plus
                         family = binomial, 
                         data = height_march_surv_may)
summary(glme.may2018.mod.7)
# AIC: 701.6 

glme.may2018.mod.8 <- glmer(may_alive ~ 
                             normalized_par * soil_moisture + species + (1|plot_number), # times
                         family = binomial, 
                         data = height_march_surv_may)
summary(glme.may2018.mod.8)
# AIC: 691.3  
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                   -1.0399     0.2213  -4.700 2.60e-06 ***
#normalized_par                 0.1509     0.1307   1.154 0.248345    
#soil_moisture                  0.5266     0.1319   3.991 6.57e-05 *** <-- tdr
#speciesHEAR                    0.9700     0.2546   3.810 0.000139 *** <-- species
#speciesRHOV                   -0.1128     0.2929  -0.385 0.700109    
#speciesSAAP                   -0.6973     0.3245  -2.149 0.031647 *  <-- species
#normalized_par:soil_moisture   0.5329     0.1466   3.636 0.000277 ***<-- tdr x par

 
# RELATIVE GROWTH RATE

# relative growth rate as dependent variable - Shane's code
glme_rgr_may2018.1 <- lmer(rgr ~ normalized_par*soil_moisture + exotic_percentcover + site + (1|plot_number),
                         data = growth_march_may)
summary(glme_rgr_may2018.1)
# no AIC
# Site 2 is significant

```

```{r may 2019 glmer, include =TRUE}

glme.may2019.mod <- (glmer(as.factor(may2019_alive) ~ 
                             normalized_par + soil_moisture # times
                             #+ site # no exotic cover, with volume
                            + jan_volume_cm3 + species # plus 
                            + (1|plot_number), 
                         family = binomial, 
                         data = height_jan_surv_may_2019))

MOD <- glme.may2019.mod 

simulationOutput <- simulateResiduals(fittedModel = MOD, plot = T)
testDispersion(simulationOutput)
plot(simulationOutput)
hist(simulationOutput)
testResiduals(simulationOutput)
plotResiduals(simulationOutput, height_jan_surv_may_2019$species) # you're looking for flat red line
plotResiduals(simulationOutput, height_jan_surv_may_2019$site) # 
# The testDispersion() function gives us a histogram of simulated expected values, and then a red line indicating our observed dispersion in our actual data. Additionally, this function performs a statistical test of our dispersion with the null hypothesis being “We do not have overdispersion”. 
# dispersion = 1.0114, p-value = 0.808
plot(residuals(MOD))
binned_residuals(MOD)
# Warning: About 80% of the residuals are inside the error bounds (~95% or higher would be good).
plot(allEffects(MOD))
r2(MOD)
# Conditional: R2 like a line
# Marginal R2: takes into account only fixed effects without random effects

#visualize alive data by random effect 
dotplot(ranef(MOD, condVar = T)) #condVar adds 95% confidence intervals around random effects estimates

# visualize data by plotting alive by random effect 
random.intercepts = ranef(MOD)$plot_number[["(Intercept)"]] # create vector of random intercepts by pulling them from model
plot.intercepts = fixef(MOD)[1] + random.intercepts # create intercepts estimates by adding effects together
#for loop creating each individual curve ~ plot number
for (i in 1:length(random.intercepts)) {
  
  if (i ==1) curve(exp(plot.intercepts[i] + fixef(MOD)["Soil Moisture"]*x)/
                     (1 + exp(plot.intercepts[i] + fixef(MOD)["Soil Moisture"]*x)),
                   from = min(height_jan_surv_may_2019$soil_moisture), to = max(height_jan_surv_may_2019$soil_moisture), ylim = c(0,1), 
                   xlab = "Centered Soil Moisture", ylab = "Probability of Alive Jan-May 2019")
  
  if (i > 1) curve(exp(plot.intercepts[i] + fixef(MOD)["Soil Moisture"]*x)/
                     (1 + exp(plot.intercepts[i] + fixef(MOD)["Length"]*x)),
                   add = T)
}




# Calculate model's residual and fitted values
F1 <- fitted(MOD)
E1 <- residuals(MOD, "pearson")

# Graph residuals vs fitted values to inspect homogeneity of variance, look for a random scattering of plots
# run together 2 lines
plot(x=F1, y=E1, xlab="Fitted Model Values", ylab="Pearson Residuals", main = "Variance")
abline(h = 0) # looking for random scatter

# Check for crazy outliers, look for lines MUCH taller than the rest of data
plot(cooks.distance(MOD))


# Plot a box plot for each factor, look for equal variance amount levels along the zero line
# Box plots need to be assessed for every fixed effect (categorical factor) for your model. 
# Random effects need the qqline just like normality. 
# So, only site and treatment get box plots. 
# exotic_cover is a covariate (continuous variable).

boxplot(E1 ~ site, data = height_jan_surv_may_2019) # <---- make sure to change to df, not the glmer
abline(h = 0)

boxplot(E1 ~ species, data = height_jan_surv_may_2019) # <---- make sure to change to df, not the lme
abline(h = 0)

# Plot each random effect in the model - things in the (1|_), look for dots along 1:1 line
qqnorm(ranef(MOD)$plot_number[,1], main = "Plot Residuals")
qqline(ranef(MOD)$plot_number[,1]) # plot number


```


### Jan-May 2019 stats

```{r may 2019 summary stats, include=TRUE}
print(glme.may2019.mod)
summary(glme.may2019.mod)
dispersiontest(glme.may2019.mod, trafo = NULL, alternative = c("greater", "two.sided", "less"))
anova(glme.may2019.mod) # no p-values

#Formula: as.factor(may2019_alive) ~ normalized_par * soil_moisture + site +  
#    jan_volume_cm3 + species + (1 | plot_number)
#   Data: height_jan_surv_may_2019
# AIC = 470.6
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)   
#(Intercept)                    0.9858     0.3877   2.542   0.0110 * 
#normalized_par                -0.2079     0.1710  -1.216   0.2239   
#soil_moisture                  0.2207     0.2296   0.961   0.3366   
#site2                         -0.8357     0.4653  -1.796   0.0725 . 
#jan_volume_cm3                 0.2003     0.1909   1.050   0.2939   
#speciesHEAR                    0.5708     0.4505   1.267   0.2051   
#speciesRHOV                   -1.1008     0.3527  -3.121   0.0018 ** <-- species
#speciesSAAP                    0.1541     0.3686   0.418   0.6759   
#normalized_par:soil_moisture   0.2851     0.1872   1.523   0.1279   


```


```{r may 2019 post hoc, include=TRUE}

glmm_interactionmay2019_species <- glmer(factor(may2019_alive) ~  species +
                            (1|plot_number),
                          family = binomial(link = "logit"),
                          data = height_jan_surv_may_2019)
summary(glmm_interactionmay2019_species)
#Fixed effects:
#            Estimate Std. Error z value Pr(>|z|)   
#(Intercept)   0.4300     0.3210   1.340  0.18035   
#speciesHEAR   0.8546     0.3609   2.368  0.01789 * 
#speciesRHOV  -1.1293     0.3525  -3.204  0.00136 **
#speciesSAAP   0.2774     0.3472   0.799  0.42431   

glmm_interactionmay2019_site <- glmer(factor(may2019_alive) ~  site +
                            (1|plot_number),
                          family = binomial(link = "logit"),
                          data = height_jan_surv_may_2019)
summary(glmm_interactionmay2019_site)
# Fixed effects:
#            Estimate Std. Error z value Pr(>|z|)    
#(Intercept)   0.9988     0.2277   4.387 1.15e-05 ***
#site2        -1.2197     0.3127  -3.900 9.62e-05 ***

# STEPHANIE - START HERE (May 12, 2023)

```

```{r}
## Soil moisture

moisture_site_1_low_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = min(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "1",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_2_low_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = min(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "2",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_1_mean_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = 0,
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "1",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_2_mean_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = 0,
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "2",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_1_max_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = max(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "1",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_2_max_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = max(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "2",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_1_prediction_2019 <- rbind(moisture_site_1_low_par_2019, moisture_site_1_mean_par_2019, moisture_site_1_max_par_2019)
moisture_site_2_prediction_2019 <- rbind(moisture_site_2_low_par_2019, moisture_site_2_mean_par_2019, moisture_site_2_max_par_2019)

site_1_sm_plot <- ggplot()+
  geom_point(data = height_march_surv_may_2019 %>%  filter(site == "1"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25) +
  geom_line(data = moisture_site_1_prediction_2019, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1)+
  theme_classic()+
  labs(x = "Soil Moisture (%)",
       y = "Probability of Survival",
       title = "Site 1")

site_2_sm_plot <- ggplot()+
  geom_point(data = height_march_surv_may_2019 %>%  filter(site == "2"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_site_2_prediction_2019, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1)+
  theme_classic()+
  labs(x = "Soil Moisture (%)",
       y = "Probability of Survival",
       title = "Site 2")

site_1_sm_plot + site_2_sm_plot
## stem height
stem_height_site_1_prediction <- seq(from = -1.7, to = 3.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(normalized_par = mean(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "1",
         soil_moisture = mean(height_march_surv_may_2019$soil_moisture),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

stem_height_site_2_prediction <- seq(from = -1.7, to = 3.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(normalized_par = mean(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "2",
         soil_moisture = mean(height_march_surv_may_2019$soil_moisture),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

site_1_sh_plot <- ggplot()+
  geom_point(data = height_march_surv_may_2019 %>%  filter(site == "1"), aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_site_1_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival",
       title = "Site 1")

site_2_sh_plot <- ggplot()+
  geom_point(data = height_march_surv_may_2019 %>%  filter(site == "2"), aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_site_2_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival",
       title = "Site 2")

site_1_sh_plot + site_2_sh_plot
```


## Repeat each model for each species

### CEOL 
```{r}
ceol_2019 <- height_march_surv_may_2019 %>% 
  filter(species == "CEOL")
  
AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ site + normalized_par + (1|plot_number),
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2019))


summary(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = ceol_2019))

## Add Figure
``` 

### RHOV

```{r} 
rhov_2019 <- height_march_surv_may_2019 %>% 
  filter(species == "RHOV")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ site + normalized_par +(1|plot_number), 
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number), 
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number), 
          family = binomial,
          data = rhov_2019))

rhov_model <- glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = rhov_2019)
summary(rhov_model)
```

### HEAR

```{r}
hear_2019 <- height_march_surv_may_2019 %>% 
  filter(species == "HEAR")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ normalized_par + site + (1|plot_number),
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2019))

hear_moisture_model_2019 <- glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number), 
                         family = binomial,
                         data = hear_2019)

summary(hear_moisture_model_2019)

hear_moisture_pred_2019 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = 1) %>% 
  mutate(alive = predict(hear_moisture_model_2019, newdata = ., type = "response"))

ggplot()+
  geom_point(data = hear_2019, aes(x = soil_moisture, y = may_alive), alpha = 0.5) +
  geom_line(data = hear_moisture_pred_2019, aes(x = soil_moisture, y = alive), linewidth = 1) +
  theme_classic()


```



```{r}
saap_2019 <- height_march_surv_may %>% 
  filter(species == "SAAP")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ site + normalized_par + (1|plot_number), 
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number), 
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number), 
          family = binomial,
          data = saap_2019))


saap_model <- glmer(as.factor(may_alive) ~ site + (1|plot_number),
                         family = binomial,
                         data = saap_2018)

summary(saap_model)
```
# Survival May - September 2019

```{r MAY 2019 subset data, include=FALSE}
par_may2019 <- dplyr::filter(par, year == "2019" & month =="9")

tdr_july2019 <- tdr %>% 
  dplyr::filter(year == "2019" & month == "7")

nncover_may2019 <- 
  
tdr_may2019 <- 
  

```

```{r may 2019 height survival df, include=TRUE}
# Making height and survival dataframe

height_may_2019 <- height_raw %>% 
  filter(date>= "2019-04-30" & date <= "2019-05-01") %>% # filtering to only have rows of data taken in March 
  dplyr::select(plot_number, MAFA_removal, location, species, stem_height_cm) %>% 
  rename(may_stem_height_cm = stem_height_cm)

survival_sep_2019 <- height_raw %>% 
  filter(date == "2019-09-19") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, alive) %>% 
  rename(sep_alive = alive) %>% 
  mutate(sep_alive = replace_na(sep_alive, 0))  # 0= dead 1 = alive

height_may_surv_sep_2019 <- full_join(height_may_2019, survival_sep_2019, by = c("plot_number", "MAFA_removal", "location", "species")) %>% 
  mutate(may_stem_height_cm = as.numeric(may_stem_height_cm)) %>% 
  drop_na() %>%  # removing na's for now. But should an NA in alive be assumed as dead? 
  mutate(plot_number = as.character(plot_number)) %>% 
  left_join(par_april2018, by = "plot_number") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, may_stem_height_cm, sep_alive, normalized_par) %>% 
  left_join(tdr_april2018, by = "plot_number") %>% 
  dplyr::select(!site & !treatment) %>% 
  left_join(nncover_may2018, by = "plot_number") %>% 
  dplyr::select(!treatment) %>% 
  rename(exotic_percentcover = cover_percent) %>% 
  rename(treatment = MAFA_removal) %>% 
  mutate(normalized_par = scale(normalized_par),
         soil_moisture = scale(soil_moisture),
         exotic_percentcover = scale(exotic_percentcover), 
         may_stem_height_cm = scale(may_stem_height_cm))
```

```{r}
glme.sep2019.mod <- glmer(as.factor(sep_alive) ~ normalized_par +  soil_moisture  + exotic_percentcover + site + may_stem_height_cm  + species + (1|plot_number), 
                         family = binomial,
                         data = height_may_surv_sep_2019)
                         

MOD <- glme.may2019.mod

# Calculate model's residual and fitted values
F1 <- fitted(MOD)
E1 <- residuals(MOD, "pearson")

# See residuals as a histogram, look for normal distribution
hist(E1)

# Graph residuals against a normal distribution, look for all points to be on 1:1 line
#need to call next two lines together
qqnorm(E1, xlab = "Theoretical Quantiles", ylab = "Pearson Residuals")
qqline(E1)

# Graph residuals vs fitted values to inspect homogeneity of variance, look for a random scattering of plots
# run together 2 lines
plot(x=F1, y=E1, xlab="Fitted Model Values", ylab="Pearson Residuals", main = "Variance")
abline(h = 0) # looking for random scatter

# Check for crazy outliers, look for lines MUCH taller than the rest of data
plot(cooks.distance(MOD))

# Plot a box plot for each factor, look for equal variance amount levels along the zero line
# Box plots need to be assessed for every fixed effect (categorical factor) for your model. 
# Random effects need the qqline just like normality. 
# So, only site and treatment get box plots. 
# MAFA cover is a covariate (continuous variable).

boxplot(E1 ~ site, data = height_march_surv_may_2019) # <---- make sure to change to df, not the lme
abline(h = 0)

# Plot each random effect in the model - things in the (1|_), look for dots along 1:1 line
#qqnorm(ranef(MOD)$treatment[,1], main = "Plot Residuals")
#qqline(ranef(MOD)$treatment[,1]) # unique dates

```

```{r}
print(glme.sep2019.mod)
summary(glme.sep2019.mod)

exotic_site1_2019 <- seq(from = -2.2, to = 2.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(exotic_percentcover = ".") %>% 
  mutate(normalized_par = 0,
         soil_moisture = 0, 
         site = "1",
         may_stem_height_cm = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(glme.sep2019.mod, newdata = ., type = "response"))

exotic_site2_2019 <- seq(from = -2.2, to = 2.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(exotic_percentcover = ".") %>% 
  mutate(normalized_par = 0,
         soil_moisture = 0, 
         site = "2",
         may_stem_height_cm = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(glme.sep2019.mod, newdata = ., type = "response"))

exotic_site1_plot_2019 <- ggplot() +
  geom_point(data = height_may_surv_sep_2019 %>%  filter(site == "1"), aes(x = exotic_percentcover, y = sep_alive), alpha = 0.25)+
  geom_line(data = exotic_site1_2019, aes(x= exotic_percentcover, y = alive), linewidth = 1)+
  theme_classic() +
  labs(title = "Site 1",
       x = "Exotic Percent Cover",
       y = "Survival Probability")

exotic_site2_plot_2019 <- ggplot() +
  geom_point(data = height_may_surv_sep_2019 %>%  filter(site == "2"), aes(x = exotic_percentcover, y = sep_alive), alpha = 0.25)+
  geom_line(data = exotic_site2_2019, aes(x= exotic_percentcover, y = alive), linewidth = 1)+
  theme_classic() +
  labs(title = "Site 2",
       x = "Exotic Percent Cover",
       y = "Survival Probability")

exotic_site1_plot_2019 + exotic_site2_plot_2019

height_site1_2019 <- seq(from = -1.6, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(may_stem_height_cm = ".") %>% 
  mutate(normalized_par = 0, 
         soil_moisture = 0,
         exotic_percentcover = 0,
         site = "1",
         plot_number = 1) %>% 
  mutate(alive = predict(glme.sep2019.mod, newdata = ., type = "response"))

height_site2_2019 <- seq(from = -1.6, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(may_stem_height_cm = ".") %>% 
  mutate(normalized_par = 0, 
         soil_moisture = 0,
         exotic_percentcover = 0,
         site = "2",
         plot_number = 1) %>% 
  mutate(alive = predict(glme.sep2019.mod, newdata = ., type = "response"))

height_site1_plot_2019 <- ggplot()+
  geom_point(data = height_may_surv_sep_2019 %>%  filter(site == "1"), aes(x = may_stem_height_cm, y = sep_alive), alpha = 0.25) +
  geom_line(data = height_site1_2019, aes(x = may_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(title = "Site 1",
       x = "Stem Height (cm)",
       y = "Survival Probability")

height_site2_plot_2019 <- ggplot()+
  geom_point(data = height_may_surv_sep_2019 %>%  filter(site == "2"), aes(x = may_stem_height_cm, y = sep_alive), alpha = 0.25) +
  geom_line(data = height_site2_2019, aes(x = may_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(title = "Site 2",
       x = "Stem Height (cm)",
       y = "Survival Probability")

height_site1_plot_2019 + height_site2_plot_2019

```

## Repeat each model for each species

### CEOL 
```{r}
ceol_2019_sep <- height_may_surv_sep_2019 %>% 
  filter(species == "CEOL")
  
AIC(glmer(as.factor(sep_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + normalized_par + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

ceol_2019_sep_model <- glmer(as.factor(sep_alive) ~ soil_moisture + (1|plot_number), 
          family = binomial,
          data = ceol_2019_sep)

summary(ceol_2019_sep_model)

ceol_moisture_2019 <- seq(from = -1.7, to = 1.7, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = 1) %>% 
  mutate(alive = predict(ceol_2019_sep_model, newdata = ., type = "response"))

ggplot()+
  geom_point(data = ceol_2019_sep, aes(x = soil_moisture, y = sep_alive), alpha = 0.25) +
  geom_line(data = ceol_moisture_2019, aes(x = soil_moisture, y = alive), linewidth = 1)+
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability")

``` 

### RHOV

```{r} 
rhov_2019_sep <- height_may_surv_sep_2019 %>% 
  filter(species == "RHOV")

AIC(glmer(as.factor(sep_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + normalized_par +(1|plot_number), 
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + soil_moisture + (1|plot_number), 
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + (1|plot_number), 
          family = binomial,
          data = rhov_2019_sep))

rhov_2019_sep_model <- glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = rhov_2019)
summary(rhov_2019_sep_model)
```

### HEAR

```{r}
hear_2019_sep <- height_may_surv_sep_2019 %>% 
  filter(species == "HEAR")

AIC(glmer(as.factor(sep_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ normalized_par + site + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + exotic_percentcover + soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + exotic_percentcover + normalized_par + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + exotic_percentcover + may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

hear_2019_sep_model <- glmer(as.factor(sep_alive) ~ site + exotic_percentcover + (1|plot_number), 
                         family = binomial,
                         data = hear_2019_sep)

summary(hear_2019_sep_model)

hear_exotic_site1_2019 <- seq(from = -2.2, to = 2.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(exotic_percentcover = ".") %>% 
  mutate(site = "1",
         plot_number = 1) %>% 
  mutate(alive = predict(hear_2019_sep_model, newdata = ., type = "response"))

hear_exotic_site2_2019 <- seq(from = -2.2, to = 2.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(exotic_percentcover = ".") %>% 
  mutate(site = "2",
         plot_number = 1) %>% 
  mutate(alive = predict(hear_2019_sep_model, newdata = ., type = "response"))

hear_exotic_site1_plot_2019 <- ggplot()+
  geom_point(data = hear_2019_sep %>% filter(site == "1"), aes(x = exotic_percentcover, y = sep_alive), alpha = 0.5) +
  geom_line(data = hear_exotic_site1_2019, aes(x = exotic_percentcover, y = alive), linewidth = 1) +
  theme_classic() +
  labs(title = "Site 1",
       x = "Exotic Percent Cover",
       y = "Survival Probability")

hear_exotic_site2_plot_2019 <- ggplot()+
  geom_point(data = hear_2019_sep %>% filter(site == "2"), aes(x = exotic_percentcover, y = sep_alive), alpha = 0.5) +
  geom_line(data = hear_exotic_site2_2019, aes(x = exotic_percentcover, y = alive), linewidth = 1) +
  theme_classic() +
  labs(title = "Site 2",
       x = "Exotic Percent Cover",
       y = "Survival Probability")

hear_exotic_site1_plot_2019 + hear_exotic_site2_plot_2019

```



```{r}
saap_2019_sep <- height_may_surv_sep_2019 %>%
  filter(species == "SAAP")

AIC(glmer(as.factor(sep_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~  + (1|plot_number),
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + normalized_par + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + soil_moisture + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + normalized_par + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + soil_moisture + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + normalized_par + soil_moisture + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + normalized_par + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

saap_2019_sep_model <- glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + normalized_par + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep)

summary(saap_2019_sep_model)

saap_height_site1_2019 <- seq(from = -1.4, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(may_stem_height_cm = ".") %>% 
  mutate(site = "1",
         normalized_par = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(saap_2019_sep_model, newdata = ., type = "response"))

saap_height_site2_2019 <- seq(from = -1.4, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(may_stem_height_cm = ".") %>% 
  mutate(site = "2",
         normalized_par = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(saap_2019_sep_model, newdata = ., type = "response"))


saap_height_site1_plot_2019 <- ggplot()+
  geom_point(data = saap_2019_sep %>% filter(site == "1"), aes(x = may_stem_height_cm, y = sep_alive), alpha = 0.5) +
  geom_line(data = saap_height_site1_2019, aes(x = may_stem_height_cm, y = alive), linewidth = 1) +
  theme_classic()+
  labs(title = "Site 1",
       x = "Stem Height (cm)",
       y = "Survival Probability")

saap_height_site2_plot_2019 <- ggplot()+
  geom_point(data = saap_2019_sep %>% filter(site == "2"), aes(x = may_stem_height_cm, y = sep_alive), alpha = 0.5) +
  geom_line(data = saap_height_site2_2019, aes(x = may_stem_height_cm, y = alive), linewidth = 1) +
  theme_classic()+
  labs(title = "Site 2",
       x = "Stem Height (cm)",
       y = "Survival Probability")

saap_height_site1_plot_2019 + saap_height_site2_plot_2019

saap_par_site1_2019 <- seq(from = -1.7, to = 2.3, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(site = "1",
         may_stem_height_cm = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(saap_2019_sep_model, newdata = ., type = "response"))

saap_par_site2_2019 <- seq(from = -1.7, to = 2.3, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(site = "2",
         may_stem_height_cm = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(saap_2019_sep_model, newdata = ., type = "response"))


saap_par_site1_plot_2019 <- ggplot()+
  geom_point(data = saap_2019_sep %>% filter(site == "1"), aes(x = normalized_par, y = sep_alive), alpha = 0.5) +
  geom_line(data = saap_par_site1_2019, aes(x = normalized_par, y = alive), linewidth = 1) +
  theme_classic()+
  labs(title = "Site 1",
       x = "Normalized PAR",
       y = "Survival Probability")

saap_par_site2_plot_2019 <- ggplot()+
  geom_point(data = saap_2019_sep %>% filter(site == "2"), aes(x = normalized_par, y = sep_alive), alpha = 0.5) +
  geom_line(data = saap_par_site2_2019, aes(x = normalized_par, y = alive), linewidth = 1) +
  theme_classic()+
  labs(title = "Site 2",
       x = "Normalized PAR",
       y = "Survival Probability")

saap_par_site1_plot_2019 + saap_par_site2_plot_2019
```
  
  