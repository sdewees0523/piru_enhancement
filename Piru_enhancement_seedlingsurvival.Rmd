---
title: "Piru_enhancement_seedlingsurvival"
author: "Stephanie Ma Lucero"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load libraries

```{r libraries, message=FALSE}
library(here) # similar to set working directory
library(dplyr) # includes functions:
library(tidyverse) # data wrangling, includes packages: ggplot2, tibble, tidyr, rear, purrr, stringr, forcats
library(lme4)
library(lmerTest)
library(emmeans) 
library(lubridate)
library(patchwork)
```

# Load colors for graphs

```{r colors, include=TRUE}
devtools::install_github("an-bui/calecopal")

library(calecopal)
# all palettes
names(cal_palettes)

# Site colors: 1, 2 
cal_palette(name = "chaparral1", n = 5, type = "continuous") # [1] "#DCC27A" "#F19B34"
site1color <- "#DCC27A"
site2color <- "#F19B34"
site1outline <- "#9C8A58"
site2outline <- "#936126"
sitecolors <- c(site1color, site2color)

# Treatment colors: Full, half, none 
cal_palette(name = "chaparral3", n = 5, type = "continuous") # [1] "#D3E3CA", "#92A587", "#2F3525"
cal_palette(name = "desert", n = 5, type = "continuous") # [1] "#F6EECF", "#B09175", "#291611"
treatment1color <- "#F6EECF"
treatment2color <- "#B09175"
treatment3color <- "#291611"
treatmentcolors <- c(treatment1color, treatment2color, treatment3color)

```

# Question 2: How does seedling survival change with PAR, TDR, % nn cover, and species?

Notes:
* __response variable__: The variable you want to test. (e.g.,. PAR, TDR, nncover)
* __explanatory variables__: The variables that can explain the outcome. (e.g., treatment, mafacover, site)
* __data frame__: Include all the data you'll be working with. (e.g., combine par and mafa_cover_all)
* __formula__: a formula is a two-sided linear formula object describing both the _fixed-effects_ and _random effects_ part of the model, with the response on the left of a ~ operator and the terms, separated by + operators, on the right. 
* __random effects__: Random-effects terms are distinguished by vertical bars __(|)__ separating expressions for design matrices from grouping factors. Two vertical bars __(||)__ can be used to specify multiple uncorrelated random effects for the same grouping variable. 
  + Because of the way it is implemented, the ||-syntax works only for design matrices containing numeric (continuous) predictors; to fit models with independent categorical effects, see dummy or the lmer_alt function from the afex package.)
  
  

### Load PAR, TDR, and non-native percent cover data.

### Saved as a csv in the "Processed" data folder.
```{r load survival height par tdr nncover data csv, include=TRUE}

# survival and mortality data
survmort_load <- read_csv("data/processed/survmort.csv",
                      col_types = cols(
                        year = col_character(),
                        month = col_character(), 
                        site = col_character(),
                        plot_number = col_character(), 
                        treatment = col_character(),
                        species = col_character(), 
                        alive = col_integer(),
                        dead = col_integer(), 
                        month_count = col_integer(),
                        transplanted = col_character()
                      )
                        )
# survival and mortality data WITH species
survmort <- survmort_load %>% 
  dplyr::select(year, month, plot_number, treatment, species, alive, dead, site, month_count, transplanted) # %>%  
#  mutate(treatment = recode(treatment, no = "none"))

# survival and mortality data WITHOUT species
survmortnospp <- survmort_load %>% 
  dplyr::select(year, month, plot_number, treatment, alive, dead, site, month_count, transplanted) %>% 
 # mutate(treatment = recode(treatment, no = "none")) %>% 
  group_by(year, month, site, plot_number, treatment, month_count, transplanted) %>% 
  summarize(totalsurvival = sum(alive), 
            totalmortality = sum(dead)) %>% 
  ungroup()
print(survmortnospp) # :) yay! it worked!

survmortnospp %>% # check number of data points
  group_by(year, treatment) %>% 
  summarise(N = length(totalsurvival))
```

```{r load height par tdr nncover data csv, include=TRUE}

# loading in height data
height_raw <- read.csv(here("data", "survival_data.csv")) %>% 
  mutate(date = mdy(date)) %>%  #having R recognize date as a date
  mutate(plot_number = as.character(plot_number)) %>% 
  mutate(stem_height_cm = as.numeric(stem_height_cm)) %>% 
  mutate(width_1_cm = as.numeric(width_1_cm)) %>% 
  mutate(width_2_cm = as.numeric(width_2_cm))
# In 2018 - Plot 26 - 1 SAAP not planted - right blue
# In 2018 - Plot 36 - 1 SAAP not planted - right green


# PAR data
par_load <- read_csv("data/processed/par.csv",
  col_types = cols(
    date = col_character(),
    plot_number = col_character(),
    treatment = col_character(),
    year = col_character(),
    month = col_character(),
    site = col_character(),
    normalized_par = col_double()
    )
)

par <- par_load %>% 
  dplyr::select(year, month, site, plot_number, treatment, normalized_par)
print(par)

# TDR data
tdr_load <- read_csv("data/processed/tdr.csv",
  col_types = cols(
    plot_number = col_character(),
    treatment = col_character(),
    year = col_character(),
    month = col_character(),
    site = col_character(),
    soil_moisture = col_double()
    )
  )

tdr <- tdr_load %>% 
   dplyr::select(year, month, site, plot_number, treatment, soil_moisture)
print(tdr)  

# exotic percent cover
exotic_cover_all_load <- read_csv("data/processed/exotic_cover_all.csv",
  col_types = cols(
    date = col_character(),
    year = col_character(),
    site = col_character(),
    plot_number = col_character(),
    MAFA_removal = col_character(),
    cover_percent = col_double()
  )
)

exotic_cover_all <- exotic_cover_all_load %>% 
  dplyr::select(date, year, site, plot_number, MAFA_removal, cover_percent) %>% 
  rename(treatment = MAFA_removal)
print(exotic_cover_all)


#mafa_cover_all_load <- read_csv("data/processed/mafa_cover_all.csv",
#  col_types = cols(
#    plot_number = col_character(),
#    year = col_integer(),
#    cover_percent = col_double(),
#    site = col_integer()
#    )
#  )
#mafa_cover_all <- mafa_cover_all_load %>% 
#  select(plot_number, year, cover_percent, site) 
#print(mafa_cover_all)

```
  
***

# May 2018 

### Code to save for later on calculating survival rate or change between two time points. 

- RUN AFTER "SURVIVAL AT TIME POINTS" AND ONLY MAKE CODE IF IT'S NEEDED
  
```{r may 2018 rate of change, include=TRUE}

# YOU DON'T NEED TO CALCULATE SURVIVAL RATE RIGHT NOW
# JUST RUN MODELS TO SEE WHAT MAKES A DIFFERENCE AT SURVEY TIME POINT. 
# YOU CAN ALWAYS GO BACK AND CALCULATE RATE ON YOUR SECOND PASS.
# 
# 
# t1 = jan 2019- march 2019
# t2 = march 2019 - may 2019
# t3 = may 2019 - sept 2019
# t4 = sept 2019 - nov 2019

# 
#survmortnospp_2018 <- survmortnospp %>% 
#  dplyr::filter(year == "2018") %>% 
#  dplyr::select(!totalmortality) %>% 
#  dplyr::select(!month_count)

#survmortnospp_2018_wider <- survmortnospp_2018 %>%
#  pivot_wider(names_from = month, values_from = totalsurvival) 
  
#view(survmortnospp_2018_wider)

# END OF CREATING A WIDER DF
```

### How are site 1 and site 2 different? 

```{r may 2018 filter environmental data, include=TRUE}

# par april 2018 
par_april2018 <- dplyr::filter(par, year == "2018" & month =="4") %>% 
  dplyr::select(site, plot_number, treatment, normalized_par) %>% 
  mutate(treatment = case_when(treatment == "no" ~ "none",
                               TRUE ~ treatment))

#tdr april 2018
tdr_april2018 <- tdr %>% dplyr::filter(year == "2018" & month =="4") %>%  
  dplyr::select(site, plot_number, treatment, soil_moisture)  %>% 
  mutate(treatment = case_when(treatment == "nonene" ~ "none",
                               TRUE ~ treatment))
tdr_april2018$site <- factor(tdr_april2018$site, levels = c("1", "2"))

# nncover may 2018
nncover_may2018 <- dplyr::filter(exotic_cover_all, year == "2018") %>% 
  dplyr::select(site, plot_number, treatment, cover_percent)

site_cond <- full_join(par_april2018, tdr_april2018, by = c("site", "plot_number", "treatment")) %>% 
  full_join(nncover_may2018, by = c("site", "plot_number", "treatment"))
```

```{r may2018 site conditions ttest}

#soil moisture
t.test(soil_moisture~site, data = site_cond) 
# YES sig diff
# data:  soil_moisture by site
# t = 5.0592, df = 33.993, p-value = 1.44e-05

#norm_par
t.test(normalized_par~site, data = site_cond) 
# not sig diff
# data:  normalized_par by site
# t = -1.2109, df = 29.972, p-value = 0.2354

#nncover
t.test(cover_percent~site, data = site_cond) #nn cover
# not sig diff
# data:  cover_percent by site
# t = 0.2511, df = 33.554, p-value = 0.8033
```
- soil moiture is sig diff by Site

### Subsetting dataframes survival, par, tdr, and nncover to May 2018 data
  - Add height at March 2018 to include in model
  
```{r may 2018 subset start end height, include=TRUE}
# subsetting data for May 2018 survival
# survmortnospp = may 2018
# par = april 2018
# tdr = april 2018
# nncover = may 2018

#seedling height in March 2018 - STARTING HEIGHT
height_march <- height_raw %>% 
  filter(date >= "2018-02-23" & date <= "2018-03-31") %>% # filtering to only have rows of data taken in March 
  dplyr::select(plot_number, MAFA_removal, location, species, stem_height_cm, individual) %>% 
  rename(march_stem_height_cm = stem_height_cm) %>% 
  drop_na()

print(height_march %>%  # check number of individuals per plot in March 2018
  group_by(plot_number) %>% 
  summarise(N = length(march_stem_height_cm)))
# not all plots had 18 seedlings planted in 2018 - Plot 26 and 36
# not all plots have 18 seedling height measurements

#seedling height in May 2018 - ENDING HEIGHT
height_may <- height_raw %>% 
  filter(date >= "2018-05-01" & date <= "2018-05-31") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, stem_height_cm, individual) %>% 
  rename(may_stem_height_cm = stem_height_cm) %>% 
  mutate(individual = case_when(individual == "s" ~ "S",
                                individual == "c" ~ "C",
                                individual == "r" ~ "R",
                                TRUE ~ individual),
         may_stem_height_cm = as.numeric(may_stem_height_cm))  %>% 
  drop_na()
print(height_may %>%  # check number of individuals per plot in March 2018
  group_by(plot_number) %>% 
  summarise(N = length(may_stem_height_cm)))

```

- Add rgr at March 2018 to include in model
```{r may 2018 relative growth rate, include=TRUE}
# growth rate from March to May 2018 - GROWTH RATE
growth_march_may <- right_join(height_march, height_may, by = c("plot_number", "MAFA_removal", "location", "species", "individual")) %>% 
  mutate(march_stem_height_cm = as.numeric(march_stem_height_cm)) %>% 
  drop_na() %>% 
  mutate(rgr = (log(may_stem_height_cm) - log(march_stem_height_cm))/60, # relative growth rate per day equation; 60 days between March and May
         plot_number = as.character(plot_number)) %>% 
  left_join(par_april2018, by = "plot_number") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, individual, rgr, normalized_par) %>% 
  left_join(tdr_april2018, by = "plot_number") %>% 
  dplyr::select(!site & !treatment) %>% 
  left_join(nncover_may2018, by = "plot_number") %>% 
  dplyr::select(!treatment) %>% 
  rename(exotic_percentcover = cover_percent) %>% 
  rename(treatment = MAFA_removal)
```

  - Add individual survival at March 2018 to include in model
```{r may 2018 individual survival, include=TRUE}
# seedling survival or dead in May 2018 - SURVIVAL 0-1
survival_may <- height_raw %>%  ## Need to change some of the individual labels to fix NAs when rejoin. 
  filter(date >= "2018-05-01" & date <= "2018-05-31") %>% # select for may 2018 data collection
  dplyr::select(plot_number, MAFA_removal, location, species, alive, individual) %>% 
  rename(may_alive = alive) %>% # 1 = alive
  mutate(may_alive = replace_na(may_alive, 0), # replace NAs with 0 = dead
         individual = case_when(individual == "s" ~ "S",
                                individual == "c" ~ "C",
                                individual == "r" ~ "R",
                                TRUE ~ individual))  # 0 = dead 1 = alive
```

### Join May 2018 data
```{r may 2018 join march to may data, include=TRUE}

# March to May 2018 join - JOIN 
# starting height, 0-1 may 2018, april 2018 normPAR, april 2018 tdr, nncover april 2018
height_march_surv_may_notransf <- full_join(height_march, survival_may, by = c("plot_number", "MAFA_removal", "location", "species", "individual")) %>% 
  mutate(march_stem_height_cm = as.numeric(march_stem_height_cm)) %>% # warning: one height "didn't plant"
  drop_na() %>% # drops nas 
  mutate(plot_number = as.character(plot_number)) %>% 
  left_join(par_april2018, by = "plot_number") %>% # join April 2018 PAR
  dplyr::select(plot_number, MAFA_removal, location, species, individual, march_stem_height_cm, may_alive, normalized_par) %>% 
  left_join(tdr_april2018, by = "plot_number") %>% # join April 2018 TDR
  dplyr::select(!site & !treatment) %>% 
  left_join(nncover_may2018, by = "plot_number") %>%  # join April 2018 nncover
  dplyr::select(!treatment) %>% 
  rename(exotic_percentcover = cover_percent) %>% 
  rename(treatment = MAFA_removal) %>% 
 left_join(growth_march_may, by = c("plot_number", "treatment", "location", "species", "individual", "normalized_par", "soil_moisture", "site", "exotic_percentcover"))
    # mutate(site = as.factor(site))
print(height_march_surv_may_notransf)

view(height_march_surv_may_notransf %>%  # check number of individuals per plot
  group_by(site, plot_number) %>% 
  summarise(N = length(individual))
)


```

```{r may 2018 transform data, include=TRUE}

# scale transform data: normPAR, tdr, nncover, starting height - SCALE
height_march_surv_may <- height_march_surv_may_notransf %>% 
  mutate(normalized_par = scale(normalized_par), # scale transforms the data; helps when comparing variables with different units; changes column names
         soil_moisture = scale(soil_moisture),
         exotic_percentcover = scale(exotic_percentcover),
         march_stem_height_cm = scale(march_stem_height_cm),
         rgr = scale(rgr),
         may_alive = as.factor(may_alive)) 
print(height_march_surv_may)
```


```{r join march to may 2018 data not transformed, include=TRUE}

# take height_march_surv_may %>%  
# group_by(plot) %>% 
# summarize by(sum(may_alive)) # to get total seedling survival 

may2018mod <- height_march_surv_may_notransf %>% 
  dplyr::select(plot_number, treatment, may_alive, site, normalized_par, soil_moisture, exotic_percentcover)
print(may2018mod)
```

- testing if the residuals are normally distributed
```{r notes lmer vs glmer, include=FALSE}

# lmer is used to fit linear mixed-effect models, so it assumes that the residual error has a Gaussian distribution. 

# If your dependent variable A is a binary outcome (e.g. a yes/no response), then the error distribution is binomial and not Gaussian. In this case you have to use glmer, which allow to fit a generalized linear mixed-effects model: these models include a link function that allows to predict response variables with non-Gaussian distributions. 

# One example of link function that could work in your case is the logistic function, which takes an input with any value from negative to positive infinity and return an output that always takes values between zero and one, which is interpretable as the probability of the binary outcome (e.g. the probability of the subject responding 'yes').
```

- model with glmer

```{r trial and extra code may 2018 glmer, include=FALSE}

# individual seedling survival in May 2018 as dependent variable - Shane's code
glme.may2018.mod <- glmer(may_alive ~ normalized_par + soil_moisture + exotic_percentcover + site + march_stem_height_cm + species + rgr + (1|plot_number) + (1|treatment) + (1|location) + (1|individual), 
                          # QUESTION -- why normalized_par * soil_moisture instead of +?
                          # treatment as independent because treatment wasn't significant in Q1
                          # QUESTION - add rgr as variable? the issue is not all rows have rgr value
                         family = binomial, 
                         data = height_march_surv_may) # <-- DO I NEED TO INCLUDE TREATMENT IF IT WASN'T SIG? Now treatment is significant... 
# error message with scaled data --> Warning: Model failed to converge with max|grad| = 0.0958267 (tol = 0.002, component 1)
# error message with un-scaled data --> Warning: Some predictor variables are on very different scales: consider rescaling

# relative growth rate as dependent variable - Shane's code
glme_rgr_may2018 <- lmer(rgr ~ normalized_par*soil_moisture + exotic_percentcover + site + (1|plot_number),
                         data = growth_march_may)
# plot number not included because only data point per plot (n = 36)
                         
# model as lmer - response must be numeric
# can run lmer if running with TOTAL seedling survival by plot
#lmer.may2018.mod <- lmer(as.factor(may_alive) ~ normalized_par * soil_moisture + #exotic_percentcover + site + march_stem_height_cm + species + rgr + (1|plot_number) + #(1|treatment) + (1|location) + (1|individual), 
#                          # QUESTION -- why normalized_par * soil_moisture instead of +?
#                          # treatment as independent because treatment wasn't significant #in Q1
#                         data = height_march_surv_may) 

# trial - Stephanie's code - with rgr
glme.may2018.mod <- glmer(may_alive ~ normalized_par * soil_moisture + exotic_percentcover + site + rgr + march_stem_height_cm + species + (1|plot_number),
                                family = binomial, 
                         data = height_march_surv_may) 
# treatment and location cause error messages
# don't include individual because it's similar to species - blue and green are CEOL, RHOV, SAAP. R, S, C are HEAR only. 

# trial - Stephanie's code - without rgr
glme.may2018.mod <- glmer(may_alive ~ normalized_par * soil_moisture + exotic_percentcover + site + march_stem_height_cm + species + (1|plot_number),
                                family = binomial, 
                         data = height_march_surv_may) 
# treatment and location cause error messages
# don't include individual because it's similar to species - blue and green are CEOL, RHOV, SAAP. R, S, C are HEAR only. 

```

### Testing for normality
```{r may 2018 test normality glmer, include =TRUE}

glme.may2018.mod <- glmer(may_alive ~ 
                            normalized_par * soil_moisture # significant from Q1
                          + exotic_percentcover # not significant from Q1
                          + site + march_stem_height_cm 
                          + (1|plot_number),
                                family = binomial, 
                         data = height_march_surv_may) # 10 columns in df without species

glme.may2018.modspp <- glmer(may_alive ~ 
                            normalized_par * soil_moisture # significant from Q1
                          + exotic_percentcover # not significant from Q1
                          + species
                          + site + march_stem_height_cm 
                          + (1|plot_number),
                                family = binomial, 
                         data = height_march_surv_may) # 11 columns 
# treatment and location cause error messages
# don't include individual because it's similar to species - blue and green are CEOL, RHOV, SAAP. R, S, C are HEAR only. 

MOD <- glme.may2018.mod # or
MOD <- glme.may2018.modspp

# Calculate model's residual and fitted values
F1 <- fitted(MOD)
E1 <- residuals(MOD, "pearson")

# See residuals as a histogram, look for normal distribution
hist(E1) 
# looks bimodal... 

# Graph residuals against a normal distribution, look for all points to be on 1:1 line
#need to call next two lines together
qqnorm(E1, xlab = "Theoretical Quantiles", ylab = "Pearson Residuals")
qqline(E1) # ends are a bit wonky... 

# Graph residuals vs fitted values to inspect homogeneity of variance, look for a random scattering of plots
# run together 2 lines
plot(x=F1, y=E1, xlab="Fitted Model Values", ylab="Pearson Residuals", main = "Variance")
abline(h = 0) # looking for random scatter

# Check for crazy outliers, look for lines MUCH taller than the rest of data
plot(cooks.distance(MOD))

# Plot a box plot for each factor, look for equal variance amount levels along the zero line
# Box plots need to be assessed for every fixed effect (categorical factor) for your model. 
# Random effects need the qqline just like normality. 
# So, only site and treatment get box plots. 
# exotic_cover is a covariate (continuous variable).

boxplot(E1 ~ site, data = height_march_surv_may) # <---- make sure to change to df, not the lme
abline(h = 0)
# error message - variable lengths differ
print(height_march_surv_may %>%  # check number of individuals per plot in March 2018
  group_by(site) %>% 
  summarise(N = length(site)))
# site N
# 1	  318			
# 2 	288	

boxplot(E1 ~ species, data = height_march_surv_may) # <---- make sure to change to df, not the lme
abline(h = 0)
# error message - variable lengths differ <-- omitting rgr in model it now runs
print(height_march_surv_may %>%  # check number of individuals per plot in March 2018
  group_by(species) %>% 
  summarise(N = length(species)))
# species N
# CEOL	  130			
# HEAR	  215			
# RHOV	  136			
# SAAP	  125	

# Plot each random effect in the model - things in the (1|_), look for dots along 1:1 line
qqnorm(ranef(MOD)$plot_number[,1], main = "Plot Residuals")
qqline(ranef(MOD)$plot_number[,1]) # plot number

#qqnorm(ranef(MOD)$individual[,1], main = "Plot Residuals")
#qqline(ranef(MOD)$individual[,1]) # individual: blue, green, S, C, R

```

### Statistics

```{r may 2018 stats, include=TRUE}

print(glme.may2018.mod)
summary(glme.may2018.mod)
# when normalized_par * soil_moisture + nncover and WITHOUT rgr or species
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                  -0.57868    0.17050  -3.394 0.000689 ***
#normalized_par                0.22687    0.13362   1.698 0.089519 .  
#soil_moisture                 0.36255    0.15091   2.402 0.016285 *  <-- soil moisture
#exotic_percentcover           0.05844    0.12111   0.483 0.629438    
#site2                        -0.52012    0.28056  -1.854 0.063762 .  
#march_stem_height_cm          0.52137    0.09360   5.570 2.55e-08 *** <-- march stem height
#normalized_par:soil_moisture  0.54752    0.13617   4.021 5.80e-05 *** <-- par x tdr interaction

# when normalized_par + soil_moisture and WITHOUT rgr = only species is significant
#Fixed effects:
#                      Estimate Std. Error z value Pr(>|z|)   
#(Intercept)          -0.800203   0.293996  -2.722  0.00649 **
#normalized_par       -0.012121   0.151858  -0.080  0.93638   
#soil_moisture         0.230743   0.178312   1.294  0.19565   
#exotic_percentcover  -0.009566   0.148175  -0.065  0.94853   
#site2                -0.474881   0.352830  -1.346  0.17833   
#march_stem_height_cm  0.167639   0.145981   1.148  0.25082   
#speciesHEAR           0.717822   0.345186   2.080  0.03757 * <-- species
#speciesRHOV          -0.085414   0.292463  -0.292  0.77025   
#speciesSAAP          -0.673506   0.322808  -2.086  0.03694 * <-- species

print(glme.may2018.modspp)
summary(glme.may2018.modspp)
# when normalized_par * soil_moisture and WITHOUT rgr = soil_moisture, norm_par*soil_moisture, species are significant
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                  -0.67222    0.26791  -2.509   0.0121 *  
#normalized_par                0.22151    0.13682   1.619   0.1055    
#soil_moisture                 0.37873    0.15482   2.446   0.0144 * <-- soil moisture
#exotic_percentcover           0.05884    0.12325   0.477   0.6331    
#site2                        -0.52592    0.28791  -1.827   0.0677 .  
#march_stem_height_cm          0.19582    0.14592   1.342   0.1796    
#speciesHEAR                   0.65675    0.34598   1.898   0.0577 .  
#speciesRHOV                  -0.09939    0.29329  -0.339   0.7347    
#speciesSAAP                  -0.71330    0.32438  -2.199   0.0279 *  <-- species
#normalized_par:soil_moisture  0.55680    0.13963   3.988 6.67e-05 *** <-- interaction PAR x TDR
# 
# when normalized_par * soil_moisture * nncover and WITHOUT rgr = soil_moisture, norm_par*soil_moisture, species are significant
#Fixed effects:
#                                                 Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                                      -0.70008    0.26985  -2.594 0.009478 ** 
#normalized_par                                    0.21233    0.13956   1.521 0.128169    
#soil_moisture                                     0.39759    0.17833   2.229 0.025783 *  
#exotic_percentcover                               0.05525    0.12237   0.451 0.651642    
#speciesHEAR                                       0.64219    0.34649   1.853 0.063827 .  
#speciesRHOV                                      -0.09718    0.29347  -0.331 0.740546    
#speciesSAAP                                      -0.71199    0.32487  -2.192 0.028405 *  
#site2                                            -0.51624    0.28299  -1.824 0.068118 .  
#march_stem_height_cm                              0.20034    0.14591   1.373 0.169737    
#normalized_par:soil_moisture                      0.60608    0.17582   3.447 0.000567 ***
#normalized_par:exotic_percentcover               -0.12603    0.11167  -1.129 0.259047     <-- nncover never significant factor
#soil_moisture:exotic_percentcover                 0.10619    0.14029   0.757 0.449112    
#normalized_par:soil_moisture:exotic_percentcover -0.04511    0.15725  -0.287 0.774232   

# Take home: when environmental conditions are considered separately, species is the main driving factor of seedling survival. However, we know environmntal variables do not act independently on seedling survival, so par x tdr is a better model that represents what is hapening in the field. 
# The interaction between Par*TDR and the species of seedling planted are correlated with seedling survival from March to May in 2018.

# Notes
# We included non-native percent cover but that was not significant by itself or when interacting with tdr and/or par so it was kept as an non-interactinve factor in the model. 
# The model including interactions between species * par * tdr didn't run so species remained a non-interacting factor.

print(glme.may2018.modspp_CEOL)
summary(glme.may2018.modspp_CEOL)


# when normalized_par + soil_moisture and WITH rgr
#Fixed effects:
#                     Estimate Std. Error z value Pr(>|z|)    
#(Intercept)           3.06593    0.61814   4.960 7.05e-07 ***
#normalized_par       -0.47379    0.19966  -2.373   0.0176 *  
#soil_moisture         0.60512    0.27015   2.240   0.0251 *  
#exotic_percentcover  -0.52274    0.21463  -2.436   0.0149 *  
#site2                -2.61512    0.53223  -4.913 8.95e-07 ***
#rgr                   0.17486    0.18525   0.944   0.3452    
#march_stem_height_cm  0.01186    0.23245   0.051   0.9593    
#speciesHEAR          -0.13926    0.60828  -0.229   0.8189    
#speciesRHOV          -0.80500    0.56642  -1.421   0.1553    
#speciesSAAP          -1.49677    0.61320  -2.441   0.0147 *  


# when normalized_par * soil_moisture and WITH rgr
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                   3.14554    0.62088   5.066 4.06e-07 ***
#normalized_par               -0.04689    0.24992  -0.188  0.85117    
#soil_moisture                 0.70144    0.26578   2.639  0.00831 ** 
#exotic_percentcover          -0.47463    0.19730  -2.406  0.01615 *  
#site2                        -2.71065    0.51212  -5.293 1.20e-07 ***
#rgr                           0.15780    0.18477   0.854  0.39309    
#march_stem_height_cm          0.03284    0.24099   0.136  0.89162    
#speciesHEAR                  -0.20153    0.61868  -0.326  0.74463    
#speciesRHOV                  -0.79117    0.56505  -1.400  0.16146    
#speciesSAAP                  -1.52418    0.61178  -2.491  0.01272 *  
#normalized_par:soil_moisture  0.64328    0.27406   2.347  0.01891 *  


# fixed level effects, pvalues, etc.
anova(glme.may2018.mod) # A significant p-value indicates that one or more significant differences exist between group means.
## not reporting p-values, only F values

anova(glme.may2018.modspp)
## not reporting p-values, only F values


```



```{r may 2018 post hoc, include=TRUE}

# CODE NOT WORKING

# testing the difference between slopes
may2018.mod.interaction <- lm(may_alive ~ normalized_par*soil_moisture * march_stem_height_cm, data = height_march_surv_may)
anova(may2018.mod.interaction) # p-values for the interaction
# error message:   warning("ANOVA F-tests on an essentially perfect fit are unreliable") : missing value where TRUE/FALSE needed
```

### Figures 
- prediction of survival in May 2018
```{r May 2018 figures stem height survival site, include=TRUE}

# stem height x survival, paneled by site
# figure: predict survival (S curve by 0-1)
stem_height_site_1_prediction <- seq(from = -1.2, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(normalized_par = mean(height_march_surv_may$normalized_par),
         exotic_percentcover = mean(height_march_surv_may$exotic_percentcover),
         site = "1",
         soil_moisture = mean(height_march_surv_may$soil_moisture),
         treatment = "full removal",
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

stem_height_site_2_prediction <- seq(from = -1.2, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(normalized_par = mean(height_march_surv_may$normalized_par),
         exotic_percentcover = mean(height_march_surv_may$exotic_percentcover),
         site = "2",
         soil_moisture = mean(height_march_surv_may$soil_moisture),
         treatment = "full removal",
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

site_1_sh_plot <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(site == "1"), aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_site_1_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic() +
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival",
       title = "Site 1")

site_2_sh_plot <- ggplot()+
  geom_point(data = height_march_surv_may %>%  filter(site == "2"), aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_site_2_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival",
       title = "Site 2")

site_1_sh_plot + site_2_sh_plot
```
- box plot of rgr May 2018
```{r may 2018 box plot rgr figure, include=FALSE}

# box.1 rgr x site
#ggplot(growth_march_may, aes(x = site, y = rgr))+
#  geom_boxplot()+
#  theme_classic()+
#  labs(x = "Planting Site",
#       y = "Relative Growth Rate")
```

- figure - prediction of survival x soil moisture x low, mean, and high PAR 
- BY SITE
```{r May 2018 figure predict site by levels of par, include=TRUE}

# soil moisture x MIN par x Site 1
moisture_low_par_site_1 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% # range of soil moisture from height_march_surv_may
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(height_march_surv_may$normalized_par), # calculate norm_par minimum
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# soil moisture x MIN par x Site 2
moisture_low_par_site_2 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(height_march_surv_may$normalized_par), 
         exotic_percentcover = 0,
         site = "2",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# soil moisture x MEAN par x Site 1
moisture_mean_par_site_1 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = 0, # mean norm_par, data is scale transformed
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# soil moisture x MEAN par x Site 2
moisture_mean_par_site_2 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = 0,
         exotic_percentcover = 0,
         site = "2",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# soil moisture x MAX par x Site 1
moisture_max_par_site_1 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(height_march_surv_may$normalized_par), # calculate norm_par maximum
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

#soil moisture x MAX par x Site 2
moisture_max_par_site_2 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(height_march_surv_may$normalized_par),
         exotic_percentcover = 0,
         site = "2",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# rbind norm_par min, mean, max at Site 1
moisture_prediction_site_1 <- rbind(moisture_low_par_site_1, moisture_mean_par_site_1, moisture_max_par_site_1)

# rbind norm_par min, mean, max at Site 2
moisture_prediction_site_2 <- rbind(moisture_low_par_site_2, moisture_mean_par_site_2, moisture_max_par_site_2)

# prediction figure - site 1
moisture_site_1_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(site == "1"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_prediction_site_1, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1) +
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability",
       title = "Site 1")

# prediction figure - site 2
moisture_site_2_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(site == "2"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_prediction_site_2, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1) +
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability",
       title = "Site 2")

moisture_site_1_graph + moisture_site_2_graph
```

- figure - prediction of survival x norm_par x low, mean, and high TDR 
- by SITE
```{r May 2018 figure predict by levels of tdr, include=TRUE}

# par x MIN tdr x plot 1
# Site = "1" 
par_low_moisture_site_1 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(height_march_surv_may$soil_moisture), # min TDR
         exotic_percentcover = 0, # mean nncover
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# par x MIN tdr x plot 2
par_low_moisture_site_2 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(height_march_surv_may$soil_moisture),
         exotic_percentcover = 0,
         site = "2",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# par x MEAN tdr x plot 1
par_mean_moisture_site_1 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = 0,
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# par x MEAN tdr x plot 2
par_mean_moisture_site_2 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = 0,
         exotic_percentcover = 0,
         site = "2",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# par x MAX tdr x plot 1
par_max_moisture_site_1 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(height_march_surv_may$soil_moisture),
         exotic_percentcover = 0,
         site = "1",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# par x MAX tdr x plot 2
par_max_moisture_site_2 <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(height_march_surv_may$soil_moisture),
         exotic_percentcover = 0,
         site = "2",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

# rbind 
par_prediction_site_1 <- rbind(par_low_moisture_site_1, par_mean_moisture_site_1, par_max_moisture_site_1)

par_prediction_site_2 <- rbind(par_low_moisture_site_2, par_mean_moisture_site_2, par_max_moisture_site_2)

par_site_1_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(site == "1"), aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_prediction_site_1, aes(x = normalized_par, y = alive, col = soil_moisture, group = soil_moisture), linewidth = 1) +
  theme_classic() +
  labs(x = "Normalized PAR", 
       y = "Survival Probability",
       title = "Site 1")

par_site_2_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(site == "2"), aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_prediction_site_2, aes(x = normalized_par, y = alive, col = soil_moisture, group = soil_moisture), linewidth = 1) +
  theme_classic() +
  labs(x = "Normalized PAR", 
       y = "Survival Probability",
       title = "Site 2")

par_site_1_graph + par_site_2_graph
```


```{r may 2018 glmer by species, include=TRUE}
#CEOL
glme.may2018.modspp_CEOL <- glmer(may_alive ~ 
                            normalized_par * soil_moisture # significant from Q1
                          + exotic_percentcover # not significant from Q1
                          + site + march_stem_height_cm 
                          + (1|plot_number),
                                family = binomial, 
                         data = (height_march_surv_may %>% filter(species == "CEOL")))

#HEAR
glme.may2018.modspp_HEAR <- glmer(may_alive ~ 
                            normalized_par * soil_moisture # significant from Q1
                          + exotic_percentcover # not significant from Q1
                          + site + march_stem_height_cm 
                          + (1|plot_number),
                                family = binomial, 
                         data = (height_march_surv_may %>% filter(species == "HEAR")))

#RHOV
glme.may2018.modspp_HEAR <- glmer(may_alive ~ 
                            normalized_par * soil_moisture # significant from Q1
                          + exotic_percentcover # not significant from Q1
                          + site + march_stem_height_cm 
                          + (1|plot_number),
                                family = binomial, 
                         data = (height_march_surv_may %>% filter(species == "RHOV")))
# error : boundary (singular) fit: see help('isSingular')

#SAAP
glme.may2018.modspp_SAAP <- glmer(may_alive ~ 
                            normalized_par * soil_moisture # significant from Q1
                          + exotic_percentcover # not significant from Q1
                          + site + march_stem_height_cm 
                          + (1|plot_number),
                                family = binomial, 
                         data = (height_march_surv_may %>% filter(species == "SAAP")))
# error : boundary (singular) fit: see help('isSingular')
```

```{r may 2018 glmer by species testing normality, include=TRUE}
MOD <- glme.may2018.modspp_CEOL #or
MOD <- glme.may2018.modspp_HEAR #or
MOD <- glme.may2018.modspp_RHOV #or
MOD <- glme.may2018.modspp_SAAP 


# Calculate model's residual and fitted values
F1 <- fitted(MOD)
E1 <- residuals(MOD, "pearson")

# See residuals as a histogram, look for normal distribution
hist(E1) 
# looks bimodal... 

# Graph residuals against a normal distribution, look for all points to be on 1:1 line
#need to call next two lines together
qqnorm(E1, xlab = "Theoretical Quantiles", ylab = "Pearson Residuals")
qqline(E1) # ends are a bit wonky... 

# Graph residuals vs fitted values to inspect homogeneity of variance, look for a random scattering of plots
# run together 2 lines
plot(x=F1, y=E1, xlab="Fitted Model Values", ylab="Pearson Residuals", main = "Variance")
abline(h = 0) # looking for random scatter

#
#
# code from here to the end of the section hasn't been checked. 
#
#

# Check for crazy outliers, look for lines MUCH taller than the rest of data
#plot(cooks.distance(MOD))

# Plot a box plot for each factor, look for equal variance amount levels along the zero line
# Box plots need to be assessed for every fixed effect (categorical factor) for your model. 
# Random effects need the qqline just like normality. 
# So, only site and treatment get box plots. 
# exotic_cover is a covariate (continuous variable).

boxplot(E1 ~ site, data = height_march_surv_may) # <---- make sure to change to df, not the lme
abline(h = 0)
# error message - variable lengths differ
print(height_march_surv_may %>%  # check number of individuals per plot in March 2018
  group_by(site) %>% 
  summarise(N = length(site)))

boxplot(E1 ~ species, data = height_march_surv_may) # <---- make sure to change to df, not the lme
abline(h = 0)
# error message - variable lengths differ <-- omitting rgr in model it now runs
print(height_march_surv_may %>%  # check number of individuals per plot in March 2018
  group_by(species) %>% 
  summarise(N = length(species)))
# species N
# CEOL	  130			
# HEAR	  215			
# RHOV	  136			
# SAAP	  125	

# Plot each random effect in the model - things in the (1|_), look for dots along 1:1 line
qqnorm(ranef(MOD)$plot_number[,1], main = "Plot Residuals")
qqline(ranef(MOD)$plot_number[,1]) # plot number

#qqnorm(ranef(MOD)$individual[,1], main = "Plot Residuals")
#qqline(ranef(MOD)$individual[,1]) # individual: blue, green, S, C, R
```

```{r may 2018 stats by species, include=TRUE}

print(glme.may2018.modspp_CEOL)
summary(glme.may2018.modspp_CEOL)
# Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)  
#(Intercept)                   -0.5339     0.6502  -0.821   0.4116  
#normalized_par                 0.6254     0.3537   1.768   0.0771 .
#soil_moisture                  0.0955     0.3642   0.262   0.7932  
#exotic_percentcover            0.2205     0.2969   0.743   0.4576  
#site2                         -1.9266     0.7697  -2.503   0.0123 * <-- site is significant
#march_stem_height_cm          -0.3505     0.8577  -0.409   0.6828  
#normalized_par:soil_moisture   0.3878     0.3124   1.242   0.2144  

print(glme.may2018.modspp_HEAR)
summary(glme.may2018.modspp_HEAR)
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)  
#(Intercept)                  -0.02166    0.55505  -0.039   0.9689  
#normalized_par               -0.23014    0.25407  -0.906   0.3650  
#soil_moisture                 0.18378    0.28832   0.637   0.5239  
#exotic_percentcover          -0.39685    0.23971  -1.656   0.0978 .
#site2                        -0.46420    0.54116  -0.858   0.3910  
#march_stem_height_cm          1.44888    0.80218   1.806   0.0709 .
#normalized_par:soil_moisture  0.26328    0.25373   1.038   0.2994  

print(glme.may2018.modspp_RHOV)
summary(glme.may2018.modspp_RHOV)

print(glme.may2018.modspp_SAAP)
summary(glme.may2018.modspp_SAAP)
#Fixed effects:
#                             Estimate Std. Error z value Pr(>|z|)   
#(Intercept)                   -0.4643     0.4266  -1.089  0.27635   
#normalized_par                 0.1688     0.3603   0.469  0.63941   
#soil_moisture                  0.2287     0.3756   0.609  0.54257   
#exotic_percentcover            0.2943     0.3278   0.898  0.36926   
#site2                         -2.7165     0.9522  -2.853  0.00433 ** <-- site is significant
#march_stem_height_cm           0.9697     0.5084   1.907  0.05650 . 
#normalized_par:soil_moisture   0.7728     0.4113   1.879  0.06030 . 
```

- by SPECIES x soil moisture
```{r May 2018 figure predict species by levels of par, include=TRUE}

# glmer(may_alive ~ 
#     normalized_par * soil_moisture + exotic_percentcover + species + site + march_stem_height_cm + 
#     (1 | plot_number), data: height_march_surv_may)

# soil moisture x MIN par x HEAR
moisture_low_par_HEAR <- seq(from = -1.6, to = 1.8, by = 0.1) %>% # range of soil moisture from height_march_surv_may
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(height_march_surv_may$normalized_par), # calculate norm_par minimum
         exotic_percentcover = 0,
         site = "1",
         species = "HEAR",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MEAN par x HEAR
moisture_mean_par_HEAR <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = 0, # mean norm_par, data is scale transformed
         exotic_percentcover = 0,
         site = "1",
         species = "HEAR",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MAX par x HEAR
moisture_max_par_HEAR <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(height_march_surv_may$normalized_par), 
         exotic_percentcover = 0,
         site = "1",
         species = "HEAR",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))


# soil moisture x MIN par x CEOL
moisture_low_par_CEOL <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(height_march_surv_may$normalized_par), # calculate norm_par minimum
         exotic_percentcover = 0,
         site = "1",
         species = "CEOL",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MEAN par x CEOL
moisture_mean_par_CEOL <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = 0, # mean norm_par, data is scale transformed
         exotic_percentcover = 0,
         site = "1",
         species = "CEOL",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MAX par x CEOL
moisture_max_par_CEOL <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(height_march_surv_may$normalized_par), 
         exotic_percentcover = 0,
         site = "1",
         species = "CEOL",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MIN par x RHOV
moisture_low_par_RHOV <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(height_march_surv_may$normalized_par), # calculate norm_par minimum
         exotic_percentcover = 0,
         site = "1",
         species = "RHOV",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MEAN par x RHOV
moisture_mean_par_RHOV <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = 0, # mean norm_par, data is scale transformed
         exotic_percentcover = 0,
         site = "1",
         species = "RHOV",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MAX par x RHOV
moisture_max_par_RHOV <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(height_march_surv_may$normalized_par), 
         exotic_percentcover = 0,
         site = "1",
         species = "RHOV",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MIN par x SAAP
moisture_low_par_SAAP <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(height_march_surv_may$normalized_par), # calculate norm_par minimum
         exotic_percentcover = 0,
         site = "1",
         species = "SAAP",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MEAN par x SAAP
moisture_mean_par_SAAP <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = 0, # mean norm_par, data is scale transformed
         exotic_percentcover = 0,
         site = "1",
         species = "SAAP",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# soil moisture x MAX par x SAAP
moisture_max_par_SAAP <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(height_march_surv_may$normalized_par), 
         exotic_percentcover = 0,
         site = "1",
         species = "SAAP",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# rbind norm_par min, mean, max for HEAR
moisture_prediction_HEAR <- rbind(moisture_low_par_HEAR, moisture_mean_par_HEAR, moisture_max_par_HEAR)

# rbind norm_par min, mean, max for CEOL
moisture_prediction_CEOL <- rbind(moisture_low_par_CEOL, moisture_mean_par_CEOL, moisture_max_par_CEOL)

# rbind norm_par min, mean, max for RHOV
moisture_prediction_RHOV <- rbind(moisture_low_par_RHOV, moisture_mean_par_RHOV, moisture_max_par_RHOV)

# rbind norm_par min, mean, max for SAAP
moisture_prediction_SAAP <- rbind(moisture_low_par_SAAP, moisture_mean_par_SAAP, moisture_max_par_SAAP)


# prediction figure - HEAR
moisture_HEAR_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "HEAR"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_prediction_HEAR, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1) +
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability",
       title = "HEAR")

# prediction figure - CEOL
moisture_CEOL_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "CEOL"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_prediction_CEOL, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1) +
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability",
       title = "CEOL")

# prediction figure - RHOV
moisture_RHOV_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "RHOV"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_prediction_RHOV, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1) +
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability",
       title = "RHOV")

# prediction figure - SAAP
moisture_SAAP_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "SAAP"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_prediction_SAAP, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1) +
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability",
       title = "SAAP")


moisture_CEOL_graph + moisture_HEAR_graph + moisture_RHOV_graph +moisture_SAAP_graph
```


- by SPECIES
```{r May 2018 figure predict species by levels of tdr, include=TRUE}

# glmer(may_alive ~ 
#     normalized_par * soil_moisture + exotic_percentcover + species + site + march_stem_height_cm + 
#     (1 | plot_number), data: height_march_surv_may)

# par x MIN par x HEAR
par_low_moisture_HEAR <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(height_march_surv_may$soil_moisture), # min tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "HEAR",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MEAN par x HEAR
par_mean_moisture_HEAR <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = 0, # mean tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "HEAR",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MAX par x HEAR
par_max_moisture_HEAR <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(height_march_surv_may$soil_moisture), # max tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "HEAR",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MIN par x CEOL
par_low_moisture_CEOL <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(height_march_surv_may$soil_moisture), # min tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "CEOL",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MEAN par x CEOL
par_mean_moisture_CEOL <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = 0, # mean tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "CEOL",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MAX par x CEOL
par_max_moisture_CEOL <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(height_march_surv_may$soil_moisture), # max tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "CEOL",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MIN par x RHOV
par_low_moisture_RHOV <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(height_march_surv_may$soil_moisture), # min tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "RHOV",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MEAN par x RHOV
par_mean_moisture_RHOV <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = 0, # mean tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "RHOV",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MAX par x RHOV
par_max_moisture_RHOV <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(height_march_surv_may$soil_moisture), # max tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "RHOV",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MIN par x SAAP
par_low_moisture_SAAP <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(height_march_surv_may$soil_moisture), # min tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "SAAP",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MEAN par x SAAP
par_mean_moisture_SAAP <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = 0, # mean tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "SAAP",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# par x MAX par x SAAP
par_max_moisture_SAAP <- seq(from = -1.7, to = 2.1, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(height_march_surv_may$soil_moisture), # max tdr
         exotic_percentcover = 0, # mean nncover
         site = "1",
         species = "SAAP",
         march_stem_height_cm = 0) %>% 
  mutate(alive = predict(glme.may2018.modspp, newdata = . , type = "response"))

# rbind 
par_prediction_CEOL <- rbind(par_low_moisture_CEOL, par_mean_moisture_CEOL, par_max_moisture_CEOL)
par_prediction_HEAR <- rbind(par_low_moisture_HEAR, par_mean_moisture_HEAR, par_max_moisture_HEAR)
par_prediction_RHOV <- rbind(par_low_moisture_RHOV, par_mean_moisture_RHOV, par_max_moisture_RHOV)
par_prediction_SAAP <- rbind(par_low_moisture_SAAP, par_mean_moisture_SAAP, par_max_moisture_SAAP)

par_CEOL_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "CEOL"), aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_prediction_CEOL, aes(x = normalized_par, y = alive, col = soil_moisture, group = soil_moisture), linewidth = 1) +
  theme_classic() +
  labs(x = "Normalized PAR", 
       y = "Survival Probability",
       title = "CEOL")

par_HEAR_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "HEAR"), aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_prediction_CEOL, aes(x = normalized_par, y = alive, col = soil_moisture, group = soil_moisture), linewidth = 1) +
  theme_classic() +
  labs(x = "Normalized PAR", 
       y = "Survival Probability",
       title = "HEAR")

par_RHOV_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "RHOV"), aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_prediction_CEOL, aes(x = normalized_par, y = alive, col = soil_moisture, group = soil_moisture), linewidth = 1) +
  theme_classic() +
  labs(x = "Normalized PAR", 
       y = "Survival Probability",
       title = "RHOV")

par_SAAP_graph <- ggplot()+
  geom_point(data = height_march_surv_may %>% filter(species == "SAAP"), aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_prediction_CEOL, aes(x = normalized_par, y = alive, col = soil_moisture, group = soil_moisture), linewidth = 1) +
  theme_classic() +
  labs(x = "Normalized PAR", 
       y = "Survival Probability",
       title = "SAAP")

par_CEOL_graph + par_HEAR_graph + par_RHOV_graph + par_SAAP_graph
```
# END

## Repeat each model for each species

### CEOL 
```{r CEOL may 2018 predict AIC values, include=TRUE}

# filter for ceol May 2018
ceol_2018 <- height_march_surv_may %>% 
  filter(species == "CEOL")
  
#ONE FACTOR AIC
# par
AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = ceol_2018))

# tdr
AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2018))

# nncover
AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = ceol_2018))

# site
AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = ceol_2018))

# march 2018 stem height
AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2018))

#TWO FACTOR AIC
# site + norm_par
AIC(glmer(as.factor(may_alive) ~ site + normalized_par + (1|plot_number),
          family = binomial,
          data = ceol_2018))

# site + tdr <-- lowest AIC
AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2018))
#[1] 143.3071

# site + nncover
AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = ceol_2018))

# site + march 2018 stem height
AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2018))
```
```{r CEOL may 2018 predict best model, include=TRUE}

summary(glmer(as.factor(may_alive) ~ soil_moisture + normalized_par + exotic_percentcover + march_stem_height_cm + site + (1|plot_number), 
          family = binomial,
          data = ceol_2018))

#Fixed effects:
#                      Estimate Std. Error z value Pr(>|z|)  
#(Intercept)          -0.713440   0.659574  -1.082   0.2794  
#soil_moisture         0.006624   0.372375   0.018   0.9858  
#normalized_par        0.505202   0.350863   1.440   0.1499  
#exotic_percentcover   0.192127   0.311171   0.617   0.5370  
#march_stem_height_cm -0.545067   0.861848  -0.632   0.5271  
#site2                -1.984967   0.809519  -2.452   0.0142 *


## Add Figure
``` 

### RHOV May 2018 - predict survival

```{r RHOV may 2018 AIC values, include=TRUE} 
rhov_2018 <- height_march_surv_may %>% 
  filter(species == "RHOV")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = rhov_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = rhov_2018))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = rhov_2018))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = rhov_2018))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + soil_moisture + (1|plot_number),
          family = binomial,
          data = rhov_2018))
```
```{r RHOV may 2018 prediction model, include=TRUE}

rhov_model <- glmer(as.factor(may_alive) ~ march_stem_height_cm + soil_moisture + normalized_par + exotic_percentcover + site + (1|plot_number),
          family = binomial,
          data = rhov_2018)
summary(rhov_model)

stem_height_rhov_prediction <- seq(from = 0.5, to = 5, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = mean(rhov_2018$soil_moisture), 
         normalized_par = 0, 
         exotic_percentcover = 0,
         site = "1") %>% 
  mutate(alive = predict(rhov_model, newdata = . , type = "response"))

ggplot()+
  geom_point(data = rhov_2018, aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_rhov_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival")


```

### HEAR

```{r}
hear_2018 <- height_march_surv_may %>% 
  filter(species == "HEAR")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture*normalized_par + (1|plot_number),
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + site + (1|plot_number),
          family = binomial,
          data = hear_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2018))

hear_model <- glmer(as.factor(may_alive) ~ soil_moisture* normalized_par + (1|plot_number), 
                         family = binomial,
                         data = hear_2018)

summary(hear_model)


moisture_hear_low_par <- seq(from = 6, to = 12, by = 0.5) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = min(hear_2018$normalized_par)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

moisture_hear_mid_par <- seq(from = 6, to = 12, by = 0.5) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = mean(hear_2018$normalized_par)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

moisture_hear_max_par <- seq(from = 6, to = 12, by = 0.5) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = "1",
         normalized_par = max(hear_2018$normalized_par)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

moisture_hear_prediction <- rbind(moisture_hear_low_par, moisture_hear_max_par, moisture_hear_mid_par) 

ggplot()+
  geom_point(data = hear_2018, aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_hear_prediction, aes(x = soil_moisture, y = alive, col = normalized_par, group= normalized_par), linewidth = 1)+
  theme_classic()+
  labs(x = "Soil Moisture",
       y = "Probability of Survival")

par_hear_low_moisture <- seq(from = 0.1, to = 0.65, by = 0.01) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = min(hear_2018$soil_moisture)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

par_hear_mid_moisture <- seq(from = 0.1, to = 0.65, by = 0.01) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = mean(hear_2018$soil_moisture)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

par_hear_max_moisture <- seq(from = 0.1, to = 0.65, by = 0.01) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(plot_number = "1",
         soil_moisture = max(hear_2018$soil_moisture)) %>% 
  mutate(alive = predict(hear_model, newdata = . , type = "response"))

par_hear_prediction <- rbind(par_hear_low_moisture, par_hear_max_moisture, par_hear_mid_moisture) 

ggplot()+
  geom_point(data = hear_2018, aes(x = normalized_par, y = may_alive, col = soil_moisture), alpha = 0.25)+
  geom_line(data = par_hear_prediction, aes(x = normalized_par, y = alive, col = soil_moisture, group= soil_moisture), linewidth = 1)+
  theme_classic()+
  labs(x = "Normalized PAR",
       y = "Probability of Survival")

```


SAAP 

```{r}
saap_2018 <- height_march_surv_may %>% 
  filter(species == "SAAP")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ site + normalized_par + (1|plot_number), 
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number), 
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = saap_2018))

AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number), 
          family = binomial,
          data = saap_2018))


saap_model <- glmer(as.factor(may_alive) ~ site + (1|plot_number),
                         family = binomial,
                         data = saap_2018)

summary(saap_model)
```

## Individual species for RGR 

### CEOL 

```{r}
ceol_rgr_2018 <- growth_march_may %>% 
  filter(species == "CEOL")
  
AIC(lmer(rgr ~ normalized_par +  (1|plot_number),
                         data = ceol_rgr_2018))

AIC(lmer(rgr ~ soil_moisture*normalized_par + (1|plot_number),
          data = ceol_rgr_2018))

AIC(lmer(rgr ~ exotic_percentcover + (1|plot_number), 
          data = ceol_rgr_2018))

AIC(lmer(rgr ~ site + (1|plot_number),
          data = ceol_rgr_2018))

AIC(lmer(rgr ~ normalized_par +  soil_moisture + (1|plot_number),
                         data = ceol_rgr_2018))

AIC(lmer(rgr ~ normalized_par + exotic_percentcover + (1|plot_number),
                         data = ceol_rgr_2018))

AIC(lmer(rgr ~ normalized_par + site + (1|plot_number),
                         data = ceol_rgr_2018))

ceol_2018rgr_model <- lmer(rgr ~ normalized_par +  (1|plot_number),
                         data = ceol_rgr_2018)

summary(ceol_2018rgr_model)
```
### Rhov

```{r}
rhov_rgr_2018 <- growth_march_may %>% 
  filter(species == "RHOV")
  
AIC(lmer(rgr ~ normalized_par+  (1|plot_number),
                         data = rhov_rgr_2018))

AIC(lmer(rgr ~ soil_moisture + (1|plot_number),
          data = rhov_rgr_2018))

AIC(lmer(rgr ~ exotic_percentcover + (1|plot_number), 
          data = rhov_rgr_2018))

AIC(lmer(rgr ~ site + (1|plot_number),
          data = rhov_rgr_2018))

AIC(lmer(rgr ~ site + normalized_par + (1|plot_number),
          data = rhov_rgr_2018))
AIC(lmer(rgr ~ site + soil_moisture + (1|plot_number),
          data = rhov_rgr_2018))
AIC(lmer(rgr ~ site + exotic_percentcover + (1|plot_number),
          data = rhov_rgr_2018))

rhov_2018rgr_model <- lmer(rgr ~ site + (1|plot_number),
          data = rhov_rgr_2018)
summary(rhov_2018rgr_model)

```

### HEAR

```{r}
hear_rgr_2018 <- growth_march_may %>% 
  filter(species == "HEAR")
  
AIC(lmer(rgr ~ normalized_par +  (1|plot_number),
                         data = hear_rgr_2018))

AIC(lmer(rgr ~ soil_moisture + (1|plot_number),
          data = hear_rgr_2018))

AIC(lmer(rgr ~ exotic_percentcover + (1|plot_number), 
          data = hear_rgr_2018))

AIC(lmer(rgr ~ site + (1|plot_number),
          data = hear_rgr_2018))

AIC(lmer(rgr ~ site + normalized_par + (1|plot_number),
          data = hear_rgr_2018))

AIC(lmer(rgr ~ site + soil_moisture + (1|plot_number),
          data = hear_rgr_2018))

AIC(lmer(rgr ~ site + exotic_percentcover + (1|plot_number),
          data = hear_rgr_2018))

hear_2018rgr_model <- lmer(rgr ~ site + (1|plot_number),
          data = hear_rgr_2018)

summary(hear_2018rgr_model)
```

## SAAP

```{r}
saap_rgr_2018 <- growth_march_may %>% 
  filter(species == "SAAP")
  
# 
AIC(lmer(rgr ~ normalized_par +  (1|plot_number),
                         data = saap_rgr_2018))

AIC(lmer(rgr ~ soil_moisture + (1|plot_number),
          data = saap_rgr_2018))

AIC(lmer(rgr ~ exotic_percentcover + (1|plot_number), 
          data = saap_rgr_2018))

AIC(lmer(rgr ~ site + (1|plot_number),
          data = saap_rgr_2018))

AIC(lmer(rgr ~ normalized_par + soil_moisture + (1|plot_number),
                         data = saap_rgr_2018))

AIC(lmer(rgr ~ normalized_par + exotic_percentcover + (1|plot_number),
                         data = saap_rgr_2018))

AIC(lmer(rgr ~ normalized_par + site + (1|plot_number),
                         data = saap_rgr_2018))

saap_2018rgr_model <- lmer(rgr ~ normalized_par +  (1|plot_number),
                         data = saap_rgr_2018)

summary(saap_2018rgr_model)
```


# May 2019 Seedling survival 
  - add height
```{r may 2019 - join data, include=TRUE}
# subsetting data for May 2019 survival
# survmortnospp = may 2019
# par = may 2019
# tdr = march 2019
# nncover = 2019

par_may2019 <- dplyr::filter(par, year == "2019" & month =="5")
tdr_march2019 <- tdr %>% 
  dplyr::filter(year == "2019" & month == "3")

# Making height and survival dataframe

height_march_2019 <- height_raw %>% 
  filter(date == "2019-03-11") %>% # filtering to only have rows of data taken in March 
  dplyr::select(plot_number, MAFA_removal, location, species, stem_height_cm) %>% 
  rename(march_stem_height_cm = stem_height_cm)

survival_may_2019 <- height_raw %>% 
  filter(date>= "2019-04-30" & date <= "2019-05-01") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, alive) %>% 
  rename(may_alive = alive) %>% 
  mutate(may_alive = replace_na(may_alive, 0))  # 0= dead 1 = alive

height_march_surv_may_2019 <- full_join(height_march_2019, survival_may_2019, by = c("plot_number", "MAFA_removal", "location", "species")) %>% 
  mutate(march_stem_height_cm = as.numeric(march_stem_height_cm)) %>% 
  drop_na() %>%  # removing na's for now. But should an NA in alive be assumed as dead? 
  mutate(plot_number = as.character(plot_number)) %>% 
  left_join(par_april2018, by = "plot_number") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, march_stem_height_cm, may_alive, normalized_par) %>% 
  left_join(tdr_april2018, by = "plot_number") %>% 
  dplyr::select(!site & !treatment) %>% 
  left_join(nncover_may2018, by = "plot_number") %>% 
  dplyr::select(!treatment) %>% 
  rename(exotic_percentcover = cover_percent) %>% 
  rename(treatment = MAFA_removal) %>% 
  mutate(normalized_par = scale(normalized_par),
         soil_moisture = scale(soil_moisture),
         exotic_percentcover = scale(exotic_percentcover),
         march_stem_height_cm = scale(march_stem_height_cm))



```

```{r}
glme.may2019.mod <- glmer(as.factor(may_alive) ~ normalized_par * soil_moisture + exotic_percentcover + site + march_stem_height_cm + species + (1|plot_number), 
                         family = binomial,
                         data = height_march_surv_may_2019)
                         

MOD <- glme.may2019.mod

# Calculate model's residual and fitted values
F1 <- fitted(MOD)
E1 <- residuals(MOD, "pearson")

# See residuals as a histogram, look for normal distribution
hist(E1)

# Graph residuals against a normal distribution, look for all points to be on 1:1 line
#need to call next two lines together
qqnorm(E1, xlab = "Theoretical Quantiles", ylab = "Pearson Residuals")
qqline(E1)

# Graph residuals vs fitted values to inspect homogeneity of variance, look for a random scattering of plots
# run together 2 lines
plot(x=F1, y=E1, xlab="Fitted Model Values", ylab="Pearson Residuals", main = "Variance")
abline(h = 0) # looking for random scatter

# Check for crazy outliers, look for lines MUCH taller than the rest of data
plot(cooks.distance(MOD))

# Plot a box plot for each factor, look for equal variance amount levels along the zero line
# Box plots need to be assessed for every fixed effect (categorical factor) for your model. 
# Random effects need the qqline just like normality. 
# So, only site and treatment get box plots. 
# MAFA cover is a covariate (continuous variable).

boxplot(E1 ~ site, data = height_march_surv_may_2019) # <---- make sure to change to df, not the lme
abline(h = 0)

# Plot each random effect in the model - things in the (1|_), look for dots along 1:1 line
#qqnorm(ranef(MOD)$treatment[,1], main = "Plot Residuals")
#qqline(ranef(MOD)$treatment[,1]) # unique dates

```

```{r}
print(glme.may2019.mod)
summary(glme.may2019.mod)
anova(glme.may2019.mod) 

# post-hoc Tukey test
# get stats on interactions
emmeans(glme.may2019.mod, list(pairwise ~ site), adjust = "tukey")
# site is not significantly different (p = 0.0923)

# calculate mean survival at Site 1 and Site 2
height_march_surv_may_2019 %>% 
  group_by(site) %>% 
  summarise(MEAN_totalsurvival=mean(may_alive, na.rm = TRUE),
            SD = sd(may_alive, na.rm = TRUE), 
            N = length(may_alive), 
            SE = ((sd(may_alive, na.rm = TRUE))/sqrt(length((may_alive))))
  )
#  site  MEAN_totalsurvival    SD     N    SE
#  <chr>              <dbl> <dbl> <int> <dbl>
#   1                   6.67  3.36    18 0.792
#   2                   3.89  1.94    18 0.457
```

```{r}
## Soil moisture

moisture_site_1_low_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = min(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "1",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_2_low_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = min(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "2",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_1_mean_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = 0,
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "1",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_2_mean_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = 0,
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "2",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_1_max_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = max(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "1",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_2_max_par_2019 <- seq(from = -1.6 , to = 1.8 , by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = max(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "2",
         march_stem_height_cm = mean(height_march_surv_may_2019$march_stem_height_cm, na.rm = TRUE),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

moisture_site_1_prediction_2019 <- rbind(moisture_site_1_low_par_2019, moisture_site_1_mean_par_2019, moisture_site_1_max_par_2019)
moisture_site_2_prediction_2019 <- rbind(moisture_site_2_low_par_2019, moisture_site_2_mean_par_2019, moisture_site_2_max_par_2019)

site_1_sm_plot <- ggplot()+
  geom_point(data = height_march_surv_may_2019 %>%  filter(site == "1"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25) +
  geom_line(data = moisture_site_1_prediction_2019, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1)+
  theme_classic()+
  labs(x = "Soil Moisture (%)",
       y = "Probability of Survival",
       title = "Site 1")

site_2_sm_plot <- ggplot()+
  geom_point(data = height_march_surv_may_2019 %>%  filter(site == "2"), aes(x = soil_moisture, y = may_alive, col = normalized_par), alpha = 0.25)+
  geom_line(data = moisture_site_2_prediction_2019, aes(x = soil_moisture, y = alive, col = normalized_par, group = normalized_par), linewidth = 1)+
  theme_classic()+
  labs(x = "Soil Moisture (%)",
       y = "Probability of Survival",
       title = "Site 2")

site_1_sm_plot + site_2_sm_plot
## stem height
stem_height_site_1_prediction <- seq(from = -1.7, to = 3.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(normalized_par = mean(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "1",
         soil_moisture = mean(height_march_surv_may_2019$soil_moisture),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

stem_height_site_2_prediction <- seq(from = -1.7, to = 3.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(normalized_par = mean(height_march_surv_may_2019$normalized_par),
         exotic_percentcover = mean(height_march_surv_may_2019$exotic_percentcover),
         site = "2",
         soil_moisture = mean(height_march_surv_may_2019$soil_moisture),
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2019.mod, newdata = . , type = "response"))

site_1_sh_plot <- ggplot()+
  geom_point(data = height_march_surv_may_2019 %>%  filter(site == "1"), aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_site_1_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival",
       title = "Site 1")

site_2_sh_plot <- ggplot()+
  geom_point(data = height_march_surv_may_2019 %>%  filter(site == "2"), aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_site_2_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival",
       title = "Site 2")

site_1_sh_plot + site_2_sh_plot
```


## Repeat each model for each species

### CEOL 
```{r}
ceol_2019 <- height_march_surv_may_2019 %>% 
  filter(species == "CEOL")
  
AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ site + normalized_par + (1|plot_number),
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = ceol_2019))

AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2019))


summary(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = ceol_2019))

## Add Figure
``` 

### RHOV

```{r} 
rhov_2019 <- height_march_surv_may_2019 %>% 
  filter(species == "RHOV")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ site + normalized_par +(1|plot_number), 
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number), 
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = rhov_2019))

AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number), 
          family = binomial,
          data = rhov_2019))

rhov_model <- glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = rhov_2019)
summary(rhov_model)
```

### HEAR

```{r}
hear_2019 <- height_march_surv_may_2019 %>% 
  filter(species == "HEAR")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ normalized_par + site + (1|plot_number),
          family = binomial,
          data = hear_2019))

AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2019))

hear_moisture_model_2019 <- glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number), 
                         family = binomial,
                         data = hear_2019)

summary(hear_moisture_model_2019)

hear_moisture_pred_2019 <- seq(from = -1.6, to = 1.8, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = 1) %>% 
  mutate(alive = predict(hear_moisture_model_2019, newdata = ., type = "response"))

ggplot()+
  geom_point(data = hear_2019, aes(x = soil_moisture, y = may_alive), alpha = 0.5) +
  geom_line(data = hear_moisture_pred_2019, aes(x = soil_moisture, y = alive), linewidth = 1) +
  theme_classic()


```



```{r}
saap_2019 <- height_march_surv_may %>% 
  filter(species == "SAAP")

AIC(glmer(as.factor(may_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ march_stem_height_cm + (1|plot_number),
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ site + normalized_par + (1|plot_number), 
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ site + soil_moisture + (1|plot_number), 
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ site + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = saap_2019))

AIC(glmer(as.factor(may_alive) ~ site + march_stem_height_cm + (1|plot_number), 
          family = binomial,
          data = saap_2019))


saap_model <- glmer(as.factor(may_alive) ~ site + (1|plot_number),
                         family = binomial,
                         data = saap_2018)

summary(saap_model)
```
# Survival May - September 2019

```{r MAY 2019 - join data, include=FALSE}
par_may2019 <- dplyr::filter(par, year == "2019" & month =="9")
tdr_july2019 <- tdr %>% 
  dplyr::filter(year == "2019" & month == "7")

# Making height and survival dataframe

height_may_2019 <- height_raw %>% 
  filter(date>= "2019-04-30" & date <= "2019-05-01") %>% # filtering to only have rows of data taken in March 
  dplyr::select(plot_number, MAFA_removal, location, species, stem_height_cm) %>% 
  rename(may_stem_height_cm = stem_height_cm)

survival_sep_2019 <- height_raw %>% 
  filter(date == "2019-09-19") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, alive) %>% 
  rename(sep_alive = alive) %>% 
  mutate(sep_alive = replace_na(sep_alive, 0))  # 0= dead 1 = alive

height_may_surv_sep_2019 <- full_join(height_may_2019, survival_sep_2019, by = c("plot_number", "MAFA_removal", "location", "species")) %>% 
  mutate(may_stem_height_cm = as.numeric(may_stem_height_cm)) %>% 
  drop_na() %>%  # removing na's for now. But should an NA in alive be assumed as dead? 
  mutate(plot_number = as.character(plot_number)) %>% 
  left_join(par_april2018, by = "plot_number") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, may_stem_height_cm, sep_alive, normalized_par) %>% 
  left_join(tdr_april2018, by = "plot_number") %>% 
  dplyr::select(!site & !treatment) %>% 
  left_join(nncover_may2018, by = "plot_number") %>% 
  dplyr::select(!treatment) %>% 
  rename(exotic_percentcover = cover_percent) %>% 
  rename(treatment = MAFA_removal) %>% 
  mutate(normalized_par = scale(normalized_par),
         soil_moisture = scale(soil_moisture),
         exotic_percentcover = scale(exotic_percentcover), 
         may_stem_height_cm = scale(may_stem_height_cm))
```

```{r}
glme.sep2019.mod <- glmer(as.factor(sep_alive) ~ normalized_par +  soil_moisture  + exotic_percentcover + site + may_stem_height_cm  + species + (1|plot_number), 
                         family = binomial,
                         data = height_may_surv_sep_2019)
                         

MOD <- glme.may2019.mod

# Calculate model's residual and fitted values
F1 <- fitted(MOD)
E1 <- residuals(MOD, "pearson")

# See residuals as a histogram, look for normal distribution
hist(E1)

# Graph residuals against a normal distribution, look for all points to be on 1:1 line
#need to call next two lines together
qqnorm(E1, xlab = "Theoretical Quantiles", ylab = "Pearson Residuals")
qqline(E1)

# Graph residuals vs fitted values to inspect homogeneity of variance, look for a random scattering of plots
# run together 2 lines
plot(x=F1, y=E1, xlab="Fitted Model Values", ylab="Pearson Residuals", main = "Variance")
abline(h = 0) # looking for random scatter

# Check for crazy outliers, look for lines MUCH taller than the rest of data
plot(cooks.distance(MOD))

# Plot a box plot for each factor, look for equal variance amount levels along the zero line
# Box plots need to be assessed for every fixed effect (categorical factor) for your model. 
# Random effects need the qqline just like normality. 
# So, only site and treatment get box plots. 
# MAFA cover is a covariate (continuous variable).

boxplot(E1 ~ site, data = height_march_surv_may_2019) # <---- make sure to change to df, not the lme
abline(h = 0)

# Plot each random effect in the model - things in the (1|_), look for dots along 1:1 line
#qqnorm(ranef(MOD)$treatment[,1], main = "Plot Residuals")
#qqline(ranef(MOD)$treatment[,1]) # unique dates

```

```{r}
print(glme.sep2019.mod)
summary(glme.sep2019.mod)

exotic_site1_2019 <- seq(from = -2.2, to = 2.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(exotic_percentcover = ".") %>% 
  mutate(normalized_par = 0,
         soil_moisture = 0, 
         site = "1",
         may_stem_height_cm = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(glme.sep2019.mod, newdata = ., type = "response"))

exotic_site2_2019 <- seq(from = -2.2, to = 2.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(exotic_percentcover = ".") %>% 
  mutate(normalized_par = 0,
         soil_moisture = 0, 
         site = "2",
         may_stem_height_cm = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(glme.sep2019.mod, newdata = ., type = "response"))

exotic_site1_plot_2019 <- ggplot() +
  geom_point(data = height_may_surv_sep_2019 %>%  filter(site == "1"), aes(x = exotic_percentcover, y = sep_alive), alpha = 0.25)+
  geom_line(data = exotic_site1_2019, aes(x= exotic_percentcover, y = alive), linewidth = 1)+
  theme_classic() +
  labs(title = "Site 1",
       x = "Exotic Percent Cover",
       y = "Survival Probability")

exotic_site2_plot_2019 <- ggplot() +
  geom_point(data = height_may_surv_sep_2019 %>%  filter(site == "2"), aes(x = exotic_percentcover, y = sep_alive), alpha = 0.25)+
  geom_line(data = exotic_site2_2019, aes(x= exotic_percentcover, y = alive), linewidth = 1)+
  theme_classic() +
  labs(title = "Site 2",
       x = "Exotic Percent Cover",
       y = "Survival Probability")

exotic_site1_plot_2019 + exotic_site2_plot_2019

height_site1_2019 <- seq(from = -1.6, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(may_stem_height_cm = ".") %>% 
  mutate(normalized_par = 0, 
         soil_moisture = 0,
         exotic_percentcover = 0,
         site = "1",
         plot_number = 1) %>% 
  mutate(alive = predict(glme.sep2019.mod, newdata = ., type = "response"))

height_site2_2019 <- seq(from = -1.6, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(may_stem_height_cm = ".") %>% 
  mutate(normalized_par = 0, 
         soil_moisture = 0,
         exotic_percentcover = 0,
         site = "2",
         plot_number = 1) %>% 
  mutate(alive = predict(glme.sep2019.mod, newdata = ., type = "response"))

height_site1_plot_2019 <- ggplot()+
  geom_point(data = height_may_surv_sep_2019 %>%  filter(site == "1"), aes(x = may_stem_height_cm, y = sep_alive), alpha = 0.25) +
  geom_line(data = height_site1_2019, aes(x = may_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(title = "Site 1",
       x = "Stem Height (cm)",
       y = "Survival Probability")

height_site2_plot_2019 <- ggplot()+
  geom_point(data = height_may_surv_sep_2019 %>%  filter(site == "2"), aes(x = may_stem_height_cm, y = sep_alive), alpha = 0.25) +
  geom_line(data = height_site2_2019, aes(x = may_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(title = "Site 2",
       x = "Stem Height (cm)",
       y = "Survival Probability")

height_site1_plot_2019 + height_site2_plot_2019

```

## Repeat each model for each species

### CEOL 
```{r}
ceol_2019_sep <- height_may_surv_sep_2019 %>% 
  filter(species == "CEOL")
  
AIC(glmer(as.factor(sep_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + normalized_par + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + soil_moisture + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = ceol_2019_sep))

ceol_2019_sep_model <- glmer(as.factor(sep_alive) ~ soil_moisture + (1|plot_number), 
          family = binomial,
          data = ceol_2019_sep)

summary(ceol_2019_sep_model)

ceol_moisture_2019 <- seq(from = -1.7, to = 1.7, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(plot_number = 1) %>% 
  mutate(alive = predict(ceol_2019_sep_model, newdata = ., type = "response"))

ggplot()+
  geom_point(data = ceol_2019_sep, aes(x = soil_moisture, y = sep_alive), alpha = 0.25) +
  geom_line(data = ceol_moisture_2019, aes(x = soil_moisture, y = alive), linewidth = 1)+
  theme_classic() +
  labs(x = "Soil Moisture", 
       y = "Survival Probability")

``` 

### RHOV

```{r} 
rhov_2019_sep <- height_may_surv_sep_2019 %>% 
  filter(species == "RHOV")

AIC(glmer(as.factor(sep_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + normalized_par +(1|plot_number), 
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + soil_moisture + (1|plot_number), 
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = rhov_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + (1|plot_number), 
          family = binomial,
          data = rhov_2019_sep))

rhov_2019_sep_model <- glmer(as.factor(may_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = rhov_2019)
summary(rhov_2019_sep_model)
```

### HEAR

```{r}
hear_2019_sep <- height_may_surv_sep_2019 %>% 
  filter(species == "HEAR")

AIC(glmer(as.factor(sep_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + exotic_percentcover + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ normalized_par + site + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + exotic_percentcover + soil_moisture + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + exotic_percentcover + normalized_par + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + exotic_percentcover + may_stem_height_cm + (1|plot_number),
          family = binomial,
          data = hear_2019_sep))

hear_2019_sep_model <- glmer(as.factor(sep_alive) ~ site + exotic_percentcover + (1|plot_number), 
                         family = binomial,
                         data = hear_2019_sep)

summary(hear_2019_sep_model)

hear_exotic_site1_2019 <- seq(from = -2.2, to = 2.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(exotic_percentcover = ".") %>% 
  mutate(site = "1",
         plot_number = 1) %>% 
  mutate(alive = predict(hear_2019_sep_model, newdata = ., type = "response"))

hear_exotic_site2_2019 <- seq(from = -2.2, to = 2.2, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(exotic_percentcover = ".") %>% 
  mutate(site = "2",
         plot_number = 1) %>% 
  mutate(alive = predict(hear_2019_sep_model, newdata = ., type = "response"))

hear_exotic_site1_plot_2019 <- ggplot()+
  geom_point(data = hear_2019_sep %>% filter(site == "1"), aes(x = exotic_percentcover, y = sep_alive), alpha = 0.5) +
  geom_line(data = hear_exotic_site1_2019, aes(x = exotic_percentcover, y = alive), linewidth = 1) +
  theme_classic() +
  labs(title = "Site 1",
       x = "Exotic Percent Cover",
       y = "Survival Probability")

hear_exotic_site2_plot_2019 <- ggplot()+
  geom_point(data = hear_2019_sep %>% filter(site == "2"), aes(x = exotic_percentcover, y = sep_alive), alpha = 0.5) +
  geom_line(data = hear_exotic_site2_2019, aes(x = exotic_percentcover, y = alive), linewidth = 1) +
  theme_classic() +
  labs(title = "Site 2",
       x = "Exotic Percent Cover",
       y = "Survival Probability")

hear_exotic_site1_plot_2019 + hear_exotic_site2_plot_2019

```



```{r}
saap_2019_sep <- height_may_surv_sep_2019 %>%
  filter(species == "SAAP")

AIC(glmer(as.factor(sep_alive) ~ normalized_par +  (1|plot_number), 
                         family = binomial,
                         data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ soil_moisture + (1|plot_number),
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ exotic_percentcover + (1|plot_number),
          family = binomial, 
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~  + (1|plot_number),
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + normalized_par + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + soil_moisture + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ may_stem_height_cm + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + normalized_par + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + soil_moisture + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + normalized_par + soil_moisture + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

AIC(glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + normalized_par + exotic_percentcover + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep))

saap_2019_sep_model <- glmer(as.factor(sep_alive) ~ site + may_stem_height_cm + normalized_par + (1|plot_number), 
          family = binomial,
          data = saap_2019_sep)

summary(saap_2019_sep_model)

saap_height_site1_2019 <- seq(from = -1.4, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(may_stem_height_cm = ".") %>% 
  mutate(site = "1",
         normalized_par = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(saap_2019_sep_model, newdata = ., type = "response"))

saap_height_site2_2019 <- seq(from = -1.4, to = 4, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(may_stem_height_cm = ".") %>% 
  mutate(site = "2",
         normalized_par = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(saap_2019_sep_model, newdata = ., type = "response"))


saap_height_site1_plot_2019 <- ggplot()+
  geom_point(data = saap_2019_sep %>% filter(site == "1"), aes(x = may_stem_height_cm, y = sep_alive), alpha = 0.5) +
  geom_line(data = saap_height_site1_2019, aes(x = may_stem_height_cm, y = alive), linewidth = 1) +
  theme_classic()+
  labs(title = "Site 1",
       x = "Stem Height (cm)",
       y = "Survival Probability")

saap_height_site2_plot_2019 <- ggplot()+
  geom_point(data = saap_2019_sep %>% filter(site == "2"), aes(x = may_stem_height_cm, y = sep_alive), alpha = 0.5) +
  geom_line(data = saap_height_site2_2019, aes(x = may_stem_height_cm, y = alive), linewidth = 1) +
  theme_classic()+
  labs(title = "Site 2",
       x = "Stem Height (cm)",
       y = "Survival Probability")

saap_height_site1_plot_2019 + saap_height_site2_plot_2019

saap_par_site1_2019 <- seq(from = -1.7, to = 2.3, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(site = "1",
         may_stem_height_cm = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(saap_2019_sep_model, newdata = ., type = "response"))

saap_par_site2_2019 <- seq(from = -1.7, to = 2.3, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(normalized_par = ".") %>% 
  mutate(site = "2",
         may_stem_height_cm = 0, 
         plot_number = 1) %>% 
  mutate(alive = predict(saap_2019_sep_model, newdata = ., type = "response"))


saap_par_site1_plot_2019 <- ggplot()+
  geom_point(data = saap_2019_sep %>% filter(site == "1"), aes(x = normalized_par, y = sep_alive), alpha = 0.5) +
  geom_line(data = saap_par_site1_2019, aes(x = normalized_par, y = alive), linewidth = 1) +
  theme_classic()+
  labs(title = "Site 1",
       x = "Normalized PAR",
       y = "Survival Probability")

saap_par_site2_plot_2019 <- ggplot()+
  geom_point(data = saap_2019_sep %>% filter(site == "2"), aes(x = normalized_par, y = sep_alive), alpha = 0.5) +
  geom_line(data = saap_par_site2_2019, aes(x = normalized_par, y = alive), linewidth = 1) +
  theme_classic()+
  labs(title = "Site 2",
       x = "Normalized PAR",
       y = "Survival Probability")

saap_par_site1_plot_2019 + saap_par_site2_plot_2019
```
  
  