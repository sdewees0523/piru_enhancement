---
title: "Piru_enhancement_seedlingsurvival"
author: "Stephanie Ma Lucero"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load libraries

```{r libraries, message=FALSE}
library(here) # similar to set working directory
library(tidyverse) # data wrangling
library(emmeans)
```

# Load colors for graphs

```{r colors, include=TRUE}
devtools::install_github("an-bui/calecopal")

library(calecopal)
# all palettes
names(cal_palettes)

# Site colors: 1, 2 
cal_palette(name = "chaparral1", n = 5, type = "continuous") # [1] "#DCC27A" "#F19B34"
site1color <- "#DCC27A"
site2color <- "#F19B34"
sitecolors <- c(site1color, site2color)

# Treatment colors: Full, half, none 
cal_palette(name = "chaparral3", n = 5, type = "continuous") # [1] "#D3E3CA", "#92A587", "#2F3525"
cal_palette(name = "desert", n = 5, type = "continuous") # [1] "#F6EECF", "#B09175", "#291611"
treatment1color <- "#F6EECF"
treatment2color <- "#B09175"
treatment3color <- "#291611"
treatmentcolors <- c(treatment1color, treatment2color, treatment3color)

```

# Question 2: How does seedling survival change with PAR, TDR, % nn cover, and species?

Notes:
* __response variable__: The variable you want to test. (e.g.,. PAR, TDR, nncover)
* __explanatory variables__: The variables that can explain the outcome. (e.g., treatment, mafacover, site)
* __data frame__: Include all the data you'll be working with. (e.g., combine par and mafa_cover_all)
* __formula__: a formula is a two-sided linear formula object describing both the _fixed-effects_ and _random effects_ part of the model, with the response on the left of a ~ operator and the terms, separated by + operators, on the right. 
* __random effects__: Random-effects terms are distinguished by vertical bars __(|)__ separating expressions for design matrices from grouping factors. Two vertical bars __(||)__ can be used to specify multiple uncorrelated random effects for the same grouping variable. 
  + Because of the way it is implemented, the ||-syntax works only for design matrices containing numeric (continuous) predictors; to fit models with independent categorical effects, see dummy or the lmer_alt function from the afex package.)
  
  

### Load PAR, TDR, and non-native percent cover data.

### Saved as a csv in the "Processed" data folder.
```{r load data csvs, include=TRUE}

# survival and mortality data
survmort_load <- read_csv("data/processed/survmort.csv",
                      col_types = cols(
                        year = col_integer(),
                        month = col_integer(), 
                        site = col_integer(),
                        plot_number = col_character(), 
                        treatment = col_character(),
                        species = col_character(), 
                        alive = col_double(),
                        dead = col_double(), 
                        month_count = col_integer(),
                        transplanted = col_integer()
                      )
                        )
# survival and mortality data WITH species
survmort <- survmort_load %>% 
  select(year, month, plot_number, treatment, species, alive, dead, site, month_count, transplanted) %>% 
  mutate(treatment = case_when(treatment == "no" ~ "none")) # <----------- HOW DO YOU RENAME "NO" TO "NONE"? Stephanie's fix - omit "treatment" in left-join


print(survmort)
# survival and mortality data WITHOUT species
survmortnospp <- survmort_load %>% 
  select(year, month, plot_number, treatment, alive, dead, site, month_count, transplanted) %>% 
  group_by(year, month, site, plot_number, treatment, month_count, transplanted) %>% 
  summarize(totalsurvival = sum(alive), 
            totalmortality = sum(dead)) %>% 
  ungroup()
print(survmortnospp) # :) yay! it worked!

# PAR data
par_load <- read_csv("data/processed/par.csv",
  col_types = cols(
    date = col_date(format = ""),
    plot_number = col_character(),
    treatment = col_character(),
    year = col_integer(),
    month = col_integer(),
    site = col_integer(),
    normalized_par = col_double()
    )
)

par <- par_load %>% 
  select(year, month, site, plot_number, treatment, normalized_par)
print(par)

# TDR data
tdr_load <- read_csv("data/processed/tdr.csv",
  col_types = cols(
    plot_number = col_character(),
    treatment = col_character(),
    year = col_integer(),
    month = col_integer(),
    site = col_integer(),
    soil_moisture = col_double()
    )
  )

tdr <- tdr_load %>% 
   select(year, month, site, plot_number, treatment, soil_moisture)
print(tdr)  

# exotic percent cover
exotic_cover_all_load <- read_csv("data/processed/exotic_cover_all.csv",
  col_types = cols(
    date = col_date(),
    year = col_integer(),
    site = col_integer(),
    plot_number = col_character(),
    MAFA_removal = col_character(),
    cover_percent = col_double()
  )
)

exotic_cover_all <- exotic_cover_all_load %>% 
  select(date, year, site, plot_number, MAFA_removal, cover_percent) %>% 
  rename(treatment = MAFA_removal)
print(exotic_cover_all)


#mafa_cover_all_load <- read_csv("data/processed/mafa_cover_all.csv",
#  col_types = cols(
#    plot_number = col_character(),
#    year = col_integer(),
#    cover_percent = col_double(),
#    site = col_integer()
#    )
#  )
#mafa_cover_all <- mafa_cover_all_load %>% 
#  select(plot_number, year, cover_percent, site) 
#print(mafa_cover_all)

```
  

# May 2018 
  
```{r MAY 2018 - join data, include=TRUE}

# subsetting data for May 2018 survival
# survmortnospp = may 2018
# par = april 2018
# tdr = april 2018
# nncover = may 2018
survmortnospp_may2018 <- dplyr::filter(survmortnospp, year == "2018" & month =="5")
par_april2018 <- dplyr::filter(par, year == "2018" & month =="4")
tdr_april2018 <- tdr %>% 
  dplyr::filter(year == "2018" & month =="4")
nncover_may2018 <- dplyr::filter(exotic_cover_all, year == "2018")

# left join data for May 2018 survival
survmortnospp_may2018_join <- survmortnospp_may2018 %>% 
  dplyr::left_join(par_april2018, by = c("year", "site", "plot_number"), na.rm = F) %>%    #left join par
  select(!treatment.x) %>% 
   rename(month_survival = month.x, 
         month_par = month.y, 
         treatment = treatment.y) %>% 
  #select(!date) %>% 
  select(transplanted, year, month_survival, month_count, site, plot_number, treatment, normalized_par, month_par, totalsurvival, totalmortality) %>% 
  dplyr::left_join(tdr_april2018, by = c("year", "site", "plot_number"), na.rm = F) %>%   # left join tdr
  rename(treatment = treatment.x, 
         month_tdr = month) %>% 
  select(!treatment.y) %>% 
   dplyr::left_join(nncover_may2018, by = c("year", "site", "plot_number"), na.rm = F) %>%   # left join exotic percent cover
  rename(exotic_percentcover = cover_percent) %>% 
  select(!treatment.y) %>% 
  select(!date) %>% 
  rename(treatment = treatment.x)
view(survmortnospp_may2018_join)
```

- testing if the residuals are normally distributed

```{r MAY 2018 - normality, include =TRUE}

lme.may2018.mod <- lmer(totalsurvival ~ normalized_par + soil_moisture + exotic_percentcover + site + (1|treatment), # <-- DO I NEED TO INCLUDE TREATMENT IF IT WASN'T SIG?
                         data = survmortnospp_may2018_join)

MOD <- lme.may2018.mod

# Calculate model's residual and fitted values
F1 <- fitted(MOD)
E1 <- residuals(MOD, "pearson")

# See residuals as a histogram, look for normal distribution
hist(E1)

# Graph residuals against a normal distribution, look for all points to be on 1:1 line
#need to call next two lines together
qqnorm(E1, xlab = "Theoretical Quantiles", ylab = "Pearson Residuals")
qqline(E1)

# Graph residuals vs fitted values to inspect homogeneity of variance, look for a random scattering of plots
# run together 2 lines
plot(x=F1, y=E1, xlab="Fitted Model Values", ylab="Pearson Residuals", main = "Variance")
abline(h = 0) # looking for random scatter

# Check for crazy outliers, look for lines MUCH taller than the rest of data
plot(cooks.distance(MOD))

# Plot a box plot for each factor, look for equal variance amount levels along the zero line
# Box plots need to be assessed for every fixed effect (categorical factor) for your model. 
# Random effects need the qqline just like normality. 
# So, only site and treatment get box plots. 
# MAFA cover is a covariate (continuous variable).

boxplot(E1 ~ site, data = survmortnospp_may2018_join) # <---- make sure to change to df, not the lme
abline(h = 0)

# Plot each random effect in the model - things in the (1|_), look for dots along 1:1 line
qqnorm(ranef(MOD)$treatment[,1], main = "Plot Residuals")
qqline(ranef(MOD)$treatment[,1]) # unique dates

```

- statistics

```{r MAY 2018 - stats, include=TRUE}

print(lme.may2018.mod)
summary(lme.may2018.mod)
anova(lme.may2018.mod) # A significant p-value indicates that one or more significant differences exist between group means.
# seedling survival is not correlated with par, tdr, exotic percent cover, or site.
# site may be ecologically interesting (p = 0.0843)

# calculate mean survival at Site 1 and Site 2
avgmay2018surv <- survmortnospp_may2018_join %>% 
  group_by(site) %>% 
  summarise(mean_survival=mean(totalsurvival, na.rm = TRUE),
            sd_survival=sd(totalsurvival, na.rm = TRUE))
```

- figures
```{r MAY 2018 - figures, include=TRUE}

# boxplot: average survival by site
may2018boxplot <- survmortnospp_may2018_join %>% 

ggplot(data = survmortnospp_may2018_join, aes(x = site, y = totalsurvival)) +
   geom_boxplot(aes(group = site)) +# <-- How change site from col_integer to col_character here? 
   labs(title = "Average seedling survival in May 2018", x = "Site", y = "Average seedling survival (n)") + 
    theme_bw() 

```



# May 2019 Seedling survival 

```{r MAY 2019 - join data, include=TRUE}

# START HERE!!!!!!!!!!


# subsetting data for May 2019 survival
# survmortnospp = may 2018
# par = april 2018
# tdr = april 2018
# nncover = may 2018
survmortnospp_may2018 <- dplyr::filter(survmortnospp, year == "2018" & month =="5")
par_april2018 <- dplyr::filter(par, year == "2018" & month =="4")
tdr_april2018 <- tdr %>% 
  dplyr::filter(year == "2018" & month =="4")
nncover_may2018 <- dplyr::filter(exotic_cover_all, year == "2018")

# left join data for May 2018 survival
survmortnospp_may2018_mod <- survmortnospp_may2018 %>% 
  dplyr::left_join(par_april2018, by = c("year", "site", "plot_number", "treatment"), na.rm = F) %>%    #left join par
  rename(month_survival = month.x, 
         month_par = month.y) %>% 
  select(!date) %>% 
  dplyr::left_join(tdr_april2018, by = c("year", "site", "plot_number"), na.rm = F) %>%   # left join tdr
  rename(treatment = treatment.x, 
         month_tdr = month) %>% 
  select(!treatment.y) %>% 
   dplyr::left_join(nncover_may2018, by = c("year", "site", "plot_number"), na.rm = F) %>%   # left join exotic percent cover
  rename(exotic_percentcover = cover_percent) %>% 
  select(!treatment.y) %>% 
  select(!date)
view(survmortnospp_may2018_mod)

```


```{r}
may2019survival <- dplyr::filter(survmortnospp, year == "2019" & month =="5")
sept2019survival <- dplyr::filter(survmortnospp, year == "2019" & month =="9")
nov2019survival <- dplyr::filter(survmortnospp, year == "2019" & month =="11")



april


```
```{r left join, include=TRUE}
  left_join(par, by = c("year", "site", "plot_number"), na.rm = F) 
  
  
  rename(mafacover = cover_percent)
print(parmod)
write.csv(parmod, "data/processed/par_model.csv")
par1 <- filter(parmod, site == "1")
par2 <- filter(parmod, site == "2")

# TDR
tdrmod <- tdr %>% 
  left_join(mafa_cover_all, by = c("year", "site", "plot_number"), na.rm = F) %>% 
  rename(mafacover = cover_percent) %>% 
  filter(year <= 2019)
print(tdrmod)
write.csv(tdrmod, "data/processed/tdr_model.csv")
tdr1 <- filter(tdrmod, site == "1")
tdr2 <- filter(tdrmod, site == "2")

# NN COVER
nnmod <- exotic_cover_all %>% 
   left_join(mafa_cover_all, by = c("year", "month", "site", "plot_number"), na.rm = F) %>% 
  rename(nncover = cover_percent.x,
         mafacover = cover_percent.y, 
         treatment = MAFA_removal) %>% 
   col_types = cols(
      year = col_character()) %>% 
  select("date", "year", "site", "plot_number", "treatment", "nncover", "mafacover")
print(nnmod)
write.csv(nnmod, "data/processed/nn_model.csv")
nnmod1 <- filter(nnmod, site == "1")
nnmod2 <- filter(nnmod, site == "2")
```
  
  