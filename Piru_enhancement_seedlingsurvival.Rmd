---
title: "Piru_enhancement_seedlingsurvival"
author: "Stephanie Ma Lucero"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load libraries

```{r libraries, message=FALSE}
library(here) # similar to set working directory
library(dplyr) # includes functions:
library(tidyverse) # data wrangling, includes packages: ggplot2, tibble, tidyr, rear, purrr, stringr, forcats
library(lme4)
library(lmerTest)
library(emmeans) 
library(lubridate)
library(patchwork)
```

# Load colors for graphs

```{r colors, include=TRUE}
devtools::install_github("an-bui/calecopal")

library(calecopal)
# all palettes
names(cal_palettes)

# Site colors: 1, 2 
cal_palette(name = "chaparral1", n = 5, type = "continuous") # [1] "#DCC27A" "#F19B34"
site1color <- "#DCC27A"
site2color <- "#F19B34"
site1outline <- "#9C8A58"
site2outline <- "#936126"
sitecolors <- c(site1color, site2color)

# Treatment colors: Full, half, none 
cal_palette(name = "chaparral3", n = 5, type = "continuous") # [1] "#D3E3CA", "#92A587", "#2F3525"
cal_palette(name = "desert", n = 5, type = "continuous") # [1] "#F6EECF", "#B09175", "#291611"
treatment1color <- "#F6EECF"
treatment2color <- "#B09175"
treatment3color <- "#291611"
treatmentcolors <- c(treatment1color, treatment2color, treatment3color)

```

# Question 2: How does seedling survival change with PAR, TDR, % nn cover, and species?

Notes:
* __response variable__: The variable you want to test. (e.g.,. PAR, TDR, nncover)
* __explanatory variables__: The variables that can explain the outcome. (e.g., treatment, mafacover, site)
* __data frame__: Include all the data you'll be working with. (e.g., combine par and mafa_cover_all)
* __formula__: a formula is a two-sided linear formula object describing both the _fixed-effects_ and _random effects_ part of the model, with the response on the left of a ~ operator and the terms, separated by + operators, on the right. 
* __random effects__: Random-effects terms are distinguished by vertical bars __(|)__ separating expressions for design matrices from grouping factors. Two vertical bars __(||)__ can be used to specify multiple uncorrelated random effects for the same grouping variable. 
  + Because of the way it is implemented, the ||-syntax works only for design matrices containing numeric (continuous) predictors; to fit models with independent categorical effects, see dummy or the lmer_alt function from the afex package.)
  
  

### Load PAR, TDR, and non-native percent cover data.

### Saved as a csv in the "Processed" data folder.
```{r load data csvs, include=TRUE}

# survival and mortality data
survmort_load <- read_csv("data/processed/survmort.csv",
                      col_types = cols(
                        year = col_character(),
                        month = col_character(), 
                        site = col_character(),
                        plot_number = col_character(), 
                        treatment = col_character(),
                        species = col_character(), 
                        alive = col_integer(),
                        dead = col_integer(), 
                        month_count = col_integer(),
                        transplanted = col_character()
                      )
                        )
# survival and mortality data WITH species
survmort <- survmort_load %>% 
  dplyr::select(year, month, plot_number, treatment, species, alive, dead, site, month_count, transplanted) # %>%  
#  mutate(treatment = recode(treatment, no = "none"))

# survival and mortality data WITHOUT species
survmortnospp <- survmort_load %>% 
  dplyr::select(year, month, plot_number, treatment, alive, dead, site, month_count, transplanted) %>% 
 # mutate(treatment = recode(treatment, no = "none")) %>% 
  group_by(year, month, site, plot_number, treatment, month_count, transplanted) %>% 
  summarize(totalsurvival = sum(alive), 
            totalmortality = sum(dead)) %>% 
  ungroup()
print(survmortnospp) # :) yay! it worked!

survmortnospp %>% # check number of data points
  group_by(year, treatment) %>% 
  summarise(N = length(totalsurvival))

# loading in height data
height_raw <- read.csv(here("data", "seedlingheight_survival_data.csv")) %>% 
  mutate(date = mdy(date)) #having R recognize date as a date

#

# PAR data
par_load <- read_csv("data/processed/par.csv",
  col_types = cols(
    date = col_character(),
    plot_number = col_character(),
    treatment = col_character(),
    year = col_character(),
    month = col_character(),
    site = col_character(),
    normalized_par = col_double()
    )
)

par <- par_load %>% 
  dplyr::select(year, month, site, plot_number, treatment, normalized_par)
print(par)

# TDR data
tdr_load <- read_csv("data/processed/tdr.csv",
  col_types = cols(
    plot_number = col_character(),
    treatment = col_character(),
    year = col_character(),
    month = col_character(),
    site = col_character(),
    soil_moisture = col_double()
    )
  )

tdr <- tdr_load %>% 
   dplyr::select(year, month, site, plot_number, treatment, soil_moisture)
print(tdr)  

# exotic percent cover
exotic_cover_all_load <- read_csv("data/processed/exotic_cover_all.csv",
  col_types = cols(
    date = col_character(),
    year = col_character(),
    site = col_character(),
    plot_number = col_character(),
    MAFA_removal = col_character(),
    cover_percent = col_double()
  )
)


exotic_cover_all <- exotic_cover_all_load %>% 
  dplyr::select(date, year, site, plot_number, MAFA_removal, cover_percent) %>% 
  rename(treatment = MAFA_removal)
print(exotic_cover_all)


#mafa_cover_all_load <- read_csv("data/processed/mafa_cover_all.csv",
#  col_types = cols(
#    plot_number = col_character(),
#    year = col_integer(),
#    cover_percent = col_double(),
#    site = col_integer()
#    )
#  )
#mafa_cover_all <- mafa_cover_all_load %>% 
#  select(plot_number, year, cover_percent, site) 
#print(mafa_cover_all)

```
  
***

# May 2018 

### Code to save for later on calculating survival rate or change between two time points. 

- RUN AFTER "SURVIVAL AT TIME POINTS" AND ONLY MAKE CODE IF IT'S NEEDED
  
```{r MAY 2018 - rate of change, include=TRUE}

# YOU DON'T NEED TO CALCULATE SURVIVAL RATE RIGHT NOW
# JUST RUN MODELS TO SEE WHAT MAKES A DIFFERENCE AT SURVEY TIME POINT. 
# YOU CAN ALWAYS GO BACK AND CALCULATE RATE ON YOUR SECOND PASS.
# 
# 
# t1 = jan 2019- march 2019
# t2 = march 2018 - may 2019
# t3 = may 2019 - sept 2019
# t4 = sept 2019 - nov 2019

# 
#survmortnospp_2018 <- survmortnospp %>% 
#  dplyr::filter(year == "2018") %>% 
#  dplyr::select(!totalmortality) %>% 
#  dplyr::select(!month_count)

#survmortnospp_2018_wider <- survmortnospp_2018 %>%
#  pivot_wider(names_from = month, values_from = totalsurvival) 
  
#view(survmortnospp_2018_wider)

# END OF CREATING A WIDER DF
```



### Subsetting dataframes survival, par, tdr, and nncover to May 2018 data
  - Add height at March to include in model

```{r MAY 2018 - join data, include=TRUE}
# subsetting data for May 2018 survival
# survmortnospp = may 2018
# par = april 2018
# tdr = april 2018
# nncover = may 2018

survmortnospp_may2018 <- dplyr::filter(survmortnospp, year == "2018" & month =="5") #survival May 2018
par_april2018 <- dplyr::filter(par, year == "2018" & month =="4") # par april 2018
tdr_april2018 <- tdr %>% dplyr::filter(year == "2018" & month =="4") #tdr april 2018
nncover_may2018 <- dplyr::filter(exotic_cover_all, year == "2018") # nncover may 2018

height_march <- height_raw %>% 
  filter(date >= "2018-02-24" & date <= "2018-03-31") %>% # filtering to only have rows of data taken in March 
  dplyr::select(plot_number, MAFA_removal, location, species, stem_height_cm, individual) %>% 
  rename(march_stem_height_cm = stem_height_cm)

survival_may <- height_raw %>% 
  filter(date >= "2018-05-01" & date <= "2018-05-31") %>% 
  dplyr::select(plot_number, MAFA_removal, location, species, alive, individual) %>% 
  rename(may_alive = alive) %>% 
  mutate(may_alive = replace_na(may_alive, 0),
         individual = case_when(individual == "s" ~ "S",
                                individual == "c" ~ "C",
                                individual == "r" ~ "R",
                                TRUE ~ individual))  # 0= dead 1 = alive

height_march_surv_may <- full_join(height_march, survival_may, by = c("plot_number", "MAFA_removal", "location", "species", "individual")) %>% 
  drop_na() %>%  # removing na's for now. But should an NA in alive be assumed as dead? 
  mutate(plot_number = as.character(plot_number)) %>% 
  left_join(par_april2018, by = "plot_number") %>% 
  select(plot_number, MAFA_removal, location, species, individual, march_stem_height_cm, may_alive, normalized_par) %>% 
  left_join(tdr_april2018, by = "plot_number") %>% 
  select(!year & !site & !month & !treatment) %>% 
  left_join(nncover_may2018, by = "plot_number") %>% 
  select(!year & !date & !treatment) %>% 
  rename(exotic_percentcover = cover_percent) %>% 
  rename(treatment = MAFA_removal) %>% 
  mutate(march_stem_height_cm = as.numeric(march_stem_height_cm))
  
  
#view(survmortnospp_may2018)

survmortnospp_may2018_join <- survmortnospp_may2018 %>% 
  dplyr::left_join(par_april2018, by = c("year", "site", "plot_number")) %>%    #left join par
  dplyr::select(!treatment.x) %>% 
   rename(month_survival = month.x, 
         month_par = month.y, 
         treatment = treatment.y) %>% 
  #select(!date) %>% 
  dplyr::select(transplanted, year, month_survival, month_count, site, plot_number, treatment, normalized_par, month_par, totalsurvival, totalmortality) %>% 
  dplyr::left_join(tdr_april2018, by = c("year", "site", "plot_number")) %>%   # left join tdr
  rename(treatment = treatment.x, 
         month_tdr = month) %>% 
  dplyr::select(!treatment.y) %>% 
   dplyr::left_join(nncover_may2018, by = c("year", "site", "plot_number")) %>%   # left join exotic percent cover
  rename(exotic_percentcover = cover_percent) %>% 
  dplyr::select(!treatment.y) %>% 
  dplyr::select(!date) %>% 
  rename(treatment = treatment.x)
view(survmortnospp_may2018_join)
```

- testing if the residuals are normally distributed

```{r MAY 2018 - normality, include =TRUE}

glme.may2018.mod <- glmer(as.factor(may_alive) ~ normalized_par + soil_moisture + exotic_percentcover + site + march_stem_height_cm + (1|treatment) + (1|plot_number), 
                         family = binomial,
                         data = height_march_surv_may) # <-- DO I NEED TO INCLUDE TREATMENT IF IT WASN'T SIG? Now treatment is significant... 
# plot number not included because only data point per plot (n = 36)
                         

MOD <- glme.may2018.mod

# Calculate model's residual and fitted values
F1 <- fitted(MOD)
E1 <- residuals(MOD, "pearson")

# See residuals as a histogram, look for normal distribution
hist(E1)

# Graph residuals against a normal distribution, look for all points to be on 1:1 line
#need to call next two lines together
qqnorm(E1, xlab = "Theoretical Quantiles", ylab = "Pearson Residuals")
qqline(E1)

# Graph residuals vs fitted values to inspect homogeneity of variance, look for a random scattering of plots
# run together 2 lines
plot(x=F1, y=E1, xlab="Fitted Model Values", ylab="Pearson Residuals", main = "Variance")
abline(h = 0) # looking for random scatter

# Check for crazy outliers, look for lines MUCH taller than the rest of data
plot(cooks.distance(MOD))

# Plot a box plot for each factor, look for equal variance amount levels along the zero line
# Box plots need to be assessed for every fixed effect (categorical factor) for your model. 
# Random effects need the qqline just like normality. 
# So, only site and treatment get box plots. 
# MAFA cover is a covariate (continuous variable).

boxplot(E1 ~ site, data = height_march_surv_may) # <---- make sure to change to df, not the lme
abline(h = 0)

# Plot each random effect in the model - things in the (1|_), look for dots along 1:1 line
qqnorm(ranef(MOD)$treatment[,1], main = "Plot Residuals")
qqline(ranef(MOD)$treatment[,1]) # unique dates

```

- statistics

```{r MAY 2018 - stats, include=TRUE}

print(glme.may2018.mod)
summary(glme.may2018.mod)
anova(glme.may2018.mod) # A significant p-value indicates that one or more significant differences exist between group means.
# seedling survival is not correlated with par, tdr, exotic percent cover, or site.
# SITE may be ecologically interesting (p = 0.0843)
# Type III Analysis of Variance Table with Satterthwaite's method
#                     Sum Sq Mean Sq NumDF  DenDF F value  Pr(>F)  
#normalized_par       1.8734  1.8734     1 30.996  0.2605 0.61338  
#soil_moisture        2.5569  2.5569     1 30.834  0.3556 0.55534  
#exotic_percentcover  1.7381  1.7381     1 25.546  0.2417 0.62718  
#site                22.9048 22.9048     1 30.273  3.1850 0.08434 .

# post-hoc Tukey test
# get stats on interactions
emmeans(glme.may2018.mod, list(pairwise ~ site), adjust = "tukey")
# site is not significantly different (p = 0.0923)

# calculate mean survival at Site 1 and Site 2
height_march_surv_may %>% 
  group_by(site) %>% 
  summarise(MEAN_totalsurvival=mean(may_alive, na.rm = TRUE),
            SD = sd(may_alive, na.rm = TRUE), 
            N = length(may_alive), 
            SE = ((sd(may_alive, na.rm = TRUE))/sqrt(length((may_alive))))
  )
#  site  MEAN_totalsurvival    SD     N    SE
#  <chr>              <dbl> <dbl> <int> <dbl>
#   1                   6.67  3.36    18 0.792
#   2                   3.89  1.94    18 0.457
```

- figures 
```{r MAY 2018 - figures, include=TRUE}

## Soil moisture

soil_moisture_site_1_prediction <- c(6:12) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = mean(height_march_surv_may$normalized_par),
         exotic_percentcover = mean(height_march_surv_may$exotic_percentcover),
         site = "1",
         march_stem_height_cm = mean(height_march_surv_may$march_stem_height_cm, na.rm = TRUE),
         treatment = "full removal",
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

soil_moisture_site_2_prediction <- c(6:12) %>% 
  as.data.frame() %>% 
  rename(soil_moisture = ".") %>% 
  mutate(normalized_par = mean(height_march_surv_may$normalized_par),
         exotic_percentcover = mean(height_march_surv_may$exotic_percentcover),
         site = "2",
         march_stem_height_cm = mean(height_march_surv_may$march_stem_height_cm, na.rm = TRUE),
         treatment = "full removal",
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

site_1_sm_plot <- ggplot()+
  geom_point(data = height_march_surv_may %>%  filter(site == "1"), aes(x = soil_moisture, y = may_alive), alpha = 0.25)+
  geom_line(data = soil_moisture_site_1_prediction, aes(x = soil_moisture, y = alive), linewidth = 1)+
  theme_classic()+
  labs(x = "Soil Moisture (%)",
       y = "Probability of Survival",
       title = "Site 1")

site_2_sm_plot <- ggplot()+
  geom_point(data = height_march_surv_may %>%  filter(site == "2"), aes(x = soil_moisture, y = may_alive), alpha = 0.25)+
  geom_line(data = soil_moisture_site_2_prediction, aes(x = soil_moisture, y = alive), linewidth = 1)+
  theme_classic()+
  labs(x = "Soil Moisture (%)",
       y = "Probability of Survival",
       title = "Site 2")

site_1_sm_plot + site_2_sm_plot
## stem height
stem_height_site_1_prediction <- seq(from = 0.2, to = 14, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(normalized_par = mean(height_march_surv_may$normalized_par),
         exotic_percentcover = mean(height_march_surv_may$exotic_percentcover),
         site = "1",
         soil_moisture = mean(height_march_surv_may$soil_moisture),
         treatment = "full removal",
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

stem_height_site_2_prediction <- seq(from = 0.2, to = 14, by = 0.1) %>% 
  as.data.frame() %>% 
  rename(march_stem_height_cm = ".") %>% 
  mutate(normalized_par = mean(height_march_surv_may$normalized_par),
         exotic_percentcover = mean(height_march_surv_may$exotic_percentcover),
         site = "2",
         soil_moisture = mean(height_march_surv_may$soil_moisture),
         treatment = "full removal",
         plot_number = "1") %>% 
  mutate(alive = predict(glme.may2018.mod, newdata = . , type = "response"))

site_1_sh_plot <- ggplot()+
  geom_point(data = height_march_surv_may %>%  filter(site == "1"), aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_site_1_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival",
       title = "Site 1")

site_2_sh_plot <- ggplot()+
  geom_point(data = height_march_surv_may %>%  filter(site == "2"), aes(x = march_stem_height_cm, y = may_alive), alpha = 0.25)+
  geom_line(data = stem_height_site_2_prediction, aes(x = march_stem_height_cm, y = alive), linewidth = 1)+
  theme_classic()+
  labs(x = "Stem Height (cm)",
       y = "Probability of Survival",
       title = "Site 2")

site_1_sh_plot + site_2_sh_plot
## site


# boxplot: average survival by site
survbox.1 <- ggplot(data = survmortnospp_may2018_join, aes(x = site, y = totalsurvival)) +
   geom_boxplot(aes(fill = site, color = site)) +
   scale_color_manual(values = c(site1outline, site2outline)) +
   scale_fill_manual(values = c(site1color, site2color)) +
   labs(title = "Average seedling survival in May 2018", x = "Site", y = "Average seedling survival (n)") + 
    theme_bw() 
ggplotly(survbox.1)



```


# May 2019 Seedling survival 
  - add height
```{r may 2019 - join data, include=TRUE}
# subsetting data for May 2019 survival
# survmortnospp = may 2019
# par = may 2019
# tdr = march 2019
# nncover = 2019
survmortnospp_may2019 <- dplyr::filter(survmortnospp, year == "2019" & month =="4" | year == "2019" & month =="5")
par_may2019 <- dplyr::filter(par, year == "2019" & month =="5")
tdr_march2019 <- tdr %>% 
  dplyr::filter(year == "2019" & month == "3")
  
tdr_march2019 <- tdr %>% 
    dplyr::filter(year == "2019" & month =="3")
nncover_may2019 <- dplyr::filter(exotic_cover_all, year == "2019")
print(survmortnospp_may2019) # each df should have 36 rows of data


# left join data for may 2019 survival
survmortnospp_may2019_join <- survmortnospp_may2019 %>% 
  dplyr::left_join(par_may2019, by = c("year", "site", "plot_number", "treatment"), na.rm = F) %>%    #left join par
  rename(month_survival = month.x, 
         month_par = month.y) %>% 
  dplyr::left_join(par_may2019, by = c("year", "site", "plot_number"), na.rm = F) %>%   # left join tdr
  rename(treatment = treatment.x, 
         month_tdr = month) %>% 
  dplyr::select(!treatment.y) %>% 
   dplyr::left_join(nncover_may2019, by = c("year", "site", "plot_number"), na.rm = F) %>%   # left join exotic percent cover
  rename(exotic_percentcover = cover_percent) %>% 
  dplyr::select(!treatment.y) %>% 
  dplyr::select(!date)
view(survmortnospp_may2019_join)


```


```{r MAY 2019 - join data, include=FALSE}

# subsetting data for May 2019 survival
# survmortnospp = may 2019
# par = may 2019
# tdr = march 2019
# nncover = may 2019

survmortnospp_t2 <- dplyr::filter(survmortnospp, month_count =="16") # <-- missing data for plots 1-6, 13, etc.
#view(survmortnospp_t2)
par_t2 <- dplyr::filter(par, year == "2019" & month =="5")
tdr_t2 <- tdr %>% 
  dplyr::filter(year == "2019" & month =="3")
nncover_t2 <- dplyr::filter(exotic_cover_all, year == "2019")

# left join data for Jan-May 2019 (t2) survival
#survmortnospp_t2_mod <- survmortnospp_t2 %>% 
#  dplyr::left_join(par_t2, by = c("year", "site", "plot_number", "treatment"), na.rm = F) %>%    #left join par
#  rename(month_survival = month.x, 
#         month_par = month.y) %>% 
#  select(!date) %>% 
#  dplyr::left_join(tdr_t2, by = c("year", "site", "plot_number"), na.rm = F) %>%   # left join tdr
#  rename(treatment = treatment.x, 
#         month_tdr = month) %>% 
#  select(!treatment.y) %>% 
#   dplyr::left_join(nncover_t2, by = c("year", "site", "plot_number"), na.rm = F) %>%   # left join exotic percent cover
#  rename(exotic_percentcover = cover_percent) %>% 
#  select(!treatment.y) %>% 
#  select(!date)
#view(survmortnospp_t2_mod)

```

### May-sep or Nov 2019
  
  