---
title: "drought experiment"
author: "Shane Dewees"
date: "3/10/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
library(lubridate)
library(DescTools)
library(gmodels)
library(janitor)
library(sicegar)
library(multcompView)
```

use t.test then broom::tidy to get mean, pvalue and confidence intervals. 

```{r, echo=FALSE, message= FALSE, warning=FALSE}
soil_moisture <- read.csv(here("data", "drought_experiment_data", "data", "soil_moisture.csv")) %>% 
  mutate(date = mdy(date))

drought_ceol <- soil_moisture %>% 
  filter(date == "2022-03-11", species == "ceol", treatment == "drought") %>% 
  dplyr::select(id)

drought_rhov <- soil_moisture %>% 
  filter(date == "2022-03-11", species == "rhov", treatment == "drought") %>% 
  dplyr::select(id)

drought_hear <- soil_moisture %>% 
  filter(date == "2022-03-11", species == "hear", treatment == "drought") %>% 
  dplyr::select(id)

soil_moisture_3_23 <- read.csv(here("data", "drought_experiment_data", "data", "03-23 Soil Moisture Data.csv")) %>% 
  dplyr::select(Note, Moisture, Timestamp) %>% 
  separate(Note, into = c("species", "id"), sep = " ") %>% 
  rename(soil_moisture = Moisture) %>% 
  rename(date = Timestamp) %>% 
  mutate(species = str_replace(species, "R", "r"),
         species = str_replace(species, "C", "c"),
         species = str_replace(species, "H", "h"),
         date = dmy_hm(date),
         treatment = case_when(species == "ceol" & id %in% drought_ceol$id ~ "drought",
                               species == "rhov" & id %in% drought_rhov$id ~ "drought",
                               species == "hear" & id %in% drought_hear$id ~ "drought",
                               TRUE ~ "wet")) %>% 
  separate(date, into = c("date", "time"), sep = " ") %>% 
  dplyr::select(!time)

soil_moisture_4_14 <- read.csv(here("data", "drought_experiment_data", "data", "pulse-data-20220414-154507.csv")) %>% 
  dplyr::select(Note, Moisture, Timestamp) %>%  
  separate(Note, into = c("species", "id", "treatment"), sep = "-") %>% 
  rename(soil_moisture = Moisture) %>%
  drop_na(id) %>% 
  separate(Timestamp, into = c("date", "time"), sep = " ") %>% 
  mutate(species = str_replace(species, "CEOL", "ceol"),
         species = str_replace(species, "H", "h"),
         species = str_replace(species, "R", "r"),
         date = ymd(date),
         treatment = case_when(treatment == "w" ~ "wet",
                               treatment == "d" ~ "drought",
                               treatment == "d " ~ "drought")) %>% 
    dplyr::select(!time)

soil_moisture_4_18 <- read.csv(here("data", "drought_experiment_data", "data", "pulse-data-20220418-134937.csv")) %>% 
  dplyr::select(Note, Moisture, Timestamp) %>%  
  separate(Note, into = c("species", "id", "treatment"), sep = "-") %>% 
  rename(soil_moisture = Moisture) %>%
  drop_na(id) %>% 
  separate(Timestamp, into = c("date", "time"), sep = " ") %>% 
  mutate(species = str_replace(species, "C", "c"),
         species = str_replace(species, "H", "h"),
         species = str_replace(species, "R", "r"),
         species = str_replace(species, "EOL", "eol"),
         species = str_replace(species, "EA", "ea"),
         species = case_when(species =="rho" ~ "rhov",
                             TRUE ~ species),
         species = str_replace(species, "OV", "ov"),
         date = ymd(date),
         treatment = case_when(treatment == "w" ~ "wet",
                               treatment == "d" ~ "drought",
                               treatment == "d " ~ "drought")) %>% 
    dplyr::select(!time) %>% 
  filter(date >= ymd("2022-04-02")) %>% 
  mutate(treatment =  case_when(date == "2022-04-02" ~ "wet",
                                TRUE ~ treatment),
         treatment = case_when(species == "ceol" & date == "2022-04-02" & id %in% drought_ceol$id ~ "drought",
                               species == "rhov" & date == "2022-04-22" & id %in% drought_rhov$id ~ "drought",
                               species == "hear" & date == "2022-04-22" & id %in% drought_hear$id ~ "drought",
                               TRUE ~ treatment))

soil_moisture <- soil_moisture %>% 
  mutate(treatment = case_when(species == "ceol" & date == "2022-03-15" & id %in% drought_ceol$id ~ "drought",
                               species == "rhov" & date == "2022-03-15" & id %in% drought_rhov$id ~ "drought",
                               species == "hear" & date == "2022-03-15" & id %in% drought_hear$id ~ "drought",
                               treatment == "" ~ "wet",
                               TRUE ~ treatment)) %>% 
  rbind(soil_moisture_3_23) %>% 
  rbind(soil_moisture_4_14) %>%
  rbind(soil_moisture_4_18) %>% 
  mutate(species = str_replace(species, "H", "h"),
         species = str_replace(species, "R", "r")) %>% 
  mutate(id = as.numeric(id))
```

```{r, echo=FALSE, message= FALSE, warning=FALSE}
gsw <- read.csv(here("data", "drought_experiment_data", "data", "gsw light adap", "2022-03-31", "gsw_light_adap_Shane_2022_03_31T19_26_28_209Z_1.csv")) %>% 
  row_to_names(1) %>% 
  filter(!row_number() %in% c(1)) %>% 
  dplyr::select("species", "id", "gsw", "PhiPS2", "Date") %>% 
  rename(stomatal_conductance = gsw) %>% 
  rename(light_adapted_flourescence = PhiPS2) %>% 
  rename(date = Date) %>% 
  mutate(id = as.numeric(id),
         light_adapted_flourescence = as.numeric(light_adapted_flourescence),
         stomatal_conductance = as.numeric(stomatal_conductance),
         date = ymd(date),
         treatment = case_when(species == "ceol" & id %in% drought_ceol$id ~ "drought",
                               species == "rhov" & id %in% drought_rhov$id ~ "drought", 
                               species == "hear" & id %in% drought_hear$id ~ "drought", 
                               TRUE ~ "wet"))
gsw_1 <- read.csv(here("data", "drought_experiment_data", "data", "gsw light adap", "2022-04-04", "gsw_light_adap_Shane_2022_04_04T19_19_54_010Z_1.csv")) %>% 
  row_to_names(1) %>% 
  filter(!row_number() %in% c(1)) %>% 
  dplyr::select("species", "id", "gsw", "PhiPS2", "Date") %>% 
  rename(stomatal_conductance = gsw) %>% 
  rename(light_adapted_flourescence = PhiPS2) %>% 
  rename(date = Date) %>% 
  mutate(id = as.numeric(id),
         light_adapted_flourescence = as.numeric(light_adapted_flourescence),
         stomatal_conductance = as.numeric(stomatal_conductance),
         date = ymd(date),
         treatment = case_when(species == "ceol" & id %in% drought_ceol$id ~ "drought",
                               species == "rhov" & id %in% drought_rhov$id ~ "drought", 
                               species == "hear" & id %in% drought_hear$id ~ "drought", 
                               TRUE ~ "wet"))

gsw_2 <- read.csv(here("data", "drought_experiment_data", "data", "gsw light adap", "2022-04-06", "gsw_light_adap_Shane_2022_04_07T19_00_28_282Z_1.csv")) %>% 
  row_to_names(1) %>% 
  filter(!row_number() %in% c(1)) %>% 
  dplyr::select("species", "id", "gsw", "PhiPS2", "Date") %>% 
  rename(stomatal_conductance = gsw) %>% 
  rename(light_adapted_flourescence = PhiPS2) %>% 
  rename(date = Date) %>% 
  mutate(id = as.numeric(id),
         light_adapted_flourescence = as.numeric(light_adapted_flourescence),
         stomatal_conductance = as.numeric(stomatal_conductance),
         date = ymd(date),
         treatment = case_when(species == "ceol" & id %in% drought_ceol$id ~ "drought",
                               species == "rhov" & id %in% drought_rhov$id ~ "drought", 
                               species == "hear" & id %in% drought_hear$id ~ "drought", 
                               TRUE ~ "wet"))

gsw_3 <- read.csv(here("data", "drought_experiment_data", "data", "gsw light adap", "2022-04-08", "gsw_light_adap_Shane_2022_04_10T21_36_14_465Z_1.csv")) %>% 
  row_to_names(1) %>% 
  filter(!row_number() %in% c(1)) %>% 
  dplyr::select("species", "id", "gsw", "PhiPS2", "Date") %>% 
  rename(stomatal_conductance = gsw) %>% 
  rename(light_adapted_flourescence = PhiPS2) %>% 
  rename(date = Date) %>%
  mutate(id = as.numeric(id),
         species = case_when(species == "ceol" & id %in% c(30, 5, 48, 9, 10, 44) ~ "rhov",
                             TRUE ~ species)) %>% 
  mutate(light_adapted_flourescence = as.numeric(light_adapted_flourescence),
         stomatal_conductance = as.numeric(stomatal_conductance),
         date = ymd(date),
         treatment = case_when(species == "ceol" & id %in% drought_ceol$id ~ "drought",
                               species == "rhov" & id %in% drought_rhov$id ~ "drought", 
                               species == "hear" & id %in% drought_hear$id ~ "drought", 
                               TRUE ~ "wet"))
gsw_4 <- read.csv(here("data", "drought_experiment_data", "data", "gsw light adap", "2022-04-10", "gsw_light_adap_Shane_2022_04_10T21_36_14_585Z_1.csv")) %>% 
  row_to_names(1) %>% 
  filter(!row_number() %in% c(1)) %>% 
  dplyr::select("species", "id", "gsw", "PhiPS2", "Date") %>% 
  rename(stomatal_conductance = gsw) %>% 
  rename(light_adapted_flourescence = PhiPS2) %>% 
  rename(date = Date) %>% 
  mutate(id = as.numeric(id),
         light_adapted_flourescence = as.numeric(light_adapted_flourescence),
         stomatal_conductance = as.numeric(stomatal_conductance),
         date = mdy(date),
         treatment = case_when(species == "ceol" & id %in% drought_ceol$id ~ "drought",
                               species == "rhov" & id %in% drought_rhov$id ~ "drought", 
                               species == "hear" & id %in% drought_hear$id ~ "drought", 
                               TRUE ~ "wet"))

gsw_5 <- read.csv(here("data", "drought_experiment_data", "data", "gsw light adap", "2022-04-12", "gsw_light_adap_Shane_2022_04_12T21_31_58_675Z_1.csv")) %>% 
  row_to_names(1) %>% 
  filter(!row_number() %in% c(1)) %>% 
  dplyr::select("species", "id", "gsw", "PhiPS2", "Date") %>% 
  rename(stomatal_conductance = gsw) %>% 
  rename(light_adapted_flourescence = PhiPS2) %>% 
  rename(date = Date) %>% 
  mutate(id = as.numeric(id),
         light_adapted_flourescence = as.numeric(light_adapted_flourescence),
         stomatal_conductance = as.numeric(stomatal_conductance),
         date = mdy(date),
         treatment = case_when(species == "ceol" & id %in% drought_ceol$id ~ "drought",
                               species == "rhov" & id %in% drought_rhov$id ~ "drought", 
                               species == "hear" & id %in% drought_hear$id ~ "drought", 
                               TRUE ~ "wet"))

gsw_6 <- read.csv(here("data", "drought_experiment_data", "data", "gsw light adap", "2022-04-14", "gsw_light_adap_Shane_2022_04_14T21_06_02_083Z_1.csv")) %>% 
  row_to_names(1) %>% 
  filter(!row_number() %in% c(1)) %>% 
  dplyr::select("species", "id", "gsw", "PhiPS2", "Date") %>% 
  rename(stomatal_conductance = gsw) %>% 
  rename(light_adapted_flourescence = PhiPS2) %>% 
  rename(date = Date) %>% 
  mutate(id = as.numeric(id),
         light_adapted_flourescence = as.numeric(light_adapted_flourescence),
         stomatal_conductance = as.numeric(stomatal_conductance),
         date = ymd(date),
         treatment = case_when(species == "ceol" & id %in% drought_ceol$id ~ "drought",
                               species == "rhov" & id %in% drought_rhov$id ~ "drought", 
                               species == "hear" & id %in% drought_hear$id ~ "drought", 
                               TRUE ~ "wet"))
gsw_7 <- read.csv(here("data", "drought_experiment_data", "data", "gsw light adap", "2022-04-16", "gsw_light_adap_Shane_2022_04_18T22_45_49_611Z_1.csv")) %>% 
  row_to_names(1) %>% 
  filter(!row_number() %in% c(1)) %>% 
  dplyr::select("species", "id", "gsw", "PhiPS2", "Date") %>% 
  rename(stomatal_conductance = gsw) %>% 
  rename(light_adapted_flourescence = PhiPS2) %>% 
  rename(date = Date) %>% 
  mutate(id = as.numeric(id),
         light_adapted_flourescence = as.numeric(light_adapted_flourescence),
         stomatal_conductance = as.numeric(stomatal_conductance),
         date = ymd(date),
         treatment = case_when(species == "ceol" & id %in% drought_ceol$id ~ "drought",
                               species == "rhov" & id %in% drought_rhov$id ~ "drought", 
                               species == "hear" & id %in% drought_hear$id ~ "drought", 
                               TRUE ~ "wet"))

gsw_8 <- read.csv(here("data", "drought_experiment_data", "data", "gsw light adap", "2022-04-18", "gsw_light_adap_Shane_2022_04_18T22_45_49_663Z_1.csv")) %>% 
  row_to_names(1) %>% 
  filter(!row_number() %in% c(1)) %>% 
  dplyr::select("species", "id", "gsw", "PhiPS2", "Date") %>% 
  rename(stomatal_conductance = gsw) %>% 
  rename(light_adapted_flourescence = PhiPS2) %>% 
  rename(date = Date) %>% 
  mutate(id = as.numeric(id),
         light_adapted_flourescence = as.numeric(light_adapted_flourescence),
         stomatal_conductance = as.numeric(stomatal_conductance),
         date = ymd(date),
         treatment = case_when(species == "ceol" & id %in% drought_ceol$id ~ "drought",
                               species == "rhov" & id %in% drought_rhov$id ~ "drought", 
                               species == "hear" & id %in% drought_hear$id ~ "drought", 
                               TRUE ~ "wet")) %>% 
  filter(!(species == "hear" & id %in% c(13, 12, 2, 9, 25, 20, 23, 22, 16)))
  


gsw_9 <- read.csv(here("data", "drought_experiment_data", "data", "gsw light adap", "2022-04-20", "gsw_light_adap_Shane_2022_04_21T18_44_48_845Z_1.csv")) %>% 
  row_to_names(1) %>% 
  filter(!row_number() %in% c(1)) %>% 
  dplyr::select("species", "id", "gsw", "PhiPS2", "Date") %>% 
  rename(stomatal_conductance = gsw) %>% 
  rename(light_adapted_flourescence = PhiPS2) %>% 
  rename(date = Date) %>% 
  mutate(id = as.numeric(id),
         light_adapted_flourescence = as.numeric(light_adapted_flourescence),
         stomatal_conductance = as.numeric(stomatal_conductance),
         date = ymd(date),
         treatment = case_when(species == "ceol" & id %in% drought_ceol$id ~ "drought",
                               species == "rhov" & id %in% drought_rhov$id ~ "drought", 
                               species == "hear" & id %in% drought_hear$id ~ "drought", 
                               TRUE ~ "wet"))


midday_stomata <- read.csv(here("data", "drought_experiment_data", "data", "midday_stomtal_conductance.csv"))%>% 
  rename(stomatal_conductance = stomatal_conducatance) %>% 
  mutate(treatment = case_when(species == "ceol" & id %in% drought_ceol$id ~ "drought",
                               species == "rhov" & id %in% drought_rhov$id ~ "drought", 
                               species == "hear" & id %in% drought_hear$id ~ "drought", 
                               TRUE ~ "wet"),
         date = mdy(date)) %>% 
  rbind(gsw) %>% 
  rbind(gsw_1) %>% 
  rbind(gsw_2) %>% 
  rbind(gsw_3) %>% 
  rbind(gsw_4) %>% 
  rbind(gsw_5) %>% 
  rbind(gsw_6) %>% 
  rbind(gsw_7) %>% 
  rbind(gsw_8) %>% 
  rbind(gsw_9)
```

```{r}
saap_moisture <- read.csv(here("data", "drought_experiment_data", "saap", "saap_moisture.csv")) %>% 
  dplyr::select(Date, Moisture, Note) %>% 
  mutate(Note = str_remove(Note, "-actual")) %>% 
  separate(Note, into = c("species", "id")) %>% 
  mutate(species = case_when(species == "SAAP" ~ "saap",
                             TRUE ~ species),
         Date = mdy(Date),
         id = as.numeric(id)) %>% 
  rename(date = Date, 
         soil_moisture = Moisture)

saap_gsw_1 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-02-08",
                            "gsw_light_adap_Shane_2023_02_28T21_54_43_679Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_2 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-02-09",
                            "gsw_light_adap_Shane_2023_02_28T21_54_43_708Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_3 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-02-10",
                            "gsw_light_adap_Shane_2023_02_28T21_54_43_726Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_4 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-02-13",
                            "gsw_light_adap_Shane_2023_02_28T21_54_43_744Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_5 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-02-14",
                            "gsw_light_adap_Shane_2023_02_28T21_54_43_759Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_6 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-02-16",
                            "gsw_light_adap_Shane_2023_02_28T21_54_43_776Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_7 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-02-17",
                            "gsw_light_adap_Shane_2023_02_28T21_54_43_794Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_8 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-02-22",
                            "gsw_light_adap_Shane_2023_02_28T21_54_43_810Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_9 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-02-23",
                            "gsw_light_adap_Shane_2023_02_28T21_54_43_828Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_10 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-02-24",
                            "gsw_light_adap_Shane_2023_02_28T21_54_43_844Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_11 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-02-27",
                            "gsw_light_adap_Shane_2023_02_28T21_54_43_860Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_12 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-02-28",
                            "gsw_light_adap_Shane_2023_02_28T21_54_43_876Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_13 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-03-01",
                            "gsw_light_adap_Shane_2023_05_31T15_40_08_494Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_14 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-03-02",
                            "gsw_light_adap_Shane_2023_05_31T15_40_08_511Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_15 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-03-03",
                            "gsw_light_adap_Shane_2023_05_31T15_40_08_531Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_16 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-03-06",
                            "gsw_light_adap_Shane_2023_05_31T15_40_08_550Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_17 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-03-13",
                            "gsw_light_adap_Shane_2023_05_31T15_40_08_573Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_18 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-03-14",
                            "gsw_light_adap_Shane_2023_05_31T15_40_08_597Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_19 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-03-15",
                            "gsw_light_adap_Shane_2023_05_31T15_40_08_616Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_20 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-03-16",
                            "gsw_light_adap_Shane_2023_05_31T15_40_08_638Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_21 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-03-17",
                            "gsw_light_adap_Shane_2023_05_31T15_40_08_658Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_22 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-03-20",
                            "gsw_light_adap_Shane_2023_05_31T15_40_08_674Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_23 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-03-21",
                            "gsw_light_adap_Shane_2023_05_31T15_40_08_692Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_24 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-03-24",
                            "gsw_light_adap_Shane_2023_05_31T15_40_08_705Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_25 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-03-28",
                            "gsw_light_adap_Shane_2023_05_31T15_40_08_720Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_26 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-03-29",
                            "gsw_light_adap_Shane_2023_05_31T15_40_08_736Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_27 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-03-30",
                            "gsw_light_adap_Shane_2023_05_31T15_40_08_751Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_28 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-04-03",
                            "gsw_light_adap_Shane_2023_05_31T15_40_08_768Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw_29 <- read.csv(here("data", "drought_experiment_data", "saap", "gsw light adap", "2023-04-04",
                            "gsw_light_adap_Shane_2023_05_31T15_40_08_780Z_1.csv"), skip = 1) %>% 
  filter(!row_number() == 1) %>% 
  mutate(date = ymd(Date)) %>% 
  dplyr::select(date, id, gsw)

saap_gsw <- rbind(saap_gsw_1,
                  saap_gsw_2,
                  saap_gsw_3,
                  saap_gsw_4,
                  saap_gsw_5,
                  saap_gsw_6,
                  saap_gsw_7,
                  saap_gsw_8,
                  saap_gsw_9,
                  saap_gsw_10,
                  saap_gsw_11,
                  saap_gsw_12,
                  saap_gsw_13,
                  saap_gsw_14,
                  saap_gsw_15,
                  saap_gsw_16,
                  saap_gsw_17,
                  saap_gsw_18,
                  saap_gsw_19,
                  saap_gsw_20,
                  saap_gsw_21,
                  saap_gsw_22,
                  saap_gsw_23,
                  saap_gsw_24,
                  saap_gsw_25,
                  saap_gsw_26,
                  saap_gsw_27,
                  saap_gsw_28,
                  saap_gsw_29) %>% 
  rename(stomatal_conductance = gsw) %>% 
  mutate(stomatal_conductance = as.numeric(stomatal_conductance))

saap_gsw_moisture <- inner_join(saap_moisture, saap_gsw, by = c("date", "id"))
```


```{r, echo=FALSE, message= FALSE, warning=FALSE}
plant_height <- read.csv(here("data", "drought_experiment_data", "data", "plant_height.csv"))%>% 
  mutate(treatment = case_when(species == "ceol" & id %in% drought_ceol$id ~ "drought",
                               species == "rhov" & id %in% drought_rhov$id ~ "drought", 
                               species == "hear" & id %in% drought_hear$id ~ "drought", 
                               TRUE ~ "wet"))
```

```{r, echo=FALSE, message= FALSE, warning=FALSE}
stomatal_moisture <- right_join(midday_stomata, soil_moisture, by = c("species", "id", "date", "treatment")) %>% 
  mutate(species = case_when(species == "ceol" ~ "ceanothus",
                             species == "hear" ~ "heteromeles",
                             species == "rhov" ~ "rhus"),
         stomatal_conductance = case_when(stomatal_conductance <= 0 ~ 0.0001,
                                          TRUE ~ stomatal_conductance)) %>% 
  filter(stomatal_conductance < 0.5)

# CEOL
ceol_sm_1 <- stomatal_moisture %>% 
  filter(species == "ceanothus") %>% 
  filter(treatment == "drought") %>% 
  filter(id == 1)

ceol_1_sum <- summary(ceol_sm_1$stomatal_conductance)
ceol_1_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = ceol_sm_1,
                  start = list(a = ceol_1_sum[6], H = 26, c = 12))
ceol_1_parameters <- summary(ceol_1_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)


ceol_sm_12 <- stomatal_moisture %>% 
  filter(species == "ceanothus") %>% 
  filter(treatment == "drought") %>% 
  filter(id == 12)

ceol_12_sum <- summary(ceol_sm_12$stomatal_conductance)
ceol_12_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = ceol_sm_12,
                  start = list(a = ceol_12_sum[6], H = 19, c = 14))
ceol_12_parameters <- summary(ceol_12_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

ceol_sm_17 <- stomatal_moisture %>% 
  filter(species == "ceanothus") %>% 
  filter(treatment == "drought") %>% 
  filter(id == 17)

ceol_17_sum <- summary(ceol_sm_17$stomatal_conductance)
ceol_17_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = ceol_sm_17,
                  start = list(a = ceol_17_sum[6], H = 26, c = 12))
ceol_17_parameters <- summary(ceol_17_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

ceol_sm_20 <- stomatal_moisture %>% 
  filter(species == "ceanothus") %>% 
  filter(treatment == "drought") %>% 
  filter(id == "20")

ceol_20_sum <- summary(ceol_sm_20$stomatal_conductance)
ceol_20_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = ceol_sm_20,
                  start = list(a = ceol_20_sum[6], H = 16, c = 7))
ceol_20_parameters <- summary(ceol_20_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

ceol_sm_21 <- stomatal_moisture %>% 
  filter(species == "ceanothus") %>% 
  filter(treatment == "drought") %>% 
  filter(id == "21")

ceol_21_sum <- summary(ceol_sm_21$stomatal_conductance)
ceol_21_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = ceol_sm_21,
                  start = list(a = ceol_21_sum[6], H = 17, c = 10))
ceol_21_parameters <- summary(ceol_21_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

ceol_sm_40 <- stomatal_moisture %>% 
  filter(species == "ceanothus") %>% 
  filter(treatment == "drought") %>% 
  filter(id == "40")

ceol_40_sum <- summary(ceol_sm_40$stomatal_conductance)
ceol_40_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = ceol_sm_40,
                  start = list(a = ceol_21_sum[6], H = 22, c = 13))
ceol_40_parameters <- summary(ceol_40_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)


ceol_sm_41 <- stomatal_moisture %>% 
  filter(species == "ceanothus") %>% 
  filter(treatment == "drought") %>% 
  filter(id == "41")

ceol_41_sum <- summary(ceol_sm_41$stomatal_conductance)
ceol_41_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = ceol_sm_41,
                  start = list(a = ceol_41_sum[6], H = 16, c = 11))
ceol_41_parameters <- summary(ceol_41_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

ceol_parameters <- rbind(ceol_1_parameters, 
                         ceol_12_parameters, 
                         ceol_17_parameters, 
                         ceol_20_parameters, 
                         ceol_21_parameters, 
                         ceol_40_parameters, 
                         ceol_41_parameters) %>% 
  mutate(species = "ceol")


# HEAR
hear_sm <- stomatal_moisture %>% 
  filter(species == "heteromeles") %>% 
  filter(treatment == "drought")

hear_sm_6 <- hear_sm %>% 
  filter(id == "6")

hear_6_sum <- summary(hear_sm_6$stomatal_conductance)
hear_6_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = hear_sm_6,
                  start = list(a = hear_6_sum[6], H = 20, c = 8))
hear_6_parameters <- summary(hear_6_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

hear_sm_8 <- hear_sm %>% 
  filter(id == "8") %>% 
  filter(stomatal_conductance < 0.4)

hear_8_sum <- summary(hear_sm_8$stomatal_conductance)
hear_8_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = hear_sm_8,
                  start = list(a = hear_8_sum[6], H = 19, c = 9))
hear_8_parameters <- summary(hear_8_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

hear_sm_10 <- hear_sm %>% 
  filter(id == "10")

hear_10_sum <- summary(hear_sm_10$stomatal_conductance)
hear_10_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = hear_sm_10,
                  start = list(a = hear_10_sum[6], H = 16, c = 9))
hear_10_parameters <- summary(hear_10_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

hear_sm_12 <- hear_sm %>% 
  filter(id == "12")

hear_12_sum <- summary(hear_sm_12$stomatal_conductance)
hear_12_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = hear_sm_12,
                  start = list(a = hear_12_sum[6], H = 19, c = 9))
hear_12_parameters <- summary(hear_12_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

hear_sm_13 <- hear_sm %>% 
  filter(id == "13")

hear_13_sum <- summary(hear_sm_13$stomatal_conductance)
hear_13_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = hear_sm_13,
                  start = list(a = hear_13_sum[6], H = 19, c = 11))
hear_13_parameters <- summary(hear_13_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

hear_sm_14 <- hear_sm %>% 
  filter(id == "14")

hear_14_sum <- summary(hear_sm_14$stomatal_conductance)
hear_14_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = hear_sm_14,
                  start = list(a = hear_14_sum[6], H = 25, c = 12))
hear_14_parameters <- summary(hear_14_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

hear_sm_18 <- hear_sm %>% 
  filter(id == "18")

hear_18_sum <- summary(hear_sm_18$stomatal_conductance)
hear_18_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = hear_sm_18,
                  start = list(a = hear_18_sum[6], H = 16, c = 8))
hear_18_parameters <- summary(hear_18_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

hear_sm_22 <- hear_sm %>% 
  filter(id == "22")

hear_22_sum <- summary(hear_sm_22$stomatal_conductance)
hear_22_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = hear_sm_22,
                  start = list(a = hear_22_sum[6], H = 20, c = 10))
hear_22_parameters <- summary(hear_22_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

hear_parameters <- rbind(hear_10_parameters, 
                         hear_12_parameters, 
                         hear_13_parameters,
                         hear_14_parameters,
                         hear_18_parameters,
                         hear_22_parameters,
                         hear_6_parameters,
                         hear_8_parameters) %>% 
  mutate(species = "hear")

# RHOV
rhov_sm <- stomatal_moisture %>% 
  filter(species == "rhus") %>% 
  filter(treatment == "drought")

rhov_sm_11 <- rhov_sm %>% 
  filter(id == "11")

rhov_11_sum <- summary(rhov_sm_11$stomatal_conductance)
rhov_11_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = rhov_sm_11,
                  start = list(a = rhov_11_sum[6], H = 21, c = 14))
rhov_11_parameters <- summary(rhov_11_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

rhov_sm_34 <- rhov_sm %>% 
  filter(id == "34")

rhov_34_sum <- summary(rhov_sm_34$stomatal_conductance)
rhov_34_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = rhov_sm_34,
                  start = list(a = rhov_34_sum[6], H = 22, c = 15),
                  control = nls.control(maxiter = 100))
rhov_34_parameters <- summary(rhov_34_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

rhov_sm_38 <- rhov_sm %>% 
  filter(id == "38")

rhov_38_sum <- summary(rhov_sm_38$stomatal_conductance)
rhov_38_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = rhov_sm_38,
                  start = list(a = rhov_38_sum[6], H = 28, c = 17))
rhov_38_parameters <- summary(rhov_38_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

rhov_sm_39 <- rhov_sm %>% 
  filter(id == "39")

rhov_39_sum <- summary(rhov_sm_39$stomatal_conductance)
rhov_39_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = rhov_sm_39,
                  start = list(a = rhov_39_sum[6], H = 27, c = 20))
rhov_39_parameters <- summary(rhov_39_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

rhov_sm_42 <- rhov_sm %>% 
  filter(id == "42")

rhov_42_sum <- summary(rhov_sm_42$stomatal_conductance)
rhov_42_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = rhov_sm_42,
                  start = list(a = rhov_42_sum[6], H = 20, c = 17))
rhov_42_parameters <- summary(rhov_42_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

rhov_parameters <- rbind(rhov_11_parameters,
                         rhov_34_parameters,
                         rhov_38_parameters,
                         rhov_39_parameters,
                         rhov_42_parameters) %>% 
  mutate(species = "rhov")

## SAAP

saap_sm_1 <- saap_gsw_moisture %>% 
  filter(id == "1")

saap_1_sum <- summary(saap_sm_1$stomatal_conductance)
saap_1_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = saap_sm_1,
                  start = list(a = saap_1_sum[6], H = 20, c = 7))
saap_1_parameters <- summary(saap_1_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

saap_sm_2 <- saap_gsw_moisture %>% 
  filter(id == "2")

saap_2_sum <- summary(saap_sm_2$stomatal_conductance)
saap_2_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = saap_sm_2,
                  start = list(a = saap_2_sum[6], H = 25, c = 8))
saap_2_parameters <- summary(saap_2_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

saap_sm_3 <- saap_gsw_moisture %>% 
  filter(id == "3")

saap_3_sum <- summary(saap_sm_3$stomatal_conductance)
saap_3_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = saap_sm_3,
                  start = list(a = saap_3_sum[6], H = 20, c = 7),
                  control = nls.control(maxiter = 100))
saap_3_parameters <- summary(saap_3_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

saap_sm_4 <- saap_gsw_moisture %>% 
  filter(id == "4")

saap_4_sum <- summary(saap_sm_4$stomatal_conductance)
saap_4_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = saap_sm_4,
                  start = list(a = saap_4_sum[6], H = 20, c = 8))
saap_4_parameters <- summary(saap_4_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

saap_sm_5 <- saap_gsw_moisture %>% 
  filter(id == "5")

saap_5_sum <- summary(saap_sm_5$stomatal_conductance)
saap_5_nls <- nls(formula = stomatal_conductance ~ (a * (soil_moisture - c))/(H + (soil_moisture - c)), 
                  data = saap_sm_5,
                  start = list(a = saap_5_sum[6], H = 20, c = 6),
                  control = nls.control(maxiter = 100))
saap_5_parameters <- summary(saap_5_nls)[["coefficients"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameters") %>% 
  dplyr::select(parameters, Estimate) %>% 
  pivot_wider(values_from = Estimate, names_from = parameters) %>% 
  rename(gsw_max = a, 
         gsw50_moist = H,
         gsw0_moist = c) %>% 
  mutate(gsw50_moist = gsw50_moist + gsw0_moist)

saap_parameters <- rbind(saap_1_parameters,
                         saap_2_parameters,
                         saap_3_parameters,
                         saap_4_parameters,
                         saap_5_parameters) %>% 
  mutate(species = "saap")

drought_parameters <- rbind(ceol_parameters,
                            hear_parameters,
                            rhov_parameters,
                            saap_parameters)



gsw_max_tukey <- TukeyHSD(aov(gsw_max~species, data = drought_parameters))
gsw50_moist_tukey <- TukeyHSD(aov(gsw50_moist~species, data = drought_parameters))
gsw0_moist_tukey <- TukeyHSD(aov(gsw0_moist~species, data = drought_parameters))

gsw_max <- multcompLetters(gsw_max_tukey$species[,4]) %>% 
  as.data.frame.list() %>% 
  rownames_to_column(var = "species") %>% 
  select(species, Letters) %>% 
  rename(gsw_max_lettters = Letters)

gsw50_moist <- multcompLetters(gsw50_moist_tukey$species[,4]) %>% 
  as.data.frame.list() %>% 
  rownames_to_column(var = "species") %>% 
  select(species, Letters) %>% 
  rename(gsw50_letters = Letters)

gsw0_moist <- multcompLetters(gsw0_moist_tukey$species[,4]) %>% 
  as.data.frame.list() %>% 
  rownames_to_column(var = "species") %>% 
  select(species, Letters) %>% 
  rename(gsw0_letters = Letters)

drought_parameters_stats <- drought_parameters %>% 
  left_join(gsw50_moist, by = "species") %>% 
  left_join(gsw_max, by = "species") %>% 
  left_join(gsw0_moist, by = "species")

ggplot(drought_parameters_stats) + 
  geom_boxplot(aes(x = species, y = gsw_max)) + 
  geom_text(aes(x = species, y = 0.4, label = gsw_max_lettters), check_overlap = TRUE) +
  theme_classic()

ggplot(drought_parameters_stats) + 
  geom_boxplot(aes(x = species, y = gsw50_moist)) + 
  geom_text(aes(x = species, y = 40, label = gsw50_letters), check_overlap = TRUE) +
  theme_classic()

ggplot(drought_parameters_stats) + 
  geom_boxplot(aes(x = species, y = gsw0_moist)) + 
  geom_text(aes(x = species, y = 17, label = gsw0_letters), check_overlap = TRUE) +
  theme_classic()
```